#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
HIkyuu-UI æ’ä»¶ç³»ç»Ÿå…¨é¢åˆ†æå·¥å…·

è¯¥å·¥å…·å¯¹æ‰€æœ‰ç°æœ‰æ’ä»¶è¿›è¡Œå…¨é¢æ£€æµ‹åˆ†æï¼ŒåŒ…æ‹¬ï¼š
1. æ’ä»¶è¯†åˆ«å’ŒåŠ è½½çŠ¶æ€
2. ä¸šåŠ¡æ¡†æ¶å®Œæ•´æ€§æ£€æŸ¥
3. ç³»ç»Ÿæ¡†æ¶å…¼å®¹æ€§éªŒè¯
4. ç¼ºå¤±å†…å®¹è¯†åˆ«
5. æ’ä»¶èƒ½åŠ›è¯„ä¼°
"""
from core.plugin_types import DataType, AssetType
from core.services.plugin_database_service import get_plugin_database_service
from core.plugin_manager import PluginManager
from core.services.unified_data_manager import UnifiedDataManager
import sys
import os
import json
from pathlib import Path
from typing import Dict, List, Any
from loguru import logger
import importlib
import inspect

# å‡è®¾é¡¹ç›®æ ¹ç›®å½•åœ¨å½“å‰è„šæœ¬çš„çˆ¶ç›®å½•
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..')))


# é…ç½®Loguruæ—¥å¿—çº§åˆ«
logger.remove()
logger.add(sys.stderr, level="INFO")


class PluginAnalyzer:
    """æ’ä»¶åˆ†æå™¨"""

    def __init__(self):
        self.unified_manager = None
        self.plugin_manager = None
        self.db_service = None
        self.analysis_results = {
            'summary': {},
            'plugins': {},
            'issues': [],
            'recommendations': []
        }

    def initialize(self):
        """åˆå§‹åŒ–åˆ†æå™¨"""
        try:
            logger.info("ğŸ”§ åˆå§‹åŒ–æ’ä»¶åˆ†æå™¨...")

            # åˆå§‹åŒ–ç»Ÿä¸€æ•°æ®ç®¡ç†å™¨
            self.unified_manager = UnifiedDataManager()
            logger.info("âœ… ç»Ÿä¸€æ•°æ®ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ")

            # è·å–æ’ä»¶ç®¡ç†å™¨
            uni_plugin_manager = self.unified_manager.get_uni_plugin_manager()
            if uni_plugin_manager:
                self.plugin_manager = uni_plugin_manager.plugin_center.plugin_manager
                logger.info("âœ… æ’ä»¶ç®¡ç†å™¨è·å–æˆåŠŸ")
            else:
                logger.error("âŒ æ— æ³•è·å–æ’ä»¶ç®¡ç†å™¨")
                return False

            # åˆå§‹åŒ–æ•°æ®åº“æœåŠ¡
            self.db_service = get_plugin_database_service()
            logger.info("âœ… æ’ä»¶æ•°æ®åº“æœåŠ¡åˆå§‹åŒ–æˆåŠŸ")

            return True

        except Exception as e:
            logger.error(f"âŒ åˆå§‹åŒ–å¤±è´¥: {e}")
            return False

    def analyze_all_plugins(self):
        """åˆ†ææ‰€æœ‰æ’ä»¶"""
        logger.info("ğŸ“Š å¼€å§‹å…¨é¢æ’ä»¶åˆ†æ...")

        # 1. åˆ†ææ’ä»¶åŠ è½½çŠ¶æ€
        self._analyze_plugin_loading_status()

        # 2. åˆ†ææ’ä»¶ä¸šåŠ¡æ¡†æ¶
        self._analyze_business_framework()

        # 3. åˆ†æç³»ç»Ÿæ¡†æ¶å…¼å®¹æ€§
        self._analyze_system_framework()

        # 4. è¯†åˆ«ç¼ºå¤±å†…å®¹
        self._identify_missing_content()

        # 5. è¯„ä¼°æ’ä»¶èƒ½åŠ›
        self._evaluate_plugin_capabilities()

        # 6. ç”Ÿæˆåˆ†ææŠ¥å‘Š
        self._generate_analysis_report()

    def _analyze_plugin_loading_status(self):
        """åˆ†ææ’ä»¶åŠ è½½çŠ¶æ€"""
        logger.info("1ï¸âƒ£ åˆ†ææ’ä»¶åŠ è½½çŠ¶æ€...")

        # è·å–æ•°æ®åº“ä¸­çš„æ’ä»¶
        db_plugins = self.db_service.get_all_plugins()

        # è·å–å·²åŠ è½½çš„æ’ä»¶
        loaded_plugins = self.plugin_manager.plugin_instances

        # è·å–æ•°æ®æºæ’ä»¶
        uni_plugin_manager = self.unified_manager.get_uni_plugin_manager()
        data_source_plugins = uni_plugin_manager.plugin_center.data_source_plugins

        self.analysis_results['summary']['total_db_plugins'] = len(db_plugins)
        self.analysis_results['summary']['total_loaded_plugins'] = len(loaded_plugins)
        self.analysis_results['summary']['total_data_source_plugins'] = len(data_source_plugins)

        logger.info(f"  ğŸ“‹ æ•°æ®åº“ä¸­æ’ä»¶æ€»æ•°: {len(db_plugins)}")
        logger.info(f"  ğŸ”Œ å·²åŠ è½½æ’ä»¶æ€»æ•°: {len(loaded_plugins)}")
        logger.info(f"  ğŸ“Š æ•°æ®æºæ’ä»¶æ€»æ•°: {len(data_source_plugins)}")

        # åˆ†ææ¯ä¸ªæ’ä»¶çš„çŠ¶æ€
        for plugin_data in db_plugins:
            plugin_name = plugin_data.get('name', '')
            plugin_status = plugin_data.get('status', '')

            analysis = {
                'name': plugin_name,
                'status_in_db': plugin_status,
                'is_loaded': plugin_name in loaded_plugins,
                'is_data_source': plugin_name in data_source_plugins,
                'issues': []
            }

            # æ£€æŸ¥çŠ¶æ€ä¸ä¸€è‡´
            if plugin_status == 'enabled' and not analysis['is_loaded']:
                analysis['issues'].append("æ’ä»¶çŠ¶æ€ä¸ºenabledä½†æœªè¢«åŠ è½½")
                self.analysis_results['issues'].append(f"{plugin_name}: æ’ä»¶çŠ¶æ€ä¸ºenabledä½†æœªè¢«åŠ è½½")

            self.analysis_results['plugins'][plugin_name] = analysis

    def _analyze_business_framework(self):
        """åˆ†æä¸šåŠ¡æ¡†æ¶å®Œæ•´æ€§"""
        logger.info("2ï¸âƒ£ åˆ†æä¸šåŠ¡æ¡†æ¶å®Œæ•´æ€§...")

        # æ£€æŸ¥æ•°æ®æºæ’ä»¶çš„ä¸šåŠ¡æ¡†æ¶
        uni_plugin_manager = self.unified_manager.get_uni_plugin_manager()
        data_source_plugins = uni_plugin_manager.plugin_center.data_source_plugins

        required_methods = [
            'get_supported_data_types',
            'fetch_data',
            'connect',
            'disconnect',
            'test_connection'
        ]

        for plugin_id, plugin_instance in data_source_plugins.items():
            if plugin_id not in self.analysis_results['plugins']:
                self.analysis_results['plugins'][plugin_id] = {'name': plugin_id, 'issues': []}

            plugin_analysis = self.analysis_results['plugins'][plugin_id]
            plugin_analysis['business_framework'] = {}

            # æ£€æŸ¥å¿…éœ€æ–¹æ³•
            missing_methods = []
            for method in required_methods:
                has_method = hasattr(plugin_instance, method)
                plugin_analysis['business_framework'][method] = has_method
                if not has_method:
                    missing_methods.append(method)

            if missing_methods:
                issue = f"ç¼ºå°‘ä¸šåŠ¡æ–¹æ³•: {', '.join(missing_methods)}"
                plugin_analysis['issues'].append(issue)
                self.analysis_results['issues'].append(f"{plugin_id}: {issue}")

            # æ£€æŸ¥æ”¯æŒçš„æ•°æ®ç±»å‹
            try:
                if hasattr(plugin_instance, 'get_supported_data_types'):
                    supported_types = plugin_instance.get_supported_data_types()
                    plugin_analysis['business_framework']['supported_data_types'] = [str(dt) for dt in supported_types]

                    # æ£€æŸ¥æ˜¯å¦æ”¯æŒåŸºæœ¬æ•°æ®ç±»å‹
                    basic_types = [DataType.ASSET_LIST, DataType.REAL_TIME_QUOTE]
                    missing_basic_types = [dt for dt in basic_types if dt not in supported_types]
                    if missing_basic_types:
                        issue = f"ç¼ºå°‘åŸºæœ¬æ•°æ®ç±»å‹æ”¯æŒ: {[str(dt) for dt in missing_basic_types]}"
                        plugin_analysis['issues'].append(issue)
                        self.analysis_results['issues'].append(f"{plugin_id}: {issue}")
                else:
                    plugin_analysis['issues'].append("æœªå®ç°get_supported_data_typesæ–¹æ³•")

            except Exception as e:
                plugin_analysis['issues'].append(f"è·å–æ”¯æŒçš„æ•°æ®ç±»å‹å¤±è´¥: {e}")

    def _analyze_system_framework(self):
        """åˆ†æç³»ç»Ÿæ¡†æ¶å…¼å®¹æ€§"""
        logger.info("3ï¸âƒ£ åˆ†æç³»ç»Ÿæ¡†æ¶å…¼å®¹æ€§...")

        uni_plugin_manager = self.unified_manager.get_uni_plugin_manager()
        data_source_plugins = uni_plugin_manager.plugin_center.data_source_plugins

        # æ£€æŸ¥æ’ä»¶æ˜¯å¦ç¬¦åˆIDataSourcePluginæ¥å£
        for plugin_id, plugin_instance in data_source_plugins.items():
            plugin_analysis = self.analysis_results['plugins'][plugin_id]
            plugin_analysis['system_framework'] = {}

            # æ£€æŸ¥æ¥å£å…¼å®¹æ€§
            interface_methods = ['get_supported_data_types', 'fetch_data']
            interface_compliance = True

            for method in interface_methods:
                has_method = hasattr(plugin_instance, method)
                plugin_analysis['system_framework'][f'implements_{method}'] = has_method
                if not has_method:
                    interface_compliance = False

            plugin_analysis['system_framework']['interface_compliant'] = interface_compliance

            if not interface_compliance:
                issue = "ä¸ç¬¦åˆIDataSourcePluginæ¥å£è§„èŒƒ"
                plugin_analysis['issues'].append(issue)
                self.analysis_results['issues'].append(f"{plugin_id}: {issue}")

            # æ£€æŸ¥æ˜¯å¦æœ‰å¥åº·æ£€æŸ¥æ–¹æ³•
            has_health_check = hasattr(plugin_instance, 'health_check')
            plugin_analysis['system_framework']['has_health_check'] = has_health_check

            if not has_health_check:
                plugin_analysis['issues'].append("ç¼ºå°‘health_checkæ–¹æ³•")

    def _identify_missing_content(self):
        """è¯†åˆ«ç¼ºå¤±å†…å®¹"""
        logger.info("4ï¸âƒ£ è¯†åˆ«ç¼ºå¤±å†…å®¹...")

        # æ£€æŸ¥æ’ä»¶ç›®å½•ç»“æ„
        plugins_dir = Path("plugins")
        expected_dirs = ["data_sources", "examples", "sentiment_data_sources"]

        for expected_dir in expected_dirs:
            dir_path = plugins_dir / expected_dir
            if not dir_path.exists():
                issue = f"ç¼ºå°‘æ’ä»¶ç›®å½•: {dir_path}"
                self.analysis_results['issues'].append(issue)

        # æ£€æŸ¥å…³é”®æ’ä»¶æ˜¯å¦å­˜åœ¨
        critical_plugins = [
            "data_sources.eastmoney_plugin",
            "data_sources.sina_plugin"
        ]

        for plugin_name in critical_plugins:
            if plugin_name not in self.analysis_results['plugins']:
                issue = f"ç¼ºå°‘å…³é”®æ’ä»¶: {plugin_name}"
                self.analysis_results['issues'].append(issue)
            elif not self.analysis_results['plugins'][plugin_name].get('is_loaded', False):
                issue = f"å…³é”®æ’ä»¶æœªåŠ è½½: {plugin_name}"
                self.analysis_results['issues'].append(issue)

    def _evaluate_plugin_capabilities(self):
        """è¯„ä¼°æ’ä»¶èƒ½åŠ›"""
        logger.info("5ï¸âƒ£ è¯„ä¼°æ’ä»¶èƒ½åŠ›...")

        uni_plugin_manager = self.unified_manager.get_uni_plugin_manager()
        data_source_plugins = uni_plugin_manager.plugin_center.data_source_plugins

        capabilities_summary = {
            'asset_list_providers': [],
            'real_time_providers': [],
            'historical_data_providers': [],
            'fund_flow_providers': []
        }

        for plugin_id, plugin_instance in data_source_plugins.items():
            try:
                if hasattr(plugin_instance, 'get_supported_data_types'):
                    supported_types = plugin_instance.get_supported_data_types()

                    if DataType.ASSET_LIST in supported_types:
                        capabilities_summary['asset_list_providers'].append(plugin_id)

                    if DataType.REAL_TIME_QUOTE in supported_types:
                        capabilities_summary['real_time_providers'].append(plugin_id)

                    if DataType.HISTORICAL_KLINE in supported_types:
                        capabilities_summary['historical_data_providers'].append(plugin_id)

                    if DataType.FUND_FLOW in supported_types:
                        capabilities_summary['fund_flow_providers'].append(plugin_id)

            except Exception as e:
                logger.warning(f"è¯„ä¼°æ’ä»¶ {plugin_id} èƒ½åŠ›æ—¶å‡ºé”™: {e}")

        self.analysis_results['summary']['capabilities'] = capabilities_summary

        # æ£€æŸ¥èƒ½åŠ›è¦†ç›–
        if len(capabilities_summary['asset_list_providers']) < 2:
            self.analysis_results['recommendations'].append("å»ºè®®å¢åŠ æ›´å¤šèµ„äº§åˆ—è¡¨æ•°æ®æºä»¥æé«˜å¯é æ€§")

        if len(capabilities_summary['real_time_providers']) < 2:
            self.analysis_results['recommendations'].append("å»ºè®®å¢åŠ æ›´å¤šå®æ—¶è¡Œæƒ…æ•°æ®æºä»¥æé«˜å¯é æ€§")

    def _generate_analysis_report(self):
        """ç”Ÿæˆåˆ†ææŠ¥å‘Š"""
        logger.info("6ï¸âƒ£ ç”Ÿæˆåˆ†ææŠ¥å‘Š...")

        # ç»Ÿè®¡é—®é¢˜
        total_issues = len(self.analysis_results['issues'])
        critical_issues = len([issue for issue in self.analysis_results['issues'] if 'å…³é”®æ’ä»¶' in issue])

        self.analysis_results['summary']['total_issues'] = total_issues
        self.analysis_results['summary']['critical_issues'] = critical_issues

        # ä¿å­˜æŠ¥å‘Šåˆ°æ–‡ä»¶
        report_file = "HIkyuu-UIæ’ä»¶ç³»ç»Ÿå…¨é¢åˆ†ææŠ¥å‘Š.json"
        with open(report_file, 'w', encoding='utf-8') as f:
            json.dump(self.analysis_results, f, ensure_ascii=False, indent=2)

        logger.info(f"ğŸ“„ åˆ†ææŠ¥å‘Šå·²ä¿å­˜åˆ°: {report_file}")

        # æ‰“å°æ‘˜è¦
        self._print_summary()

    def _print_summary(self):
        """æ‰“å°åˆ†ææ‘˜è¦"""
        logger.info("\n" + "="*60)
        logger.info("ğŸ“‹ HIkyuu-UI æ’ä»¶ç³»ç»Ÿåˆ†ææ‘˜è¦")
        logger.info("="*60)

        summary = self.analysis_results['summary']

        logger.info(f"ğŸ“Š æ’ä»¶ç»Ÿè®¡:")
        logger.info(f"  æ•°æ®åº“ä¸­æ’ä»¶æ€»æ•°: {summary.get('total_db_plugins', 0)}")
        logger.info(f"  å·²åŠ è½½æ’ä»¶æ€»æ•°: {summary.get('total_loaded_plugins', 0)}")
        logger.info(f"  æ•°æ®æºæ’ä»¶æ€»æ•°: {summary.get('total_data_source_plugins', 0)}")

        logger.info(f"\nğŸ¯ èƒ½åŠ›ç»Ÿè®¡:")
        capabilities = summary.get('capabilities', {})
        logger.info(f"  èµ„äº§åˆ—è¡¨æä¾›è€…: {len(capabilities.get('asset_list_providers', []))}")
        logger.info(f"  å®æ—¶è¡Œæƒ…æä¾›è€…: {len(capabilities.get('real_time_providers', []))}")
        logger.info(f"  å†å²æ•°æ®æä¾›è€…: {len(capabilities.get('historical_data_providers', []))}")
        logger.info(f"  èµ„é‡‘æµæä¾›è€…: {len(capabilities.get('fund_flow_providers', []))}")

        logger.info(f"\nâš ï¸ é—®é¢˜ç»Ÿè®¡:")
        logger.info(f"  æ€»é—®é¢˜æ•°: {summary.get('total_issues', 0)}")
        logger.info(f"  å…³é”®é—®é¢˜æ•°: {summary.get('critical_issues', 0)}")

        if self.analysis_results['issues']:
            logger.info(f"\nğŸ” å‘ç°çš„é—®é¢˜:")
            for i, issue in enumerate(self.analysis_results['issues'][:10], 1):
                logger.info(f"  {i}. {issue}")
            if len(self.analysis_results['issues']) > 10:
                logger.info(f"  ... è¿˜æœ‰ {len(self.analysis_results['issues']) - 10} ä¸ªé—®é¢˜")

        if self.analysis_results['recommendations']:
            logger.info(f"\nğŸ’¡ å»ºè®®:")
            for i, rec in enumerate(self.analysis_results['recommendations'], 1):
                logger.info(f"  {i}. {rec}")

        logger.info("="*60)


def main():
    """ä¸»å‡½æ•°"""
    logger.info("ğŸš€ å¯åŠ¨HIkyuu-UIæ’ä»¶ç³»ç»Ÿå…¨é¢åˆ†æ...")

    analyzer = PluginAnalyzer()

    if not analyzer.initialize():
        logger.error("âŒ åˆ†æå™¨åˆå§‹åŒ–å¤±è´¥")
        return

    analyzer.analyze_all_plugins()

    logger.info("âœ… æ’ä»¶ç³»ç»Ÿå…¨é¢åˆ†æå®Œæˆï¼")


if __name__ == "__main__":
    main()
