# 图表性能监控使用指南

## 概述

为了验证图表显示修复的效果，我们创建了一个图表性能监控系统，可以实时监控图表加载性能和错误日志。

## 功能特性

### 1. 性能监控
- **加载时间监控**：记录每次图表加载的耗时
- **内存使用监控**：跟踪图表加载时的内存使用情况
- **成功率统计**：计算图表加载的成功率

### 2. 错误监控
- **错误日志记录**：自动记录图表加载错误
- **错误统计**：统计错误次数和类型
- **错误详情**：记录错误发生的股票代码和详细信息

### 3. 性能报告
- **实时统计**：提供实时的性能统计数据
- **性能评级**：根据性能指标自动评级
- **历史数据**：保存历史监控数据

## 使用方法

### 1. 启动监控

监控系统会在系统启动时自动启用（如果`monitor_chart_performance.py`文件存在）。

```python
# 监控系统会自动初始化
from monitor_chart_performance import chart_monitor
```

### 2. 查看实时性能

```python
# 获取性能统计
stats = chart_monitor.get_performance_stats()
print(stats)

# 生成性能报告
report = chart_monitor.generate_report()
print(report)
```

### 3. 保存监控数据

```python
# 保存当前监控数据
chart_monitor.save_metrics("chart_metrics.json")

# 加载历史监控数据
chart_monitor.load_metrics("chart_metrics.json")
```

## 监控指标说明

### 性能指标
- **平均加载时间**：所有图表加载的平均耗时
- **最快/最慢加载时间**：加载时间的范围
- **平均内存使用**：图表加载时的平均内存使用量

### 质量指标
- **成功率**：图表加载成功的百分比
- **错误次数**：图表加载失败的次数
- **监控时长**：总监控时间

### 性能评级标准

#### 加载速度评级
- **优秀 ✓**：平均加载时间 < 0.5秒
- **良好 ✓**：平均加载时间 < 1.0秒
- **一般 ⚠**：平均加载时间 < 2.0秒
- **需要优化 ✗**：平均加载时间 ≥ 2.0秒

#### 稳定性评级
- **优秀 ✓**：成功率 ≥ 95%
- **良好 ✓**：成功率 ≥ 90%
- **一般 ⚠**：成功率 ≥ 80%
- **需要优化 ✗**：成功率 < 80%

## 日志文件

### chart_performance.log
记录详细的性能和错误日志：
```
2025-01-06 10:30:15,123 [INFO] 图表加载成功，耗时: 0.245秒
2025-01-06 10:30:20,456 [ERROR] 图表错误 [sz000001]: 数据加载失败
```

### chart_metrics.json
保存监控数据的JSON文件：
```json
{
  "chart_load_times": [0.245, 0.312, 0.189],
  "memory_usage": [125.6, 128.3, 124.1],
  "error_count": 1,
  "success_count": 15,
  "start_time": "2025-01-06T10:30:00"
}
```

## 示例报告

```
=== 图表性能监控报告 ===
监控时间: 3600.0秒
总加载次数: 50
成功次数: 48
失败次数: 2
成功率: 96.0%

性能指标:
- 平均加载时间: 0.345秒
- 最快加载时间: 0.189秒
- 最慢加载时间: 0.678秒
- 平均内存使用: 126.5MB

性能评级:
- 加载速度: 优秀 ✓
- 稳定性: 优秀 ✓
```

## 集成到系统

监控系统已经集成到以下组件：

### 1. ChartCanvas.update_chart()
使用`@monitor_chart_load`装饰器自动监控图表更新性能。

### 2. 自动启用
系统启动时会自动检测并启用监控功能。

### 3. 错误处理
图表加载错误会自动记录到监控系统。

## 故障排除

### 1. 监控未启用
如果看到"图表性能监控已启用"日志，说明监控正常工作。
如果没有看到，检查`monitor_chart_performance.py`文件是否存在。

### 2. 性能数据为空
如果报告显示"无性能数据"，说明还没有图表加载操作。
尝试加载一些股票图表后再查看报告。

### 3. 日志文件过大
监控会持续记录日志，注意定期清理`chart_performance.log`文件。

## 建议的监控流程

### 1. 日常监控
- 每天查看一次性能报告
- 关注错误日志中的异常模式
- 监控内存使用趋势

### 2. 性能优化
- 如果平均加载时间超过1秒，考虑优化
- 如果成功率低于95%，检查错误原因
- 如果内存使用持续增长，检查内存泄漏

### 3. 版本对比
- 在修复前后对比性能数据
- 保存不同版本的监控数据
- 分析性能变化趋势

## 扩展功能

可以根据需要扩展监控功能：

### 1. 添加更多指标
- CPU使用率监控
- 网络请求时间
- 缓存命中率

### 2. 告警功能
- 性能异常自动告警
- 错误率超阈值通知
- 内存使用过高警告

### 3. 可视化
- 性能趋势图表
- 实时监控仪表板
- 历史数据分析

---

通过这个监控系统，我们可以持续跟踪图表显示修复的效果，确保系统性能稳定可靠。 