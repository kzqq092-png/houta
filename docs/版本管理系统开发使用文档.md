# HIkyuu-UI 版本管理系统开发使用文档

## 概述

HIkyuu-UI 版本管理系统是一个完整的算法版本控制解决方案，专门为形态识别算法的开发、测试、部署和维护而设计。系统提供了版本创建、激活、回滚、导入导出、性能对比等全方位的版本管理功能。

## 系统架构

### 核心组件

1. **版本管理器 (VersionManager)**
   - 位置：`optimization/version_manager.py`
   - 功能：版本的CRUD操作、激活、回滚、对比等核心逻辑
   - 数据存储：SQLite数据库

2. **版本管理对话框 (VersionManagerDialog)**
   - 位置：`gui/dialogs/version_manager_dialog.py`
   - 功能：用户界面，提供可视化的版本管理操作
   - 特点：集成真实后端数据和模拟数据的双重支持

3. **数据库管理器 (OptimizationDatabaseManager)**
   - 位置：`optimization/database_schema.py`
   - 功能：数据库表结构管理和数据操作
   - 表结构：algorithm_versions, performance_metrics等

### 数据流架构

```
用户界面 (GUI) 
    ↓
版本管理对话框 (VersionManagerDialog)
    ↓
版本管理器 (VersionManager)
    ↓
数据库管理器 (OptimizationDatabaseManager)
    ↓
SQLite数据库 (hikyuu_system.db)
```

## 功能详解

### 1. 版本管理功能

#### 1.1 创建版本
- **功能**：为指定形态创建新的算法版本
- **操作流程**：
  1. 选择目标形态类型
  2. 输入版本描述
  3. 系统自动分配版本号
  4. 保存到数据库

```python
# 代码示例
version_id = version_manager.save_version(
    pattern_id=0,
    pattern_name="头肩顶",
    algorithm_code="# 算法代码",
    parameters={},
    description="新版本描述",
    optimization_method="manual"
)
```

#### 1.2 激活版本
- **功能**：将指定版本设为当前活动版本
- **操作流程**：
  1. 选择要激活的版本
  2. 系统将其他版本设为非活动状态
  3. 更新主算法表中的代码

```python
# 代码示例
success = version_manager.activate_version(version_id)
```

#### 1.3 版本回滚
- **功能**：回滚到历史版本
- **操作流程**：
  1. 选择目标版本
  2. 激活该版本
  3. 替换当前活动版本

```python
# 代码示例
success = version_manager.rollback_to_version("头肩顶", version_number)
```

#### 1.4 版本删除
- **功能**：删除不需要的版本
- **限制**：不能删除活动版本
- **操作**：同时删除版本记录和性能数据

```python
# 代码示例
success = version_manager.delete_version(version_id)
```

### 2. 导入导出功能

#### 2.1 版本导出
- **格式**：JSON文件
- **内容**：版本信息、算法代码、参数、性能指标
- **用途**：备份、分享、迁移

```json
{
  "version_info": {
    "id": 1,
    "pattern_name": "头肩顶",
    "version_number": 1,
    "algorithm_code": "...",
    "parameters": {...},
    "description": "版本描述"
  },
  "export_time": "2023-12-01T10:00:00",
  "export_format_version": "1.0"
}
```

#### 2.2 版本导入
- **支持格式**：JSON文件
- **操作流程**：
  1. 选择导入文件
  2. 选择目标形态
  3. 解析文件内容
  4. 创建新版本

### 3. 性能对比功能

#### 3.1 版本对比
- **功能**：对比两个版本的性能差异
- **对比维度**：
  - 整体准确率
  - 信号质量
  - 执行时间
  - 内存使用
  - 识别数量
  - 平均置信度

```python
# 代码示例
comparison = version_manager.compare_versions(version_id1, version_id2)
```

#### 3.2 性能指标
- **存储**：performance_metrics表
- **指标类型**：
  - 准确性指标：precision, recall, f1_score
  - 性能指标：execution_time, memory_usage
  - 质量指标：signal_quality, confidence_avg

### 4. 版本历史功能

#### 4.1 版本列表
- **显示内容**：版本号、创建时间、状态、描述
- **排序**：按创建时间倒序
- **筛选**：按形态类型筛选

#### 4.2 变更记录
- **记录内容**：操作时间、操作类型、操作人、变更内容
- **操作类型**：创建、激活、回滚、删除、优化

## 用户界面设计

### 界面布局

```
┌─────────────────────────────────────────────────────────┐
│ 工具栏                                                    │
│ [版本管理] [版本操作] [筛选工具]                           │
├─────────────┬───────────────────────────────────────────┤
│ 版本列表    │ 详情区域                                   │
│             │ ┌─────────────────────────────────────────┐ │
│ ├─头肩顶v2.1│ │ 版本信息 │ 变更记录 │ 性能对比 │ 配置对比 │ │
│ ├─头肩顶v2.0│ └─────────────────────────────────────────┘ │
│ ├─双底v1.5  │                                           │
│ └─...       │                                           │
└─────────────┴───────────────────────────────────────────┘
```

### 工具栏功能

#### 版本管理组
- **创建版本**：创建新的算法版本
- **导入版本**：从文件导入版本
- **导出版本**：导出版本到文件

#### 版本操作组
- **激活版本**：激活选中的版本
- **回滚版本**：回滚到选中的版本
- **删除版本**：删除选中的版本

#### 筛选工具组
- **形态类型**：按形态类型筛选版本
- **刷新**：重新加载版本列表

### 详情区域

#### 版本信息标签页
- 版本基本信息：ID、名称、创建时间、创建者
- 版本描述：详细的版本说明
- 形态列表：包含的形态及其状态

#### 变更记录标签页
- 操作历史：时间、类型、内容、操作人
- 变更详情：具体的变更内容

#### 性能对比标签页
- 对比选择：选择对比的版本
- 性能表格：各项指标的对比结果
- 差异分析：性能提升或下降的分析

#### 配置对比标签页
- 参数对比：算法参数的差异
- 代码对比：算法代码的差异

## 开发指南

### 1. 环境配置

#### 依赖要求
```python
# requirements.txt
PyQt5>=5.15.0
sqlite3  # Python内置
json     # Python内置
datetime # Python内置
```

#### 数据库初始化
```python
from optimization.database_schema import OptimizationDatabaseManager

# 初始化数据库
db_manager = OptimizationDatabaseManager('db/hikyuu_system.db')
```

### 2. 核心API使用

#### 2.1 创建版本管理器
```python
from optimization.version_manager import create_version_manager

# 创建版本管理器实例
version_manager = create_version_manager('db/hikyuu_system.db')
```

#### 2.2 版本操作示例
```python
# 保存新版本
version_id = version_manager.save_version(
    pattern_id=1,
    pattern_name="头肩顶",
    algorithm_code="""
def detect_head_shoulders(data):
    # 算法实现
    return results
""",
    parameters={"threshold": 0.8, "window": 20},
    description="优化后的头肩顶识别算法",
    optimization_method="genetic_algorithm"
)

# 激活版本
success = version_manager.activate_version(version_id)

# 获取版本列表
versions = version_manager.get_versions("头肩顶", limit=10)

# 版本对比
comparison = version_manager.compare_versions(version_id1, version_id2)

# 导出版本
success = version_manager.export_version(version_id, "backup.json")

# 导入版本
new_version_id = version_manager.import_version("backup.json", "头肩顶")
```

### 3. 扩展开发

#### 3.1 添加新的性能指标
```python
# 在 PerformanceMetrics 类中添加新字段
@dataclass
class PerformanceMetrics:
    # 现有字段...
    new_metric: float = 0.0  # 新增指标
```

#### 3.2 自定义版本筛选
```python
def custom_filter_versions(self, filter_criteria):
    """自定义版本筛选逻辑"""
    filtered_versions = []
    for version in self.versions:
        if self.meets_criteria(version, filter_criteria):
            filtered_versions.append(version)
    return filtered_versions
```

#### 3.3 集成外部算法
```python
def integrate_external_algorithm(self, algorithm_path, pattern_name):
    """集成外部算法"""
    with open(algorithm_path, 'r') as f:
        algorithm_code = f.read()
    
    version_id = self.version_manager.save_version(
        pattern_id=0,
        pattern_name=pattern_name,
        algorithm_code=algorithm_code,
        parameters={},
        description="外部算法集成",
        optimization_method="external"
    )
    return version_id
```

## 最佳实践

### 1. 版本命名规范
- 使用语义化版本号：major.minor.patch
- 主版本号：重大功能变更
- 次版本号：功能增加
- 修订号：bug修复

### 2. 版本描述规范
- 简洁明了：一句话概括主要变更
- 详细说明：包含具体的改进点
- 影响评估：说明对性能的影响

### 3. 性能测试规范
- 标准数据集：使用统一的测试数据
- 多维度评估：不仅关注准确率，还要考虑性能
- 对比基准：与当前活动版本对比

### 4. 版本管理策略
- 定期清理：删除过期的测试版本
- 备份重要版本：导出关键版本到文件
- 分支管理：为不同的优化方向创建分支

## 故障排除

### 1. 常见问题

#### 问题1：版本管理器初始化失败
```
错误：版本管理器初始化失败: No module named 'optimization.version_manager'
解决：检查模块路径，确保optimization目录在Python路径中
```

#### 问题2：数据库连接失败
```
错误：database is locked
解决：检查数据库文件权限，确保没有其他进程占用
```

#### 问题3：版本激活失败
```
错误：激活版本失败: version not found
解决：检查版本是否存在，确保版本ID正确
```

### 2. 调试技巧

#### 启用详细日志
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

#### 检查数据库状态
```python
# 查看版本表
cursor.execute("SELECT * FROM algorithm_versions")
print(cursor.fetchall())
```

#### 验证版本完整性
```python
def verify_version_integrity(version_id):
    """验证版本数据完整性"""
    version = version_manager.get_version_by_id(version_id)
    if not version:
        return False, "版本不存在"
    
    if not version.algorithm_code:
        return False, "算法代码为空"
    
    return True, "版本完整"
```

## 性能优化

### 1. 数据库优化
- 添加索引：在常用查询字段上添加索引
- 分页查询：大量数据时使用分页
- 连接池：使用数据库连接池

### 2. 内存优化
- 延迟加载：只在需要时加载版本详情
- 缓存机制：缓存频繁访问的版本数据
- 批量操作：批量处理多个版本操作

### 3. 界面优化
- 异步加载：使用线程加载版本数据
- 进度提示：长时间操作显示进度条
- 懒加载：按需加载版本详情

## 安全考虑

### 1. 数据安全
- 备份策略：定期备份版本数据
- 访问控制：限制版本删除权限
- 数据验证：验证导入的版本数据

### 2. 操作安全
- 确认机制：重要操作需要用户确认
- 回滚保护：防止误操作导致数据丢失
- 审计日志：记录所有版本操作

## 未来扩展

### 1. 功能扩展
- 版本分支：支持并行开发分支
- 自动测试：版本创建后自动运行测试
- 智能推荐：基于性能数据推荐最佳版本

### 2. 集成扩展
- CI/CD集成：与持续集成系统集成
- 云端同步：支持多设备版本同步
- 团队协作：支持多人协作开发

### 3. 界面扩展
- 可视化图表：版本性能趋势图
- 自定义视图：用户自定义版本列表
- 移动端支持：开发移动端版本管理应用

## 总结

HIkyuu-UI 版本管理系统提供了完整的算法版本控制解决方案，通过规范的接口设计和友好的用户界面，让开发者能够高效地管理算法版本，确保系统的稳定性和可维护性。

系统的模块化设计使得功能扩展变得简单，同时支持真实数据和模拟数据的双重模式，确保在不同环境下都能正常工作。

通过遵循本文档的开发指南和最佳实践，开发者可以充分利用版本管理系统的功能，提高算法开发的效率和质量。 