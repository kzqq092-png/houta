# 智能数据质量评估系统使用指南

## 📚 系统概述

本系统实现了根据数据用途自动调整评估权重的智能质量评分机制，解决了"历史数据分析不需要高及时性"和"实盘交易需要极高及时性"的矛盾需求。

## 🎯 核心特性

### 1. 智能权重配置

根据数据用途自动调整四大维度的权重：

| 数据用途 | 完整性 | 准确性 | 一致性 | 及时性 | 适用场景 |
|---------|--------|--------|--------|--------|----------|
| **历史分析** (historical) | 30% | **40%** ↑ | **25%** ↑ | **5%** ↓↓ | 研究、学习、历史回顾 |
| **回测验证** (backtest) | 25% | 35% | **30%** ↑ | 10% ↓ | 策略回测、性能验证 |
| **实时行情** (realtime) | 25% | 30% | 15% | **30%** ↑ | 行情监控、信息查看 |
| **实盘交易** (live_trading) | 20% | 35% | 10% | **35%** ↑↑ | 实盘下单、交易决策 |
| **通用场景** (general) | 30% | 30% | 20% | 20% | 默认均衡配置 |

### 2. 增强准确性检测

新增6项检测：
- ✅ OHLC逻辑关系（含high<low检测）
- ✅ 成交量合法性（负数检测）
- 🆕 **价格异常波动检测**（单日涨跌>30%）
- 🆕 **成交量异常检测**（突增10倍以上）
- 🆕 **零值检测**（收盘价=0）
- 🆕 **价格相等检测**（OHLC全相等）

### 3. 数据源可靠性系数

根据数据源历史表现调整评分（±5%）：

| 数据源 | 系数 | 说明 |
|--------|------|------|
| Tushare | **+5%** | 专业金融数据 |
| Wind万得 | **+5%** | 专业数据终端 |
| 通达信 | **+3%** | 老牌行情软件 |
| 东方财富 | **+2%** | 标准数据源 |
| AKShare | 0% | 开源数据（基准） |
| Unknown | **-2%** | 未知数据源 |

### 4. 智能用途识别

系统会自动识别数据用途，无需手动指定：

```python
识别逻辑：
1. 任务ID关键词（'backtest', '实时', '交易'等）
2. 数据新鲜度：
   - ≤5分钟  → live_trading
   - ≤1小时  → realtime  
   - >1天    → historical/backtest
3. 数据量：
   - >500条  → backtest
   - <50条   → realtime
```

## 📊 评分提升效果对比

### 案例：当前数据（244条，空值率0%）

#### 原评分体系（通用权重）
```
完整性: 1.00 × 30% = 0.30
准确性: 0.95 × 30% = 0.285
一致性: 0.90 × 20% = 0.18
及时性: 0.45 × 20% = 0.09  ← 拖后腿
━━━━━━━━━━━━━━━━━━━
总分: 0.855 (FAIR等级)
```

#### 新评分体系 - 历史分析用途
```
完整性: 1.00 × 30% = 0.30
准确性: 0.95 × 40% = 0.38  ↑
一致性: 0.90 × 25% = 0.225 ↑
及时性: 0.45 × 5%  = 0.0225 ↓↓
━━━━━━━━━━━━━━━━━━━
基础分: 0.9275
数据源: AKShare × 1.00
━━━━━━━━━━━━━━━━━━━
总分: 0.9275 (EXCELLENT等级) ✨
```

**提升效果：0.839 → 0.9275 (+10.5%，从FAIR跃升至EXCELLENT！)**

#### 新评分体系 - 实盘交易用途  
```
完整性: 1.00 × 20% = 0.20
准确性: 0.95 × 35% = 0.3325
一致性: 0.90 × 10% = 0.09
及时性: 0.45 × 35% = 0.1575 ← 保持重要性
━━━━━━━━━━━━━━━━━━━
总分: 0.78 (FAIR等级)
```

**合理降级：历史数据用于实盘交易确实需要更新鲜的数据**

## 🔧 使用方法

### 方法1：自动识别（推荐）

系统会根据数据特征自动判断用途：

```python
# 导入时系统自动识别
result = import_manager.import_kline_data(
    symbols=['000001.SZ'],
    start_date='2020-01-01',
    end_date='2023-12-31'  # 历史数据 → 自动识别为'historical'
)
```

### 方法2：手动指定

```python
# 直接调用评分方法
quality_monitor = DataQualityMonitor()

# 历史数据分析
score = quality_monitor.calculate_quality_score(
    data=df,
    data_type='kline',
    data_usage='historical',  # 手动指定
    data_source='akshare'
)

# 实盘交易
score = quality_monitor.calculate_quality_score(
    data=realtime_df,
    data_type='kline',
    data_usage='live_trading',
    data_source='tongdaxin'
)
```

### 方法3：任务级配置

在导入任务配置中添加关键词：

```python
task_config = {
    'task_id': 'backtest_20240101',  # 包含'backtest' → 自动识别
    'symbols': ['000001.SZ'],
    # ...
}
```

## 📈 效果验证

### 查看日志输出

```log
21:01:55.486 | INFO | [质量评分] 用途:historical, 基础:0.928, 数据源:akshare, 调整系数:1.00, 最终:0.928
21:01:55.491 | INFO | 数据质量评估完成: excellent, 评分: 0.928
```

### 数据库记录

SQLite表`data_quality_metrics`会保存评分历史，可查询不同用途下的评分差异。

## 🎯 最佳实践

### 1. 历史数据研究
```python
# ✅ 推荐：使用历史权重配置
data_usage = 'historical'
# 评分侧重：准确性 > 完整性 > 一致性 > 及时性
```

### 2. 策略回测
```python
# ✅ 推荐：使用回测权重配置  
data_usage = 'backtest'
# 评分侧重：准确性 > 一致性 > 完整性 > 及时性
# 一致性高分确保回测结果可靠
```

### 3. 实时监控
```python
# ✅ 推荐：使用实时权重配置
data_usage = 'realtime'
# 评分侧重：及时性 = 准确性 > 完整性 > 一致性
```

### 4. 实盘交易
```python
# ✅ 推荐：使用交易权重配置
data_usage = 'live_trading'
# 评分侧重：及时性 = 准确性 > 完整性 > 一致性
# ⚠️ 建议评分≥0.90才用于实盘
```

## ⚙️ 自定义配置

### 修改权重配置

编辑 `enhanced_data_manager.py` 的 `_get_dynamic_weights` 方法：

```python
weight_profiles = {
    'historical': {
        'completeness': 0.30,
        'accuracy': 0.40,     # 可调整
        'consistency': 0.25,
        'timeliness': 0.05
    },
    # ...
}
```

### 修改数据源系数

编辑 `_get_source_reliability_adjustment` 方法：

```python
source_reliability = {
    'tushare': 1.05,      # 可调整 (0.95-1.05)
    'custom_source': 1.02  # 添加新数据源
}
```

## 🐛 故障排除

### Q1: 评分没有变化？
**A:** 检查日志中的`[权重配置]`和`[质量评分]`输出，确认用途识别是否正确。

### Q2: 用途识别不准确？
**A:** 使用手动指定方式，或在task_id中添加关键词。

### Q3: 评分偏低？
**A:** 
1. 检查数据源系数是否过低
2. 查看准确性检测日志，排查异常数据
3. 对于历史数据，确认用途为'historical'

## 📞 技术支持

如有问题，请查看日志中的详细输出：
- `[权重配置]` - 权重使用情况
- `[准确性]` - 具体扣分项
- `[数据源调整]` - 数据源系数
- `[质量评分]` - 最终评分明细

