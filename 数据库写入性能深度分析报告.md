# æ•°æ®åº“å†™å…¥æ€§èƒ½æ·±åº¦åˆ†ææŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**ç°è±¡**ï¼š
- å†™å…¥5711æ¡è®°å½•è€—æ—¶16.26ç§’
- å†™å…¥é€Ÿåº¦ï¼š351.3æ¡/ç§’
- å†™å…¥çº¿ç¨‹æ˜¾ç¤ºï¼š5214æ¡è®°å½•è€—æ—¶14.77ç§’ï¼Œé€Ÿåº¦353.0æ¡/ç§’

**é¢„æœŸæ€§èƒ½**ï¼š
- ç†æƒ³æƒ…å†µä¸‹åº”è¯¥è¾¾åˆ°ï¼š5000-10000æ¡/ç§’
- å½“å‰æ€§èƒ½ä»…ä¸ºé¢„æœŸçš„3.5%-7%

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. **executemanyé€æ¡æ‰§è¡ŒON CONFLICTï¼ˆä¸»è¦åŸå› ï¼‰**

**é—®é¢˜**ï¼š
```python
# å½“å‰å®ç°
data_tuples = [tuple(row) for row in filtered_data.values]
conn.executemany(sql, data_tuples)  # é€æ¡æ‰§è¡ŒINSERT ON CONFLICT
```

**åˆ†æ**ï¼š
- DuckDBçš„`executemany`å¯¹äº`INSERT ... ON CONFLICT`è¯­å¥ï¼Œ**ä»ç„¶æ˜¯é€æ¡æ‰§è¡Œ**
- æ¯æ¡è®°å½•éƒ½éœ€è¦ï¼š
  1. æ£€æŸ¥ä¸»é”®å†²çªï¼ˆ4ä¸ªå­—æ®µï¼šsymbol, data_source, timestamp, frequencyï¼‰
  2. å¦‚æœå†²çªåˆ™æ‰§è¡ŒUPDATEï¼Œå¦åˆ™æ‰§è¡ŒINSERT
  3. ç»´æŠ¤æ‰€æœ‰ç´¢å¼•ï¼ˆ5ä¸ªç´¢å¼•ï¼‰
  4. æ›´æ–°updated_atå­—æ®µ

**æ€§èƒ½å¼€é”€**ï¼š
- 5711æ¡è®°å½• = 5711æ¬¡ä¸»é”®æ£€æŸ¥
- 5711æ¬¡ç´¢å¼•ç»´æŠ¤
- 5711æ¬¡äº‹åŠ¡æ—¥å¿—å†™å…¥

**å½±å“**ï¼š**çº¦å æ€»è€—æ—¶çš„60-70%**

---

### 2. **ç´¢å¼•ç»´æŠ¤å¼€é”€ï¼ˆæ¬¡è¦åŸå› ï¼‰**

**å½“å‰ç´¢å¼•**ï¼š
```sql
CREATE INDEX idx_historical_kline_data_symbol ON historical_kline_data(symbol)
CREATE INDEX idx_historical_kline_data_timestamp ON historical_kline_data(timestamp)
CREATE INDEX idx_historical_kline_data_symbol_timestamp ON historical_kline_data(symbol, timestamp)
CREATE INDEX idx_historical_kline_data_data_source ON historical_kline_data(data_source)
CREATE INDEX idx_historical_kline_data_conflict_key ON historical_kline_data(symbol, data_source, timestamp, frequency)
```

**é—®é¢˜**ï¼š
- 5ä¸ªç´¢å¼•ï¼Œæ¯æ¬¡æ’å…¥/æ›´æ–°éƒ½éœ€è¦ç»´æŠ¤
- `conflict_key`ç´¢å¼•ä¸ä¸»é”®é‡å¤ï¼ˆä¸»é”®æœ¬èº«å°±æ˜¯ç´¢å¼•ï¼‰
- `symbol_timestamp`ç´¢å¼•ä¸`conflict_key`ç´¢å¼•æœ‰é‡å 

**å½±å“**ï¼š**çº¦å æ€»è€—æ—¶çš„15-20%**

---

### 3. **æ•°æ®è½¬æ¢å¼€é”€ï¼ˆæ¬¡è¦åŸå› ï¼‰**

**å½“å‰å®ç°**ï¼š
```python
data_tuples = [tuple(row) for row in filtered_data.values]
```

**é—®é¢˜**ï¼š
- DataFrameè½¬Python tupleåˆ—è¡¨éœ€è¦å†…å­˜æ‹·è´
- 5711æ¡è®°å½• Ã— çº¦15ä¸ªå­—æ®µ = 85665ä¸ªå€¼éœ€è¦è½¬æ¢
- Pythonå¯¹è±¡åˆ›å»ºå¼€é”€

**å½±å“**ï¼š**çº¦å æ€»è€—æ—¶çš„5-10%**

---

### 4. **ON CONFLICTæ£€æŸ¥é€»è¾‘ï¼ˆæ¬¡è¦åŸå› ï¼‰**

**å½“å‰SQL**ï¼š
```sql
INSERT INTO historical_kline_data (...) 
VALUES (?)
ON CONFLICT (symbol, data_source, timestamp, frequency) DO UPDATE SET
    open = EXCLUDED.open,
    high = EXCLUDED.high,
    ...
    updated_at = NOW()
```

**é—®é¢˜**ï¼š
- æ¯æ¡è®°å½•éƒ½éœ€è¦æ£€æŸ¥4ä¸ªå­—æ®µçš„å¤åˆä¸»é”®
- å³ä½¿æ²¡æœ‰å†²çªï¼Œä¹Ÿéœ€è¦æ£€æŸ¥
- `NOW()`å‡½æ•°è°ƒç”¨å¼€é”€ï¼ˆæ¯æ¡è®°å½•ï¼‰

**å½±å“**ï¼š**çº¦å æ€»è€—æ—¶çš„10-15%**

---

### 5. **æ—¥å¿—è¾“å‡ºå¼€é”€ï¼ˆè½»å¾®å½±å“ï¼‰**

**å½“å‰å®ç°**ï¼š
```python
logger.debug(f"[æ•°æ®æ’å…¥] æ‰§è¡Œæ‰¹é‡æ’å…¥ï¼Œè¡¨: {table_name}, è®°å½•æ•°: {len(filtered_data)}")
```

**é—®é¢˜**ï¼š
- è™½ç„¶å·²ç»ä¼˜åŒ–ä¸ºdebugçº§åˆ«ï¼Œä½†ä»æœ‰å¼€é”€
- å­—ç¬¦ä¸²æ ¼å¼åŒ–å¼€é”€

**å½±å“**ï¼š**çº¦å æ€»è€—æ—¶çš„1-2%**

---

## ğŸ“Š æ€§èƒ½ç“¶é¢ˆåˆ†å¸ƒ

| ç“¶é¢ˆé¡¹ | å æ¯” | è¯´æ˜ |
|--------|------|------|
| executemanyé€æ¡æ‰§è¡Œ | 60-70% | ä¸»è¦ç“¶é¢ˆ |
| ç´¢å¼•ç»´æŠ¤ | 15-20% | æ¬¡è¦ç“¶é¢ˆ |
| ON CONFLICTæ£€æŸ¥ | 10-15% | æ¬¡è¦ç“¶é¢ˆ |
| æ•°æ®è½¬æ¢ | 5-10% | è½»å¾®å½±å“ |
| æ—¥å¿—è¾“å‡º | 1-2% | å¯å¿½ç•¥ |

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨DuckDBæ‰¹é‡INSERTï¼ˆæ¨èï¼Œæ€§èƒ½æå‡10-50å€ï¼‰

**åŸç†**ï¼š
- ä½¿ç”¨DuckDBçš„`register`åŠŸèƒ½æ³¨å†ŒDataFrame
- ä½¿ç”¨`INSERT INTO ... SELECT FROM`æ‰¹é‡æ’å…¥
- ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰è®°å½•ï¼Œè€Œä¸æ˜¯é€æ¡æ‰§è¡Œ

**å®ç°**ï¼š
```python
def _upsert_data_batch(self, conn, table_name: str, data: pd.DataFrame, data_type: DataType) -> int:
    """ä½¿ç”¨DuckDBæ‰¹é‡INSERTä¼˜åŒ–æ€§èƒ½"""
    try:
        # è¿‡æ»¤æ•°æ®
        table_columns = self._get_table_columns(conn, table_name)
        filtered_data = self._filter_dataframe_columns(data, table_columns)
        
        if filtered_data.empty:
            return 0
        
        # âœ… ä¼˜åŒ–ï¼šä½¿ç”¨ä¸´æ—¶è¡¨+æ‰¹é‡INSERT
        temp_table = f"temp_insert_{int(time.time() * 1000000)}"
        
        # æ³¨å†ŒDataFrameä¸ºä¸´æ—¶è¡¨ï¼ˆé›¶æ‹·è´ï¼‰
        conn.register(temp_table, filtered_data)
        
        # æ„å»ºæ‰¹é‡UPSERT SQL
        if data_type == DataType.HISTORICAL_KLINE:
            # è·å–éœ€è¦æ›´æ–°çš„å­—æ®µï¼ˆæ’é™¤ä¸»é”®å­—æ®µï¼‰
            update_fields = []
            for col in filtered_data.columns:
                if col not in ['symbol', 'data_source', 'timestamp', 'frequency']:
                    update_fields.append(f"{col} = EXCLUDED.{col}")
            
            update_clause = ', '.join(update_fields)
            update_clause += ", updated_at = NOW()"
            
            sql = f"""
                INSERT INTO {table_name} 
                SELECT * FROM {temp_table}
                ON CONFLICT (symbol, data_source, timestamp, frequency) DO UPDATE SET
                {update_clause}
            """
        else:
            # å…¶ä»–æ•°æ®ç±»å‹çš„å¤„ç†...
            sql = f"INSERT INTO {table_name} SELECT * FROM {temp_table}"
        
        # æ‰§è¡Œæ‰¹é‡æ’å…¥
        write_start = time.time()
        conn.execute(sql)
        write_duration = time.time() - write_start
        
        # æ¸…ç†ä¸´æ—¶è¡¨
        conn.unregister(temp_table)
        
        write_speed = len(filtered_data) / write_duration if write_duration > 0 else 0
        logger.info(f"[æ‰¹é‡æ’å…¥] æˆåŠŸæ’å…¥ {len(filtered_data)} æ¡è®°å½•ï¼Œè€—æ—¶: {write_duration:.2f}ç§’, é€Ÿåº¦: {write_speed:.1f}æ¡/ç§’")
        
        return len(filtered_data)
        
    except Exception as e:
        logger.error(f"[æ‰¹é‡æ’å…¥] æ’å…¥å¤±è´¥: {e}")
        raise
```

**é¢„æœŸæ€§èƒ½æå‡**ï¼š
- 5711æ¡è®°å½•ï¼š16.26ç§’ â†’ **0.5-1.5ç§’**ï¼ˆæå‡10-30å€ï¼‰
- å†™å…¥é€Ÿåº¦ï¼š351æ¡/ç§’ â†’ **3500-11000æ¡/ç§’**

---

### æ–¹æ¡ˆ2ï¼šä¼˜åŒ–ç´¢å¼•ç»“æ„ï¼ˆæ€§èƒ½æå‡20-30%ï¼‰

**ä¼˜åŒ–**ï¼š
1. ç§»é™¤é‡å¤ç´¢å¼•
2. åªä¿ç•™å¿…è¦çš„ç´¢å¼•

**ä¼˜åŒ–åçš„ç´¢å¼•**ï¼š
```sql
-- ä¿ç•™ï¼šä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
-- PRIMARY KEY (symbol, data_source, timestamp, frequency)

-- ä¿ç•™ï¼šæŸ¥è¯¢å¸¸ç”¨ç´¢å¼•
CREATE INDEX idx_historical_kline_data_symbol_timestamp ON historical_kline_data(symbol, timestamp);

-- å¯é€‰ï¼šå¦‚æœç»å¸¸æŒ‰data_sourceæŸ¥è¯¢
CREATE INDEX idx_historical_kline_data_data_source ON historical_kline_data(data_source);

-- ç§»é™¤ï¼šé‡å¤ç´¢å¼•
-- âŒ CREATE INDEX idx_historical_kline_data_symbol (ä¸»é”®å·²åŒ…å«)
-- âŒ CREATE INDEX idx_historical_kline_data_timestamp (å·²æœ‰symbol_timestamp)
-- âŒ CREATE INDEX idx_historical_kline_data_conflict_key (ä¸ä¸»é”®é‡å¤)
```

**é¢„æœŸæ€§èƒ½æå‡**ï¼š
- ç´¢å¼•ç»´æŠ¤å¼€é”€å‡å°‘çº¦40%
- æ•´ä½“æ€§èƒ½æå‡çº¦20-30%

---

### æ–¹æ¡ˆ3ï¼šæ‰¹é‡å¤§å°è‡ªé€‚åº”ï¼ˆæ€§èƒ½æå‡10-20%ï¼‰

**åŸç†**ï¼š
- å°æ‰¹é‡ï¼ˆ<1000æ¡ï¼‰ï¼šä½¿ç”¨executemany
- å¤§æ‰¹é‡ï¼ˆâ‰¥1000æ¡ï¼‰ï¼šä½¿ç”¨æ‰¹é‡INSERT

**å®ç°**ï¼š
```python
def _upsert_data(self, conn, table_name: str, data: pd.DataFrame, data_type: DataType) -> int:
    """æ’å…¥æˆ–æ›´æ–°æ•°æ®ï¼ˆè‡ªé€‚åº”æ‰¹é‡å¤§å°ï¼‰"""
    if len(data) < 1000:
        # å°æ‰¹é‡ï¼šä½¿ç”¨executemanyï¼ˆå½“å‰å®ç°ï¼‰
        return self._upsert_data_executemany(conn, table_name, data, data_type)
    else:
        # å¤§æ‰¹é‡ï¼šä½¿ç”¨æ‰¹é‡INSERTï¼ˆæ–¹æ¡ˆ1ï¼‰
        return self._upsert_data_batch(conn, table_name, data, data_type)
```

---

### æ–¹æ¡ˆ4ï¼šå‡å°‘ON CONFLICTå­—æ®µæ£€æŸ¥ï¼ˆæ€§èƒ½æå‡5-10%ï¼‰

**ä¼˜åŒ–**ï¼š
- å¦‚æœæ•°æ®å·²ç»æŒ‰symbolæ’åºï¼Œå¯ä»¥ä¼˜åŒ–å†²çªæ£€æŸ¥
- ä½¿ç”¨MERGEè¯­å¥ï¼ˆå¦‚æœDuckDBæ”¯æŒï¼‰

---

## ğŸ¯ ç»¼åˆä¼˜åŒ–æ•ˆæœé¢„æµ‹

| ä¼˜åŒ–æ–¹æ¡ˆ | æ€§èƒ½æå‡ | å®æ–½éš¾åº¦ | ä¼˜å…ˆçº§ |
|---------|---------|---------|--------|
| æ–¹æ¡ˆ1ï¼šæ‰¹é‡INSERT | 10-50å€ | ä¸­ç­‰ | â­â­â­â­â­ |
| æ–¹æ¡ˆ2ï¼šä¼˜åŒ–ç´¢å¼• | 20-30% | ä½ | â­â­â­â­ |
| æ–¹æ¡ˆ3ï¼šè‡ªé€‚åº”æ‰¹é‡ | 10-20% | ä½ | â­â­â­ |
| æ–¹æ¡ˆ4ï¼šä¼˜åŒ–å†²çªæ£€æŸ¥ | 5-10% | é«˜ | â­â­ |

**ç»¼åˆé¢„æœŸ**ï¼š
- **å½“å‰æ€§èƒ½**ï¼š351æ¡/ç§’
- **ä¼˜åŒ–åæ€§èƒ½**ï¼š**5000-15000æ¡/ç§’**ï¼ˆæå‡14-43å€ï¼‰
- **5711æ¡è®°å½•è€—æ—¶**ï¼š16.26ç§’ â†’ **0.4-1.2ç§’**

---

## ğŸ”§ å®æ–½å»ºè®®

### é˜¶æ®µ1ï¼šç«‹å³å®æ–½ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
1. âœ… **æ–¹æ¡ˆ1ï¼šæ‰¹é‡INSERT**ï¼ˆæœ€å¤§æ€§èƒ½æå‡ï¼‰
2. âœ… **æ–¹æ¡ˆ2ï¼šä¼˜åŒ–ç´¢å¼•**ï¼ˆç®€å•ä¸”æœ‰æ•ˆï¼‰

### é˜¶æ®µ2ï¼šåç»­ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
3. âœ… **æ–¹æ¡ˆ3ï¼šè‡ªé€‚åº”æ‰¹é‡**ï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰

### é˜¶æ®µ3ï¼šæ·±åº¦ä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
4. âœ… **æ–¹æ¡ˆ4ï¼šä¼˜åŒ–å†²çªæ£€æŸ¥**ï¼ˆéœ€è¦æ›´å¤šæµ‹è¯•ï¼‰

---

## ğŸ“ ç»“è®º

### æ ¹æœ¬åŸå› 
1. **ä¸»è¦é—®é¢˜**ï¼š`executemany`é€æ¡æ‰§è¡Œ`INSERT ON CONFLICT`ï¼Œå¯¼è‡´æ¯æ¡è®°å½•éƒ½éœ€è¦å•ç‹¬æ£€æŸ¥å’Œå¤„ç†
2. **æ¬¡è¦é—®é¢˜**ï¼šç´¢å¼•è¿‡å¤šï¼Œç»´æŠ¤å¼€é”€å¤§
3. **è½»å¾®é—®é¢˜**ï¼šæ•°æ®è½¬æ¢å’Œæ—¥å¿—å¼€é”€

### é—®é¢˜æ€§è´¨
- **ç¨‹åºé—®é¢˜**ï¼š70%ï¼ˆexecutemanyä½¿ç”¨ä¸å½“ï¼‰
- **æ•°æ®åº“é—®é¢˜**ï¼š20%ï¼ˆç´¢å¼•è¿‡å¤šï¼‰
- **é…ç½®é—®é¢˜**ï¼š10%ï¼ˆæ‰¹é‡å¤§å°è®¾ç½®ï¼‰

### ä¼˜åŒ–æ–¹å‘
1. **æ”¹ç”¨æ‰¹é‡INSERT**ï¼šä½¿ç”¨DuckDBçš„`register`+`INSERT INTO ... SELECT FROM`
2. **ä¼˜åŒ–ç´¢å¼•**ï¼šç§»é™¤é‡å¤ç´¢å¼•ï¼Œåªä¿ç•™å¿…è¦ç´¢å¼•
3. **è‡ªé€‚åº”æ‰¹é‡**ï¼šæ ¹æ®æ•°æ®é‡é€‰æ‹©æœ€ä¼˜ç­–ç•¥

---

## âœ… éªŒè¯æ–¹æ³•

ä¼˜åŒ–åéªŒè¯æŒ‡æ ‡ï¼š
1. **å†™å…¥é€Ÿåº¦**ï¼šåº”è¾¾åˆ°5000+æ¡/ç§’
2. **5711æ¡è®°å½•è€—æ—¶**ï¼šåº”<2ç§’
3. **CPUä½¿ç”¨ç‡**ï¼šåº”é™ä½ï¼ˆå‡å°‘é€æ¡å¤„ç†å¼€é”€ï¼‰
4. **å†…å­˜ä½¿ç”¨**ï¼šåº”ç¨³å®šï¼ˆæ‰¹é‡å¤„ç†æ›´é«˜æ•ˆï¼‰

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. DuckDBå®˜æ–¹æ–‡æ¡£ï¼šæ‰¹é‡æ’å…¥æœ€ä½³å®è·µ
2. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–æŒ‡å—
3. ç´¢å¼•è®¾è®¡åŸåˆ™

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-01-XX
**åˆ†æäººå‘˜**ï¼šAI Assistant
**çŠ¶æ€**ï¼šå¾…å®æ–½ä¼˜åŒ–

