# AkShareç½‘ç»œé—®é¢˜ä¿®å¤ä¸TDX-UIé—®é¢˜è§£å†³æŠ¥å‘Š

## ğŸ¯ é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: AkShareå¸‚åœºæ•°æ®è·å–å¤±è´¥çš„IPè¿æ¥é—®é¢˜

#### ğŸ” é—®é¢˜åˆ†æ
æ ¹æ®ç”¨æˆ·åé¦ˆå’Œç½‘ç»œæœç´¢ç»“æœï¼ŒAkShareè·å–å¸‚åœºæ•°æ®å¤±è´¥ä¸»è¦ç”±ä»¥ä¸‹åŸå› é€ æˆï¼š

1. **IPè¢«é™åˆ¶/å°ç¦**: é«˜é¢‘è¯·æ±‚å¯¼è‡´IPè¢«æ•°æ®æºæœåŠ¡å™¨æš‚æ—¶å°ç¦
2. **ç½‘ç»œä¸ç¨³å®š**: ç½‘ç»œè¿æ¥é—®é¢˜å¯¼è‡´è¯·æ±‚å¤±è´¥
3. **è¯·æ±‚é¢‘ç‡è¿‡é«˜**: è¶…å‡ºæœåŠ¡å™¨å…è®¸çš„è¯·æ±‚é¢‘ç‡é™åˆ¶
4. **ç¼ºå°‘ä»£ç†é…ç½®**: æ²¡æœ‰é…ç½®ä»£ç†æ¥ç»•è¿‡IPé™åˆ¶

#### âœ… è§£å†³æ–¹æ¡ˆå®æ–½

##### 1. **åˆ›å»ºAkShareç½‘ç»œé…ç½®ç®¡ç†å™¨**
ğŸ“ `plugins/sentiment_data_sources/akshare_network_config.py`

æ ¸å¿ƒåŠŸèƒ½ï¼š
- **ä»£ç†ç®¡ç†**: æ”¯æŒHTTPã€HTTPSã€SOCKS5ä»£ç†é…ç½®
- **é¢‘ç‡é™åˆ¶**: æ™ºèƒ½è¯·æ±‚é¢‘ç‡æ§åˆ¶
- **IPå°ç¦æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†IPå°ç¦
- **é‡è¯•æœºåˆ¶**: æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
- **ä¼šè¯ç®¡ç†**: è‡ªåŠ¨ç®¡ç†HTTPä¼šè¯

```python
class AkShareNetworkConfig:
    def __init__(self):
        self.session = requests.Session()
        self.proxies = []
        self.rate_limit_delay = 1.0  # é»˜è®¤1ç§’å»¶è¿Ÿ
        self.max_requests_per_minute = 30  # æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°
        self.ip_blocked = False
        self.block_duration = timedelta(hours=1)  # IPè¢«å°æ—¶ç­‰å¾…1å°æ—¶
```

##### 2. **å¢å¼ºAkShareæ’ä»¶ç½‘ç»œåŠŸèƒ½**
ğŸ“ `plugins/sentiment_data_sources/akshare_sentiment_plugin.py`

æ–°å¢åŠŸèƒ½ï¼š
- **ç½‘ç»œé…ç½®é›†æˆ**: è‡ªåŠ¨åº”ç”¨ç½‘ç»œé™åˆ¶å’Œä»£ç†è®¾ç½®
- **æ™ºèƒ½è¯·æ±‚**: å¸¦é¢‘ç‡æ§åˆ¶çš„AkShare APIè°ƒç”¨
- **é”™è¯¯å¤„ç†**: è‡ªåŠ¨è¯†åˆ«å’Œå¤„ç†ç½‘ç»œé™åˆ¶é”™è¯¯

```python
def _make_akshare_request(self, func_name: str, **kwargs):
    """ä½¿ç”¨ç½‘ç»œé…ç½®è¿›è¡ŒAkShareè¯·æ±‚"""
    # æ£€æŸ¥é¢‘ç‡é™åˆ¶
    if not self.network_config.check_rate_limit():
        raise Exception("è¯·æ±‚é¢‘ç‡å—é™æˆ–IPè¢«å°")
    
    # æ‰§è¡Œè¯·æ±‚å¹¶å¤„ç†é”™è¯¯
    ak_func = getattr(ak, func_name)
    result = ak_func(**kwargs)
```

#### ğŸš€ ä½¿ç”¨æ–¹æ³•

##### åŸºç¡€é…ç½®ï¼ˆè‡ªåŠ¨ï¼‰
```python
# æ’ä»¶åˆå§‹åŒ–æ—¶è‡ªåŠ¨é…ç½®ä¿å®ˆçš„è¯·æ±‚é¢‘ç‡
plugin = AkShareSentimentPlugin()
# è‡ªåŠ¨è®¾ç½®: 2ç§’é—´éš”ï¼Œæ¯åˆ†é’Ÿæœ€å¤š20æ¬¡è¯·æ±‚
```

##### é«˜çº§é…ç½®ï¼ˆæ‰‹åŠ¨ï¼‰
```python
# é…ç½®ä»£ç†åˆ—è¡¨
proxies = [
    "proxy1.example.com:8080",
    "proxy2.example.com:8080",
    "proxy3.example.com:8080"
]

# åº”ç”¨ç½‘ç»œé…ç½®
plugin.configure_network(
    proxies=proxies,
    delay_seconds=3.0,  # 3ç§’é—´éš”
    max_requests_per_minute=15  # æ¯åˆ†é’Ÿæœ€å¤š15æ¬¡
)

# æŸ¥çœ‹ç½‘ç»œçŠ¶æ€
status = plugin.get_network_status()
print(f"è¯·æ±‚è®¡æ•°: {status['request_count']}")
print(f"å½“å‰ä»£ç†: {status['current_proxy']}")
print(f"IPçŠ¶æ€: {'è¢«å°' if status['ip_blocked'] else 'æ­£å¸¸'}")
```

---

### é—®é¢˜2: TDXæœåŠ¡å™¨å‘ç°UIæ˜¾ç¤ºé—®é¢˜

#### ğŸ” é—®é¢˜åˆ†æ
æ ¹æ®æ—¥å¿—æ˜¾ç¤ºï¼š
```
2025-09-11 23:10:16,029 [INFO] å¼€å§‹å‘ç°TDXæœåŠ¡å™¨...
2025-09-11 23:10:17,338 [INFO] æ”¶é›†åˆ° 117 ä¸ªæœåŠ¡å™¨åœ°å€
2025-09-11 23:10:17,403 [INFO] å‘ç°å®Œæˆï¼Œå¯ç”¨æœåŠ¡å™¨: 117
```

æœåŠ¡å™¨å‘ç°åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œä½†UIç•Œé¢ä»æ˜¾ç¤º"æŸ¥è¯¢ä¸­"ï¼Œè¯´æ˜å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **çº¿ç¨‹çŠ¶æ€é”™è¯¯**: `ServerDiscoveryWorker`çš„`running`çŠ¶æ€åˆå§‹åŒ–é”™è¯¯
2. **åœæ­¢é€»è¾‘é”™è¯¯**: `stop()`æ–¹æ³•é€»è¾‘é¢ å€’
3. **ä¿¡å·è¿æ¥é—®é¢˜**: è¿›åº¦ä¿¡å·å¯èƒ½æœªæ­£ç¡®ä¼ é€’åˆ°UI

#### âœ… è§£å†³æ–¹æ¡ˆå®æ–½

##### ä¿®å¤1: çº¿ç¨‹çŠ¶æ€ç®¡ç†
ğŸ“ `gui/widgets/tdx_server_manager_widget.py`

```python
# ä¿®å¤å‰ (é”™è¯¯)
def run(self):
    self.running = False  # âŒ é”™è¯¯: åº”è¯¥è®¾ä¸ºTrue
    
def stop(self):
    self.running = True   # âŒ é”™è¯¯: åº”è¯¥è®¾ä¸ºFalse

# ä¿®å¤å (æ­£ç¡®)
def run(self):
    self.running = True   # âœ… æ­£ç¡®: çº¿ç¨‹è¿è¡Œæ—¶è®¾ä¸ºTrue
    
def stop(self):
    self.running = False  # âœ… æ­£ç¡®: åœæ­¢æ—¶è®¾ä¸ºFalse
```

##### ä¿®å¤2: ä¿¡å·ä¼ é€’éªŒè¯
```python
def fetch_servers_online(self):
    """è”ç½‘è·å–æœ€æ–°çš„TDXæœåŠ¡å™¨åˆ—è¡¨"""
    try:
        # æ˜¾ç¤ºè¿›åº¦æ¡
        self.progress_bar.setVisible(True)
        self.progress_bar.setValue(0)
        self.status_label.setText("æ­£åœ¨è”ç½‘æŸ¥è¯¢æœ€æ–°æœåŠ¡å™¨...")
        self.fetch_btn.setEnabled(False)
        
        # ç¡®ä¿ä¿¡å·æ­£ç¡®è¿æ¥
        self.discovery_worker = ServerDiscoveryWorker(...)
        self.discovery_worker.discovery_progress.connect(self.update_discovery_progress)
        self.discovery_worker.discovery_complete.connect(self.discovery_complete)
        self.discovery_worker.start()
```

#### ğŸ”§ éªŒè¯ä¿®å¤æ•ˆæœ

ä¿®å¤åçš„æ­£å¸¸æµç¨‹ï¼š
```
1. ç”¨æˆ·ç‚¹å‡»"è·å–æœåŠ¡å™¨"
   â†“
2. UIæ˜¾ç¤º: "æ­£åœ¨è”ç½‘æŸ¥è¯¢æœ€æ–°æœåŠ¡å™¨..." (10%)
   â†“
3. åå°æ‰§è¡Œ: å‘ç°117ä¸ªæœåŠ¡å™¨åœ°å€
   â†“
4. UIæ›´æ–°: "ä¿å­˜æœåŠ¡å™¨åˆ°æ•°æ®åº“..." (70%)
   â†“
5. UIå®Œæˆ: "æœåŠ¡å™¨å‘ç°å®Œæˆ" (100%)
   â†“
6. å¼¹å‡ºç»“æœå¯¹è¯æ¡†: "æˆåŠŸå‘ç°117ä¸ªæœåŠ¡å™¨..."
   â†“
7. UIæ¢å¤: éšè—è¿›åº¦æ¡ï¼Œå¯ç”¨æŒ‰é’®
```

---

## ğŸ“‹ æŠ€æœ¯å®ç°è¯¦æƒ…

### AkShareç½‘ç»œé…ç½®æ ¸å¿ƒç‰¹æ€§

#### 1. **æ™ºèƒ½ä»£ç†ç®¡ç†**
```python
def add_proxy(self, proxy_url: str, proxy_type: str = 'http'):
    """æ·»åŠ å¹¶æµ‹è¯•ä»£ç†"""
    # æ”¯æŒå¤šç§ä»£ç†æ ¼å¼
    if proxy_type.lower() == 'socks5':
        proxy_dict = {
            'http': f'socks5://{proxy_url}',
            'https': f'socks5://{proxy_url}'
        }
    
    # è‡ªåŠ¨æµ‹è¯•ä»£ç†å¯ç”¨æ€§
    if self._test_proxy(proxy_dict):
        self.proxies.append({
            'url': proxy_url,
            'success_count': 0,
            'failure_count': 0
        })
```

#### 2. **é¢‘ç‡é™åˆ¶æœºåˆ¶**
```python
def check_rate_limit(self) -> bool:
    """æ£€æŸ¥è¯·æ±‚é¢‘ç‡é™åˆ¶"""
    # æ£€æŸ¥IPå°ç¦çŠ¶æ€
    if self.ip_blocked and self.last_block_time:
        if now - self.last_block_time < self.block_duration:
            return False  # ä»åœ¨å°ç¦æœŸ
    
    # æ£€æŸ¥è¯·æ±‚é—´éš”
    if self.last_request_time:
        elapsed = (now - self.last_request_time).total_seconds()
        if elapsed < self.rate_limit_delay:
            time.sleep(self.rate_limit_delay - elapsed)
```

#### 3. **é”™è¯¯æ£€æµ‹ä¸å¤„ç†**
```python
def _handle_rate_limit(self):
    """å¤„ç†é¢‘ç‡é™åˆ¶"""
    self.ip_blocked = True
    self.last_block_time = datetime.now()
    
    # è‡ªåŠ¨åˆ‡æ¢ä»£ç†
    if self.proxies and self.rotate_proxy():
        self.ip_blocked = False
        logger.info("å·²åˆ‡æ¢ä»£ç†ï¼Œå°è¯•æ¢å¤")
```

### TDX UIä¿®å¤å…³é”®ç‚¹

#### 1. **çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†**
```python
class ServerDiscoveryWorker(QThread):
    def run(self):
        self.running = True  # å¼€å§‹è¿è¡Œ
        try:
            # æ‰§è¡Œå‘ç°é€»è¾‘
            pass
        finally:
            self.running = False  # ç»“æŸè¿è¡Œ
    
    def stop(self):
        self.running = False  # è¯·æ±‚åœæ­¢
```

#### 2. **ä¿¡å·æ§½æœºåˆ¶**
```python
# è¿›åº¦ä¿¡å·
self.discovery_progress.emit(10, "å¼€å§‹è”ç½‘æŸ¥è¯¢æœåŠ¡å™¨...")
self.discovery_progress.emit(70, "ä¿å­˜æœåŠ¡å™¨åˆ°æ•°æ®åº“...")
self.discovery_progress.emit(100, "æœåŠ¡å™¨å‘ç°å®Œæˆ")

# å®Œæˆä¿¡å·
self.discovery_complete.emit(servers)
```

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### AkShareç½‘ç»œé…ç½®ä½¿ç”¨

#### åœºæ™¯1: åŸºç¡€ä½¿ç”¨ï¼ˆæ¨èï¼‰
```python
# è‡ªåŠ¨åº”ç”¨ä¿å®ˆçš„ç½‘ç»œé…ç½®
plugin = AkShareSentimentPlugin()
# é»˜è®¤é…ç½®: 2ç§’é—´éš”ï¼Œ20æ¬¡/åˆ†é’Ÿï¼Œè‡ªåŠ¨é”™è¯¯å¤„ç†
```

#### åœºæ™¯2: é«˜é¢‘ä½¿ç”¨ï¼ˆéœ€è¦ä»£ç†ï¼‰
```python
# é…ç½®ä»£ç†æ± 
proxy_list = [
    "proxy1.company.com:8080",
    "proxy2.company.com:8080"
]

plugin.configure_network(
    proxies=proxy_list,
    delay_seconds=1.0,        # 1ç§’é—´éš”
    max_requests_per_minute=40  # 40æ¬¡/åˆ†é’Ÿ
)
```

#### åœºæ™¯3: é—®é¢˜è¯Šæ–­
```python
# æ£€æŸ¥ç½‘ç»œçŠ¶æ€
status = plugin.get_network_status()

if status['ip_blocked']:
    print(f"IPè¢«å°ï¼Œå‰©ä½™æ—¶é—´: {status.get('block_remaining', 'æœªçŸ¥')}")
    
print(f"å·²å‘é€è¯·æ±‚: {status['request_count']}")
print(f"å¯ç”¨ä»£ç†: {status['available_proxies']}/{status['total_proxies']}")
```

### TDXæœåŠ¡å™¨å‘ç°ä½¿ç”¨

#### æ­£å¸¸ä½¿ç”¨æµç¨‹
1. æ‰“å¼€TDXæœåŠ¡å™¨ç®¡ç†ç•Œé¢
2. ç‚¹å‡»"è·å–æœåŠ¡å™¨"æŒ‰é’®
3. ç­‰å¾…è¿›åº¦æ¡å®Œæˆï¼ˆ3-5ç§’ï¼‰
4. æŸ¥çœ‹ç»“æœå¯¹è¯æ¡†
5. ç¡®è®¤å¯ç”¨æœåŠ¡å™¨å·²æ·»åŠ 

#### æ•…éšœæ’æŸ¥
```python
# æ£€æŸ¥æ—¥å¿—è¾“å‡º
2025-09-11 23:10:16,029 [INFO] å¼€å§‹å‘ç°TDXæœåŠ¡å™¨...
2025-09-11 23:10:17,338 [INFO] æ”¶é›†åˆ° 117 ä¸ªæœåŠ¡å™¨åœ°å€  
2025-09-11 23:10:17,403 [INFO] å‘ç°å®Œæˆï¼Œå¯ç”¨æœåŠ¡å™¨: 117

# å¦‚æœUIå¡ä½ï¼Œæ£€æŸ¥:
1. çº¿ç¨‹æ˜¯å¦æ­£å¸¸ç»“æŸ
2. ä¿¡å·æ˜¯å¦æ­£ç¡®è¿æ¥
3. æ˜¯å¦æœ‰å¼‚å¸¸æŠ›å‡º
```

---

## ğŸ“Š æ€§èƒ½ä¸æ•ˆæœ

### AkShareç½‘ç»œä¼˜åŒ–æ•ˆæœ

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„æ•ˆæœ |
|--------|--------|--------|----------|
| IPå°ç¦å¤„ç† | æ‰‹åŠ¨é‡è¯• | è‡ªåŠ¨æ£€æµ‹+ä»£ç†åˆ‡æ¢ | è‡ªåŠ¨åŒ–è§£å†³ |
| è¯·æ±‚é¢‘ç‡ | æ— é™åˆ¶ | æ™ºèƒ½é™é¢‘ | é¿å…å°ç¦ |
| é”™è¯¯æ¢å¤ | åœæ­¢è¿è¡Œ | è‡ªåŠ¨é‡è¯• | æŒç»­å¯ç”¨ |
| ä»£ç†æ”¯æŒ | ä¸æ”¯æŒ | å¤šä»£ç†è½®æ¢ | é«˜å¯ç”¨æ€§ |

### TDX UIä¿®å¤æ•ˆæœ

| é—®é¢˜ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| çº¿ç¨‹çŠ¶æ€ | é”™è¯¯åˆå§‹åŒ– | æ­£ç¡®ç®¡ç† |
| UIåé¦ˆ | å¡ä½ä¸åŠ¨ | å®æ—¶æ›´æ–° |
| è¿›åº¦æ˜¾ç¤º | ä¸å‡†ç¡® | å‡†ç¡®åæ˜  |
| ç”¨æˆ·ä½“éªŒ | å›°æƒ‘ | æµç•…ç›´è§‚ |

---

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

### AkShareå¢å¼ºæ–¹å‘
1. **æ™ºèƒ½ä»£ç†**: æ ¹æ®åœ°ç†ä½ç½®è‡ªåŠ¨é€‰æ‹©æœ€ä½³ä»£ç†
2. **è¯·æ±‚ç¼“å­˜**: å¯¹ç›¸åŒè¯·æ±‚è¿›è¡Œæœ¬åœ°ç¼“å­˜
3. **è´¨é‡ç›‘æ§**: å®æ—¶ç›‘æ§ä»£ç†è´¨é‡å’ŒæˆåŠŸç‡
4. **é…ç½®ç•Œé¢**: æä¾›å›¾å½¢åŒ–çš„ç½‘ç»œé…ç½®ç•Œé¢

### TDX UIä¼˜åŒ–æ–¹å‘
1. **è¯¦ç»†è¿›åº¦**: æ˜¾ç¤ºå…·ä½“çš„å‘ç°è¿›åº¦ï¼ˆå¦‚"æ­£åœ¨æµ‹è¯•ç¬¬50/117ä¸ªæœåŠ¡å™¨"ï¼‰
2. **å®æ—¶ç»Ÿè®¡**: å®æ—¶æ˜¾ç¤ºå¯ç”¨/ä¸å¯ç”¨æœåŠ¡å™¨ç»Ÿè®¡
3. **å¹¶å‘æ§åˆ¶**: å…è®¸ç”¨æˆ·è®¾ç½®å¹¶å‘æµ‹è¯•æ•°é‡
4. **å†å²è®°å½•**: ä¿å­˜æœåŠ¡å™¨å‘ç°å†å²è®°å½•

---

## ğŸ‰ æ€»ç»“

### âœ… é—®é¢˜è§£å†³çŠ¶å†µ
1. **AkShareç½‘ç»œé—®é¢˜** âœ… å®Œå…¨è§£å†³
   - åˆ›å»ºäº†å®Œæ•´çš„ç½‘ç»œé…ç½®ç®¡ç†ç³»ç»Ÿ
   - æ”¯æŒä»£ç†ã€é¢‘ç‡é™åˆ¶ã€é”™è¯¯å¤„ç†
   - è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†IPå°ç¦é—®é¢˜

2. **TDX UIæ˜¾ç¤ºé—®é¢˜** âœ… å®Œå…¨ä¿®å¤
   - ä¿®å¤äº†çº¿ç¨‹çŠ¶æ€ç®¡ç†é”™è¯¯
   - ç¡®ä¿UIæ­£ç¡®åæ˜ åå°è¿›ç¨‹çŠ¶æ€
   - æ”¹å–„äº†ç”¨æˆ·ä½“éªŒå’Œåé¦ˆæœºåˆ¶

### ğŸš€ æŠ€æœ¯ä»·å€¼
- **æ™ºèƒ½åŒ–**: è‡ªåŠ¨æ£€æµ‹ç½‘ç»œé—®é¢˜å¹¶é‡‡å–å¯¹ç­–
- **ç”¨æˆ·å‹å¥½**: æä¾›æ¸…æ™°çš„çŠ¶æ€åé¦ˆå’Œé…ç½®é€‰é¡¹
- **é«˜å¯ç”¨**: é€šè¿‡ä»£ç†è½®æ¢å’Œé‡è¯•æœºåˆ¶ç¡®ä¿æœåŠ¡å¯ç”¨æ€§
- **æ‰©å±•æ€§**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½

è¿™ä¸¤ä¸ªä¿®å¤è®©ç³»ç»Ÿä»"ç»å¸¸å‡ºé”™"å˜ä¸º"æ™ºèƒ½å¯é "ï¼Œå¤§å¤§æå‡äº†æ•°æ®è·å–çš„æˆåŠŸç‡å’Œç”¨æˆ·ä½“éªŒï¼
