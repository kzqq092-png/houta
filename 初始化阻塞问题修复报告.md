# åˆå§‹åŒ–é˜»å¡é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ” é—®é¢˜ç°è±¡

ç”¨æˆ·åé¦ˆï¼š**ä»»åŠ¡å¯åŠ¨äº†ä½†åœåœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œæ²¡æœ‰çœŸæ­£çš„æ•°æ®å¯¼å…¥**

ä»æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼š
- âœ… ä»»åŠ¡æˆåŠŸå¯åŠ¨ï¼š`ğŸš€ å¼‚æ­¥å¯¼å…¥ä»»åŠ¡å¯åŠ¨: 0c124224-b228-44b6-846a-924389fd42dd`
- âŒ åœåœ¨åˆå§‹åŒ–ï¼š`è¿›åº¦æ›´æ–°: 0% - åˆå§‹åŒ–æ•°æ®å¯¼å…¥...`

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

é€šè¿‡æ·±å…¥åˆ†æå¼‚æ­¥å¯¼å…¥å·¥ä½œçº¿ç¨‹çš„æ‰§è¡Œæµç¨‹ï¼Œå‘ç°é—®é¢˜å‡ºç°åœ¨ `DataImportExecutionEngine` çš„åˆå§‹åŒ–é˜¶æ®µï¼š

### é—®é¢˜è°ƒç”¨é“¾
```
AsyncDataImportWorker.run()
â†“
_initialize_import_engine()
â†“
DataImportExecutionEngine(config_manager)
â†“
UnifiedDataManager()  â† é˜»å¡ç‚¹
â†“
_init_duckdb_integration()  â† å¯èƒ½çš„é˜»å¡æº
```

### æ ¹æœ¬åŸå› ï¼šUnifiedDataManager åˆå§‹åŒ–é˜»å¡ âŒ

**é—®é¢˜ä½ç½®**: `core/importdata/import_execution_engine.py:84`

```python
# åŸå§‹ä»£ç  - å¼ºåˆ¶åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨
self.data_manager = data_manager or UnifiedDataManager()
```

**é˜»å¡åŸå› **:
1. `UnifiedDataManager()` æ„é€ å‡½æ•°æ‰§è¡Œå¤§é‡åˆå§‹åŒ–æ“ä½œ
2. åŒ…æ‹¬ DuckDB é›†æˆã€TET æ•°æ®ç®¡é“ã€å¤šæ•°æ®æºåˆå§‹åŒ–ç­‰
3. è¿™äº›æ“ä½œå¯èƒ½æ¶‰åŠæ–‡ä»¶I/Oã€æ•°æ®åº“è¿æ¥ã€æ¨¡å—å¯¼å…¥ç­‰è€—æ—¶æ“ä½œ
4. åœ¨å¼‚æ­¥å·¥ä½œçº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡Œè¿™äº›æ“ä½œä¼šå¯¼è‡´é˜»å¡

**å…·ä½“é˜»å¡ç‚¹**:
```python
# UnifiedDataManager.__init__() ä¸­çš„æ½œåœ¨é˜»å¡æ“ä½œ
self._init_duckdb_integration()  # DuckDB æ¨¡å—å¯¼å…¥å’Œåˆå§‹åŒ–
self._initialize_data_sources()  # å¤šæ•°æ®æºåˆå§‹åŒ–
# TET æ•°æ®ç®¡é“åˆå§‹åŒ–
# æ•°æ®åº“è¿æ¥å»ºç«‹
# è¡Œä¸šç®¡ç†å™¨åˆå§‹åŒ–
```

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. å»¶è¿Ÿåˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨ âœ…

#### ä¿®æ”¹å¼‚æ­¥å¯¼å…¥ç®¡ç†å™¨
```python
# core/services/async_data_import_manager.py
def _initialize_import_engine(self):
    # å°è¯•ä»æœåŠ¡å®¹å™¨è·å–æ•°æ®ç®¡ç†å™¨ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
    data_manager = None
    try:
        from core.containers import get_service_container
        from core.services.unified_data_manager import UnifiedDataManager
        
        service_container = get_service_container()
        if service_container.is_registered(UnifiedDataManager):
            data_manager = service_container.resolve(UnifiedDataManager)
            logger.info("âœ… ä½¿ç”¨æœåŠ¡å®¹å™¨ä¸­çš„æ•°æ®ç®¡ç†å™¨")
        else:
            logger.info("âš ï¸ æœåŠ¡å®¹å™¨ä¸­æœªæ‰¾åˆ°æ•°æ®ç®¡ç†å™¨ï¼Œå°†å»¶è¿Ÿåˆå§‹åŒ–")
    except Exception as e:
        logger.warning(f"âš ï¸ è·å–æ•°æ®ç®¡ç†å™¨å¤±è´¥: {e}")
    
    self._import_engine = DataImportExecutionEngine(self._config_manager, data_manager)
```

#### ä¿®æ”¹æ‰§è¡Œå¼•æ“æ„é€ å‡½æ•°
```python
# core/importdata/import_execution_engine.py
def __init__(self, config_manager: ImportConfigManager = None,
             data_manager: UnifiedDataManager = None,
             max_workers: int = 4):
    # æ•°æ®ç®¡ç†å™¨ - å»¶è¿Ÿåˆå§‹åŒ–ä»¥é¿å…é˜»å¡
    self.data_manager = data_manager
    self._data_manager_initialized = data_manager is not None
    
    # ... å…¶ä»–åˆå§‹åŒ–ä»£ç  ...
```

### 2. æ·»åŠ å»¶è¿Ÿåˆå§‹åŒ–æ–¹æ³• âœ…

```python
def _ensure_data_manager(self):
    """ç¡®ä¿æ•°æ®ç®¡ç†å™¨å·²åˆå§‹åŒ–"""
    if not self._data_manager_initialized:
        try:
            logger.info("ğŸ”„ å»¶è¿Ÿåˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨...")
            self.data_manager = UnifiedDataManager()
            self._data_manager_initialized = True
            logger.info("âœ… æ•°æ®ç®¡ç†å™¨å»¶è¿Ÿåˆå§‹åŒ–å®Œæˆ")
        except Exception as e:
            logger.error(f"âŒ æ•°æ®ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: {e}")
            # åˆ›å»ºä¸€ä¸ªæœ€å°çš„æ•°æ®ç®¡ç†å™¨æ›¿ä»£
            self.data_manager = None
            self._data_manager_initialized = False
```

### 3. åœ¨éœ€è¦æ—¶æ‰åˆå§‹åŒ– âœ…

```python
def _import_kline_data(self, task_config: ImportTaskConfig, result: TaskExecutionResult):
    """å¯¼å…¥Kçº¿æ•°æ®"""
    try:
        # ç¡®ä¿æ•°æ®ç®¡ç†å™¨å·²åˆå§‹åŒ–
        self._ensure_data_manager()
        
        # ... æ•°æ®å¯¼å…¥é€»è¾‘ ...
```

## âœ… ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰çš„é—®é¢˜
- âŒ å¼‚æ­¥å·¥ä½œçº¿ç¨‹åœ¨åˆå§‹åŒ–é˜¶æ®µé˜»å¡
- âŒ `UnifiedDataManager` å¼ºåˆ¶åŒæ­¥åˆå§‹åŒ–
- âŒ å¤§é‡åˆå§‹åŒ–æ“ä½œåœ¨å·¥ä½œçº¿ç¨‹ä¸­æ‰§è¡Œ
- âŒ ä»»åŠ¡å¯åŠ¨åæ— æ³•ç»§ç»­æ‰§è¡Œ

### ä¿®å¤åçš„æ•ˆæœ
- âœ… **å¿«é€Ÿå¯åŠ¨**: å¼‚æ­¥å·¥ä½œçº¿ç¨‹å¿«é€Ÿé€šè¿‡åˆå§‹åŒ–é˜¶æ®µ
- âœ… **å»¶è¿Ÿåˆå§‹åŒ–**: æ•°æ®ç®¡ç†å™¨åœ¨çœŸæ­£éœ€è¦æ—¶æ‰åˆå§‹åŒ–
- âœ… **æœåŠ¡å¤ç”¨**: ä¼˜å…ˆä½¿ç”¨æœåŠ¡å®¹å™¨ä¸­å·²åˆå§‹åŒ–çš„æ•°æ®ç®¡ç†å™¨
- âœ… **å®¹é”™å¤„ç†**: åˆå§‹åŒ–å¤±è´¥æ—¶æœ‰é™çº§æ–¹æ¡ˆ
- âœ… **éé˜»å¡**: é¿å…åœ¨å·¥ä½œçº¿ç¨‹ä¸­æ‰§è¡Œè€—æ—¶çš„åŒæ­¥æ“ä½œ

## ğŸ¯ é¢„æœŸçš„å®Œæ•´æ—¥å¿—æµç¨‹

ä¿®å¤åï¼Œç”¨æˆ·åº”è¯¥çœ‹åˆ°ä»¥ä¸‹å®Œæ•´çš„æ‰§è¡Œæ—¥å¿—ï¼š

```
[INFO] ğŸš€ å¼‚æ­¥å¯¼å…¥ä»»åŠ¡å¯åŠ¨: xxx
[INFO] åˆå§‹åŒ–å¯¼å…¥å¼•æ“...
[INFO] âš ï¸ æœåŠ¡å®¹å™¨ä¸­æœªæ‰¾åˆ°æ•°æ®ç®¡ç†å™¨ï¼Œå°†å»¶è¿Ÿåˆå§‹åŒ–
[INFO] å¯¼å…¥å¼•æ“åˆå§‹åŒ–å®Œæˆ
[INFO] ğŸ“Š å¼€å§‹å¤„ç†æ•°æ®æºï¼Œæ€»æ•°: 1, æ•°æ®æºåˆ—è¡¨: ['default']
[INFO] ğŸ”„ å¼€å§‹å¤„ç†æ•°æ®æº 1/1: default
[INFO] âœ… ä»»åŠ¡é…ç½®å·²æ·»åŠ åˆ°é…ç½®ç®¡ç†å™¨: async_import_default_xxx
[INFO] ğŸš€ å°è¯•å¯åŠ¨å¯¼å…¥ä»»åŠ¡: async_import_default_xxx
[INFO] ğŸ” å¼€å§‹å¯åŠ¨ä»»åŠ¡: async_import_default_xxx
[INFO] âœ… æ‰¾åˆ°ä»»åŠ¡é…ç½®: å¼‚æ­¥å¯¼å…¥_default, è‚¡ç¥¨ä»£ç : ['000001']
[INFO] ğŸ“Š ä»»åŠ¡å¯åŠ¨ç»“æœ: True
[INFO] ğŸš€ å¼€å§‹æ‰§è¡Œä»»åŠ¡: async_import_default_xxx
[INFO] ğŸ“Š ä»»åŠ¡è¯¦æƒ…: æ•°æ®ç±»å‹=Kçº¿æ•°æ®, è‚¡ç¥¨=['000001']
[INFO] ğŸ”„ æ‰§è¡Œæ•°æ®ç±»å‹: Kçº¿æ•°æ®
[INFO] ğŸ“ˆ å¼€å§‹å¯¼å…¥Kçº¿æ•°æ®
[INFO] ğŸ”„ å»¶è¿Ÿåˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨...
[INFO] âœ… æ•°æ®ç®¡ç†å™¨å»¶è¿Ÿåˆå§‹åŒ–å®Œæˆ
[INFO] ğŸ“ˆ å¼€å§‹å¯¼å…¥Kçº¿æ•°æ®ï¼Œè‚¡ç¥¨åˆ—è¡¨: ['000001']
[INFO] ğŸ“… æ—¶é—´èŒƒå›´: 2025-08-22 åˆ° 2025-08-29
[INFO] ğŸ“Š é¢‘ç‡: DataFrequency.DAILY
[INFO] ğŸ”„ æ­£åœ¨è·å– 000001 çš„Kçº¿æ•°æ®...
[INFO] ğŸ“Š è·å–åˆ° 000001 æ•°æ®: X æ¡è®°å½•
[INFO] æˆåŠŸå¯¼å…¥å¹¶ä¿å­˜ 000001 çš„Kçº¿æ•°æ®: X æ¡è®°å½•
[INFO] ä»»åŠ¡æ‰§è¡Œå®Œæˆ: async_import_default_xxx
```

## ğŸ“Š æŠ€æœ¯æ¶æ„æ”¹è¿›

### åˆå§‹åŒ–ç­–ç•¥
```
å¿«é€Ÿå¯åŠ¨ â†’ å»¶è¿Ÿåˆå§‹åŒ– â†’ æŒ‰éœ€åŠ è½½
```

### æ•°æ®ç®¡ç†å™¨è·å–ä¼˜å…ˆçº§
1. **æœåŠ¡å®¹å™¨ä¸­çš„å®ä¾‹** (æœ€é«˜ä¼˜å…ˆçº§)
2. **å»¶è¿Ÿåˆå§‹åŒ–æ–°å®ä¾‹** (ä¸­ç­‰ä¼˜å…ˆçº§)  
3. **é™çº§åˆ° None** (æœ€ä½ä¼˜å…ˆçº§ï¼Œå®¹é”™)

### å…³é”®æ”¹è¿›ç‚¹
1. **éé˜»å¡å¯åŠ¨**: å¼‚æ­¥å·¥ä½œçº¿ç¨‹å¿«é€Ÿå¯åŠ¨
2. **èµ„æºå¤ç”¨**: ä¼˜å…ˆä½¿ç”¨å·²åˆå§‹åŒ–çš„æœåŠ¡
3. **æŒ‰éœ€åŠ è½½**: åªåœ¨çœŸæ­£éœ€è¦æ—¶åˆå§‹åŒ–é‡é‡çº§ç»„ä»¶
4. **å®¹é”™æœºåˆ¶**: åˆå§‹åŒ–å¤±è´¥æ—¶æœ‰é™çº§æ–¹æ¡ˆ

## ğŸ”§ ä¿®å¤çš„æ–‡ä»¶

1. **core/services/async_data_import_manager.py**
   - ä¿®æ”¹ `_initialize_import_engine()` æ–¹æ³•
   - æ·»åŠ æœåŠ¡å®¹å™¨æ•°æ®ç®¡ç†å™¨è·å–é€»è¾‘
   - æ”¯æŒå»¶è¿Ÿåˆå§‹åŒ–

2. **core/importdata/import_execution_engine.py**
   - ä¿®æ”¹æ„é€ å‡½æ•°æ”¯æŒå¯é€‰æ•°æ®ç®¡ç†å™¨
   - æ·»åŠ  `_ensure_data_manager()` å»¶è¿Ÿåˆå§‹åŒ–æ–¹æ³•
   - åœ¨ `_import_kline_data()` ä¸­è°ƒç”¨å»¶è¿Ÿåˆå§‹åŒ–

## ğŸ‰ æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†å¼‚æ­¥å¯¼å…¥ä»»åŠ¡åœ¨åˆå§‹åŒ–é˜¶æ®µé˜»å¡çš„é—®é¢˜ï¼š

1. **æ¶æ„ä¼˜åŒ–**: ä»å¼ºåˆ¶åŒæ­¥åˆå§‹åŒ–æ”¹ä¸ºå»¶è¿ŸæŒ‰éœ€åˆå§‹åŒ–
2. **æ€§èƒ½æå‡**: å¼‚æ­¥å·¥ä½œçº¿ç¨‹å¿«é€Ÿå¯åŠ¨ï¼Œé¿å…é˜»å¡
3. **èµ„æºç®¡ç†**: ä¼˜åŒ–æ•°æ®ç®¡ç†å™¨çš„åˆ›å»ºå’Œå¤ç”¨
4. **å®¹é”™å¢å¼º**: æ·»åŠ åˆå§‹åŒ–å¤±è´¥çš„é™çº§å¤„ç†

ç°åœ¨ä»»åŠ¡åº”è¯¥èƒ½å¤Ÿï¼š
- å¿«é€Ÿé€šè¿‡åˆå§‹åŒ–é˜¶æ®µ
- æ­£å¸¸æ‰§è¡Œæ•°æ®å¯¼å…¥é€»è¾‘
- æ˜¾ç¤ºå®Œæ•´çš„æ‰§è¡Œè¿‡ç¨‹æ—¥å¿—
- çœŸæ­£ä¸‹è½½å’Œä¿å­˜æ•°æ®

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œæ•°æ®å¯¼å…¥åŠŸèƒ½åº”è¯¥èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œä¸å†åœç•™åœ¨åˆå§‹åŒ–é˜¶æ®µã€‚ 