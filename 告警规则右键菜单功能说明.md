# 告警规则右键菜单功能说明

## 功能概述

告警规则配置界面已经进行了重要改进，将原来的工具栏按钮操作迁移到了更直观的右键菜单中。这样可以节省界面空间，提供更好的用户体验。

## 功能变更

### 已移除
- ❌ 原有的工具栏按钮：
  - `➕ 添加规则`
  - `✏️ 编辑规则`
  - `🗑️ 删除规则`

### 新增功能
- ✅ 智能右键菜单：
  - 根据选中状态动态显示可用操作
  - 提供更多便捷功能

## 使用方法

### 1. 添加规则
- **操作**: 在告警规则列表的空白区域右键点击
- **菜单**: 显示 `➕ 添加规则` 选项
- **功能**: 打开告警规则编辑对话框，创建新规则

### 2. 编辑规则
- **操作**: 在现有规则上右键点击
- **菜单**: 显示 `✏️ 编辑规则` 选项
- **功能**: 打开告警规则编辑对话框，修改现有规则

### 3. 复制规则
- **操作**: 在现有规则上右键点击
- **菜单**: 显示 `📋 复制规则` 选项
- **功能**: 基于现有规则创建副本，自动添加"副本"后缀

### 4. 启用/禁用规则
- **操作**: 在现有规则上右键点击
- **菜单**: 根据当前状态显示：
  - `⏸️ 禁用规则` (当前为启用状态)
  - `▶️ 启用规则` (当前为禁用状态)
- **功能**: 快速切换规则的启用/禁用状态

### 5. 删除规则
- **操作**: 在现有规则上右键点击
- **菜单**: 显示 `🗑️ 删除规则` 选项
- **功能**: 删除选中的规则（需要确认）

## 菜单结构

### 空白区域右键菜单
```
┌─────────────────┐
│ ➕ 添加规则     │
└─────────────────┘
```

### 规则项右键菜单
```
┌─────────────────┐
│ ➕ 添加规则     │
├─────────────────┤
│ ✏️ 编辑规则     │
│ 📋 复制规则     │
├─────────────────┤
│ ⏸️ 禁用规则     │  (或 ▶️ 启用规则)
├─────────────────┤
│ 🗑️ 删除规则     │
└─────────────────┘
```

## 技术实现

### 核心代码修改

1. **启用右键菜单**
```python
self.rules_tree.setContextMenuPolicy(Qt.CustomContextMenu)
self.rules_tree.customContextMenuRequested.connect(self.show_rules_context_menu)
```

2. **动态菜单生成**
```python
def show_rules_context_menu(self, position):
    # 获取点击位置的项目
    item = self.rules_tree.itemAt(position)
    
    # 创建上下文菜单
    context_menu = QMenu(self)
    
    # 根据是否选中项目显示不同选项
    if item:
        # 显示完整菜单
    else:
        # 只显示添加选项
```

3. **新增功能方法**
- `copy_alert_rule()`: 复制规则功能
- `toggle_rule_status()`: 切换规则状态功能

### 数据库操作

所有操作都会同步更新到数据库：
- 新增规则 → 保存到 `alert_rules` 表
- 编辑规则 → 更新数据库记录
- 复制规则 → 创建新的数据库记录
- 状态切换 → 更新 `enabled` 字段
- 删除规则 → 从数据库删除记录

## 优势特点

1. **界面简洁**: 移除了工具栏按钮，节省界面空间
2. **操作直观**: 右键点击即可快速访问相关操作
3. **智能菜单**: 根据选中状态动态显示可用操作
4. **功能完整**: 保留原有功能，新增复制和状态切换
5. **数据安全**: 所有操作都有数据库支持，支持恢复

## 注意事项

1. **数据库依赖**: 确保告警配置数据库 (`alert_config.db`) 正常可用
2. **权限确认**: 删除操作需要用户确认，防止误操作
3. **状态同步**: 规则状态变更会立即同步到数据库和UI显示
4. **错误处理**: 所有操作都有完善的错误处理和用户提示

## 测试建议

1. 在空白区域右键，验证只显示"添加规则"选项
2. 在现有规则上右键，验证显示完整菜单
3. 测试添加、编辑、复制功能的对话框是否正常打开
4. 测试启用/禁用状态切换是否正确
5. 测试删除功能的确认对话框和数据库删除

通过这些改进，告警规则配置界面变得更加直观和高效，用户可以通过简单的右键操作完成所有规则管理任务。 