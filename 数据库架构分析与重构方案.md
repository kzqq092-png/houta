# HIkyuu-UI 数据库架构分析与重构方案

## 🔍 现有数据库分析

### 当前数据库文件清单

#### SQLite 数据库 (.db)
1. **factorweave_system.db** (2.9MB) - 系统配置和元数据
2. **strategies.db** (64KB) - 策略相关数据
3. **import_config.db** (72KB) - 导入配置
4. **metrics.db** (5.2GB) - 性能指标数据 ⚠️ **过大**
5. **hikyuu_system.db** (0B) - 空文件，可能废弃
6. **hikyuu_system.db.bakck** (764KB) - 备份文件
7. **factorweave_strategies.db** (64KB) - 策略数据（重复？）

#### DuckDB 数据库 (.duckdb)
1. **market_data.duckdb** (268KB) - 市场数据
2. **performance_metrics.duckdb** (268KB) - 性能指标
3. **backtest_results.duckdb** (268KB) - 回测结果
4. **analytics.duckdb** (268KB) - 分析数据
5. **factorweave_analytics.duckdb** (3.0MB) - 分析数据（重复？）
6. **analytics_factorweave_analytics.duckdb** (8.3MB) - 分析数据（重复？）
7. **kline_stock.duckdb** - K线数据（用户新建）

### 🚨 发现的问题

#### 1. 数据库文件过多且功能重叠
- **策略数据重复**: `strategies.db` 和 `factorweave_strategies.db`
- **分析数据重复**: `analytics.duckdb`, `factorweave_analytics.duckdb`, `analytics_factorweave_analytics.duckdb`
- **性能数据分散**: `metrics.db` (SQLite) 和 `performance_metrics.duckdb` (DuckDB)

#### 2. 文件命名不规范
- 混用 `.db` 和 `.duckdb` 后缀
- 命名不一致（如 `factorweave_` 前缀不统一）

#### 3. 数据存储技术选择不当
- **SQLite** 用于大数据量（如 5.2GB 的 metrics.db）- 性能差
- **DuckDB** 用于小配置数据 - 资源浪费

#### 4. 存储空间浪费
- 多个重复功能的数据库
- 空文件和备份文件占用空间

## 🎯 重构方案

### 核心原则
1. **按数据类型选择存储技术**
2. **统一命名规范**
3. **消除重复和冗余**
4. **优化性能和存储**

### 重构后的数据库架构

#### 方案A：双数据库架构（推荐）

```
db/
├── hikyuu_system.sqlite        # 系统配置和元数据（SQLite）
└── hikyuu_analytics.duckdb     # 所有分析数据（DuckDB）
```

**hikyuu_system.sqlite** - 轻量级配置数据
- 系统配置
- 用户设置
- 插件管理
- 导入配置
- 策略定义

**hikyuu_analytics.duckdb** - 高性能分析数据
- K线数据
- 市场数据
- 回测结果
- 性能指标
- 分析结果

#### 方案B：单数据库架构（简化版）

```
db/
└── hikyuu.duckdb              # 统一数据库（DuckDB）
```

**优势**: 最简化，只需要一个数据库
**劣势**: 配置数据也用DuckDB，可能过度设计

### 📊 数据迁移映射表

| 原数据库 | 目标数据库 | 数据类型 | 操作 |
|---------|-----------|---------|------|
| factorweave_system.db | hikyuu_system.sqlite | 系统配置 | 迁移 |
| import_config.db | hikyuu_system.sqlite | 导入配置 | 合并 |
| strategies.db | hikyuu_system.sqlite | 策略定义 | 迁移 |
| factorweave_strategies.db | - | 策略数据 | 删除（重复） |
| metrics.db | hikyuu_analytics.duckdb | 性能数据 | 迁移 |
| market_data.duckdb | hikyuu_analytics.duckdb | 市场数据 | 迁移 |
| performance_metrics.duckdb | hikyuu_analytics.duckdb | 性能指标 | 合并 |
| backtest_results.duckdb | hikyuu_analytics.duckdb | 回测结果 | 迁移 |
| analytics.duckdb | hikyuu_analytics.duckdb | 分析数据 | 迁移 |
| factorweave_analytics.duckdb | - | 分析数据 | 删除（重复） |
| analytics_factorweave_analytics.duckdb | - | 分析数据 | 删除（重复） |
| kline_stock.duckdb | hikyuu_analytics.duckdb | K线数据 | 迁移 |
| hikyuu_system.db | - | 空文件 | 删除 |
| hikyuu_system.db.bakck | - | 备份文件 | 删除 |

## 🔧 实施计划

### 阶段1：数据库迁移脚本
创建自动化迁移工具：
- 数据备份
- 数据迁移
- 数据验证
- 清理旧文件

### 阶段2：代码重构
更新所有数据库引用：
- 配置管理器
- 数据访问层
- 服务类
- 测试代码

### 阶段3：性能优化
- DuckDB 配置优化
- 索引创建
- 查询优化

## 📋 迁移脚本设计

### 核心功能
1. **数据备份**: 自动备份所有现有数据库
2. **数据迁移**: 按映射表迁移数据
3. **数据验证**: 确保迁移完整性
4. **代码更新**: 自动更新数据库路径引用
5. **清理**: 删除重复和废弃文件

### 安全措施
- 完整备份机制
- 回滚功能
- 数据完整性检查
- 分步执行，可中断恢复

## 🎯 预期收益

### 性能提升
- **查询速度**: DuckDB 处理大数据集比 SQLite 快 10-100 倍
- **存储效率**: 消除重复数据，节省 50%+ 存储空间
- **内存使用**: 统一数据库减少连接开销

### 维护简化
- **文件数量**: 从 12+ 个减少到 2 个
- **备份简化**: 只需备份 2 个文件
- **部署简化**: 减少配置复杂度

### 开发效率
- **统一接口**: 减少数据访问代码复杂度
- **类型安全**: DuckDB 更好的类型系统
- **调试简化**: 更少的数据库连接问题

## 🚀 实施建议

### 推荐方案：双数据库架构
基于以下考虑：
1. **技术适配**: SQLite 适合配置，DuckDB 适合分析
2. **性能平衡**: 各取所长
3. **风险控制**: 渐进式迁移
4. **兼容性**: 保持现有架构的优势

### 实施顺序
1. 创建迁移脚本和测试
2. 在测试环境验证
3. 生产环境分步迁移
4. 代码重构和优化
5. 清理和文档更新

这个重构将显著提升系统性能和可维护性，同时遵循数据库设计最佳实践。 