# FactorWeave-Quant 智能数据源选择系统使用说明

## 📖 概述

本文档介绍FactorWeave-Quant系统中新实现的智能数据源选择机制，该机制解决了原有固定数据源的问题，实现了根据数据类型自动选择最优数据源的功能。

## 🎯 解决的问题

### 原有问题
- 板块资金流服务显示"当前数据源: hikyuu"，但HIkyuu不支持板块资金流数据
- 系统设计为多数据源架构，但实际使用时固定选择某个数据源
- 缺乏数据源适配性检测和智能路由机制

### 解决方案
- ✅ 实现数据源自动检测和注册机制
- ✅ 基于数据类型和健康状态的智能路由选择
- ✅ 支持TET框架和传统数据源的统一管理
- ✅ 动态数据源切换和故障转移

## 🏗️ 架构设计

### 核心组件

#### 1. 数据源自动检测器
```python
def _detect_optimal_data_sources(self) -> None:
    """智能检测板块资金流数据的最优数据源"""
    # 1. 检查TET框架可用性
    # 2. 检查传统数据源
    # 3. 根据健康状态和功能支持排序
    # 4. 输出检测结果
```

#### 2. 智能路由系统
```python
def _get_data_with_smart_routing(self, indicator: str) -> pd.DataFrame:
    """使用智能路由获取板块资金流数据"""
    # 优先使用TET框架进行智能路由
    # 降级到最优传统数据源
```

#### 3. 数据源注册表
```python
self._available_sources = {}  # 可用数据源注册表
self._optimal_sources = []    # 最优数据源列表
```

### 数据源优先级算法

```python
def get_priority_score(source_id: str, info: Dict) -> float:
    health_score = info['health_score']
    type_weight = 1.0 if info['type'] == 'tet_plugin' else 0.8
    
    # 特殊加权
    if 'akshare' in source_id.lower():
        type_weight += 0.3  # AkShare是板块资金流的专业数据源
    
    return health_score * type_weight if info['supports_fund_flow'] else 0
```

## 🚀 使用方法

### 1. 服务初始化

```python
from core.services.sector_fund_flow_service import SectorFundFlowService
from core.services.unified_data_manager import get_unified_data_manager

# 获取数据管理器
data_manager = get_unified_data_manager()

# 初始化服务（自动进行数据源检测）
service = SectorFundFlowService(data_manager=data_manager)
if service.initialize():
    print("✅ 服务初始化成功，数据源自动检测完成")
```

### 2. 查看检测结果

```python
# 获取数据源检测信息
sources_info = service.get_available_sources_info()

print("可用数据源:", sources_info['available_sources'])
print("最优数据源排序:", sources_info['optimal_sources'])
print("当前选择:", sources_info['current_source'])

# 获取服务状态
status = service.get_service_status()
print("服务状态:", status)
```

### 3. 智能数据获取

```python
# 获取板块资金流数据（自动选择最优数据源）
df = service.get_sector_flow_rank(indicator="今日", force_refresh=True)

# 查看实际使用的数据源
current_source = service.get_current_optimal_source()
print(f"实际使用数据源: {current_source}")
```

### 4. 手动数据源切换

```python
# 切换到指定数据源
success = service.switch_data_source("akshare")
if success:
    print("✅ 数据源切换成功")
    
    # 重新获取数据
    df = service.get_sector_flow_rank(indicator="今日", force_refresh=True)
```

## 📊 日志输出示例

### 数据源检测过程

```
🔍 开始检测板块资金流数据源...
✅ TET框架可用，检测插件化数据源...
✅ 发现TET数据源: akshare (健康度: 0.85)
🔶 数据源 hikyuu 不支持板块资金流
🔍 检测传统数据源...
✅ 发现传统数据源: eastmoney (健康度: 0.70)
ℹ️ HIkyuu数据源：专注K线数据，不适用于板块资金流

📊 板块资金流数据源检测结果:
   总计发现数据源: 3 个
   支持板块资金流: 2 个
🏆 推荐数据源优先级排序:
   1. akshare (健康度: 0.85, 类型: tet_plugin)
   2. eastmoney (健康度: 0.70, 类型: legacy)
✅ 自动选择最优数据源: akshare
```

### 数据获取过程

```
🔄 获取板块资金流排行数据: 今日
🔄 通过TET框架智能路由获取板块资金流数据...
✅ TET框架成功获取数据，实际数据源: akshare
✅ 板块资金流排行数据获取成功: 45 条记录
```

## 🔧 配置选项

### 数据源检测配置

```python
class SectorFlowConfig:
    cache_duration_minutes: int = 5
    auto_refresh_interval_minutes: int = 10
    max_concurrent_requests: int = 3
    request_timeout_seconds: int = 30
    enable_cache: bool = True
    enable_auto_refresh: bool = True
    fallback_data_source: str = "akshare"  # 降级数据源
```

### 数据源权重配置

```python
# 在 _rank_data_sources 方法中可自定义权重
TYPE_WEIGHTS = {
    'tet_plugin': 1.0,    # TET插件最高优先级
    'legacy': 0.8,        # 传统数据源次优先级
}

SPECIAL_WEIGHTS = {
    'akshare': +0.3,      # AkShare专业板块资金流
    'hikyuu': -0.5,       # HIkyuu不适用于资金流
}
```

## 🧪 测试验证

### 运行测试脚本

```bash
# 运行完整测试
python test_smart_data_source_selection.py

# 查看测试日志
tail -f logs/smart_data_source_test.log
```

### 测试覆盖

1. ✅ 数据源自动检测
2. ✅ 优先级排序算法
3. ✅ TET框架路由
4. ✅ 传统数据源降级
5. ✅ 数据源切换功能
6. ✅ 健康状态监控
7. ✅ 错误处理和恢复

## 📈 性能优化

### 缓存策略

```python
# 多级缓存系统
cache_key = f"sector_flow_rank_{indicator}"

# 1. 内存缓存 (最快)
if self._is_cache_valid(cache_key):
    return self._get_from_cache(cache_key)

# 2. 智能路由获取 (自适应)
df = self._get_data_with_smart_routing(indicator)

# 3. 更新缓存
self._update_cache(cache_key, df)
```

### 并发控制

```python
# 线程池管理
self._executor = ThreadPoolExecutor(
    max_workers=self.config.max_concurrent_requests
)

# 超时控制
result = future.result(timeout=self.config.request_timeout_seconds)
```

## 🔄 扩展开发

### 添加新数据源支持

1. **实现数据源插件**

```python
class NewDataSourcePlugin(IDataSourcePlugin):
    def get_sector_fund_flow_data(self, symbol: str, **kwargs):
        # 实现板块资金流数据获取
        pass
```

2. **注册插件信息**

```python
@dataclass
class PluginInfo:
    supported_data_types: List[DataType] = field(default_factory=lambda: [
        DataType.SECTOR_FUND_FLOW,  # 声明支持板块资金流
        DataType.HISTORICAL_KLINE,
    ])
```

3. **自动发现**
系统会自动检测新插件并加入优先级排序。

### 自定义路由策略

```python
def custom_routing_strategy(available_sources: Dict, request_context: Dict) -> str:
    """自定义路由策略"""
    # 实现自定义选择逻辑
    # 例如：基于数据质量、成本、地理位置等
    return selected_source_id
```

## 🛠️ 故障排除

### 常见问题

#### 1. 无可用数据源
```
⚠️ 未发现支持板块资金流的数据源，将使用模拟数据
```
**解决方案：**
- 检查AkShare插件是否正确安装
- 验证网络连接和API配置
- 查看TET框架是否正常初始化

#### 2. 数据源连接失败
```
⚠️ 数据源 akshare 获取失败: Connection timeout
```
**解决方案：**
- 检查网络连接
- 调整超时配置
- 系统会自动降级到其他可用数据源

#### 3. TET框架不可用
```
⚠️ TET管道不可用
🔄 降级到传统数据源模式...
```
**解决方案：**
- 检查TET框架模块导入
- 验证插件注册状态
- 系统会自动使用传统数据源

### 调试工具

```python
# 启用详细日志
import logging
logging.getLogger().setLevel(logging.DEBUG)

# 查看数据源状态
service.get_available_sources_info()

# 手动触发检测
service._detect_optimal_data_sources()
```

## 📋 最佳实践

### 1. 数据源配置
- 配置多个备用数据源以提高可用性
- 定期监控数据源健康状态
- 根据实际需求调整优先级权重

### 2. 缓存管理
- 合理设置缓存过期时间
- 在数据更新频繁时使用强制刷新
- 监控缓存命中率

### 3. 错误处理
- 实现优雅的降级策略
- 记录详细的错误日志
- 提供用户友好的错误提示

### 4. 性能监控
- 监控数据源响应时间
- 跟踪数据获取成功率
- 分析用户访问模式

## 🎉 总结

智能数据源选择系统成功解决了原有固定数据源的问题，实现了：

- 🔍 **自动检测**：智能识别可用数据源和功能支持
- 🎯 **精确路由**：根据数据类型选择最适合的数据源  
- 🔄 **动态切换**：支持手动和自动数据源切换
- 📊 **透明监控**：详细的数据源状态和使用情况日志
- 🛡️ **故障保护**：完整的降级和错误恢复机制

这个系统体现了现代软件架构的最佳实践，为FactorWeave-Quant平台提供了灵活、可靠、高性能的数据基础设施。
