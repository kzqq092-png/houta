# ä»»åŠ¡å‚æ•°å®Œæ•´æ€§ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šäº†ä¸¤ä¸ªé—®é¢˜ï¼š

1. **AIPredictionServiceé”™è¯¯**: `'AIPredictionService' object has no attribute '_ml_libs_cache'`
2. **æ—¥æœŸèŒƒå›´ç¼ºå¤±**: æ—¶é—´èŒƒå›´æ˜¾ç¤º `None åˆ° None`

åŒæ—¶è¦æ±‚éªŒè¯æ‰€æœ‰UIå‚æ•°éƒ½è¢«æ­£ç¡®ä¿å­˜å’Œä½¿ç”¨ã€‚

## ä¿®å¤å†…å®¹

### âœ… ä¿®å¤ 1: AIPredictionService åˆå§‹åŒ–é”™è¯¯

**é—®é¢˜æ ¹å› **: 
- `_ml_libs_cache` å±æ€§çš„åˆå§‹åŒ–ä»£ç ä½äº `return False` è¯­å¥ä¹‹åï¼ˆç¬¬192-193è¡Œï¼‰
- è¿™å¯¼è‡´ä»£ç æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Œå±æ€§æ°¸è¿œä¸ä¼šè¢«åˆå§‹åŒ–

**è§£å†³æ–¹æ¡ˆ**:
- å°† `self._ml_libs_cache = None` ç§»åŠ¨åˆ° `__init__` æ–¹æ³•çš„æ­£ç¡®ä½ç½®ï¼ˆç¬¬179è¡Œï¼‰
- æ”¾åœ¨è°ƒç”¨ `_initialize_models()` ä¹‹å‰

**æ–‡ä»¶**: `core/services/ai_prediction_service.py`

### âœ… ä¿®å¤ 2: æ—¥æœŸèŒƒå›´å‚æ•°æœªä¿å­˜

**é—®é¢˜æ ¹å› **:
- UIå±‚åœ¨ `_get_ui_config()` ä¸­æ”¶é›†äº† `start_date` å’Œ `end_date` (ç¬¬2398-2399è¡Œ)
- ä½†åœ¨åˆ›å»º `ImportTaskConfig` å¯¹è±¡æ—¶æ²¡æœ‰ä¼ é€’è¿™äº›å‚æ•°

**è§£å†³æ–¹æ¡ˆ**:
- åœ¨ `start_import()` å‡½æ•°ä¸­æ·»åŠ æ—¥æœŸå‚æ•°ä¼ é€’ï¼ˆç¬¬2013-2014è¡Œï¼‰
- åœ¨ `_create_task_legacy()` å‡½æ•°ä¸­æ·»åŠ æ—¥æœŸå‚æ•°ä¼ é€’ï¼ˆç¬¬2448-2449è¡Œï¼‰

**æ–‡ä»¶**: `gui/widgets/enhanced_data_import_widget.py`

### âœ… ä¿®å¤ 3: æ·»åŠ ç¼ºå¤±çš„ä»»åŠ¡é…ç½®å‚æ•°

**é—®é¢˜å‘ç°**:
UIä¸­æ˜¾ç¤ºäº†è®¸å¤šé…ç½®å‚æ•°ï¼Œä½† `ImportTaskConfig` æ•°æ®ç±»ä¸­ç¼ºå°‘è¿™äº›å­—æ®µï¼š
- âŒ retry_count (é‡è¯•æ¬¡æ•°)
- âŒ error_strategy (é”™è¯¯å¤„ç†)
- âŒ memory_limit (å†…å­˜é™åˆ¶)
- âŒ timeout (è¶…æ—¶æ—¶é—´)
- âŒ progress_interval (è¿›åº¦é—´éš”)
- âŒ validate_data (æ•°æ®éªŒè¯)

**è§£å†³æ–¹æ¡ˆ**:

1. **æ‰©å±• ImportTaskConfig æ•°æ®ç±»**:
   ```python
   retry_count: int = 3               # å¤±è´¥é‡è¯•æ¬¡æ•°
   error_strategy: str = "è·³è¿‡"        # é”™è¯¯å¤„ç†ç­–ç•¥
   memory_limit: int = 2048           # å†…å­˜é™åˆ¶(MB)
   timeout: int = 300                 # è¶…æ—¶æ—¶é—´(ç§’)
   progress_interval: int = 5         # è¿›åº¦æ›´æ–°é—´éš”(ç§’)
   validate_data: bool = True         # æ˜¯å¦éªŒè¯æ•°æ®
   ```

2. **æ›´æ–°ä»»åŠ¡åˆ›å»ºé€»è¾‘**:
   - åœ¨ä¸¤å¤„åˆ›å»ºä»»åŠ¡çš„åœ°æ–¹éƒ½æ·»åŠ äº†è¿™äº›å‚æ•°
   - `start_import()` å‡½æ•°ï¼ˆç¬¬2015-2020è¡Œï¼‰
   - `_create_task_legacy()` å‡½æ•°ï¼ˆç¬¬2458-2463è¡Œï¼‰

**æ–‡ä»¶**: 
- `core/importdata/import_config_manager.py` (æ•°æ®ç±»å®šä¹‰)
- `gui/widgets/enhanced_data_import_widget.py` (ä»»åŠ¡åˆ›å»º)

## UI å‚æ•°å®Œæ•´æ€§éªŒè¯

æ ¹æ®ç”¨æˆ·æä¾›çš„UIæˆªå›¾ï¼ŒéªŒè¯æ‰€æœ‰å‚æ•°ï¼š

| UIå‚æ•° | å­—æ®µå | ä¿å­˜çŠ¶æ€ | ä½¿ç”¨çŠ¶æ€ | è¯´æ˜ |
|--------|--------|----------|----------|------|
| èµ„äº§ç±»å‹ | asset_type | âœ… | âœ… | å·²ä¿å­˜å¹¶ä½¿ç”¨ |
| æ•°æ®ç±»å‹ | data_type | âœ… | âœ… | å·²ä¿å­˜å¹¶ä½¿ç”¨ |
| æ•°æ®é¢‘ç‡ | frequency | âœ… | âœ… | å·²ä¿å­˜å¹¶ä½¿ç”¨ |
| æ•°æ®æº | data_source | âœ… | âœ… | å·²ä¿å­˜å¹¶ä½¿ç”¨ |
| å¼€å§‹æ—¥æœŸ | start_date | âœ… | âœ… | **å·²ä¿®å¤** |
| ç»“æŸæ—¥æœŸ | end_date | âœ… | âœ… | **å·²ä¿®å¤** |
| æ‰¹é‡å¤§å° | batch_size | âœ… | âœ… | å·²ä¿å­˜å¹¶ä½¿ç”¨ |
| é‡è¯•æ¬¡æ•° | retry_count | âœ… | â³ | **å·²æ·»åŠ åˆ°é…ç½®ï¼Œå¾…å®ç°ä½¿ç”¨é€»è¾‘** |
| å·¥ä½œçº¿ç¨‹æ•° | max_workers | âœ… | âœ… | å·²ä¿å­˜å¹¶ä½¿ç”¨ |
| é”™è¯¯å¤„ç† | error_strategy | âœ… | â³ | **å·²æ·»åŠ åˆ°é…ç½®ï¼Œå¾…å®ç°ä½¿ç”¨é€»è¾‘** |
| å†…å­˜é™åˆ¶ | memory_limit | âœ… | â³ | **å·²æ·»åŠ åˆ°é…ç½®ï¼Œå¾…å®ç°ä½¿ç”¨é€»è¾‘** |
| è¿›åº¦é—´éš” | progress_interval | âœ… | â³ | **å·²æ·»åŠ åˆ°é…ç½®ï¼Œå¾…å®ç°ä½¿ç”¨é€»è¾‘** |
| AIæ™ºèƒ½ä¼˜åŒ– | ai_optimization | âœ… | âœ… | å¼•æ“çº§é…ç½® |
| AutoTuner | auto_tuning | âœ… | âœ… | å¼•æ“çº§é…ç½® |
| åˆ†å¸ƒå¼æ‰§è¡Œ | distributed | âœ… | âœ… | å¼•æ“çº§é…ç½® |
| æ™ºèƒ½ç¼“å­˜ | caching | âœ… | âœ… | å¼•æ“çº§é…ç½® |
| æ•°æ®è´¨é‡ç›‘æ§ | quality_monitoring | âœ… | âœ… | å¼•æ“çº§é…ç½® |

### å‚æ•°åˆ†ç±»

**ä»»åŠ¡çº§å‚æ•°** (ä¿å­˜åœ¨ ImportTaskConfig):
- åŸºç¡€ä¿¡æ¯: task_id, name, data_source, asset_type, data_type
- æ•°æ®é€‰æ‹©: symbols, frequency, start_date, end_date
- æ‰§è¡Œé…ç½®: batch_size, max_workers, retry_count, error_strategy
- èµ„æºé™åˆ¶: memory_limit, timeout, progress_interval
- æ•°æ®éªŒè¯: validate_data

**å¼•æ“çº§å‚æ•°** (ä¿å­˜åœ¨ ImportEngine):
- AIä¼˜åŒ–åŠŸèƒ½: ai_optimization, auto_tuning
- åˆ†å¸ƒå¼æ‰§è¡Œ: distributed
- ç¼“å­˜ç­–ç•¥: caching
- è´¨é‡ç›‘æ§: quality_monitoring

## å¾…å®ç°åŠŸèƒ½

### 1. é‡è¯•é€»è¾‘ (retry_count)

**å½“å‰çŠ¶æ€**: ä¸‹è½½å¤±è´¥æ—¶ç›´æ¥è®°å½•é”™è¯¯å¹¶è¿”å›
**éœ€è¦å®ç°**: 
```python
def download_with_retry(symbol: str, retry_count: int):
    for attempt in range(retry_count + 1):
        try:
            return download_single_stock(symbol)
        except Exception as e:
            if attempt < retry_count:
                logger.warning(f"é‡è¯• {attempt+1}/{retry_count}: {symbol}")
                time.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿
            else:
                raise
```

### 2. é”™è¯¯å¤„ç†ç­–ç•¥ (error_strategy)

**å¯é€‰ç­–ç•¥**:
- "åœæ­¢": é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢æ•´ä¸ªä»»åŠ¡
- "è·³è¿‡": è·³è¿‡å¤±è´¥çš„è‚¡ç¥¨ï¼Œç»§ç»­å¤„ç†å…¶ä»–è‚¡ç¥¨ï¼ˆå½“å‰é»˜è®¤è¡Œä¸ºï¼‰
- "é‡è¯•": ä½¿ç”¨ retry_count è¿›è¡Œé‡è¯•

### 3. å†…å­˜é™åˆ¶ (memory_limit)

**éœ€è¦å®ç°**:
- ç›‘æ§å½“å‰å†…å­˜ä½¿ç”¨
- å½“æ¥è¿‘é™åˆ¶æ—¶æš‚åœæ–°ä»»åŠ¡
- è§¦å‘åƒåœ¾å›æ”¶
- å¯ä»¥ä½¿ç”¨ `psutil` åº“ç›‘æ§å†…å­˜

### 4. è¿›åº¦é—´éš” (progress_interval)

**éœ€è¦å®ç°**:
- ä½¿ç”¨ `progress_interval` æ§åˆ¶è¿›åº¦æ›´æ–°é¢‘ç‡
- é¿å…è¿‡äºé¢‘ç¹çš„UIæ›´æ–°å½±å“æ€§èƒ½

### 5. æ•°æ®éªŒè¯ (validate_data)

**éœ€è¦å®ç°**:
- å¦‚æœå¯ç”¨ï¼Œå¯¹ä¸‹è½½çš„æ•°æ®è¿›è¡Œå®Œæ•´æ€§æ£€æŸ¥
- éªŒè¯å¿…éœ€å­—æ®µã€æ•°æ®ç±»å‹ã€æ•°æ®èŒƒå›´ç­‰

## ä¿®æ”¹æ–‡ä»¶æ±‡æ€»

### å·²ä¿®æ”¹æ–‡ä»¶

1. âœ… `core/services/ai_prediction_service.py`
   - ä¿®å¤ `_ml_libs_cache` åˆå§‹åŒ–ä½ç½®

2. âœ… `core/importdata/import_config_manager.py`
   - æ‰©å±• `ImportTaskConfig` æ•°æ®ç±»ï¼Œæ·»åŠ 6ä¸ªæ–°å­—æ®µ

3. âœ… `gui/widgets/enhanced_data_import_widget.py`
   - åœ¨ `start_import()` ä¸­æ·»åŠ æ—¥æœŸå’Œé«˜çº§å‚æ•°
   - åœ¨ `_create_task_legacy()` ä¸­æ·»åŠ æ—¥æœŸå’Œé«˜çº§å‚æ•°

### å¾…ä¿®æ”¹æ–‡ä»¶

1. â³ `core/importdata/import_execution_engine.py`
   - å®ç°é‡è¯•é€»è¾‘
   - å®ç°é”™è¯¯å¤„ç†ç­–ç•¥
   - å®ç°å†…å­˜ç›‘æ§
   - å®ç°è¿›åº¦é—´éš”æ§åˆ¶
   - å®ç°æ•°æ®éªŒè¯

## æµ‹è¯•å»ºè®®

### åŸºæœ¬æµ‹è¯•

1. **æ—¥æœŸèŒƒå›´æµ‹è¯•**:
   ```
   - åˆ›å»ºä»»åŠ¡æ—¶è®¾ç½®å¼€å§‹æ—¥æœŸï¼š2024-01-01
   - åˆ›å»ºä»»åŠ¡æ—¶è®¾ç½®ç»“æŸæ—¥æœŸï¼š2024-12-31
   - éªŒè¯ä»»åŠ¡é…ç½®ä¸­æœ‰æ­£ç¡®çš„æ—¥æœŸ
   - å¯åŠ¨ä»»åŠ¡ï¼Œæ£€æŸ¥æ—¥å¿—ç¡®è®¤ä½¿ç”¨äº†æ­£ç¡®çš„æ—¥æœŸ
   ```

2. **å‚æ•°ä¿å­˜æµ‹è¯•**:
   ```
   - è®¾ç½®æ‰€æœ‰UIå‚æ•°
   - ä¿å­˜ä»»åŠ¡
   - é‡æ–°åŠ è½½ä»»åŠ¡
   - éªŒè¯æ‰€æœ‰å‚æ•°éƒ½è¢«ä¿ç•™
   ```

3. **AIé¢„æµ‹æµ‹è¯•**:
   ```
   - å¯åŠ¨ä»»åŠ¡
   - éªŒè¯AIæ‰§è¡Œæ—¶é—´é¢„æµ‹ä¸å†æŠ¥é”™
   ```

### é«˜çº§åŠŸèƒ½æµ‹è¯• (å¾…å®ç°å)

1. **é‡è¯•é€»è¾‘æµ‹è¯•**:
   ```
   - è®¾ç½®retry_count=3
   - æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯
   - éªŒè¯è‡ªåŠ¨é‡è¯•3æ¬¡
   ```

2. **é”™è¯¯ç­–ç•¥æµ‹è¯•**:
   ```
   - æµ‹è¯•"åœæ­¢"ç­–ç•¥ï¼šé¦–ä¸ªé”™è¯¯åä»»åŠ¡åœæ­¢
   - æµ‹è¯•"è·³è¿‡"ç­–ç•¥ï¼šé”™è¯¯è¢«è·³è¿‡ï¼Œç»§ç»­å…¶ä»–è‚¡ç¥¨
   - æµ‹è¯•"é‡è¯•"ç­–ç•¥ï¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„è‚¡ç¥¨
   ```

3. **å†…å­˜é™åˆ¶æµ‹è¯•**:
   ```
   - è®¾ç½®memory_limit=1024 (1GB)
   - å¯¼å…¥å¤§é‡æ•°æ®
   - éªŒè¯å†…å­˜ä¸è¶…è¿‡é™åˆ¶
   ```

## æ€»ç»“

### å·²å®Œæˆ âœ…

1. âœ… ä¿®å¤ AIPredictionService åˆå§‹åŒ–é”™è¯¯
2. âœ… ä¿®å¤æ—¥æœŸèŒƒå›´å‚æ•°æœªä¿å­˜é—®é¢˜
3. âœ… æ‰©å±• ImportTaskConfig æ·»åŠ æ‰€æœ‰UIå‚æ•°
4. âœ… æ›´æ–°ä»»åŠ¡åˆ›å»ºé€»è¾‘ä»¥ä¿å­˜æ‰€æœ‰å‚æ•°
5. âœ… éªŒè¯æ‰€æœ‰UIå‚æ•°éƒ½è¢«æ­£ç¡®æ”¶é›†å’Œä¿å­˜
6. âœ… æ— lintingé”™è¯¯

### å¾…å®Œæˆ â³

1. â³ åœ¨ import_execution_engine ä¸­å®ç°é‡è¯•é€»è¾‘
2. â³ å®ç°é”™è¯¯å¤„ç†ç­–ç•¥ï¼ˆåœæ­¢/è·³è¿‡/é‡è¯•ï¼‰
3. â³ å®ç°å†…å­˜é™åˆ¶ç›‘æ§
4. â³ å®ç°å¯é…ç½®çš„è¿›åº¦é—´éš”
5. â³ å®ç°æ•°æ®éªŒè¯åŠŸèƒ½
6. â³ å®Œæ•´çš„é›†æˆæµ‹è¯•

**ä¿®å¤çŠ¶æ€**: ğŸŸ¢ æ ¸å¿ƒé—®é¢˜å·²ä¿®å¤ï¼Œé«˜çº§åŠŸèƒ½å¾…å®ç°  
**ä»£ç è´¨é‡**: âœ… æ— lintingé”™è¯¯  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…ç”¨æˆ·éªŒè¯å’Œé›†æˆæµ‹è¯•

