# è½»é‡çº§æ•°æ®æºæ’ä»¶åŒ–è¯¦ç»†å¼€å‘è®¡åˆ’

## ğŸ¯ é¡¹ç›®æ¦‚è§ˆ

**é¡¹ç›®ç›®æ ‡**ï¼šåŸºäºFactorWeave-Quant ç°æœ‰æ¶æ„ï¼Œé€šè¿‡è½»é‡çº§æ‰©å±•å®ç°æ’ä»¶åŒ–æ•°æ®æºç®¡ç†

**æ ¸å¿ƒåŸåˆ™**ï¼š
- âœ… æœ€å¤§åŒ–å¤ç”¨ç°æœ‰ç»„ä»¶ï¼ˆ90%å¤ç”¨ç‡ï¼‰
- âœ… æœ€å°åŒ–ä»£ç é‡å¤å’Œé‡æ„é£é™©
- âœ… å•æ–‡ä»¶ä»£ç è¡Œæ•°ä¸¥æ ¼æ§åˆ¶åœ¨2500è¡Œä»¥å†…
- âœ… ä¿æŒå‘ä¸‹å…¼å®¹ï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½

**é¢„æœŸæ”¶ç›Š**ï¼š
- ğŸ“ˆ å¼€å‘æ•ˆç‡æå‡70%ï¼ˆ4å‘¨ vs 10å‘¨ï¼‰
- ğŸ›¡ï¸ é™ä½ç³»ç»Ÿé£é™©ï¼ŒåŸºäºæˆç†Ÿç»„ä»¶
- ğŸ”§ æå‡ç»´æŠ¤æ€§ï¼Œé¿å…é‡å¤è®¾è®¡

---

## ğŸ“Š ç°æœ‰ç³»ç»Ÿè°ƒç”¨é“¾åˆ†æ

### å…³é”®è°ƒç”¨è·¯å¾„

```
main.py
â”œâ”€â”€ HIkyuuUIApplication.initialize()
â”œâ”€â”€ ServiceBootstrap.bootstrap()
â”‚   â”œâ”€â”€ _register_core_services()
â”‚   â”‚   â””â”€â”€ container.register(UnifiedDataManager)
â”‚   â”œâ”€â”€ _register_business_services()
â”‚   â”‚   â””â”€â”€ container.register(StockService)
â”‚   â””â”€â”€ _register_plugin_services()
â”‚       â””â”€â”€ container.register(PluginManager)
â””â”€â”€ MainWindowCoordinator.setup()
    â””â”€â”€ PluginManagerDialog (èœå•è§¦å‘)

æ•°æ®è®¿é—®è°ƒç”¨é“¾ï¼š
GUIç»„ä»¶ â†’ DataAccess â†’ Repository â†’ DataManager â†’ DataSourceå®ç°
å®æ—¶æ•°æ®ï¼šRealTimeDataWorker â†’ DataAccess â†’ get_kline_data()
äº‹ä»¶ç³»ç»Ÿï¼šEventBus.publish() â†’ å„ç§EventHandler
```

### ç°æœ‰æ•°æ®ç®¡ç†ç»„ä»¶èŒè´£

```
DataManager (core/data_manager.py - 1469è¡Œ)
â”œâ”€â”€ _data_sources: ç®¡ç†5ä¸ªæ•°æ®æºå®ä¾‹
â”œâ”€â”€ set_data_source(): æ”¯æŒåŠ¨æ€åˆ‡æ¢
â”œâ”€â”€ cache_manager: ç¼“å­˜ç®¡ç†
â””â”€â”€ industry_manager: è¡Œä¸šæ•°æ®ç®¡ç†

UnifiedDataManager (core/services/unified_data_manager.py - 719è¡Œ)  
â”œâ”€â”€ _data_cache: ç»Ÿä¸€æ•°æ®ç¼“å­˜
â”œâ”€â”€ _request_dedup: è¯·æ±‚å»é‡æœºåˆ¶
â”œâ”€â”€ _executor: ThreadPoolExecutorå¼‚æ­¥å¤„ç†
â””â”€â”€ history/realtime_data_strategy: æ•°æ®ç­–ç•¥

PluginManager (core/plugin_manager.py)
â”œâ”€â”€ loaded_plugins: æ’ä»¶å®ä¾‹ç®¡ç†
â”œâ”€â”€ plugin_instances: æ’ä»¶å¯¹è±¡ç¼“å­˜
â”œâ”€â”€ enhanced_plugins: å¢å¼ºæ’ä»¶ä¿¡æ¯
â””â”€â”€ load_plugin(): æ’ä»¶åŠ è½½æœºåˆ¶
```

---

## ğŸš€ ä¸‰é˜¶æ®µå¼€å‘è®¡åˆ’

### é˜¶æ®µä¸€ï¼šæ ¸å¿ƒæ‰©å±•ï¼ˆç¬¬1å‘¨ï¼‰

#### ğŸ¯ ç›®æ ‡
æ‰©å±•ç°æœ‰DataManagerå’ŒPluginManagerï¼Œæ”¯æŒæ’ä»¶åŒ–æ•°æ®æºæ³¨å†Œå’ŒåŸºç¡€ç®¡ç†

#### ğŸ“ æ–‡ä»¶ä¿®æ”¹å’Œæ–°å»º

| æ–‡ä»¶è·¯å¾„ | ç±»å‹ | åŸå§‹è¡Œæ•° | ç›®æ ‡è¡Œæ•° | ä¸»è¦å˜æ›´ |
|---------|------|----------|----------|----------|
| `core/data_manager.py` | ä¿®æ”¹ | 1469 | 1800 | æ–°å¢æ’ä»¶æ•°æ®æºæ”¯æŒ |
| `core/plugin_manager.py` | ä¿®æ”¹ | ä¼°è®¡1500 | 1700 | æ–°å¢æ•°æ®æºæ’ä»¶ç±»å‹ |
| `core/data_source_extensions.py` | æ–°å»º | 0 | 500 | æ’ä»¶æ¥å£å’Œæ‰©å±•åŠŸèƒ½ |
| `core/plugin_types.py` | æ–°å»º | 0 | 200 | æ•°æ®æºæ’ä»¶ç±»å‹å®šä¹‰ |

#### ğŸ”§ å…·ä½“ä»»åŠ¡

**Task 1.1: è®¾è®¡æ’ä»¶æ•°æ®æºæ¥å£ (1å¤©)**
```python
# core/data_source_extensions.py (é¢„ä¼°400è¡Œ)
from abc import ABC, abstractmethod
from typing import List, Dict, Any, Optional
import pandas as pd
from datetime import datetime

class IDataSourcePlugin(ABC):
    """æ•°æ®æºæ’ä»¶æ ‡å‡†æ¥å£"""
    
    @abstractmethod
    def get_plugin_info(self) -> Dict[str, Any]:
        """è·å–æ’ä»¶åŸºæœ¬ä¿¡æ¯"""
        pass
    
    @abstractmethod
    def get_supported_asset_types(self) -> List[str]:
        """è·å–æ”¯æŒçš„èµ„äº§ç±»å‹"""
        pass
    
    @abstractmethod
    def get_supported_data_types(self) -> List[str]:
        """è·å–æ”¯æŒçš„æ•°æ®ç±»å‹"""
        pass
        
    @abstractmethod
    def initialize(self, config: Dict[str, Any]) -> bool:
        """åˆå§‹åŒ–æ’ä»¶"""
        pass
        
    @abstractmethod
    def fetch_data(self, symbol: str, data_type: str, 
                   start_date: Optional[datetime] = None,
                   end_date: Optional[datetime] = None,
                   **kwargs) -> pd.DataFrame:
        """è·å–æ•°æ®"""
        pass
        
    @abstractmethod
    def get_real_time_data(self, symbols: List[str]) -> Dict[str, Any]:
        """è·å–å®æ—¶æ•°æ®"""
        pass
        
    @abstractmethod
    def health_check(self) -> bool:
        """å¥åº·æ£€æŸ¥"""
        pass

class DataSourcePluginAdapter:
    """æ•°æ®æºæ’ä»¶é€‚é…å™¨ - æ¡¥æ¥ç°æœ‰DataSourceæ¥å£"""
    
    def __init__(self, plugin: IDataSourcePlugin):
        self.plugin = plugin
        self._is_connected = False
        
    def connect(self) -> bool:
        """è¿æ¥é€‚é…"""
        return self.plugin.initialize({})
        
    def get_kdata(self, symbol: str, freq: str, **kwargs) -> pd.DataFrame:
        """Kçº¿æ•°æ®è·å–é€‚é…"""
        return self.plugin.fetch_data(symbol, 'kline', **kwargs)
```

**Task 1.2: æ‰©å±•DataManageræ”¯æŒæ’ä»¶ (2å¤©)**
```python
# core/data_manager.py æ–°å¢éƒ¨åˆ† (é¢„ä¼°300è¡Œæ–°å¢ä»£ç )
class DataManager:
    def __init__(self):
        # ... ç°æœ‰åˆå§‹åŒ–ä»£ç  ...
        
        # æ–°å¢ï¼šæ’ä»¶æ•°æ®æºç®¡ç†
        self._plugin_data_sources: Dict[str, IDataSourcePlugin] = {}
        self._data_source_priorities: Dict[str, List[str]] = {
            'stock': ['hikyuu', 'akshare', 'eastmoney'],
            'futures': [],
            'crypto': []
        }
        self._routing_strategy = 'priority'  # priority, round_robin, health_based
        self._health_status: Dict[str, bool] = {}
        
    def register_plugin_data_source(self, plugin_id: str, 
                                   plugin: IDataSourcePlugin) -> bool:
        """æ³¨å†Œæ’ä»¶æ•°æ®æº"""
        try:
            if plugin.initialize({}):
                # åˆ›å»ºé€‚é…å™¨æ¡¥æ¥ç°æœ‰æ¥å£
                adapter = DataSourcePluginAdapter(plugin)
                
                # æ³¨å†Œåˆ°ç°æœ‰æ•°æ®æºå­—å…¸ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
                self._data_sources[plugin_id] = adapter
                
                # æ³¨å†Œåˆ°æ’ä»¶æ•°æ®æºå­—å…¸
                self._plugin_data_sources[plugin_id] = plugin
                
                # åˆå§‹åŒ–å¥åº·çŠ¶æ€
                self._health_status[plugin_id] = True
                
                self.log_manager.info(f"æ’ä»¶æ•°æ®æºæ³¨å†ŒæˆåŠŸ: {plugin_id}")
                return True
            
        except Exception as e:
            self.log_manager.error(f"æ’ä»¶æ•°æ®æºæ³¨å†Œå¤±è´¥ {plugin_id}: {e}")
            return False
    
    def set_data_source_priority(self, asset_type: str, 
                                priorities: List[str]) -> None:
        """è®¾ç½®æ•°æ®æºä¼˜å…ˆçº§"""
        self._data_source_priorities[asset_type] = priorities
        self.log_manager.info(f"è®¾ç½® {asset_type} æ•°æ®æºä¼˜å…ˆçº§: {priorities}")
    
    def get_data_with_fallback(self, symbol: str, data_type: str,
                              asset_type: str = 'stock', **kwargs) -> pd.DataFrame:
        """æ”¯æŒæ•…éšœåˆ‡æ¢çš„æ•°æ®è·å–"""
        priorities = self._data_source_priorities.get(asset_type, ['hikyuu'])
        
        for source_id in priorities:
            if source_id not in self._data_sources:
                continue
                
            try:
                # å¥åº·æ£€æŸ¥
                if not self._check_source_health(source_id):
                    continue
                    
                # è·å–æ•°æ®
                if source_id in self._plugin_data_sources:
                    # ä½¿ç”¨æ’ä»¶æ•°æ®æº
                    plugin = self._plugin_data_sources[source_id]
                    data = plugin.fetch_data(symbol, data_type, **kwargs)
                else:
                    # ä½¿ç”¨ç°æœ‰æ•°æ®æº
                    source = self._data_sources[source_id]
                    data = source.get_kdata(symbol, kwargs.get('freq', 'D'))
                
                if not data.empty:
                    self.log_manager.debug(f"æ•°æ®è·å–æˆåŠŸ: {source_id}")
                    return data
                    
            except Exception as e:
                self.log_manager.warning(f"æ•°æ®æº {source_id} å¤±è´¥ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª: {e}")
                self._health_status[source_id] = False
                continue
        
        raise RuntimeError(f"æ‰€æœ‰æ•°æ®æºéƒ½ä¸å¯ç”¨ï¼Œèµ„äº§ç±»å‹: {asset_type}")
    
    def _check_source_health(self, source_id: str) -> bool:
        """æ£€æŸ¥æ•°æ®æºå¥åº·çŠ¶æ€"""
        if source_id in self._plugin_data_sources:
            try:
                plugin = self._plugin_data_sources[source_id]
                is_healthy = plugin.health_check()
                self._health_status[source_id] = is_healthy
                return is_healthy
            except:
                self._health_status[source_id] = False
                return False
        
        # ç°æœ‰æ•°æ®æºé»˜è®¤ä¸ºå¥åº·
        return self._health_status.get(source_id, True)
```

**Task 1.3: æ‰©å±•PluginManageræ”¯æŒæ•°æ®æºæ’ä»¶ (1å¤©)**
```python
# core/plugin_types.py (æ–°å»ºæ–‡ä»¶ï¼Œé¢„ä¼°200è¡Œ)
from enum import Enum

class PluginType(Enum):
    """æ‰©å±•æ’ä»¶ç±»å‹æšä¸¾"""
    # ç°æœ‰ç±»å‹
    INDICATOR = "indicator"
    SENTIMENT = "sentiment"
    STRATEGY = "strategy"
    
    # æ–°å¢æ•°æ®æºç±»å‹
    DATA_SOURCE = "data_source"
    DATA_SOURCE_STOCK = "data_source_stock"  
    DATA_SOURCE_FUTURES = "data_source_futures"
    DATA_SOURCE_CRYPTO = "data_source_crypto"
    DATA_SOURCE_FOREX = "data_source_forex"

class AssetType(Enum):
    """èµ„äº§ç±»å‹æšä¸¾"""
    STOCK = "stock"
    FUTURES = "futures"
    CRYPTO = "crypto"
    FOREX = "forex"
    BOND = "bond"
    COMMODITY = "commodity"

# core/plugin_manager.py æ–°å¢éƒ¨åˆ† (é¢„ä¼°200è¡Œ)
class PluginManager:
    def __init__(self):
        # ... ç°æœ‰åˆå§‹åŒ– ...
        
        # æ–°å¢ï¼šæ•°æ®æºæ’ä»¶ç®¡ç†
        self.data_source_plugins: Dict[str, PluginInfo] = {}
        
    def load_data_source_plugin(self, plugin_path: str) -> bool:
        """åŠ è½½æ•°æ®æºæ’ä»¶"""
        try:
            # å¤ç”¨ç°æœ‰æ’ä»¶åŠ è½½æœºåˆ¶
            plugin_info = self._load_plugin_from_path(plugin_path)
            
            if plugin_info.plugin_type in [PluginType.DATA_SOURCE, 
                                         PluginType.DATA_SOURCE_STOCK,
                                         PluginType.DATA_SOURCE_FUTURES,
                                         PluginType.DATA_SOURCE_CRYPTO]:
                
                # éªŒè¯æ’ä»¶æ¥å£
                if not isinstance(plugin_info.instance, IDataSourcePlugin):
                    raise ValueError(f"æ’ä»¶æœªå®ç°IDataSourcePluginæ¥å£")
                
                # æ³¨å†Œåˆ°æ•°æ®ç®¡ç†å™¨
                data_manager = self._get_data_manager()
                if data_manager.register_plugin_data_source(
                    plugin_info.id, plugin_info.instance):
                    
                    self.data_source_plugins[plugin_info.id] = plugin_info
                    self.plugin_loaded.emit(plugin_info.id)
                    return True
                    
        except Exception as e:
            self.log_manager.error(f"åŠ è½½æ•°æ®æºæ’ä»¶å¤±è´¥: {e}")
            return False
```

**Task 1.4: å•å…ƒæµ‹è¯• (1å¤©)**
- æµ‹è¯•æ’ä»¶æ¥å£å®ç°
- æµ‹è¯•æ•°æ®æºæ³¨å†ŒåŠŸèƒ½  
- æµ‹è¯•åŸºç¡€æ•…éšœåˆ‡æ¢é€»è¾‘
- æµ‹è¯•å‘ä¸‹å…¼å®¹æ€§

#### ğŸ“‹ äº¤ä»˜ç‰©
- [ ] IDataSourcePluginæ¥å£å®šä¹‰
- [ ] DataSourcePluginAdapteré€‚é…å™¨
- [ ] DataManageræ’ä»¶æ”¯æŒæ‰©å±•
- [ ] PluginManageræ•°æ®æºæ’ä»¶åŠ è½½
- [ ] å•å…ƒæµ‹è¯•ç”¨ä¾‹ (è¦†ç›–ç‡>90%)
- [ ] é›†æˆæµ‹è¯•éªŒè¯ç°æœ‰åŠŸèƒ½ä¸å—å½±å“

---

### é˜¶æ®µäºŒï¼šæ™ºèƒ½è·¯ç”±å®ç°ï¼ˆç¬¬2å‘¨ï¼‰

#### ğŸ¯ ç›®æ ‡
åŸºäºUnifiedDataManagerå®ç°æ™ºèƒ½æ•°æ®æºè·¯ç”±ï¼Œé›†æˆäº‹ä»¶é©±åŠ¨çš„æ•…éšœåˆ‡æ¢æœºåˆ¶

#### ğŸ“ æ–‡ä»¶ä¿®æ”¹å’Œæ–°å»º

| æ–‡ä»¶è·¯å¾„ | ç±»å‹ | åŸå§‹è¡Œæ•° | ç›®æ ‡è¡Œæ•° | ä¸»è¦å˜æ›´ |
|---------|------|----------|----------|----------|
| `core/services/unified_data_manager.py` | ä¿®æ”¹ | 719 | 1000 | é›†æˆè·¯ç”±åŠŸèƒ½ |
| `core/services/data_source_router.py` | æ–°å»º | 0 | 400 | è·¯ç”±ç­–ç•¥å®ç° |
| `core/events/data_source_events.py` | æ–°å»º | 0 | 200 | æ•°æ®æºäº‹ä»¶å®šä¹‰ |
| `core/services/data_source_health_monitor.py` | æ–°å»º | 0 | 300 | å¥åº·ç›‘æ§æœåŠ¡ |

#### ğŸ”§ å…·ä½“ä»»åŠ¡

**Task 2.1: è®¾è®¡æ•°æ®æºè·¯ç”±å™¨ (2å¤©)**
```python
# core/services/data_source_router.py (é¢„ä¼°400è¡Œ)
from typing import List, Dict, Any, Optional
from dataclasses import dataclass
from enum import Enum
import time
import threading

class RoutingStrategy(Enum):
    """è·¯ç”±ç­–ç•¥æšä¸¾"""
    PRIORITY = "priority"           # ä¼˜å…ˆçº§è·¯ç”±
    ROUND_ROBIN = "round_robin"     # è½®è¯¢
    HEALTH_BASED = "health_based"   # åŸºäºå¥åº·çŠ¶æ€
    LOAD_BALANCED = "load_balanced" # è´Ÿè½½å‡è¡¡

@dataclass
class RoutingPlan:
    """è·¯ç”±è®¡åˆ’"""
    primary_source: str
    fallback_sources: List[str]
    strategy: RoutingStrategy
    estimated_latency: int = 0

@dataclass
class DataSourceStats:
    """æ•°æ®æºç»Ÿè®¡ä¿¡æ¯"""
    source_id: str
    success_count: int = 0
    error_count: int = 0
    avg_response_time: float = 0.0
    last_success_time: Optional[float] = None
    last_error_time: Optional[float] = None
    health_score: float = 1.0

class DataSourceRouter:
    """è½»é‡çº§æ•°æ®æºè·¯ç”±å™¨"""
    
    def __init__(self):
        self.routing_rules: Dict[str, List[str]] = {
            'stock': ['hikyuu', 'akshare', 'eastmoney'],
            'futures': ['ctp', 'wenhua'],
            'crypto': ['binance', 'coinbase']
        }
        self.source_stats: Dict[str, DataSourceStats] = {}
        self.stats_lock = threading.Lock()
        
    def route_request(self, request_params: Dict[str, Any]) -> RoutingPlan:
        """è·¯ç”±è¯·æ±‚åˆ°æœ€ä¼˜æ•°æ®æº"""
        asset_type = request_params.get('asset_type', 'stock')
        strategy = request_params.get('routing_strategy', RoutingStrategy.PRIORITY)
        
        available_sources = self.routing_rules.get(asset_type, ['hikyuu'])
        
        if strategy == RoutingStrategy.PRIORITY:
            return self._priority_routing(available_sources)
        elif strategy == RoutingStrategy.HEALTH_BASED:
            return self._health_based_routing(available_sources)
        elif strategy == RoutingStrategy.ROUND_ROBIN:
            return self._round_robin_routing(available_sources)
        else:
            return self._priority_routing(available_sources)
    
    def _priority_routing(self, sources: List[str]) -> RoutingPlan:
        """ä¼˜å…ˆçº§è·¯ç”±"""
        return RoutingPlan(
            primary_source=sources[0] if sources else 'hikyuu',
            fallback_sources=sources[1:] if len(sources) > 1 else [],
            strategy=RoutingStrategy.PRIORITY
        )
    
    def _health_based_routing(self, sources: List[str]) -> RoutingPlan:
        """åŸºäºå¥åº·çŠ¶æ€çš„è·¯ç”±"""
        # æŒ‰å¥åº·åˆ†æ•°æ’åº
        healthy_sources = sorted(
            sources,
            key=lambda s: self.source_stats.get(s, DataSourceStats(s)).health_score,
            reverse=True
        )
        
        return RoutingPlan(
            primary_source=healthy_sources[0] if healthy_sources else 'hikyuu',
            fallback_sources=healthy_sources[1:],
            strategy=RoutingStrategy.HEALTH_BASED
        )
    
    def record_success(self, source_id: str, response_time: float):
        """è®°å½•æˆåŠŸè¯·æ±‚"""
        with self.stats_lock:
            if source_id not in self.source_stats:
                self.source_stats[source_id] = DataSourceStats(source_id)
            
            stats = self.source_stats[source_id]
            stats.success_count += 1
            stats.last_success_time = time.time()
            
            # æ›´æ–°å¹³å‡å“åº”æ—¶é—´
            stats.avg_response_time = (
                (stats.avg_response_time * (stats.success_count - 1) + response_time) 
                / stats.success_count
            )
            
            # æ›´æ–°å¥åº·åˆ†æ•°
            self._update_health_score(stats)
    
    def record_error(self, source_id: str, error: Exception):
        """è®°å½•é”™è¯¯è¯·æ±‚"""
        with self.stats_lock:
            if source_id not in self.source_stats:
                self.source_stats[source_id] = DataSourceStats(source_id)
            
            stats = self.source_stats[source_id]
            stats.error_count += 1
            stats.last_error_time = time.time()
            
            # æ›´æ–°å¥åº·åˆ†æ•°
            self._update_health_score(stats)
```

**Task 2.2: é›†æˆUnifiedDataManagerè·¯ç”±åŠŸèƒ½ (2å¤©)**
```python
# core/services/unified_data_manager.py æ‰©å±•éƒ¨åˆ† (é¢„ä¼°280è¡Œæ–°å¢)
class UnifiedDataManager:
    def __init__(self, service_container, event_bus, max_workers=3):
        # ... ç°æœ‰åˆå§‹åŒ– ...
        
        # æ–°å¢ï¼šæ•°æ®æºè·¯ç”±
        self.data_source_router = DataSourceRouter()
        self.data_manager = None  # å»¶è¿Ÿæ³¨å…¥
        
    def get_data_with_intelligent_routing(self, request: DataRequest) -> Any:
        """æ™ºèƒ½è·¯ç”±çš„æ•°æ®è·å–"""
        # åˆ©ç”¨ç°æœ‰å»é‡æœºåˆ¶
        cache_key = self._generate_cache_key(request)
        
        with self._cache_lock:
            if cache_key in self._data_cache:
                cached_time = self._cache_timestamps.get(cache_key, 0)
                if time.time() - cached_time < self._cache_ttl:
                    return self._data_cache[cache_key]
        
        # è·å–è·¯ç”±è®¡åˆ’
        routing_plan = self.data_source_router.route_request(request.parameters)
        
        # æŒ‰è·¯ç”±è®¡åˆ’å°è¯•è·å–æ•°æ®
        for source_id in [routing_plan.primary_source] + routing_plan.fallback_sources:
            start_time = time.time()
            try:
                data = self._fetch_from_source(source_id, request)
                
                if data is not None:
                    # è®°å½•æˆåŠŸ
                    response_time = time.time() - start_time
                    self.data_source_router.record_success(source_id, response_time)
                    
                    # åˆ©ç”¨ç°æœ‰ç¼“å­˜æœºåˆ¶
                    with self._cache_lock:
                        self._data_cache[cache_key] = data
                        self._cache_timestamps[cache_key] = time.time()
                    
                    # å‘å¸ƒæˆåŠŸäº‹ä»¶
                    self.event_bus.publish('DataSourceSuccessEvent', 
                                         source_id=source_id, response_time=response_time)
                    
                    return data
                    
            except Exception as e:
                # è®°å½•é”™è¯¯
                self.data_source_router.record_error(source_id, e)
                
                # å‘å¸ƒå¤±è´¥äº‹ä»¶
                self.event_bus.publish('DataSourceFailedEvent',
                                     source_id=source_id, error=str(e),
                                     request_context=request.parameters)
                
                self.logger.warning(f"æ•°æ®æº {source_id} å¤±è´¥: {e}")
                continue
        
        raise RuntimeError("æ‰€æœ‰è·¯ç”±çš„æ•°æ®æºéƒ½ä¸å¯ç”¨")
    
    def _fetch_from_source(self, source_id: str, request: DataRequest) -> Any:
        """ä»æŒ‡å®šæ•°æ®æºè·å–æ•°æ®"""
        if self.data_manager is None:
            # å»¶è¿Ÿè·å–DataManagerå®ä¾‹
            self.data_manager = self.service_container.resolve(DataManager)
        
        # ä½¿ç”¨æ‰©å±•åçš„DataManageræ–¹æ³•
        return self.data_manager.get_data_with_fallback(
            symbol=request.symbol,
            data_type=request.data_type,
            asset_type=request.parameters.get('asset_type', 'stock'),
            **request.parameters
        )
```

**Task 2.3: å®šä¹‰æ•°æ®æºäº‹ä»¶ (1å¤©)**
```python
# core/events/data_source_events.py (é¢„ä¼°200è¡Œ)
from dataclasses import dataclass
from typing import Dict, Any, Optional
from core.events.events import BaseEvent

@dataclass
class DataSourceEvent(BaseEvent):
    """æ•°æ®æºäº‹ä»¶åŸºç±»"""
    source_id: str
    timestamp: float
    
@dataclass  
class DataSourceSuccessEvent(DataSourceEvent):
    """æ•°æ®æºè¯·æ±‚æˆåŠŸäº‹ä»¶"""
    response_time: float
    data_size: int = 0

@dataclass
class DataSourceFailedEvent(DataSourceEvent):
    """æ•°æ®æºè¯·æ±‚å¤±è´¥äº‹ä»¶"""
    error: str
    request_context: Dict[str, Any]
    retry_count: int = 0

@dataclass
class DataSourceChangedEvent(DataSourceEvent):
    """æ•°æ®æºåˆ‡æ¢äº‹ä»¶"""
    old_source: str
    new_source: str
    reason: str
    asset_type: str

@dataclass
class DataSourceHealthEvent(DataSourceEvent):
    """æ•°æ®æºå¥åº·çŠ¶æ€äº‹ä»¶"""
    is_healthy: bool
    health_score: float
    error_rate: float

class DataSourceEventHandler:
    """æ•°æ®æºäº‹ä»¶å¤„ç†å™¨"""
    
    def __init__(self, event_bus, data_manager):
        self.event_bus = event_bus
        self.data_manager = data_manager
        
        # æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
        self.event_bus.subscribe('DataSourceFailedEvent', self.handle_source_failure)
        self.event_bus.subscribe('DataSourceHealthEvent', self.handle_health_change)
    
    def handle_source_failure(self, event: DataSourceFailedEvent):
        """å¤„ç†æ•°æ®æºæ•…éšœ"""
        # è‡ªåŠ¨æ•…éšœåˆ‡æ¢é€»è¾‘
        asset_type = event.request_context.get('asset_type', 'stock')
        priorities = self.data_manager._data_source_priorities.get(asset_type, [])
        
        if event.source_id in priorities:
            current_index = priorities.index(event.source_id)
            if current_index < len(priorities) - 1:
                # åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ•°æ®æº
                next_source = priorities[current_index + 1]
                
                # å‘å¸ƒåˆ‡æ¢äº‹ä»¶
                self.event_bus.publish(DataSourceChangedEvent(
                    source_id=next_source,
                    old_source=event.source_id,
                    new_source=next_source,
                    reason=f"æ•…éšœåˆ‡æ¢: {event.error}",
                    asset_type=asset_type,
                    timestamp=time.time()
                ))
```

**Task 2.4: é›†æˆæµ‹è¯•å’Œæ€§èƒ½éªŒè¯ (1å¤©)**
- æµ‹è¯•è·¯ç”±ç­–ç•¥æ­£ç¡®æ€§
- æµ‹è¯•æ•…éšœåˆ‡æ¢æœºåˆ¶
- æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆç¡®ä¿å“åº”æ—¶é—´<200msï¼‰
- äº‹ä»¶æ€»çº¿é›†æˆæµ‹è¯•

#### ğŸ“‹ äº¤ä»˜ç‰©
- [ ] DataSourceRouterè·¯ç”±å™¨å®ç°
- [ ] UnifiedDataManagerè·¯ç”±é›†æˆ
- [ ] æ•°æ®æºäº‹ä»¶å®šä¹‰å’Œå¤„ç†å™¨
- [ ] å¥åº·ç›‘æ§æœåŠ¡
- [ ] æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
- [ ] é›†æˆæµ‹è¯•ç”¨ä¾‹

---

### é˜¶æ®µä¸‰ï¼šUIç®¡ç†ç•Œé¢ï¼ˆç¬¬3-4å‘¨ï¼‰

#### ğŸ¯ ç›®æ ‡
åœ¨ç°æœ‰æ’ä»¶ç®¡ç†ç•Œé¢ä¸­é›†æˆæ•°æ®æºç®¡ç†åŠŸèƒ½ï¼Œæä¾›ç›´è§‚çš„é…ç½®å’Œç›‘æ§ç•Œé¢

#### ğŸ“ æ–‡ä»¶ä¿®æ”¹å’Œæ–°å»º

| æ–‡ä»¶è·¯å¾„ | ç±»å‹ | åŸå§‹è¡Œæ•° | ç›®æ ‡è¡Œæ•° | ä¸»è¦å˜æ›´ |
|---------|------|----------|----------|----------|
| `gui/dialogs/plugin_manager_dialog.py` | ä¿®æ”¹ | 1883 | 2000 | æ·»åŠ æ•°æ®æºé€‰é¡¹å¡ |
| `gui/dialogs/data_source_manager_widget.py` | æ–°å»º | 0 | 800 | æ•°æ®æºç®¡ç†ä¸»ç•Œé¢ |
| `gui/dialogs/data_source_config_widget.py` | æ–°å»º | 0 | 600 | æ•°æ®æºé…ç½®ç•Œé¢ |
| `gui/dialogs/data_source_monitor_widget.py` | æ–°å»º | 0 | 500 | çŠ¶æ€ç›‘æ§ç•Œé¢ |

#### ğŸ”§ å…·ä½“ä»»åŠ¡

**Task 3.1: é‡æ„ç°æœ‰æ’ä»¶ç®¡ç†å¯¹è¯æ¡† (2å¤©)**

ç”±äºç°æœ‰`plugin_manager_dialog.py`å·²è¾¾1883è¡Œï¼Œéœ€è¦è¿›è¡Œæ¨¡å—åŒ–é‡æ„ï¼š

```python
# gui/dialogs/plugin_manager_dialog.py ä¸»æ¡†æ¶éƒ¨åˆ†
class PluginManagerDialog(QDialog):
    def __init__(self, plugin_manager, parent=None):
        super().__init__(parent)
        self.plugin_manager = plugin_manager
        self.setWindowTitle("æ’ä»¶ç®¡ç†")
        self.setMinimumSize(1200, 800)
        
        self.init_ui()
    
    def init_ui(self):
        """åˆå§‹åŒ–UI - ä¸»æ¡†æ¶"""
        layout = QVBoxLayout(self)
        
        # åˆ›å»ºé€‰é¡¹å¡æ§ä»¶
        self.tab_widget = QTabWidget()
        
        # ç°æœ‰é€‰é¡¹å¡
        self.plugin_list_tab = self._create_plugin_list_tab()
        self.tab_widget.addTab(self.plugin_list_tab, "æ’ä»¶åˆ—è¡¨")
        
        self.monitoring_tab = self._create_monitoring_tab() 
        self.tab_widget.addTab(self.monitoring_tab, "æ€§èƒ½ç›‘æ§")
        
        # æ–°å¢ï¼šæ•°æ®æºç®¡ç†é€‰é¡¹å¡
        self.data_source_tab = self._create_data_source_tab()
        self.tab_widget.addTab(self.data_source_tab, "æ•°æ®æºç®¡ç†")
        
        layout.addWidget(self.tab_widget)
        
        # åº•éƒ¨æŒ‰é’®æ å¤ç”¨ç°æœ‰ä»£ç 
        self._create_button_bar(layout)
    
    def _create_data_source_tab(self) -> QWidget:
        """åˆ›å»ºæ•°æ®æºç®¡ç†é€‰é¡¹å¡"""
        from gui.dialogs.data_source_manager_widget import DataSourceManagerWidget
        
        # åµŒå…¥æ•°æ®æºç®¡ç†ç»„ä»¶
        return DataSourceManagerWidget(self.plugin_manager, self)
```

**Task 3.2: è®¾è®¡æ•°æ®æºç®¡ç†ä¸»ç•Œé¢ (3å¤©)**
```python
# gui/dialogs/data_source_manager_widget.py (é¢„ä¼°800è¡Œ)
from PyQt5.QtWidgets import *
from PyQt5.QtCore import *
from PyQt5.QtGui import *
from typing import Dict, List, Any

class DataSourceManagerWidget(QWidget):
    """æ•°æ®æºç®¡ç†ä¸»ç•Œé¢ç»„ä»¶"""
    
    def __init__(self, plugin_manager, parent=None):
        super().__init__(parent)
        self.plugin_manager = plugin_manager
        self.data_manager = None
        self.timer = QTimer()
        
        self.init_ui()
        self.setup_connections()
        self.load_data_sources()
        
    def init_ui(self):
        """åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢"""
        layout = QHBoxLayout(self)
        layout.setSpacing(10)
        
        # å·¦ä¾§é¢æ¿ï¼šæ•°æ®æºåˆ—è¡¨å’Œæ§åˆ¶
        left_panel = self._create_left_panel()
        layout.addWidget(left_panel, 2)
        
        # å³ä¾§é¢æ¿ï¼šé…ç½®å’Œç›‘æ§
        right_panel = self._create_right_panel()
        layout.addWidget(right_panel, 3)
    
    def _create_left_panel(self) -> QWidget:
        """åˆ›å»ºå·¦ä¾§æ§åˆ¶é¢æ¿"""
        panel = QWidget()
        layout = QVBoxLayout(panel)
        
        # èµ„äº§ç±»å‹é€‰æ‹©
        asset_group = QGroupBox("èµ„äº§ç±»å‹")
        asset_layout = QHBoxLayout(asset_group)
        
        self.asset_combo = QComboBox()
        self.asset_combo.addItems(["è‚¡ç¥¨", "æœŸè´§", "æ•°å­—è´§å¸", "å¤–æ±‡"])
        self.asset_combo.currentTextChanged.connect(self.on_asset_type_changed)
        asset_layout.addWidget(self.asset_combo)
        
        layout.addWidget(asset_group)
        
        # æ•°æ®æºåˆ—è¡¨
        source_group = QGroupBox("å¯ç”¨æ•°æ®æº")
        source_layout = QVBoxLayout(source_group)
        
        self.source_table = QTableWidget()
        self.source_table.setColumnCount(4)
        self.source_table.setHorizontalHeaderLabels([
            "æ•°æ®æº", "ç±»å‹", "çŠ¶æ€", "ä¼˜å…ˆçº§"
        ])
        self.source_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.source_table.itemSelectionChanged.connect(self.on_source_selection_changed)
        source_layout.addWidget(self.source_table)
        
        # æ“ä½œæŒ‰é’®
        button_layout = QHBoxLayout()
        
        self.add_btn = QPushButton("â• æ·»åŠ ")
        self.add_btn.clicked.connect(self.add_data_source)
        button_layout.addWidget(self.add_btn)
        
        self.remove_btn = QPushButton("â– ç§»é™¤")
        self.remove_btn.clicked.connect(self.remove_data_source)
        self.remove_btn.setEnabled(False)
        button_layout.addWidget(self.remove_btn)
        
        self.test_btn = QPushButton("ğŸ” æµ‹è¯•")
        self.test_btn.clicked.connect(self.test_data_source)
        self.test_btn.setEnabled(False)
        button_layout.addWidget(self.test_btn)
        
        source_layout.addLayout(button_layout)
        layout.addWidget(source_group)
        
        # ä¼˜å…ˆçº§è°ƒæ•´
        priority_group = QGroupBox("ä¼˜å…ˆçº§è®¾ç½®")
        priority_layout = QVBoxLayout(priority_group)
        
        self.priority_list = QListWidget()
        self.priority_list.setDragDropMode(QListWidget.InternalMove)
        self.priority_list.model().rowsMoved.connect(self.on_priority_changed)
        priority_layout.addWidget(self.priority_list)
        
        priority_btn_layout = QHBoxLayout()
        up_btn = QPushButton("â¬†ï¸ ä¸Šç§»")
        up_btn.clicked.connect(self.move_priority_up)
        priority_btn_layout.addWidget(up_btn)
        
        down_btn = QPushButton("â¬‡ï¸ ä¸‹ç§»") 
        down_btn.clicked.connect(self.move_priority_down)
        priority_btn_layout.addWidget(down_btn)
        
        priority_layout.addLayout(priority_btn_layout)
        layout.addWidget(priority_group)
        
        return panel
    
    def _create_right_panel(self) -> QWidget:
        """åˆ›å»ºå³ä¾§é…ç½®é¢æ¿"""
        panel = QWidget()
        layout = QVBoxLayout(panel)
        
        # é€‰é¡¹å¡ç»„ä»¶
        self.right_tab_widget = QTabWidget()
        
        # é…ç½®é€‰é¡¹å¡
        from gui.dialogs.data_source_config_widget import DataSourceConfigWidget
        self.config_widget = DataSourceConfigWidget(self)
        self.right_tab_widget.addTab(self.config_widget, "é…ç½®")
        
        # ç›‘æ§é€‰é¡¹å¡
        from gui.dialogs.data_source_monitor_widget import DataSourceMonitorWidget
        self.monitor_widget = DataSourceMonitorWidget(self)
        self.right_tab_widget.addTab(self.monitor_widget, "ç›‘æ§")
        
        layout.addWidget(self.right_tab_widget)
        return panel
```

**Task 3.3: å®ç°é…ç½®ç•Œé¢ç»„ä»¶ (2å¤©)**
```python
# gui/dialogs/data_source_config_widget.py (é¢„ä¼°600è¡Œ)
class DataSourceConfigWidget(QWidget):
    """æ•°æ®æºé…ç½®ç•Œé¢"""
    
    def __init__(self, parent_widget, parent=None):
        super().__init__(parent)
        self.parent_widget = parent_widget
        self.current_source_id = None
        self.config_controls = {}
        
        self.init_ui()
    
    def init_ui(self):
        """åˆå§‹åŒ–é…ç½®ç•Œé¢"""
        layout = QVBoxLayout(self)
        
        # åŸºç¡€é…ç½®ç»„
        basic_group = QGroupBox("åŸºç¡€é…ç½®")
        basic_layout = QFormLayout(basic_group)
        
        # å¯ç”¨çŠ¶æ€
        self.enabled_cb = QCheckBox()
        self.enabled_cb.stateChanged.connect(self.on_config_changed)
        basic_layout.addRow("å¯ç”¨:", self.enabled_cb)
        
        # ä¼˜å…ˆçº§
        self.priority_spin = QSpinBox()
        self.priority_spin.setRange(1, 100)
        self.priority_spin.valueChanged.connect(self.on_config_changed)
        basic_layout.addRow("ä¼˜å…ˆçº§:", self.priority_spin)
        
        # è¶…æ—¶è®¾ç½®
        self.timeout_spin = QSpinBox()
        self.timeout_spin.setRange(1, 300)
        self.timeout_spin.setSuffix(" ç§’")
        self.timeout_spin.valueChanged.connect(self.on_config_changed)
        basic_layout.addRow("è¶…æ—¶æ—¶é—´:", self.timeout_spin)
        
        layout.addWidget(basic_group)
        
        # é«˜çº§é…ç½®ç»„ (åŠ¨æ€ç”Ÿæˆ)
        self.advanced_group = QGroupBox("é«˜çº§é…ç½®")
        self.advanced_layout = QFormLayout(self.advanced_group)
        layout.addWidget(self.advanced_group)
        
        # ä¿å­˜æŒ‰é’®
        save_btn = QPushButton("ğŸ’¾ ä¿å­˜é…ç½®")
        save_btn.clicked.connect(self.save_config)
        layout.addWidget(save_btn)
        
        layout.addStretch()
    
    def load_source_config(self, source_id: str):
        """åŠ è½½æ•°æ®æºé…ç½®"""
        self.current_source_id = source_id
        
        # æ¸…é™¤ç°æœ‰é«˜çº§é…ç½®æ§ä»¶
        self._clear_advanced_config()
        
        # æ ¹æ®æ•°æ®æºç±»å‹åŠ¨æ€åˆ›å»ºé…ç½®æ§ä»¶
        self._create_type_specific_config(source_id)
        
        # åŠ è½½ä¿å­˜çš„é…ç½®å€¼
        self._load_saved_config(source_id)
```

**Task 3.4: å®ç°çŠ¶æ€ç›‘æ§ç•Œé¢ (2å¤©)**
```python
# gui/dialogs/data_source_monitor_widget.py (é¢„ä¼°500è¡Œ)
class DataSourceMonitorWidget(QWidget):
    """æ•°æ®æºçŠ¶æ€ç›‘æ§ç•Œé¢"""
    
    def __init__(self, parent_widget, parent=None):
        super().__init__(parent)
        self.parent_widget = parent_widget
        self.update_timer = QTimer()
        
        self.init_ui()
        self.setup_timer()
    
    def init_ui(self):
        """åˆå§‹åŒ–ç›‘æ§ç•Œé¢"""
        layout = QVBoxLayout(self)
        
        # å®æ—¶çŠ¶æ€æ¦‚è§ˆ
        status_group = QGroupBox("å®æ—¶çŠ¶æ€")
        status_layout = QGridLayout(status_group)
        
        # çŠ¶æ€æŒ‡æ ‡æ ‡ç­¾
        self.total_requests_label = QLabel("0")
        self.success_rate_label = QLabel("0%")
        self.avg_response_label = QLabel("0ms")
        
        status_layout.addWidget(QLabel("æ€»è¯·æ±‚æ•°:"), 0, 0)
        status_layout.addWidget(self.total_requests_label, 0, 1)
        status_layout.addWidget(QLabel("æˆåŠŸç‡:"), 0, 2)
        status_layout.addWidget(self.success_rate_label, 0, 3)
        status_layout.addWidget(QLabel("å¹³å‡å“åº”:"), 1, 0)
        status_layout.addWidget(self.avg_response_label, 1, 1)
        
        layout.addWidget(status_group)
        
        # è¯¦ç»†ç›‘æ§è¡¨æ ¼
        detail_group = QGroupBox("è¯¦ç»†ç›‘æ§")
        detail_layout = QVBoxLayout(detail_group)
        
        self.monitor_table = QTableWidget()
        self.monitor_table.setColumnCount(6)
        self.monitor_table.setHorizontalHeaderLabels([
            "æ•°æ®æº", "çŠ¶æ€", "è¯·æ±‚æ•°", "æˆåŠŸç‡", "å“åº”æ—¶é—´", "æœ€åé”™è¯¯"
        ])
        detail_layout.addWidget(self.monitor_table)
        
        layout.addWidget(detail_group)
    
    def setup_timer(self):
        """è®¾ç½®å®šæ—¶æ›´æ–°"""
        self.update_timer.timeout.connect(self.update_monitoring_data)
        self.update_timer.start(5000)  # 5ç§’æ›´æ–°ä¸€æ¬¡
```

**Task 3.5: é›†æˆæµ‹è¯•å’ŒUIä¼˜åŒ– (1å¤©)**
- UIå“åº”æ€§æµ‹è¯•
- ç”¨æˆ·äº¤äº’æµç¨‹æµ‹è¯•
- ç•Œé¢æ ·å¼ä¼˜åŒ–
- é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

#### ğŸ“‹ äº¤ä»˜ç‰©
- [ ] é‡æ„åçš„æ’ä»¶ç®¡ç†å¯¹è¯æ¡†
- [ ] æ•°æ®æºç®¡ç†ä¸»ç•Œé¢ç»„ä»¶
- [ ] æ•°æ®æºé…ç½®ç•Œé¢
- [ ] çŠ¶æ€ç›‘æ§ç•Œé¢
- [ ] UIé›†æˆæµ‹è¯•ç”¨ä¾‹
- [ ] ç”¨æˆ·æ“ä½œæ‰‹å†Œ

---

## ğŸ§ª ç»¼åˆæµ‹è¯•æ–¹æ¡ˆ

### å•å…ƒæµ‹è¯•è®¡åˆ’

#### æµ‹è¯•è¦†ç›–èŒƒå›´
```
core/data_source_extensions.py
â”œâ”€â”€ IDataSourcePluginæ¥å£å®ç°æµ‹è¯•
â”œâ”€â”€ DataSourcePluginAdapteré€‚é…å™¨æµ‹è¯•
â””â”€â”€ æ’ä»¶ç”Ÿå‘½å‘¨æœŸæµ‹è¯•

core/data_manager.py (æ‰©å±•éƒ¨åˆ†)
â”œâ”€â”€ æ’ä»¶æ³¨å†ŒåŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ ä¼˜å…ˆçº§ç®¡ç†æµ‹è¯•
â”œâ”€â”€ æ•…éšœåˆ‡æ¢é€»è¾‘æµ‹è¯•
â””â”€â”€ å‘ä¸‹å…¼å®¹æ€§æµ‹è¯•

core/services/data_source_router.py
â”œâ”€â”€ è·¯ç”±ç­–ç•¥æµ‹è¯• (priority, health_based, round_robin)
â”œâ”€â”€ ç»Ÿè®¡ä¿¡æ¯æ”¶é›†æµ‹è¯•
â””â”€â”€ æ€§èƒ½æŒ‡æ ‡æµ‹è¯•

guiç»„ä»¶æµ‹è¯•
â”œâ”€â”€ ç•Œé¢å…ƒç´ åˆ›å»ºæµ‹è¯•
â”œâ”€â”€ ç”¨æˆ·äº¤äº’æµ‹è¯•
â””â”€â”€ æ•°æ®ç»‘å®šæµ‹è¯•
```

#### æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹
```python
# tests/test_data_source_extensions.py
import unittest
from unittest.mock import Mock, patch
import pandas as pd
from core.data_source_extensions import IDataSourcePlugin, DataSourcePluginAdapter

class TestDataSourcePlugin(unittest.TestCase):
    
    def setUp(self):
        self.mock_plugin = Mock(spec=IDataSourcePlugin)
        self.mock_plugin.initialize.return_value = True
        self.mock_plugin.health_check.return_value = True
        self.mock_plugin.fetch_data.return_value = pd.DataFrame({
            'close': [100, 101, 102],
            'volume': [1000, 1100, 1200]
        })
        
    def test_plugin_adapter_initialization(self):
        """æµ‹è¯•æ’ä»¶é€‚é…å™¨åˆå§‹åŒ–"""
        adapter = DataSourcePluginAdapter(self.mock_plugin)
        self.assertFalse(adapter._is_connected)
        
        # æµ‹è¯•è¿æ¥
        result = adapter.connect()
        self.assertTrue(result)
        self.mock_plugin.initialize.assert_called_once()
    
    def test_plugin_data_fetch(self):
        """æµ‹è¯•æ•°æ®è·å–é€‚é…"""
        adapter = DataSourcePluginAdapter(self.mock_plugin)
        adapter.connect()
        
        data = adapter.get_kdata('000001', 'D')
        self.assertFalse(data.empty)
        self.assertIn('close', data.columns)
        self.mock_plugin.fetch_data.assert_called_once()

# tests/test_data_manager_extensions.py  
class TestDataManagerExtensions(unittest.TestCase):
    
    def setUp(self):
        self.data_manager = DataManager()
        self.mock_plugin = Mock(spec=IDataSourcePlugin)
        
    def test_plugin_registration(self):
        """æµ‹è¯•æ’ä»¶æ³¨å†Œ"""
        self.mock_plugin.initialize.return_value = True
        
        result = self.data_manager.register_plugin_data_source(
            'test_plugin', self.mock_plugin
        )
        
        self.assertTrue(result)
        self.assertIn('test_plugin', self.data_manager._plugin_data_sources)
        self.assertIn('test_plugin', self.data_manager._data_sources)
    
    def test_failover_mechanism(self):
        """æµ‹è¯•æ•…éšœåˆ‡æ¢æœºåˆ¶"""
        # è®¾ç½®ä¼˜å…ˆçº§
        self.data_manager.set_data_source_priority('stock', ['source1', 'source2'])
        
        # æ¨¡æ‹Ÿç¬¬ä¸€ä¸ªæ•°æ®æºå¤±è´¥
        with patch.object(self.data_manager, '_check_source_health') as mock_health:
            mock_health.side_effect = [False, True]  # ç¬¬ä¸€ä¸ªå¤±è´¥ï¼Œç¬¬äºŒä¸ªæˆåŠŸ
            
            # åº”è¯¥åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªæ•°æ®æº
            # ... æµ‹è¯•é€»è¾‘
```

### é›†æˆæµ‹è¯•è®¡åˆ’

#### æµ‹è¯•åœºæ™¯
1. **æ•°æ®ä¸€è‡´æ€§æµ‹è¯•**
   - ä¸åŒæ•°æ®æºè¿”å›æ•°æ®æ ¼å¼ä¸€è‡´æ€§
   - ç¼“å­˜æ•°æ®ä¸å®æ—¶æ•°æ®ä¸€è‡´æ€§
   - å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ•°æ®ä¸€è‡´æ€§

2. **æ€§èƒ½åŸºå‡†æµ‹è¯•**
   ```python
   # tests/performance/test_routing_performance.py
   import time
   import statistics
   
   class RoutingPerformanceTest(unittest.TestCase):
       
       def test_routing_latency(self):
           """æµ‹è¯•è·¯ç”±å»¶è¿Ÿ"""
           router = DataSourceRouter()
           latencies = []
           
           for _ in range(100):
               start = time.time()
               plan = router.route_request({'asset_type': 'stock'})
               latency = (time.time() - start) * 1000  # ms
               latencies.append(latency)
           
           avg_latency = statistics.mean(latencies)
           p95_latency = statistics.quantiles(latencies, n=20)[18]  # 95th percentile
           
           self.assertLess(avg_latency, 10, "å¹³å‡è·¯ç”±å»¶è¿Ÿåº”å°äº10ms")
           self.assertLess(p95_latency, 50, "P95è·¯ç”±å»¶è¿Ÿåº”å°äº50ms")
   ```

3. **æ•…éšœæ¢å¤æµ‹è¯•**
   ```python
   def test_automatic_failover(self):
       """æµ‹è¯•è‡ªåŠ¨æ•…éšœåˆ‡æ¢"""
       # æ¨¡æ‹Ÿä¸»æ•°æ®æºæ•…éšœ
       # éªŒè¯è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®æº
       # éªŒè¯æ•…éšœæ¢å¤åè‡ªåŠ¨åˆ‡å›
   ```

### å…¼å®¹æ€§æµ‹è¯•è®¡åˆ’

#### å‘ä¸‹å…¼å®¹æ€§éªŒè¯
```python
# tests/compatibility/test_backward_compatibility.py
class BackwardCompatibilityTest(unittest.TestCase):
    
    def test_existing_api_unchanged(self):
        """æµ‹è¯•ç°æœ‰APIæ¥å£æœªå˜æ›´"""
        data_manager = DataManager()
        
        # æµ‹è¯•ç°æœ‰æ–¹æ³•ä»ç„¶å¯ç”¨
        self.assertTrue(hasattr(data_manager, 'set_data_source'))
        self.assertTrue(hasattr(data_manager, 'get_kdata'))
        
        # æµ‹è¯•ç°æœ‰è°ƒç”¨æ–¹å¼ä»ç„¶æœ‰æ•ˆ
        data_manager.set_data_source('hikyuu')
        # ... å…¶ä»–å…¼å®¹æ€§æµ‹è¯•
    
    def test_configuration_compatibility(self):
        """æµ‹è¯•é…ç½®æ–‡ä»¶å…¼å®¹æ€§"""
        # æµ‹è¯•ç°æœ‰é…ç½®æ–‡ä»¶æ ¼å¼ä»ç„¶è¢«æ”¯æŒ
        # æµ‹è¯•æ–°å¢é…ç½®é¡¹æœ‰åˆç†é»˜è®¤å€¼
```

---

## âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹

### ä»£ç è´¨é‡æ§åˆ¶

#### æ–‡ä»¶è¡Œæ•°é™åˆ¶ç­–ç•¥
```
ä¸¥æ ¼æ§åˆ¶å•æ–‡ä»¶è¡Œæ•° â‰¤ 2500è¡Œçš„ç­–ç•¥:

1. åŠŸèƒ½æ¨¡å—åŒ–åˆ†ç¦»
   - å°†å¤§å‹ç±»æ‹†åˆ†ä¸ºå¤šä¸ªä¸“é—¨çš„å°ç±»
   - ä½¿ç”¨ç»„åˆæ¨¡å¼æ›¿ä»£ç»§æ‰¿
   - æŠ½å–å…¬å…±åŠŸèƒ½åˆ°ç‹¬ç«‹çš„å·¥å…·æ¨¡å—

2. UIç»„ä»¶åˆ†å±‚
   - ä¸»å¯¹è¯æ¡†åªè´Ÿè´£å¸ƒå±€å’Œåè°ƒ
   - å…·ä½“åŠŸèƒ½é¢æ¿ç‹¬ç«‹æˆå•ç‹¬æ–‡ä»¶
   - é…ç½®æ§ä»¶æŒ‰ç±»å‹åˆ†ç»„åˆ°ä¸åŒæ–‡ä»¶

3. ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
   - æ•°æ®è®¿é—®é€»è¾‘ç‹¬ç«‹
   - ä¸šåŠ¡é€»è¾‘ä¸UIé€»è¾‘åˆ†ç¦»
   - å·¥å…·å‡½æ•°æå–åˆ°ç‹¬ç«‹æ¨¡å—

4. é‡æ„ç°æœ‰å¤§æ–‡ä»¶
   plugin_manager_dialog.py (1883è¡Œ) â†’ æ‹†åˆ†ä¸º:
   â”œâ”€â”€ plugin_manager_dialog.py (ä¸»æ¡†æ¶, 500è¡Œ)
   â”œâ”€â”€ plugin_list_widget.py (æ’ä»¶åˆ—è¡¨, 600è¡Œ)
   â”œâ”€â”€ plugin_config_widget.py (é…ç½®é¢æ¿, 500è¡Œ)
   â””â”€â”€ plugin_monitor_widget.py (ç›‘æ§é¢æ¿, 400è¡Œ)
```

#### ä»£ç è§„èŒƒè¦æ±‚
```python
# 1. ç±»èŒè´£å•ä¸€
class DataSourceRouter:
    """å•ä¸€èŒè´£ï¼šåªè´Ÿè´£è·¯ç”±å†³ç­–ï¼Œä¸å¤„ç†æ•°æ®è·å–"""
    pass

class DataSourceHealthMonitor:  
    """å•ä¸€èŒè´£ï¼šåªè´Ÿè´£å¥åº·ç›‘æ§ï¼Œä¸å¤„ç†è·¯ç”±é€»è¾‘"""
    pass

# 2. æ–¹æ³•é•¿åº¦æ§åˆ¶
def route_request(self, params):
    """å•ä¸ªæ–¹æ³•ä¸è¶…è¿‡50è¡Œ"""
    # å°†å¤æ‚é€»è¾‘æ‹†åˆ†ä¸ºå¤šä¸ªç§æœ‰æ–¹æ³•
    validated_params = self._validate_params(params)
    available_sources = self._get_available_sources(validated_params)
    return self._select_optimal_source(available_sources)

# 3. æ³¨é‡Šå’Œæ–‡æ¡£
class IDataSourcePlugin(ABC):
    """
    æ•°æ®æºæ’ä»¶æ ‡å‡†æ¥å£
    
    ç”¨äºç»Ÿä¸€ä¸åŒæ•°æ®æºçš„æ¥å£ï¼Œæ”¯æŒå¤šç§èµ„äº§ç±»å‹å’Œæ•°æ®ç±»å‹ã€‚
    å®ç°æ­¤æ¥å£çš„æ’ä»¶å¯ä»¥æ— ç¼é›†æˆåˆ°FactorWeave-Quant çš„æ•°æ®ç®¡ç†ç³»ç»Ÿä¸­ã€‚
    
    ç¤ºä¾‹:
        class MyDataSource(IDataSourcePlugin):
            def fetch_data(self, symbol, data_type, **kwargs):
                # å®ç°æ•°æ®è·å–é€»è¾‘
                return pd.DataFrame()
    """
```

### é£é™©æ§åˆ¶æªæ–½

#### ç°æœ‰åŠŸèƒ½ä¿æŠ¤
```python
# 1. æ¸è¿›å¼æ‰©å±•ï¼Œé¿å…ç ´åæ€§å˜æ›´
class DataManager:
    def __init__(self):
        # ä¿æŒç°æœ‰åˆå§‹åŒ–é€»è¾‘ä¸å˜
        self.existing_initialization()
        
        # æ–°å¢åŠŸèƒ½ç”¨ç‹¬ç«‹çš„æ–¹æ³•å’Œå±æ€§
        self._initialize_plugin_support()
    
    # ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜
    def set_data_source(self, source: str) -> None:
        """ä¿æŒç°æœ‰APIä¸å˜ï¼Œç¡®ä¿å‘ä¸‹å…¼å®¹"""
        # ç°æœ‰é€»è¾‘ä¿æŒä¸å˜
        pass
    
    # æ–°å¢æ–¹æ³•ä½¿ç”¨ä¸åŒçš„å‘½å
    def register_plugin_data_source(self, plugin_id: str, plugin) -> bool:
        """æ–°å¢æ–¹æ³•ï¼Œä¸å½±å“ç°æœ‰é€»è¾‘"""
        pass

# 2. ä¼˜é›…é™çº§æœºåˆ¶
def get_data_with_fallback(self, **kwargs):
    """æ–°åŠŸèƒ½å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°ç°æœ‰é€»è¾‘"""
    try:
        # å°è¯•ä½¿ç”¨æ–°çš„æ’ä»¶åŒ–è·¯ç”±
        return self._get_data_via_plugin_routing(**kwargs)
    except Exception as e:
        self.logger.warning(f"æ’ä»¶è·¯ç”±å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ–¹å¼: {e}")
        # å›é€€åˆ°ç°æœ‰çš„æ•°æ®è·å–æ–¹å¼
        return self._get_data_traditional_way(**kwargs)
```

#### çº¿ç¨‹å®‰å…¨ä¿è¯
```python
import threading
from concurrent.futures import ThreadPoolExecutor

class ThreadSafeDataSourceManager:
    def __init__(self):
        self._lock = threading.RLock()
        self._source_locks = {}  # æ¯ä¸ªæ•°æ®æºä¸€ä¸ªé”
        
    def register_plugin_data_source(self, plugin_id: str, plugin):
        """çº¿ç¨‹å®‰å…¨çš„æ’ä»¶æ³¨å†Œ"""
        with self._lock:
            # æ³¨å†Œé€»è¾‘
            pass
    
    def get_data_with_routing(self, **kwargs):
        """çº¿ç¨‹å®‰å…¨çš„æ•°æ®è·å–"""
        source_id = self._determine_source(**kwargs)
        
        # è·å–æˆ–åˆ›å»ºæ•°æ®æºä¸“ç”¨é”
        with self._lock:
            if source_id not in self._source_locks:
                self._source_locks[source_id] = threading.Lock()
        
        # ä½¿ç”¨æ•°æ®æºä¸“ç”¨é”
        with self._source_locks[source_id]:
            return self._fetch_data_from_source(source_id, **kwargs)
```

#### æ€§èƒ½å½±å“æœ€å°åŒ–
```python
# 1. æ‡’åŠ è½½æœºåˆ¶
class DataSourceRouter:
    def __init__(self):
        self._routing_cache = {}
        self._cache_ttl = 300  # 5åˆ†é’Ÿç¼“å­˜
        
    def route_request(self, params):
        """ä½¿ç”¨ç¼“å­˜å‡å°‘è·¯ç”±è®¡ç®—å¼€é”€"""
        cache_key = self._generate_cache_key(params)
        
        if cache_key in self._routing_cache:
            cached_time, cached_plan = self._routing_cache[cache_key]
            if time.time() - cached_time < self._cache_ttl:
                return cached_plan
        
        # è®¡ç®—æ–°çš„è·¯ç”±è®¡åˆ’
        plan = self._calculate_routing_plan(params)
        self._routing_cache[cache_key] = (time.time(), plan)
        return plan

# 2. å¼‚æ­¥å¤„ç†
async def async_health_check(self):
    """å¼‚æ­¥å¥åº·æ£€æŸ¥ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹"""
    async with aiohttp.ClientSession() as session:
        tasks = []
        for source_id in self.data_sources:
            task = self._check_source_health_async(session, source_id)
            tasks.append(task)
        
        results = await asyncio.gather(*tasks, return_exceptions=True)
        self._update_health_status(results)
```

### æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

#### æœ€ä½è¦†ç›–ç‡æ ‡å‡†
```
æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è¦†ç›–ç‡è¦æ±‚ï¼š
â”œâ”€â”€ æ•°æ®æºæ¥å£å’Œé€‚é…å™¨: â‰¥95%
â”œâ”€â”€ è·¯ç”±å’Œæ•…éšœåˆ‡æ¢é€»è¾‘: â‰¥90%
â”œâ”€â”€ é…ç½®ç®¡ç†: â‰¥85%
â”œâ”€â”€ UIäº¤äº’é€»è¾‘: â‰¥80%
â””â”€â”€ äº‹ä»¶å¤„ç†: â‰¥85%

æ•´ä½“é¡¹ç›®è¦†ç›–ç‡: â‰¥85%
```

#### å…³é”®æµ‹è¯•åœºæ™¯
```python
# å¿…æµ‹åœºæ™¯æ¸…å•
test_scenarios = [
    "æ’ä»¶æ³¨å†Œå’Œæ³¨é”€",
    "æ•°æ®æºä¼˜å…ˆçº§è°ƒæ•´", 
    "ä¸»æ•°æ®æºæ•…éšœæ—¶çš„è‡ªåŠ¨åˆ‡æ¢",
    "æ•°æ®æºæ¢å¤åçš„è‡ªåŠ¨åˆ‡å›",
    "å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§",
    "é…ç½®çƒ­æ›´æ–°",
    "ç•Œé¢å…ƒç´ çŠ¶æ€åŒæ­¥",
    "æ€§èƒ½åŸºå‡†è¾¾æ ‡",
    "å†…å­˜æ³„æ¼æ£€æµ‹",
    "å‘ä¸‹å…¼å®¹æ€§éªŒè¯"
]
```

---

## ğŸ“… é¡¹ç›®é‡Œç¨‹ç¢‘

### Week 1: æ ¸å¿ƒæ‰©å±•
- [ ] Day 1: æ’ä»¶æ¥å£è®¾è®¡å®Œæˆ
- [ ] Day 2-3: DataManageræ‰©å±•å®ç°
- [ ] Day 4: PluginManageræ‰©å±•å®ç°  
- [ ] Day 5: å•å…ƒæµ‹è¯•å’Œé›†æˆéªŒè¯

### Week 2: æ™ºèƒ½è·¯ç”±
- [ ] Day 1-2: è·¯ç”±å™¨è®¾è®¡å’Œå®ç°
- [ ] Day 3-4: UnifiedDataManageré›†æˆ
- [ ] Day 5: äº‹ä»¶ç³»ç»Ÿé›†æˆå’Œæµ‹è¯•

### Week 3: UIåŸºç¡€
- [ ] Day 1-2: ç°æœ‰å¯¹è¯æ¡†é‡æ„
- [ ] Day 3-4: æ•°æ®æºç®¡ç†ä¸»ç•Œé¢
- [ ] Day 5: é…ç½®ç•Œé¢åŸºç¡€å®ç°

### Week 4: UIå®Œå–„
- [ ] Day 1-2: ç›‘æ§ç•Œé¢å®ç°
- [ ] Day 3: UIé›†æˆå’Œä¼˜åŒ–
- [ ] Day 4: ç»¼åˆæµ‹è¯•
- [ ] Day 5: æ–‡æ¡£å’Œäº¤ä»˜

### è´¨é‡é—¨ç¦
- âœ… æ¯å‘¨æœ«ä»£ç å®¡æŸ¥
- âœ… æ€§èƒ½åŸºå‡†éªŒè¯
- âœ… å…¼å®¹æ€§æµ‹è¯•é€šè¿‡
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡

---

## ğŸ“ˆ æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡
- [ ] ä»£ç è¦†ç›–ç‡ â‰¥85%
- [ ] è·¯ç”±å»¶è¿Ÿ <10ms (P95 <50ms)
- [ ] æ•…éšœåˆ‡æ¢æ—¶é—´ <5ç§’
- [ ] å†…å­˜ä½¿ç”¨å¢é•¿ <20MB
- [ ] å•æ–‡ä»¶è¡Œæ•° â‰¤2500è¡Œ

### åŠŸèƒ½æŒ‡æ ‡  
- [ ] æ”¯æŒè‡³å°‘3ç§æ–°æ•°æ®æºæ’ä»¶
- [ ] æ•…éšœåˆ‡æ¢æˆåŠŸç‡ >99%
- [ ] é…ç½®çƒ­æ›´æ–°å“åº” <1ç§’
- [ ] UIæ“ä½œå“åº” <200ms

### ä¸šåŠ¡æŒ‡æ ‡
- [ ] å‘ä¸‹å…¼å®¹ç‡ 100%
- [ ] å¼€å‘æ•ˆç‡æå‡ 70%
- [ ] ä»£ç ç»´æŠ¤æˆæœ¬é™ä½ 50%
- [ ] ç”¨æˆ·æ»¡æ„åº¦ >4.5/5.0

é€šè¿‡è¿™ä¸ªè¯¦ç»†çš„å¼€å‘è®¡åˆ’ï¼Œæˆ‘ä»¬èƒ½å¤Ÿç¡®ä¿åœ¨ä¸¥æ ¼æ§åˆ¶ä»£ç è¡Œæ•°çš„åŒæ—¶ï¼Œé«˜è´¨é‡åœ°å®Œæˆæ’ä»¶åŒ–æ•°æ®æºçš„è½»é‡çº§æ”¹é€ ï¼Œæœ€å¤§åŒ–å¤ç”¨ç°æœ‰ç³»ç»Ÿèƒ½åŠ›ï¼Œæœ€å°åŒ–å¼€å‘é£é™©ã€‚ 