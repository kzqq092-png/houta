# 数据库目录统一和修复指南

## 目录结构分析

### 1. 历史遗留
- **data/databases**: 旧架构目录（已在2025-10-14迁移完成，应该为空）
- **db/databases**: 新架构统一目录（当前使用）

### 2. 迁移历史
根据DATABASE_MIGRATION_SUCCESS_REPORT.md (2025-10-14):
- 将data/databases下的数据迁移到db/databases
- 更新所有代码配置使用db/databases
- AssetDatabaseConfig.base_path = "db/databases"

## 当前问题

### 1. data/databases目录
- **状态**: 已清空
- **原因**: 之前迁移后产生的临时文件
- **处理**: 已删除

### 2. db/databases/stock_a/stock_a_data.duckdb
- **状态**: 文件损坏（UnicodeDecodeError）
- **原因**: 表结构不匹配（使用了错误的datetime/timestamp字段）
- **处理**: 需要删除重建
- **文件**: 
  - stock_a_data.duckdb (损坏)
  - stock_a_data.duckdb.wal (WAL日志)

## 根本原因

### 表结构不一致历史
1. **原始错误**: 之前修复时错误地将表结构改为使用datetime字段和(symbol, datetime, frequency)主键
2. **正确架构**: 应该使用timestamp字段和(symbol, data_source, timestamp, frequency)主键
3. **本次修复**: 已恢复正确的表结构定义

## 完整解决方案

### 步骤1：清理损坏数据库（手动）
由于文件被占用，需要手动操作：
1. 关闭所有Python进程和应用
2. 删除 `db/databases/stock_a/stock_a_data.duckdb*`
3. 可选：清理其他资产类型的旧数据库

### 步骤2：验证配置
确认配置正确：
```python
# core/asset_database_manager.py Line 35
base_path: str = "db/databases"  # ✅ 正确
```

### 步骤3：重新导入数据
使用数据导入功能：
1. 选择数据源（如：通达信、AKShare等）
2. 选择资产类型（如：A股）
3. 执行导入

系统会自动：
1. 创建正确的表结构（使用timestamp字段）
2. 插入K线数据到historical_kline_data表
3. 保存资产元数据到asset_metadata表
4. 创建unified_best_quality_kline等视图

### 步骤4：验证
1. 检查资产列表是否显示
2. 检查K线数据是否可查询
3. 检查多数据源是否能共存

## 新架构关键点

### 1. 表结构标准
```sql
CREATE TABLE historical_kline_data (
    symbol VARCHAR NOT NULL,
    data_source VARCHAR NOT NULL,  -- 重要！支持多数据源
    timestamp TIMESTAMP NOT NULL,   -- 使用timestamp，非datetime
    frequency VARCHAR NOT NULL DEFAULT '1d',
    ...
    PRIMARY KEY (symbol, data_source, timestamp, frequency)
)
```

### 2. 字段映射
- 数据标准化时使用datetime字段
- 插入数据库时自动映射: datetime → timestamp
- 映射在_filter_dataframe_columns中自动处理

### 3. 数据流
```
插件数据(datetime) 
  ↓ _standardize_kline_data_fields
datetime字段
  ↓ _filter_dataframe_columns 
timestamp字段
  ↓ INSERT
historical_kline_data表
```

### 4. 多数据源支持
同一symbol可以有多个data_source的数据：
- 通达信: data_source='tongdaxin'
- AKShare: data_source='akshare'
- Tushare: data_source='tushare'

unified_best_quality_kline视图自动选择最优质量数据。

## 配置文件位置
- 数据库管理: core/asset_database_manager.py
- 数据导入: core/importdata/import_execution_engine.py
- 统一管理: core/services/unified_data_manager.py

## 目录规范
**统一使用**: `db/databases/` 
**废弃**: `data/databases/` (已清空，不再使用)

所有资产类型存储在：
- db/databases/stock_a/
- db/databases/crypto/
- db/databases/stock_us/
- db/databases/fund/
- 等等...

## 注意事项
1. 旧数据库文件不兼容，必须删除重建
2. 不要手动创建数据库文件，让系统自动创建
3. 确保没有混用data/databases路径
4. WAL文件会自动生成，不需要手动管理
5. 表结构由系统自动创建，不需要手动初始化

## 相关修复
本次会话完成的修复：
1. ValidationResult参数修复
2. SQL表名schema前缀修复  
3. 新架构表结构恢复（timestamp字段和完整主键）
4. 字段映射和索引修复
5. 数据库目录清理
