# 新架构表结构修复完整方案

## 问题描述
用户删除历史表数据后，下载数据后资产列表没有数据，新架构的表和视图异常。

## 根本原因
之前的修复错误地将表结构改为：
- 字段名：`datetime`（错误）
- 主键：`(symbol, datetime, frequency)`（错误，缺少data_source）

但**新架构**的正确定义应该是（见core/asset_database_manager.py Line 165-201）：
- 字段名：`timestamp`
- 主键：`(symbol, data_source, timestamp, frequency)`

## 新架构核心设计

### 1. 分库存储
- `db/databases/stock_a/stock_a_data.duckdb` - A股数据
- `db/databases/crypto/crypto_data.duckdb` - 加密货币
- 每个资产类型独立数据库，使用统一表名

### 2. 表结构

#### historical_kline_data表
```sql
CREATE TABLE historical_kline_data (
    -- 主键字段
    symbol VARCHAR NOT NULL,
    data_source VARCHAR NOT NULL,         -- 数据源标识
    timestamp TIMESTAMP NOT NULL,         -- 时间戳（非datetime）
    frequency VARCHAR NOT NULL DEFAULT '1d',
    
    -- OHLCV字段
    open DECIMAL(10,2) NOT NULL,
    high DECIMAL(10,2) NOT NULL,
    low DECIMAL(10,2) NOT NULL,
    close DECIMAL(10,2) NOT NULL,
    volume BIGINT DEFAULT 0,
    amount DECIMAL(18,2) DEFAULT 0,
    
    -- 扩展字段
    turnover DECIMAL(18,2) DEFAULT 0,
    adj_close DECIMAL(10,4),
    adj_factor DECIMAL(10,6) DEFAULT 1.0,
    turnover_rate DECIMAL(8,2),
    vwap DECIMAL(10,2),
    change DECIMAL(10,2),
    change_pct DECIMAL(8,2),
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (symbol, data_source, timestamp, frequency)
)
```

**关键点**：
- 使用`timestamp`字段（不是datetime）
- 主键包含`data_source`，支持多数据源共存
- name、market等元数据字段已移除，改用asset_metadata表关联

#### asset_metadata表
```sql
CREATE TABLE asset_metadata (
    symbol VARCHAR PRIMARY KEY,
    name VARCHAR NOT NULL,
    market VARCHAR NOT NULL,
    asset_type VARCHAR NOT NULL,
    exchange VARCHAR,
    sector VARCHAR,
    industry VARCHAR,
    listing_date DATE,
    data_sources VARCHAR,              -- JSON数组
    primary_data_source VARCHAR,
    ...
)
```

### 3. 数据流程

1. **数据导入**：
   - 插件返回数据（字段可能叫datetime、date等）
   - `_standardize_kline_data_fields`标准化为datetime字段
   - `_filter_dataframe_columns`自动映射datetime→timestamp
   - 插入到historical_kline_data表（使用timestamp字段）
   
2. **元数据保存**：
   - 提取资产信息（从插件的get_stock_list()）
   - 调用`upsert_asset_metadata`保存到asset_metadata表
   
3. **查询**：
   - UI查询asset_metadata获取资产列表
   - 查询unified_best_quality_kline视图获取最优质量数据
   - 视图自动JOIN historical_kline_data和data_quality_monitor

## 本次修复

### 1. 表创建SQL修复 (Line 837-859)
恢复正确的表结构：
- 字段名：timestamp（不是datetime）
- 主键：(symbol, data_source, timestamp, frequency)
- 添加created_at字段

### 2. ON CONFLICT子句修复 (Line 1067-1073)
与主键完全一致：
```sql
ON CONFLICT (symbol, data_source, timestamp, frequency) DO UPDATE SET
```

### 3. 字段映射保持 (Line 987)
```python
field_mapping = {
    'datetime': 'timestamp'  # 数据中的datetime自动映射到表中的timestamp
}
```

### 4. 索引修复 (Line 956-959)
```python
CREATE INDEX idx_historical_kline_data_symbol ON historical_kline_data(symbol)
CREATE INDEX idx_historical_kline_data_timestamp ON historical_kline_data(timestamp)
CREATE INDEX idx_historical_kline_data_symbol_timestamp ON historical_kline_data(symbol, timestamp)
CREATE INDEX idx_historical_kline_data_data_source ON historical_kline_data(data_source)
```

## 验证要点

1. **表结构**：检查historical_kline_data表是否使用timestamp字段和正确主键
2. **数据导入**：导入数据后检查K线数据和asset_metadata表
3. **资产列表**：UI应该能正确显示资产列表（从asset_metadata表）
4. **视图**：unified_best_quality_kline视图应该能正常工作
5. **多数据源**：同一symbol的不同数据源数据应该能共存

## 修改文件
- core/asset_database_manager.py
  - Line 837-859: 表结构定义
  - Line 1050-1073: ON CONFLICT子句
  - Line 987: 字段映射
  - Line 956-959: 索引创建

## 注意事项
1. 旧数据库文件需要删除重建（表结构已变更）
2. 标准化函数继续使用datetime字段，映射在插入时自动进行
3. data_source字段很重要，不能省略
4. 所有查询和视图都应该使用timestamp字段名
