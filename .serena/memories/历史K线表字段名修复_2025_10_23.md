# 历史K线数据表字段名不一致修复

## 问题描述
数据插入失败，错误信息：
```
Binder Error: Table "historical_kline_data" does not have a column with name "timestamp"
```

## 根本原因
表结构定义与ON CONFLICT子句中使用的字段名不一致：

### 表结构定义 (line 838 in asset_database_manager.py)
```sql
CREATE TABLE historical_kline_data (
    symbol VARCHAR,
    market VARCHAR,
    datetime TIMESTAMP,  -- 使用datetime
    ...
    PRIMARY KEY (symbol, datetime, frequency)  -- 主键使用datetime
)
```

### ON CONFLICT子句 (原line 1061)
```sql
ON CONFLICT (symbol, data_source, timestamp, frequency) DO UPDATE SET
```

**两处不一致**：
1. 字段名：表定义用`datetime`，ON CONFLICT用`timestamp`
2. 主键字段：表定义是`(symbol, datetime, frequency)`，ON CONFLICT用`(symbol, data_source, timestamp, frequency)`

## 修复方案
统一使用`datetime`字段名，使ON CONFLICT与PRIMARY KEY定义完全一致。

## 修复内容

### 1. 修正ON CONFLICT子句 (core/asset_database_manager.py, lines 1043-1068)
```python
if data_type == DataType.HISTORICAL_KLINE:
    # ✅ K线数据使用(symbol, datetime, frequency)作为复合主键（与表结构定义一致）
    ...
    sql = f"""
        INSERT INTO {table_name} ({columns}) 
        VALUES ({placeholders})
        ON CONFLICT (symbol, datetime, frequency) DO UPDATE SET  # 修改为datetime
        {update_clause}
    """
```

**关键修改**：
- `timestamp` → `datetime`
- 移除`data_source`（不是主键的一部分）
- 主键字段：`(symbol, datetime, frequency)` 与表定义完全一致

### 2. 扩展UPDATE字段列表
添加更多字段到update_fields列表，确保冲突时正确更新：
```python
for col in ['open', 'high', 'low', 'close', 'volume', 'amount', 'turnover',
            'adj_close', 'adj_factor', 'turnover_rate', 'vwap', 'change', 'change_pct',
            'data_source', 'market', 'name']:  # 新增data_source, market, name
    if col in filtered_data.columns:
        update_fields.append(f"{col} = EXCLUDED.{col}")
```

### 3. 增强日志记录
添加详细的数据插入日志：
- `[数据插入]` 标签便于追踪
- 记录数据类型、记录数、字段列表
- 检查datetime/timestamp字段存在性
- 记录表结构字段、过滤后字段
- 记录SQL语句和执行结果
- 异常详情包含表名、数据类型、列信息

## 数据流程确认
1. 数据源插件返回数据 → 字段可能是各种名称（date, datetime, timestamp等）
2. `_standardize_kline_data_fields` → 统一标准化为`datetime`字段
3. `_upsert_data` → 检查数据有`datetime`字段
4. `_filter_dataframe_columns` → 保留表中存在的字段（包括datetime）
5. INSERT ON CONFLICT → 使用`(symbol, datetime, frequency)`作为冲突键

## 相关文件
- `core/asset_database_manager.py`: 主要修改
- `core/importdata/import_execution_engine.py`: _standardize_kline_data_fields确保datetime字段

## 测试建议
1. 重新运行K线数据导入
2. 检查日志确认datetime字段正确传递
3. 验证ON CONFLICT正确处理重复数据
4. 确认DuckDB表中数据正确插入和更新
