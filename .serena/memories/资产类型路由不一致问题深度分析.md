# 资产类型路由不一致问题深度分析

## 问题本质
系统中存在三套不同的资产类型判断逻辑，导致数据存储到错误的数据库中：

### 1. 三套逻辑冲突
- **UI选择逻辑**：用户在下拉框中选择资产类型（如"A股"）
- **后端推断逻辑**：系统根据数据源和股票代码自动推断资产类型
- **数据存储逻辑**：系统根据股票代码后缀判断资产类型

### 2. 问题影响
- 用户明确选择"A股"，但系统可能推断为"美股"
- 数据最终存储位置与用户预期不符
- 业务逻辑混乱，缺乏统一的资产类型管理

## 解决方案

### 3. 优先级原则
**UI选择 > 后端推断 > 默认值**

```python
def resolve_asset_type(ui_selection: str, data_source: str, symbol: str) -> AssetType:
    # 1. 优先使用UI选择
    if ui_selection and ui_selection != "自动推断":
        return parse_ui_asset_type(ui_selection)
    
    # 2. 使用后端推断
    inferred_type = infer_asset_type_from_data_source(data_source, symbol)
    if inferred_type:
        return inferred_type
    
    # 3. 使用默认值
    return AssetType.STOCK_A
```

### 4. 一致性检查机制
- 检查UI选择与推断结果的一致性
- 当不一致时给出警告和建议
- 建立统一的资产类型管理器

### 5. 推断逻辑使用场景
- **需要推断**：用户选择"自动推断"、未明确选择、数据源不明确
- **不需要推断**：用户明确选择、数据源明确、业务场景明确

## 关键修复点
1. 修改`get_kdata_from_source`方法，优先使用UI选择的资产类型
2. 统一`import_execution_engine`中的存储逻辑
3. 添加任务启动前的资产类型一致性检查
4. 建立资产类型管理器，统一管理所有相关逻辑

## 业务价值
- 确保数据存储到用户期望的数据库中
- 提高用户体验，减少数据混乱
- 建立可预测的数据管理机制