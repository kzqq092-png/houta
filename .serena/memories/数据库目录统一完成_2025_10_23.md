# 数据库目录统一完成报告

## 执行日期
2025-10-23

## 统一方案

### 目标
1. 统一使用 `data/` 目录存储所有数据库文件
2. 规范文件后缀：Duck DB使用`.duckdb`，SQLite使用`.sqlite`
3. 清理`db/`目录，避免与代码目录(`core/database/`)混淆

### 理由
1. **语义清晰**: `data/`明确表示数据存储，`db/`容易与数据库代码混淆
2. **标准实践**: 大多数项目使用`data/`目录存储数据文件
3. **代码分离**: 代码在`core/database/`，数据在`data/`，职责清晰
4. **后缀规范**: 使用正确的文件后缀，便于识别和管理

## 已完成的配置更新

### 1. 资产数据库配置 (core/asset_database_manager.py)
```python
# 修改前
base_path: str = "db/databases"

# 修改后  
base_path: str = "data/databases"
```

**影响**: 所有资产类型数据库（stock_a, crypto, fund等）将存储在`data/databases/`

### 2. 分析数据库配置 (core/database/factorweave_analytics_db.py)
```python
# 修改前
db_path: str = 'db/factorweave_analytics.duckdb'

# 修改后
db_path: str = 'data/factorweave_analytics.duckdb'
```

**影响**: 策略执行结果、技术指标、回测监控等分析数据

### 3. 系统配置数据库 (5个文件)
以下文件中的SQLite路径已更新：
- `core/services/unified_data_manager.py`
- `core/ai/data_anomaly_detector.py`  
- `gui/dialogs/database_admin_dialog.py`
- `core/importdata/import_config_manager.py`

```python
# 修改前
db_path = "db/factorweave_system.sqlite"

# 修改后
db_path = "data/factorweave_system.sqlite"
```

**影响**: 系统配置、插件状态、导入任务配置等

## 目录结构（统一后）

```
hikyuu-ui/
├── data/                           # 数据存储目录（统一）
│   ├── databases/                  # 资产数据库（DuckDB）
│   │   ├── stock_a/
│   │   │   └── stock_a_data.duckdb
│   │   ├── crypto/
│   │   │   └── crypto_data.duckdb
│   │   ├── fund/
│   │   │   └── fund_data.duckdb
│   │   └── ...
│   ├── factorweave_analytics.duckdb   # 分析数据库
│   ├── factorweave_system.sqlite      # 系统配置数据库
│   ├── unified_quality_monitor.sqlite # 质量监控
│   ├── enhanced_risk_monitor.sqlite   # 风险监控
│   ├── task_status.sqlite             # 任务状态
│   └── ...
│
├── db/                             # 数据库代码目录（清理后）
│   ├── __init__.py
│   ├── models/                     # 数据模型
│   ├── init_database_and_tables.py # 初始化脚本
│   └── ...                         # 数据库相关代码
│
└── core/
    ├── database/                   # 数据库核心代码
    │   ├── factorweave_analytics_db.py
    │   ├── duckdb_connection_pool.py
    │   └── ...
    └── ...
```

## 文件后缀规范

### DuckDB文件 (.duckdb)
- 资产数据库: `data/databases/*/stock_a_data.duckdb`
- 分析数据库: `data/factorweave_analytics.duckdb`
- K线数据: `data/unified_kline_data.duckdb`
- 基本面数据: `data/unified_fundamental_data.duckdb`
- 等等...

### SQLite文件 (.sqlite)
- 系统配置: `data/factorweave_system.sqlite`
- 质量监控: `data/unified_quality_monitor.sqlite`
- 风险监控: `data/enhanced_risk_monitor.sqlite`
- 任务状态: `data/task_status.sqlite`
- 策略数据: `data/strategy.sqlite`
- 等等...

### 废弃后缀
- ❌ `.db` (通用后缀，不再使用)

## 手动操作步骤（需要关闭应用后执行）

### 步骤1：移动DuckDB文件
```powershell
# 创建目录
New-Item -Path "data/databases" -ItemType Directory -Force

# 移动分析数据库
if (Test-Path "db/factorweave_analytics.duckdb") {
    Move-Item "db/factorweave_analytics.duckdb*" "data/" -Force
}

# 移动资产数据库（如果存在）
if (Test-Path "db/databases/stock_a") {
    Move-Item "db/databases/stock_a" "data/databases/" -Force  
}
if (Test-Path "db/databases/crypto") {
    Move-Item "db/databases/crypto" "data/databases/" -Force
}
# ... 其他资产类型
```

### 步骤2：移动SQLite文件
```powershell
if (Test-Path "db/factorweave_system.sqlite") {
    Move-Item "db/factorweave_system.sqlite" "data/" -Force
}
```

### 步骤3：规范化文件后缀（在data/目录）
```powershell
# 重命名.db文件为.sqlite或.duckdb
Get-ChildItem "data" -Filter "*.db" | ForEach-Object {
    $newName = $_.Name -replace '\.db$', '.sqlite'
    Rename-Item $_.FullName -NewName $newName -Force
    Write-Host "Renamed: $($_.Name) -> $newName"
}
```

### 步骤4：清理db/目录中的测试文件
```powershell
# 删除测试数据库
Remove-Item "db/complete_test.duckdb" -ErrorAction SilentlyContinue
Remove-Item "db/final_verification.duckdb" -ErrorAction SilentlyContinue
Remove-Item "db/performance_test.duckdb" -ErrorAction SilentlyContinue
Remove-Item "db/unified_*.duckdb" -ErrorAction SilentlyContinue
Remove-Item "db/test_*.db" -ErrorAction SilentlyContinue
Remove-Item "db/alert_config.db" -ErrorAction SilentlyContinue
Remove-Item "db/backtest_monitor.db" -ErrorAction SilentlyContinue
Remove-Item "db/deep_analysis.db" -ErrorAction SilentlyContinue

Write-Host "Cleanup completed"
```

## 验证步骤

1. 启动应用
2. 检查资产列表是否正常显示
3. 检查K线数据查询是否正常
4. 检查导入任务配置是否保留
5. 检查分析功能是否正常

## 回滚方案（如有问题）
配置文件已自动创建备份（.backup_yyyymmdd_hhmmss）：
- `core/asset_database_manager.py.backup_*`
- `core/database/factorweave_analytics_db.py.backup_*`
- 等等...

使用备份文件恢复配置，然后重启应用。

## 优点总结

1. **目录职责清晰**：
   - `data/` - 数据存储
   - `db/` - 数据库代码和脚本
   - `core/database/` - 数据库核心代码

2. **易于管理**：
   - 所有数据库文件在一个目录
   - 备份和迁移更简单
   - 文件后缀规范，一目了然

3. **避免混淆**：
   - `db/`不再包含数据文件
   - 减少路径歧义
   - 符合项目最佳实践

## 注意事项

1. 首次启动应用时会自动在`data/databases/`创建新的资产数据库
2. 如果有旧数据库文件需要迁移，请手动执行上述PowerShell命令
3. WAL文件会随主数据库文件一起迁移
4. 确保`data/`目录有足够的磁盘空间

## 相关记忆
本次会话完成的所有修复：
1. ValidationResult_参数修复_2025_10_23
2. 历史K线表字段名修复_2025_10_23  
3. 新架构表结构修复_2025_10_23
4. 数据库目录统一和修复指南_2025_10_23
5. 数据库目录统一完成_2025_10_23（本文档）
