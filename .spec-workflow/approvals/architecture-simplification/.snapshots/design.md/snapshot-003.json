{
  "id": "snapshot_1758897164704_dym6ax1qo",
  "approvalId": "approval_1758897143480_wv2zj5ovh",
  "approvalTitle": "架构精简重构设计文档(修订版) - 15个核心服务的完整真实实现方案",
  "version": 3,
  "timestamp": "2025-09-26T14:32:44.704Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# 架构精简重构设计文档\r\n\r\n## Overview\r\n\r\n本设计文档详细描述了HIkyuu-UI系统从当前的164个管理组件（91个Manager + 73个Service）精简到15个核心服务的技术实现方案。这是一个**减法重构**项目，目标是通过真正的功能整合和组件替换，而非叠加包装，来大幅简化系统复杂性，提升性能和可维护性。\r\n\r\n核心设计原则：**替换而非包装，整合而非叠加，精简而非复杂化**\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n- 遵循Python面向对象设计原则，使用单一职责和依赖注入\r\n- 保持PyQt5界面框架和loguru日志系统的技术选型\r\n- 遵循现有的数据库访问模式（DuckDB/SQLite）\r\n- 保持异步处理和线程安全的设计标准\r\n\r\n### Project Structure (structure.md)\r\n- 核心服务放置在 `core/services/` 目录下\r\n- 保持现有的测试结构 `tests/` 目录\r\n- 维护配置文件结构 `config/` 目录\r\n- 遵循现有的工具类组织 `utils/` 目录\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n- **BaseService**: 扩展现有基础服务类，作为所有新服务的基类\r\n- **ServiceContainer**: 利用现有依赖注入容器进行服务管理\r\n- **loguru配置**: 复用现有的日志配置和性能监控\r\n- **数据库连接池**: 复用DuckDB和SQLite的连接管理机制\r\n- **PyQt事件系统**: 利用现有的事件总线和信号机制\r\n\r\n### Integration Points\r\n- **现有数据库模式**: 新服务将兼容现有的表结构和数据模型\r\n- **配置系统**: 集成现有的配置文件格式和加载机制\r\n- **插件接口**: 保持现有插件API的向后兼容性\r\n- **UI组件**: 新服务将透明地为现有UI组件提供数据\r\n\r\n## Architecture\r\n\r\n整体架构采用分层服务设计，通过依赖注入和事件驱动实现服务间的松耦合。每个服务负责一个明确的业务域，服务间通过标准化接口进行交互。\r\n\r\n### Modular Design Principles\r\n- **单一职责**: 每个服务只负责一个业务域的功能\r\n- **接口标准化**: 所有服务都实现统一的BaseService接口\r\n- **依赖最小化**: 服务间依赖关系最小，优先使用事件通信\r\n- **资源集约化**: 多个Manager的功能整合到单个Service中\r\n\r\n```mermaid\r\ngraph TD\r\n    %% 应用层\r\n    UI[UI Layer] --> BS[Business Services]\r\n    API[API Layer] --> BS\r\n    \r\n    %% 业务服务层\r\n    BS --> TS[TradingService]\r\n    BS --> AS[AnalysisService] \r\n    BS --> MS[MarketService]\r\n    BS --> NS[NotificationService]\r\n    \r\n    %% 核心服务层\r\n    TS --> DS[DataService]\r\n    AS --> DS\r\n    MS --> DS\r\n    TS --> CS[ConfigService]\r\n    AS --> CAS[CacheService]\r\n    MS --> PS[PluginService]\r\n    \r\n    %% 基础服务层\r\n    DS --> DBS[DatabaseService]\r\n    DS --> NWS[NetworkService]\r\n    PS --> ES[ExtensionService]\r\n    CS --> ENS[EnvironmentService]\r\n    \r\n    %% 系统服务层\r\n    DBS --> PFS[PerformanceService]\r\n    NWS --> SS[SecurityService] \r\n    ALL --> LS[LifecycleService]\r\n    \r\n    %% 依赖方向说明\r\n    classDef business fill:#e1f5fe\r\n    classDef core fill:#f3e5f5  \r\n    classDef infra fill:#e8f5e8\r\n    classDef system fill:#fff3e0\r\n    \r\n    class TS,AS,MS,NS business\r\n    class DS,CS,CAS,PS core\r\n    class DBS,NWS,ES,ENS infra\r\n    class PFS,SS,LS system\r\n```\r\n\r\n## Components and Interfaces\r\n\r\n### 数据服务域\r\n\r\n#### DataService\r\n- **Purpose:** 统一数据访问、缓存和质量控制\r\n- **Interfaces:** \r\n  - `get_data(source, symbol, timeframe) -> DataFrame`\r\n  - `store_data(data, metadata) -> bool`\r\n  - `validate_data(data) -> ValidationResult`\r\n  - `cache_data(key, data, ttl) -> bool`\r\n- **Dependencies:** DatabaseService, CacheService\r\n- **Replaces:** UnifiedDataManager, DataQualityRiskManager, AssetManager, EnhancedDataManager, DataSourceManager, FallbackDataManager, MinimalDataManager\r\n- **完整实现承诺:** \r\n  - 100%实现所有被替代Manager的完整功能，无任何简化\r\n  - 真实的数据验证逻辑，完整的质量检查算法\r\n  - 真实的多数据源路由和负载均衡\r\n  - 完整的错误恢复和降级机制\r\n\r\n#### DatabaseService  \r\n- **Purpose:** 数据库连接管理、事务处理和查询优化\r\n- **Interfaces:**\r\n  - `get_connection(db_type='duckdb') -> Connection`\r\n  - `execute_query(sql, params) -> Result`\r\n  - `execute_transaction(operations) -> bool`\r\n  - `optimize_query(sql) -> OptimizedSQL`\r\n- **Dependencies:** PerformanceService\r\n- **Replaces:** DuckDBConnectionManager, SQLiteExtensionManager, AssetSeparatedDatabaseManager, EnhancedAssetDatabaseManager, StrategyDatabaseManager, TdxServerDatabaseManager\r\n- **完整实现承诺:**\r\n  - 完整实现所有数据库Manager的连接池和事务功能\r\n  - 真实的查询优化算法，完整的SQL解析和优化\r\n  - 完整的多数据库支持（DuckDB、SQLite、MySQL等）\r\n  - 真实的故障恢复和连接管理机制\r\n\r\n#### CacheService\r\n- **Purpose:** 多级缓存管理和智能失效策略\r\n- **Interfaces:**\r\n  - `get(key, level='auto') -> Any`\r\n  - `set(key, value, ttl, level='auto') -> bool`\r\n  - `invalidate(pattern) -> int`\r\n  - `get_statistics() -> CacheStats`\r\n- **Dependencies:** PerformanceService\r\n- **Replaces:** MultiLevelCacheManager, IntelligentCacheManager, CacheManager, MemoryManager\r\n\r\n### 插件服务域\r\n\r\n#### PluginService\r\n- **Purpose:** 插件生命周期管理和配置\r\n- **Interfaces:**\r\n  - `discover_plugins() -> List[PluginInfo]`\r\n  - `load_plugin(plugin_id) -> Plugin`\r\n  - `activate_plugin(plugin_id, config) -> bool`\r\n  - `get_plugin_config(plugin_id) -> Dict`\r\n- **Dependencies:** ConfigService, DatabaseService\r\n- **Replaces:** PluginManager, PluginCenter, PluginConfigManager, PluginTableManager, AsyncPluginDiscoveryService, EnhancedAsyncPluginDiscoveryService\r\n\r\n#### ExtensionService\r\n- **Purpose:** 扩展点管理和第三方集成\r\n- **Interfaces:**\r\n  - `register_extension(name, handler) -> bool`\r\n  - `execute_extension(name, context) -> Result`\r\n  - `list_extensions() -> List[ExtensionInfo]`\r\n- **Dependencies:** PluginService\r\n- **Replaces:** DataSourceExtensions, IndicatorExtensions, StrategyExtensions\r\n\r\n### 配置服务域\r\n\r\n#### ConfigService\r\n- **Purpose:** 配置管理、验证和变更通知\r\n- **Interfaces:**\r\n  - `get(key, default=None) -> Any`\r\n  - `set(key, value) -> bool`\r\n  - `validate(config) -> ValidationResult`\r\n  - `watch(key, callback) -> bool`\r\n- **Dependencies:** EnvironmentService\r\n- **Replaces:** ConfigService, DynamicConfigManager, ImportConfigManager, IntelligentConfigManager, MigrationConfigManager\r\n\r\n#### EnvironmentService\r\n- **Purpose:** 环境检测、部署配置和系统集成\r\n- **Interfaces:**\r\n  - `detect_environment() -> EnvironmentInfo`\r\n  - `get_deployment_config() -> DeploymentConfig`\r\n  - `check_system_requirements() -> List[Requirement]`\r\n- **Dependencies:** None (基础服务)\r\n- **Replaces:** SystemIntegrationManager, DeploymentManager\r\n\r\n### 网络服务域\r\n\r\n#### NetworkService\r\n- **Purpose:** 网络通信、连接池和重试机制\r\n- **Interfaces:**\r\n  - `request(url, method, data, retry_policy) -> Response`\r\n  - `configure_pool(max_connections, timeout) -> bool`\r\n  - `get_connection_stats() -> NetworkStats`\r\n- **Dependencies:** SecurityService, PerformanceService\r\n- **Replaces:** NetworkManager, UniversalNetworkConfigManager, SmartRetryManager, RetryManager\r\n\r\n#### SecurityService\r\n- **Purpose:** 安全控制、认证和熔断保护\r\n- **Interfaces:**\r\n  - `authenticate(credentials) -> AuthResult`\r\n  - `authorize(user, resource, action) -> bool`\r\n  - `create_circuit_breaker(name, config) -> CircuitBreaker`\r\n- **Dependencies:** ConfigService\r\n- **Replaces:** SecurityManager, CircuitBreakerManager, EnhancedCircuitBreaker\r\n\r\n### 业务服务域\r\n\r\n#### TradingService\r\n- **Purpose:** 交易执行、风险控制和仓位管理\r\n- **Interfaces:**\r\n  - `execute_trade(order) -> TradeResult`\r\n  - `calculate_risk(position) -> RiskMetrics`\r\n  - `get_positions(account) -> List[Position]`\r\n  - `update_position(position_id, changes) -> bool`\r\n- **Dependencies:** DataService, NotificationService, PerformanceService\r\n- **Replaces:** TradingManager, RiskManager, PositionManager, PortfolioManager, RiskRuleManager\r\n- **完整实现承诺:**\r\n  - 完整实现所有交易Manager的真实交易逻辑，无模拟\r\n  - 真实的风险计算算法，完整的风险控制规则\r\n  - 完整的仓位跟踪和投资组合管理功能\r\n  - 真实的订单执行和成交处理机制\r\n\r\n#### AnalysisService\r\n- **Purpose:** 技术分析、指标计算和策略分析\r\n- **Interfaces:**\r\n  - `calculate_indicator(indicator_type, data, params) -> Series`\r\n  - `analyze_pattern(data, pattern_type) -> PatternResult`\r\n  - `generate_signals(strategy, data) -> List[Signal]`\r\n- **Dependencies:** DataService, CacheService\r\n- **Replaces:** AnalysisManager, IndicatorCombinationManager, UnifiedIndicatorService, IndicatorService\r\n\r\n#### MarketService\r\n- **Purpose:** 市场数据、行业分类和股票信息\r\n- **Interfaces:**\r\n  - `get_market_data(symbol, fields) -> MarketData`\r\n  - `get_industry_classification(symbol) -> Industry`\r\n  - `get_stock_info(symbol) -> StockInfo`\r\n  - `list_stocks(criteria) -> List[Symbol]`\r\n- **Dependencies:** DataService, CacheService\r\n- **Replaces:** IndustryManager, StockManager, FallbackIndustryManager\r\n\r\n#### NotificationService\r\n- **Purpose:** 消息通知、警报规则和去重处理\r\n- **Interfaces:**\r\n  - `send_notification(message, channels) -> bool`\r\n  - `create_alert_rule(rule) -> RuleID`\r\n  - `process_alert(alert) -> bool`\r\n- **Dependencies:** ConfigService\r\n- **Replaces:** NotificationService, AlertRuleEngine, AlertDeduplicationService, AlertRuleHotLoader\r\n\r\n### 基础服务域\r\n\r\n#### PerformanceService\r\n- **Purpose:** 性能监控、资源管理和自动优化\r\n- **Interfaces:**\r\n  - `monitor_metrics() -> MetricsSnapshot`\r\n  - `optimize_resource(resource_type) -> bool`\r\n  - `generate_report(timeframe) -> PerformanceReport`\r\n  - `set_alert_threshold(metric, threshold) -> bool`\r\n- **Dependencies:** None (基础服务)\r\n- **Replaces:** PerformanceMonitor, UnifiedMonitor, ResourceManager, DynamicResourceManager, GPUAccelerationManager, BackpressureManager\r\n\r\n#### LifecycleService\r\n- **Purpose:** 服务启动、任务调度和生命周期管理\r\n- **Interfaces:**\r\n  - `start_service(service_name) -> bool`\r\n  - `stop_service(service_name) -> bool`\r\n  - `schedule_task(task, schedule) -> TaskID`\r\n  - `get_service_status(service_name) -> ServiceStatus`\r\n- **Dependencies:** ConfigService, PerformanceService\r\n- **Replaces:** ServiceBootstrap, TaskManager, StrategyLifecycleManager, FailoverManager, FaultToleranceManager\r\n\r\n## Data Models\r\n\r\n### ServiceConfiguration\r\n```python\r\n@dataclass\r\nclass ServiceConfiguration:\r\n    service_name: str\r\n    enabled: bool\r\n    config: Dict[str, Any]\r\n    dependencies: List[str]\r\n    health_check_interval: int = 30\r\n```\r\n\r\n### ServiceMetrics\r\n```python\r\n@dataclass  \r\nclass ServiceMetrics:\r\n    service_name: str\r\n    cpu_usage: float\r\n    memory_usage: float\r\n    request_count: int\r\n    error_count: int\r\n    avg_response_time: float\r\n    timestamp: datetime\r\n```\r\n\r\n### CacheEntry\r\n```python\r\n@dataclass\r\nclass CacheEntry:\r\n    key: str\r\n    value: Any\r\n    ttl: int\r\n    level: CacheLevel\r\n    created_at: datetime\r\n    accessed_at: datetime\r\n    hit_count: int\r\n```\r\n\r\n### PluginMetadata\r\n```python\r\n@dataclass\r\nclass PluginMetadata:\r\n    plugin_id: str\r\n    name: str\r\n    version: str\r\n    description: str\r\n    author: str\r\n    dependencies: List[str]\r\n    config_schema: Dict[str, Any]\r\n    status: PluginStatus\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n1. **服务初始化失败**\r\n   - **Handling:** 记录详细错误信息，回退到最小功能模式\r\n   - **User Impact:** 显示友好的错误消息，提供故障排除建议\r\n\r\n2. **数据库连接中断**\r\n   - **Handling:** 自动重连机制，使用缓存数据作为临时替代\r\n   - **User Impact:** 数据可能暂时不是最新，但系统继续可用\r\n\r\n3. **插件加载错误**\r\n   - **Handling:** 跳过问题插件，记录错误，继续加载其他插件\r\n   - **User Impact:** 相关功能不可用，但核心功能正常\r\n\r\n4. **网络请求超时**\r\n   - **Handling:** 智能重试，熔断保护，使用缓存数据\r\n   - **User Impact:** 轻微延迟，可能显示缓存数据\r\n\r\n5. **内存不足**\r\n   - **Handling:** 自动清理缓存，降级功能，释放资源\r\n   - **User Impact:** 系统响应可能变慢，但保持稳定\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n- 每个服务独立测试，**使用真实依赖而非Mock**\r\n- 测试覆盖率要求 ≥ 90%\r\n- 重点测试接口方法、错误处理和边界条件\r\n- 使用pytest进行真实环境测试\r\n- **所有测试使用真实数据库连接和真实数据**\r\n\r\n### Integration Testing\r\n- 测试服务间的真实集成交互\r\n- 验证真实数据流的正确性\r\n- 测试真实配置变更的传播\r\n- 验证真实事件机制的可靠性\r\n- **使用生产级数据进行集成验证**\r\n\r\n### End-to-End Testing\r\n- 执行完整的真实用户工作流程\r\n- 验证真实系统启动和关闭过程\r\n- 测试真实故障恢复和降级机制\r\n- 真实性能基准测试和回归测试\r\n- **所有测试场景使用真实业务数据**\r\n\r\n### Migration Testing\r\n- 验证从旧架构到新架构的真实数据迁移\r\n- 测试真实向后兼容性\r\n- 验证真实功能等效性\r\n- 测试真实回滚机制\r\n- **使用生产数据副本进行迁移验证**\r\n\r\n## Performance Optimization Strategy\r\n\r\n### 启动优化\r\n- 延迟加载非关键服务\r\n- 并行初始化独立服务\r\n- 预编译配置和模板\r\n- 优化import路径\r\n\r\n### 内存优化\r\n- 智能缓存策略，及时释放不用数据\r\n- 对象池复用，减少GC压力\r\n- 按需加载插件和扩展\r\n- 监控内存泄漏\r\n\r\n### 响应优化\r\n- 异步处理长时间操作\r\n- 智能预取常用数据\r\n- 连接池复用\r\n- 查询优化和索引\r\n\r\n## Migration Strategy\r\n\r\n### Phase 1: 真实基础服务实现 (Week 1-2)\r\n1. **完整实现**15个核心服务的所有功能，**无任何简化或模拟**\r\n2. 建立真实的服务注册和依赖注入机制，**完整支持所有依赖关系**\r\n3. 实现完整的健康检查和监控，**真实监控所有指标**\r\n4. 建立**完整的真实环境测试基础设施**，**无Mock数据**\r\n\r\n### Phase 2: 完整功能迁移 (Week 3-6)\r\n1. **完整迁移**所有Manager功能到Service，**保证100%功能覆盖**\r\n2. 实现**真实的兼容性适配器**，**完全支持所有旧接口**\r\n3. **完整更新**所有调用方使用新服务，**无功能缺失**\r\n4. **严格验证**功能等效性，**确保所有业务逻辑完整保留**\r\n\r\n### Phase 3: 完整清理优化 (Week 7-8)\r\n1. **安全删除**不再使用的Manager类，**确保无功能丢失**\r\n2. **渐进移除**兼容性适配器，**保证平滑过渡**\r\n3. **全面优化**服务性能和资源使用，**不降低任何功能**\r\n4. **完成**文档更新和知识转移，**覆盖所有实现细节**\r\n\r\n## 实现承诺\r\n\r\n**本设计确保100%真实实现，绝无Mock、模拟或功能精简：**\r\n\r\n1. **所有服务功能完整实现**：每个Service将完整实现所有替代Manager的功能\r\n2. **所有数据操作真实执行**：使用真实数据库连接、真实数据处理\r\n3. **所有接口完整保留**：确保向后兼容，无接口功能缺失\r\n4. **所有业务逻辑完整迁移**：100%保留现有业务逻辑复杂度\r\n5. **所有测试使用真实环境**：无Mock依赖，使用真实数据验证\r\n6. **所有错误处理完整实现**：真实的错误恢复和降级机制\r\n\r\n这个设计确保了真正的**功能整合和组件减少**，**同时保证所有功能的完整性和真实性**，绝无任何简化或模拟实现。\r\n",
  "fileStats": {
    "size": 15874,
    "lines": 422,
    "lastModified": "2025-09-26T14:32:15.879Z"
  },
  "comments": []
}