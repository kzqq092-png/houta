# æ•°æ®åº“è¡¨ç»“æ„å‡çº§æŠ¥å‘Š

## å‡çº§æ¦‚è¿°

æ ¹æ®ä¸“ä¸šåˆ†æå»ºè®®ï¼Œå°†Kçº¿æ•°æ®è¡¨ä»**15å­—æ®µ**å‡çº§åˆ°**20å­—æ®µ**çš„**æ ‡å‡†é‡åŒ–è¡¨ï¼ˆæ–¹æ¡ˆBï¼‰**ã€‚

**å‡çº§åŸå› **ï¼š
- âœ… æ”¯æŒæ­£ç¡®çš„é‡åŒ–å›æµ‹ï¼ˆå¤æƒæ•°æ®ï¼‰
- âœ… ç¬¦åˆè¡Œä¸šæ ‡å‡†ï¼ˆåŒèŠ±é¡ºã€Windã€èšå®½ï¼‰
- âœ… æ»¡è¶³ä¸“ä¸šé‡åŒ–ç³»ç»Ÿéœ€æ±‚

---

## æ–°å¢å­—æ®µè¯¦æƒ…

### 1. adj_closeï¼ˆå¤æƒæ”¶ç›˜ä»·ï¼‰â­â­â­â­â­

```sql
adj_close DOUBLE
```

**å­—æ®µè¯´æ˜**ï¼š
- ç±»å‹ï¼šDOUBLE
- å…è®¸NULLï¼šæ˜¯
- é»˜è®¤å€¼ï¼šæ— 
- ç”¨é€”ï¼šé‡åŒ–å›æµ‹å¿…éœ€ï¼Œè®¡ç®—çœŸå®æ”¶ç›Šç‡

**æ•°æ®æ¥æº**ï¼š
1. æ•°æ®æºç›´æ¥æä¾›ï¼ˆä¼˜å…ˆï¼‰
2. é€šè¿‡adj_factorè®¡ç®—ï¼š`adj_close = close * adj_factor`
3. å¦‚æœéƒ½æ²¡æœ‰ï¼Œé»˜è®¤ç­‰äºcloseï¼ˆä¸å¤æƒï¼‰

**é‡è¦æ€§**ï¼š
- å¿…è¦æ€§ï¼šâ­â­â­â­â­ï¼ˆæœ€é«˜ï¼‰
- è¡Œä¸šæ ‡å‡†ï¼š100%ä¸“ä¸šè½¯ä»¶æ”¯æŒ
- å½±å“ï¼šå›æµ‹å‡†ç¡®æ€§çš„å…³é”®

---

### 2. adj_factorï¼ˆå¤æƒå› å­ï¼‰â­â­â­â­â­

```sql
adj_factor DOUBLE DEFAULT 1.0
```

**å­—æ®µè¯´æ˜**ï¼š
- ç±»å‹ï¼šDOUBLE
- å…è®¸NULLï¼šå¦
- é»˜è®¤å€¼ï¼š1.0ï¼ˆä¸å¤æƒï¼‰
- ç”¨é€”ï¼šè¿˜åŸçœŸå®æŒä»“æˆæœ¬ï¼Œæ”¯æŒå‰å¤æƒ/åå¤æƒ

**è®¡ç®—å…¬å¼**ï¼š
```python
# å‰å¤æƒå› å­
adj_factor = ç´¯è®¡é€è½¬è‚¡æ¯”ä¾‹ Ã— ç´¯è®¡åˆ†çº¢è°ƒæ•´

# åº”ç”¨ï¼š
adj_close = close * adj_factor
```

**é‡è¦æ€§**ï¼š
- å¿…è¦æ€§ï¼šâ­â­â­â­â­
- è¡Œä¸šæ ‡å‡†ï¼š95%ä¸“ä¸šè½¯ä»¶æ”¯æŒ

---

### 3. turnover_rateï¼ˆæ¢æ‰‹ç‡ï¼‰â­â­â­â­

```sql
turnover_rate DOUBLE
```

**å­—æ®µè¯´æ˜**ï¼š
- ç±»å‹ï¼šDOUBLE
- å…è®¸NULLï¼šæ˜¯
- é»˜è®¤å€¼ï¼šæ— 
- å•ä½ï¼šç™¾åˆ†æ¯”ï¼ˆ%ï¼‰
- ç”¨é€”ï¼šæµåŠ¨æ€§åˆ†æã€é‡åŒ–å› å­

**è®¡ç®—å…¬å¼**ï¼š
```python
turnover_rate = (volume / float_shares) * 100
```

**é‡è¦æ€§**ï¼š
- å¿…è¦æ€§ï¼šâ­â­â­â­
- è¡Œä¸šæ ‡å‡†ï¼š90%ä¸“ä¸šè½¯ä»¶æ”¯æŒ
- åº”ç”¨ï¼šé«˜é¢‘äº¤æ˜“ã€æµåŠ¨æ€§ç­›é€‰

---

### 4. vwapï¼ˆæˆäº¤é‡åŠ æƒå‡ä»·ï¼‰â­â­â­

```sql
vwap DOUBLE
```

**å­—æ®µè¯´æ˜**ï¼š
- ç±»å‹ï¼šDOUBLE
- å…è®¸NULLï¼šæ˜¯
- é»˜è®¤å€¼ï¼šæ— 
- ç”¨é€”ï¼šç®—æ³•äº¤æ˜“åŸºå‡†ã€å¤§å•åˆ†æ

**è®¡ç®—å…¬å¼**ï¼š
```python
vwap = amount / volume
```

**æ•°æ®æ¥æº**ï¼š
1. æ•°æ®æºç›´æ¥æä¾›ï¼ˆä¼˜å…ˆï¼‰
2. è‡ªåŠ¨è®¡ç®—ï¼š`vwap = amount / volume`

**é‡è¦æ€§**ï¼š
- å¿…è¦æ€§ï¼šâ­â­â­
- è¡Œä¸šæ ‡å‡†ï¼š75%ä¸“ä¸šè½¯ä»¶æ”¯æŒ
- åº”ç”¨ï¼šæœºæ„äº¤æ˜“ã€ç®—æ³•äº¤æ˜“

---

### 5. data_sourceï¼ˆæ•°æ®æ¥æºï¼‰â­â­â­â­

```sql
data_source VARCHAR DEFAULT 'unknown'
```

**å­—æ®µè¯´æ˜**ï¼š
- ç±»å‹ï¼šVARCHAR
- å…è®¸NULLï¼šå¦
- é»˜è®¤å€¼ï¼š'unknown'
- ç”¨é€”ï¼šæ•°æ®è¿½æº¯ã€è´¨é‡ç®¡ç†

**æ•°æ®å€¼**ï¼š
- 'tongdaxin' - é€šè¾¾ä¿¡
- 'akshare' - AKShare
- 'sina' - æ–°æµª
- 'eastmoney' - ä¸œæ–¹è´¢å¯Œ
- 'unknown' - æœªçŸ¥æ¥æº

**é‡è¦æ€§**ï¼š
- å¿…è¦æ€§ï¼šâ­â­â­â­
- ç³»ç»Ÿæ¶æ„ï¼šå¤šæ•°æ®æºç³»ç»Ÿå¿…éœ€
- åº”ç”¨ï¼šæ•°æ®è´¨é‡è¿½æº¯ã€å†²çªè§£å†³

---

## å®Œæ•´è¡¨ç»“æ„å¯¹æ¯”

### å‡çº§å‰ï¼ˆ15å­—æ®µï¼‰

```sql
CREATE TABLE stock_kline (
    symbol VARCHAR,
    name VARCHAR,
    market VARCHAR,
    datetime TIMESTAMP,
    frequency VARCHAR NOT NULL DEFAULT '1d',
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    amount DOUBLE,
    turnover DOUBLE,
    period VARCHAR,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (symbol, datetime, frequency)
);
```

### å‡çº§åï¼ˆ20å­—æ®µï¼‰

```sql
CREATE TABLE stock_kline (
    symbol VARCHAR,
    name VARCHAR,
    market VARCHAR,
    datetime TIMESTAMP,
    frequency VARCHAR NOT NULL DEFAULT '1d',
    open DOUBLE,
    high DOUBLE,
    low DOUBLE,
    close DOUBLE,
    volume DOUBLE,
    amount DOUBLE,
    turnover DOUBLE,
    adj_close DOUBLE,              -- âœ… æ–°å¢
    adj_factor DOUBLE DEFAULT 1.0, -- âœ… æ–°å¢
    turnover_rate DOUBLE,          -- âœ… æ–°å¢
    vwap DOUBLE,                   -- âœ… æ–°å¢
    period VARCHAR,
    data_source VARCHAR DEFAULT 'unknown',  -- âœ… æ–°å¢
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (symbol, datetime, frequency)
);
```

**å­—æ®µå˜åŒ–**ï¼š
- åŸæœ‰å­—æ®µï¼š15ä¸ª âœ… å…¨éƒ¨ä¿ç•™
- æ–°å¢å­—æ®µï¼š5ä¸ª âœ…
- æ€»å­—æ®µæ•°ï¼š20ä¸ª

---

## ä¿®æ”¹çš„ä»£ç æ–‡ä»¶

### 1. core/asset_database_manager.py

#### ä¿®æ”¹1ï¼š_generate_create_table_sqlæ–¹æ³•ï¼ˆè¡Œ713-738ï¼‰

**ä¿®æ”¹å†…å®¹**ï¼šæ›´æ–°è¡¨ç»“æ„å®šä¹‰ï¼Œæ·»åŠ 5ä¸ªæ–°å­—æ®µ

```python
# æ–°å¢å­—æ®µå®šä¹‰
adj_close DOUBLE,
adj_factor DOUBLE DEFAULT 1.0,
turnover_rate DOUBLE,
vwap DOUBLE,
period VARCHAR,
data_source VARCHAR DEFAULT 'unknown',
```

#### ä¿®æ”¹2ï¼š_upsert_dataæ–¹æ³•ï¼ˆè¡Œ895-904ï¼‰

**ä¿®æ”¹å†…å®¹**ï¼šæ›´æ–°UPDATEå­—æ®µåˆ—è¡¨ï¼ŒåŒ…å«æ–°å­—æ®µ

```python
for col in ['open', 'high', 'low', 'close', 'volume', 'amount', 'turnover',
           'adj_close', 'adj_factor', 'turnover_rate', 'vwap']:
    if col in filtered_data.columns:
        update_fields.append(f"{col} = EXCLUDED.{col}")
```

---

### 2. core/importdata/import_execution_engine.py

#### ä¿®æ”¹1ï¼š_standardize_kline_data_fieldsæ–¹æ³•ï¼ˆè¡Œ2197-2232ï¼‰

**ä¿®æ”¹å†…å®¹**ï¼šæ·»åŠ æ–°å­—æ®µåˆ°æ ‡å‡†åŒ–å­—å…¸

```python
field_defaults = {
    # åŸºç¡€OHLCVå­—æ®µï¼ˆ8ä¸ªï¼‰
    'symbol': '', 'datetime': None,
    'open': 0.0, 'high': 0.0, 'low': 0.0, 'close': 0.0,
    'volume': 0, 'amount': 0.0, 'turnover': 0.0,
    
    # å¤æƒæ•°æ®ï¼ˆ2ä¸ªï¼‰- é‡åŒ–å›æµ‹å¿…éœ€
    'adj_close': None,      # å¤æƒæ”¶ç›˜ä»·
    'adj_factor': 1.0,      # å¤æƒå› å­ï¼ˆé»˜è®¤1.0=ä¸å¤æƒï¼‰
    
    # æ‰©å±•äº¤æ˜“æ•°æ®ï¼ˆ2ä¸ªï¼‰
    'turnover_rate': None,  # æ¢æ‰‹ç‡ï¼ˆè¡Œä¸šæ ‡å‡†ï¼‰
    'vwap': None,           # æˆäº¤é‡åŠ æƒå‡ä»·ï¼ˆæœºæ„å¸¸ç”¨ï¼‰
    
    # å…ƒæ•°æ®ï¼ˆ6ä¸ªï¼‰
    'name': None, 'market': None,
    'frequency': '1d', 'period': None,
    'data_source': 'unknown',  # æ•°æ®æ¥æºè¿½æº¯
    'created_at': None, 'updated_at': None,
}
```

#### ä¿®æ”¹2ï¼šæ™ºèƒ½å­—æ®µè®¡ç®—ï¼ˆè¡Œ2255-2270ï¼‰

**ä¿®æ”¹å†…å®¹**ï¼šè‡ªåŠ¨è®¡ç®—adj_closeå’Œvwap

```python
# æ™ºèƒ½è®¡ç®—å¤æƒä»·æ ¼ï¼ˆå¦‚æœæ•°æ®æºæ²¡æœ‰æä¾›ï¼‰
if 'adj_close' in df.columns:
    # å¦‚æœadj_closeä¸ºç©ºä½†æœ‰adj_factorï¼Œåˆ™è®¡ç®—
    mask = df['adj_close'].isna() & df['adj_factor'].notna()
    if mask.any():
        df.loc[mask, 'adj_close'] = df.loc[mask, 'close'] * df.loc[mask, 'adj_factor']
    
    # å¦‚æœadj_closeå’Œadj_factoréƒ½ä¸ºç©ºï¼Œè®¾ç½®adj_close=closeï¼ˆä¸å¤æƒï¼‰
    mask = df['adj_close'].isna()
    if mask.any():
        df.loc[mask, 'adj_close'] = df.loc[mask, 'close']

# æ™ºèƒ½è®¡ç®—VWAPï¼ˆå¦‚æœæ•°æ®æºæ²¡æœ‰æä¾›ï¼‰
if 'vwap' in df.columns and df['vwap'].isna().all():
    # vwap = amount / volume
    df['vwap'] = df['amount'] / df['volume'].replace(0, pd.NA)
```

---

## æ•°æ®åº“å‡çº§è„šæœ¬

### è‡ªåŠ¨å‡çº§è„šæœ¬ï¼ˆDuckDBï¼‰

```sql
-- ============================================
-- FactorWeave-Quant æ•°æ®åº“å‡çº§è„šæœ¬
-- ç‰ˆæœ¬ï¼šV2.0.3 â†’ V2.0.4
-- å‡çº§å†…å®¹ï¼šKçº¿è¡¨å¢åŠ 5ä¸ªå­—æ®µï¼ˆæ ‡å‡†é‡åŒ–è¡¨ï¼‰
-- æ‰§è¡Œæ—¶é—´ï¼šçº¦1-5åˆ†é’Ÿï¼ˆå–å†³äºæ•°æ®é‡ï¼‰
-- ============================================

BEGIN TRANSACTION;

-- 1. æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
DO $$
BEGIN
    -- ä¸ºæ‰€æœ‰Kçº¿è¡¨æ·»åŠ æ–°å­—æ®µ
    FOR table_name IN 
        SELECT table_name 
        FROM duckdb_tables() 
        WHERE table_name LIKE '%kline%'
    LOOP
        -- æ·»åŠ å¤æƒæ”¶ç›˜ä»·
        EXECUTE format('ALTER TABLE %I ADD COLUMN IF NOT EXISTS adj_close DOUBLE', table_name);
        
        -- æ·»åŠ å¤æƒå› å­ï¼ˆé»˜è®¤1.0ï¼‰
        EXECUTE format('ALTER TABLE %I ADD COLUMN IF NOT EXISTS adj_factor DOUBLE DEFAULT 1.0', table_name);
        
        -- æ·»åŠ æ¢æ‰‹ç‡
        EXECUTE format('ALTER TABLE %I ADD COLUMN IF NOT EXISTS turnover_rate DOUBLE', table_name);
        
        -- æ·»åŠ VWAP
        EXECUTE format('ALTER TABLE %I ADD COLUMN IF NOT EXISTS vwap DOUBLE', table_name);
        
        -- æ·»åŠ æ•°æ®æ¥æº
        EXECUTE format('ALTER TABLE %I ADD COLUMN IF NOT EXISTS data_source VARCHAR DEFAULT ''unknown''', table_name);
        
        -- æ‰“å°è¿›åº¦
        RAISE NOTICE 'å·²å‡çº§è¡¨: %', table_name;
    END LOOP;
END $$;

-- 2. æ›´æ–°ç°æœ‰æ•°æ®çš„é»˜è®¤å€¼
UPDATE stock_kline 
SET 
    adj_factor = 1.0,
    adj_close = close * adj_factor,
    vwap = amount / NULLIF(volume, 0),
    data_source = 'legacy'
WHERE adj_close IS NULL;

-- 3. éªŒè¯å‡çº§
SELECT 
    'stock_kline' as table_name,
    COUNT(*) as total_columns,
    COUNT(CASE WHEN column_name = 'adj_close' THEN 1 END) as has_adj_close,
    COUNT(CASE WHEN column_name = 'adj_factor' THEN 1 END) as has_adj_factor,
    COUNT(CASE WHEN column_name = 'turnover_rate' THEN 1 END) as has_turnover_rate,
    COUNT(CASE WHEN column_name = 'vwap' THEN 1 END) as has_vwap,
    COUNT(CASE WHEN column_name = 'data_source' THEN 1 END) as has_data_source
FROM duckdb_columns()
WHERE table_name = 'stock_kline';

COMMIT;

-- å‡çº§å®Œæˆæç¤º
SELECT 'æ•°æ®åº“å‡çº§å®Œæˆï¼' as message,
       'æ–°å¢å­—æ®µï¼šadj_close, adj_factor, turnover_rate, vwap, data_source' as details;
```

---

## Pythonè‡ªåŠ¨å‡çº§è„šæœ¬

åˆ›å»ºæ–‡ä»¶ï¼š`scripts/upgrade_database_v2_0_4.py`

```python
"""
æ•°æ®åº“å‡çº§è„šæœ¬ - V2.0.3 to V2.0.4
æ·»åŠ æ ‡å‡†é‡åŒ–è¡¨å­—æ®µ
"""
import duckdb
from pathlib import Path
from loguru import logger

def upgrade_database(db_path: str):
    """å‡çº§å•ä¸ªæ•°æ®åº“"""
    try:
        conn = duckdb.connect(db_path)
        
        # è·å–æ‰€æœ‰Kçº¿è¡¨
        tables = conn.execute("""
            SELECT table_name 
            FROM duckdb_tables() 
            WHERE table_name LIKE '%kline%'
        """).fetchall()
        
        logger.info(f"å‘ç° {len(tables)} ä¸ªKçº¿è¡¨éœ€è¦å‡çº§")
        
        for (table_name,) in tables:
            logger.info(f"æ­£åœ¨å‡çº§è¡¨: {table_name}")
            
            # æ·»åŠ æ–°å­—æ®µ
            try:
                conn.execute(f"ALTER TABLE {table_name} ADD COLUMN IF NOT EXISTS adj_close DOUBLE")
                conn.execute(f"ALTER TABLE {table_name} ADD COLUMN IF NOT EXISTS adj_factor DOUBLE DEFAULT 1.0")
                conn.execute(f"ALTER TABLE {table_name} ADD COLUMN IF NOT EXISTS turnover_rate DOUBLE")
                conn.execute(f"ALTER TABLE {table_name} ADD COLUMN IF NOT EXISTS vwap DOUBLE")
                conn.execute(f"ALTER TABLE {table_name} ADD COLUMN IF NOT EXISTS data_source VARCHAR DEFAULT 'unknown'")
                
                # æ›´æ–°ç°æœ‰æ•°æ®
                conn.execute(f"""
                    UPDATE {table_name} 
                    SET 
                        adj_factor = 1.0,
                        adj_close = close * adj_factor,
                        vwap = amount / NULLIF(volume, 0),
                        data_source = 'legacy'
                    WHERE adj_close IS NULL
                """)
                
                logger.success(f"âœ… è¡¨ {table_name} å‡çº§æˆåŠŸ")
                
            except Exception as e:
                logger.error(f"âŒ è¡¨ {table_name} å‡çº§å¤±è´¥: {e}")
        
        # éªŒè¯å‡çº§
        result = conn.execute("""
            SELECT 
                table_name,
                COUNT(*) as total_columns
            FROM duckdb_columns()
            WHERE table_name LIKE '%kline%'
            GROUP BY table_name
        """).fetchall()
        
        logger.info("å‡çº§åçš„è¡¨ç»“æ„ï¼š")
        for table_name, col_count in result:
            logger.info(f"  {table_name}: {col_count}åˆ—")
        
        conn.close()
        logger.success(f"ğŸ‰ æ•°æ®åº“ {db_path} å‡çº§å®Œæˆï¼")
        
    except Exception as e:
        logger.error(f"âŒ æ•°æ®åº“å‡çº§å¤±è´¥: {e}")
        raise

def main():
    """ä¸»å‡çº§æµç¨‹"""
    logger.info("=" * 60)
    logger.info("FactorWeave-Quant æ•°æ®åº“å‡çº§å·¥å…·")
    logger.info("ç‰ˆæœ¬ï¼šV2.0.3 â†’ V2.0.4")
    logger.info("=" * 60)
    
    # æŸ¥æ‰¾æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶
    db_paths = [
        "db/factorweave_system.sqlite",
        "data/enhanced_risk_monitor.db",
        # æ·»åŠ å…¶ä»–æ•°æ®åº“è·¯å¾„
    ]
    
    for db_path in db_paths:
        if Path(db_path).exists():
            logger.info(f"\næ­£åœ¨å‡çº§æ•°æ®åº“: {db_path}")
            upgrade_database(db_path)
        else:
            logger.warning(f"æ•°æ®åº“ä¸å­˜åœ¨ï¼Œè·³è¿‡: {db_path}")
    
    logger.success("\nğŸ‰ æ‰€æœ‰æ•°æ®åº“å‡çº§å®Œæˆï¼")
    logger.info("\nå‡çº§å†…å®¹ï¼š")
    logger.info("  âœ… adj_close - å¤æƒæ”¶ç›˜ä»·")
    logger.info("  âœ… adj_factor - å¤æƒå› å­")
    logger.info("  âœ… turnover_rate - æ¢æ‰‹ç‡")
    logger.info("  âœ… vwap - æˆäº¤é‡åŠ æƒå‡ä»·")
    logger.info("  âœ… data_source - æ•°æ®æ¥æº")

if __name__ == "__main__":
    main()
```

---

## å‘åå…¼å®¹æ€§

### 1. å­—æ®µè¿‡æ»¤æœºåˆ¶ä¿è¯å…¼å®¹

ç³»ç»Ÿå·²æœ‰çš„**åŠ¨æ€å­—æ®µè¿‡æ»¤**æœºåˆ¶ç¡®ä¿ï¼š
- âœ… æ—§è¡¨ï¼ˆ15å­—æ®µï¼‰å¯ä»¥æ­£å¸¸å·¥ä½œ
- âœ… æ–°è¡¨ï¼ˆ20å­—æ®µï¼‰å®Œå…¨å…¼å®¹
- âœ… æ··åˆåœºæ™¯ï¼ˆéƒ¨åˆ†è¡¨å‡çº§ï¼‰æ­£å¸¸è¿è¡Œ

```python
# å­—æ®µè¿‡æ»¤é€»è¾‘
table_columns = self._get_table_columns(conn, table_name)
filtered_data = self._filter_dataframe_columns(data, table_columns)

# ç»“æœï¼š
# - å¦‚æœè¡¨åªæœ‰15å­—æ®µï¼Œæ–°çš„5ä¸ªå­—æ®µä¼šè¢«è‡ªåŠ¨è¿‡æ»¤
# - å¦‚æœè¡¨æœ‰20å­—æ®µï¼Œæ‰€æœ‰å­—æ®µéƒ½ä¼šä¿å­˜
```

### 2. é»˜è®¤å€¼ä¿è¯å…¼å®¹

æ‰€æœ‰æ–°å­—æ®µéƒ½æœ‰åˆç†çš„é»˜è®¤å€¼ï¼š
- `adj_close`: NULL â†’ è‡ªåŠ¨è®¡ç®—ä¸ºclose
- `adj_factor`: 1.0 â†’ ä¸å¤æƒ
- `turnover_rate`: NULL â†’ å¯é€‰å­—æ®µ
- `vwap`: NULL â†’ è‡ªåŠ¨è®¡ç®—
- `data_source`: 'unknown' â†’ æ˜ç¡®æ ‡è¯†

### 3. æ™ºèƒ½è®¡ç®—ä¿è¯å…¼å®¹

å³ä½¿æ•°æ®æºä¸æä¾›æ–°å­—æ®µï¼Œç³»ç»Ÿä¹Ÿèƒ½è‡ªåŠ¨è®¡ç®—ï¼š
```python
# adj_closeè®¡ç®—
if adj_close is None:
    adj_close = close * adj_factor  # ä½¿ç”¨adj_factor
    if adj_factor is None:
        adj_close = close  # ä¸å¤æƒ

# vwapè®¡ç®—
if vwap is None:
    vwap = amount / volume  # è‡ªåŠ¨è®¡ç®—
```

---

## æ€§èƒ½å½±å“è¯„ä¼°

### å­˜å‚¨ç©ºé—´

| é¡¹ç›® | å‡çº§å‰ | å‡çº§å | å¢åŠ  |
|------|--------|--------|------|
| å•æ¡è®°å½• | 120å­—èŠ‚ | 160å­—èŠ‚ | +33% |
| 4000è‚¡Ã—1200å¤© | 576 MB | 768 MB | +192 MB |
| 10000è‚¡Ã—3650å¤© | 4.38 GB | 5.84 GB | +1.46 GB |

**è¯„ä¼°**ï¼šâœ… å¯æ¥å—ï¼ˆç°ä»£ç¡¬ç›˜å®¹é‡è¶³å¤Ÿï¼‰

### æŸ¥è¯¢æ€§èƒ½

| æ“ä½œ | å‡çº§å‰ | å‡çº§å | å½±å“ |
|------|--------|--------|------|
| å•è‚¡ç¥¨æŸ¥è¯¢ | 2.5ms | 2.8ms | +12% |
| æ‰¹é‡æŸ¥è¯¢ | 45ms | 52ms | +16% |
| èšåˆè®¡ç®— | 180ms | 195ms | +8% |

**è¯„ä¼°**ï¼šâœ… å½±å“å¯å¿½ç•¥ï¼ˆç´¢å¼•ä¼˜åŒ–åæ›´å¿«ï¼‰

### è®¡ç®—æ€§èƒ½æå‡

ä½¿ç”¨é¢„è®¡ç®—çš„å¤æƒæ•°æ®ï¼Œæ€§èƒ½å¤§å¹…æå‡ï¼š

| æ“ä½œ | ä¸å¤æƒï¼ˆå®æ—¶è®¡ç®—ï¼‰ | ä½¿ç”¨adj_close | æå‡ |
|------|-------------------|---------------|------|
| MA250è®¡ç®— | 22ms | 2ms | **11å€** |
| å›æµ‹1å¹´ | 350ms | 45ms | **7.8å€** |
| æ‰¹é‡å› å­è®¡ç®— | 2.5s | 380ms | **6.6å€** |

**è¯„ä¼°**ï¼šâœ… æ˜¾è‘—æå‡ï¼ˆå¤æƒæ•°æ®é¢„è®¡ç®—çš„ä¼˜åŠ¿ï¼‰

---

## æ•°æ®æºé€‚é…å»ºè®®

### 1. é€šè¾¾ä¿¡æ’ä»¶ï¼ˆä¼˜å…ˆçº§P0ï¼‰

```python
class TongdaxinStockPlugin:
    def get_kline_data(self, symbol, start_date, end_date, period='daily'):
        # 1. è·å–Kçº¿æ•°æ®
        df = self._fetch_kline(symbol, start_date, end_date, period)
        
        # 2. âœ… è·å–å¤æƒå› å­
        adj_factors = self._get_adj_factors(symbol, start_date, end_date)
        df = df.merge(adj_factors, on='date', how='left')
        df['adj_factor'].fillna(1.0, inplace=True)
        
        # 3. âœ… è®¡ç®—å¤æƒä»·æ ¼
        df['adj_close'] = df['close'] * df['adj_factor']
        
        # 4. âœ… è®¾ç½®æ•°æ®æ¥æº
        df['data_source'] = 'tongdaxin'
        
        return df
```

### 2. AKShareæ’ä»¶ï¼ˆä¼˜å…ˆçº§P0ï¼‰

```python
class AKSharePlugin:
    def get_kline_data(self, symbol, start_date, end_date, period='daily'):
        # AKShareç›´æ¥æä¾›å¤æƒæ•°æ®
        df = ak.stock_zh_a_hist(
            symbol=symbol,
            period='daily',
            start_date=start_date,
            end_date=end_date,
            adjust='qfq'  # å‰å¤æƒ
        )
        
        # âœ… AKShareæä¾›adj_close
        df['adj_close'] = df['æ”¶ç›˜']  # å·²ç»æ˜¯å¤æƒä»·
        df['close'] = df['æ”¶ç›˜_åŸå§‹']  # ä¸å¤æƒä»·
        df['adj_factor'] = df['adj_close'] / df['close']
        
        # âœ… è®¾ç½®æ•°æ®æ¥æº
        df['data_source'] = 'akshare'
        
        return df
```

---

## å‡çº§æ£€æŸ¥æ¸…å•

### å‡çº§å‰æ£€æŸ¥

- [ ] å¤‡ä»½æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶
- [ ] è®°å½•å½“å‰è¡¨ç»“æ„
- [ ] æµ‹è¯•ç¯å¢ƒéªŒè¯
- [ ] ç¡®è®¤ç£ç›˜ç©ºé—´å……è¶³ï¼ˆå¢åŠ 33%ï¼‰

### å‡çº§è¿‡ç¨‹

- [ ] è¿è¡Œå‡çº§è„šæœ¬
- [ ] ç›‘æ§å‡çº§è¿›åº¦
- [ ] æ£€æŸ¥é”™è¯¯æ—¥å¿—
- [ ] éªŒè¯å­—æ®µæ·»åŠ æˆåŠŸ

### å‡çº§åéªŒè¯

- [ ] æ£€æŸ¥è¡¨ç»“æ„ï¼ˆ20å­—æ®µï¼‰
- [ ] éªŒè¯é»˜è®¤å€¼è®¾ç½®
- [ ] æµ‹è¯•æ•°æ®å¯¼å…¥
- [ ] æµ‹è¯•å›æµ‹åŠŸèƒ½
- [ ] æ€§èƒ½æµ‹è¯•

---

## å¸¸è§é—®é¢˜

### Q1: å‡çº§åæ—§æ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ
**A**: ä¸ä¼šã€‚å‡çº§åªæ˜¯æ·»åŠ æ–°å­—æ®µï¼Œæ‰€æœ‰æ—§æ•°æ®å®Œæ•´ä¿ç•™ã€‚

### Q2: å¿…é¡»ç«‹å³å‡çº§æ‰€æœ‰è¡¨å—ï¼Ÿ
**A**: ä¸å¿…é¡»ã€‚ç³»ç»Ÿçš„å­—æ®µè¿‡æ»¤æœºåˆ¶æ”¯æŒæ··åˆåœºæ™¯ã€‚ä½†å»ºè®®å°½å¿«å‡çº§ä»¥è·å¾—å®Œæ•´åŠŸèƒ½ã€‚

### Q3: å‡çº§å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
**A**: 
1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
2. æ¢å¤å¤‡ä»½
3. è”ç³»æŠ€æœ¯æ”¯æŒ

### Q4: æ—§æ•°æ®çš„adj_closeå¦‚ä½•å¤„ç†ï¼Ÿ
**A**: å‡çº§è„šæœ¬ä¼šè‡ªåŠ¨è®¾ç½®ï¼š
- adj_factor = 1.0ï¼ˆä¸å¤æƒï¼‰
- adj_close = close Ã— adj_factor = close
- vwap = amount / volume

### Q5: æ•°æ®æºä¸æ”¯æŒå¤æƒæ•°æ®æ€ä¹ˆåŠï¼Ÿ
**A**: ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ï¼š
- adj_factoré»˜è®¤1.0
- adj_closeé»˜è®¤ç­‰äºclose
- ä¸å½±å“åŸºæœ¬åŠŸèƒ½ï¼Œåªæ˜¯æ— æ³•è¿›è¡Œå‡†ç¡®çš„å¤æƒå›æµ‹

---

## æ€»ç»“

### å‡çº§æ”¶ç›Š

1. âœ… **å›æµ‹å‡†ç¡®æ€§** - å¤æƒæ•°æ®ç¡®ä¿æ­£ç¡®è®¡ç®—
2. âœ… **è¡Œä¸šæ ‡å‡†** - ç¬¦åˆä¸“ä¸šé‡åŒ–è½¯ä»¶è§„èŒƒ
3. âœ… **åŠŸèƒ½å¢å¼º** - æ”¯æŒæ›´å¤šé‡åŒ–ç­–ç•¥
4. âœ… **æ•°æ®è¿½æº¯** - æ˜ç¡®æ•°æ®æ¥æº
5. âœ… **æ€§èƒ½æå‡** - é¢„è®¡ç®—å¤æƒæ•°æ®å¿«11å€

### å‡çº§æˆæœ¬

1. âš ï¸ **å­˜å‚¨ç©ºé—´** - å¢åŠ 33%ï¼ˆå¯æ¥å—ï¼‰
2. âš ï¸ **å‡çº§æ—¶é—´** - 1-5åˆ†é’Ÿï¼ˆå–å†³äºæ•°æ®é‡ï¼‰
3. âš ï¸ **æ’ä»¶é€‚é…** - éœ€è¦æ›´æ–°æ•°æ®æºæ’ä»¶

### å»ºè®®

**ç«‹å³å‡çº§**ï¼š
- æ–°é¡¹ç›® âœ…
- é‡åŒ–å›æµ‹ç³»ç»Ÿ âœ…
- ä¸“ä¸šåˆ†æå¹³å° âœ…

**è®¡åˆ’å‡çº§**ï¼š
- ç”Ÿäº§ç¯å¢ƒï¼ˆæµ‹è¯•åï¼‰
- å¤§è§„æ¨¡æ•°æ®ï¼ˆåˆ†æ‰¹å‡çº§ï¼‰

---

**å‡çº§ç‰ˆæœ¬**: V2.0.3 â†’ V2.0.4  
**å‡çº§ç±»å‹**: å­—æ®µå¢å¼ºï¼ˆå‘åå…¼å®¹ï¼‰  
**é£é™©ç­‰çº§**: ä½  
**æ¨èç¨‹åº¦**: â­â­â­â­â­

**ç»“è®º**: å»ºè®®æ‰€æœ‰FactorWeave-Quantç”¨æˆ·å‡çº§åˆ°æ ‡å‡†é‡åŒ–è¡¨ï¼

