# 交易系统重构修复计划

## 问题分析

### 发现的主要问题

1. **功能重复和架构不统一**
   - `TradingSystem` (core/trading_system.py) - 老版本，直接使用hikyuu API
   - `TradingEngine` (core/trading_engine.py) - 新版本，使用插件架构
   - `TradingService` (core/services/trading_service.py) - 最新版本，完整的服务架构
   - `TradingManager` (core/business/trading_manager.py) - 业务逻辑层
   - `TradingController` (core/trading_controller.py) - UI控制层，存在错误依赖

2. **调用链错误**
   - `TradingController` 试图连接 `TradingSystem` 的PyQt信号，但这些信号不存在
   - `TradingController` 调用 `TradingSystem` 的不存在方法：
     - `get_current_risk()`
     - `execute_order()`
     - `initialized` 属性
     - `initialize_systems()`
   - 不同组件使用不同的数据访问方式

3. **架构违反插件原则**
   - `TradingSystem` 直接使用hikyuu API，违反插件架构原则
   - 存在直接的hikyuu导入和调用

### 调用链分析

```
错误的调用链:
UI层: TradingWidget -> TradingController -> TradingSystem (直接hikyuu调用)

正确的调用链:
UI层: TradingWidget -> ServiceContainer -> TradingService
服务层: TradingService -> StrategyPlugins -> UnifiedDataManager -> TET Pipeline
```

## 修复策略

### 1. 保留最稳定的版本
- **保留**: `TradingService` - 功能最完整，架构最现代
- **保留**: `TradingEngine` - 作为TradingService的核心引擎
- **合并**: `TradingManager` 的订单管理功能到 `TradingService`
- **重构**: `TradingController` 使用正确的服务依赖
- **废弃**: `TradingSystem` - 替换为插件架构版本

### 2. 功能合并计划

#### 2.1 TradingService 增强 (保留为主要交易服务)
- 合并 `TradingManager` 的订单管理功能
- 合并 `TradingSystem` 的回测功能 (重构为插件架构)
- 保持现有的策略插件支持

#### 2.2 TradingEngine 整合 (作为TradingService的核心)
- 保持现有的信号处理和仓位管理
- 与TradingService深度集成

#### 2.3 TradingController 重构
- 移除对TradingSystem的错误依赖
- 改为使用ServiceContainer获取TradingService
- 添加缺失的PyQt信号定义

## 实施计划

### Phase 1: 修复TradingController的错误依赖
1. 重构TradingController使用TradingService
2. 添加缺失的PyQt信号
3. 修复方法调用错误

### Phase 2: 合并TradingManager功能到TradingService
1. 将订单管理功能合并到TradingService
2. 保留TradingManager的业务逻辑但使用TradingService
3. 统一交易记录和统计功能

### Phase 3: 重构TradingSystem为插件架构
1. 将TradingSystem的回测功能迁移到TradingService
2. 移除直接的hikyuu调用
3. 使用UnifiedDataManager和插件架构

### Phase 4: 清理和优化
1. 删除重复的代码
2. 统一接口和数据结构
3. 更新UI组件使用统一的服务

### Phase 5: 验证和测试
1. 确保所有交易功能正常工作
2. 验证UI组件正常调用和显示
3. 测试插件架构的兼容性

## 文件修改清单

### 需要重构的文件
1. `core/trading_controller.py` - 修复错误依赖
2. `core/trading_system.py` - 重构为插件架构或废弃
3. `core/services/trading_service.py` - 增强功能
4. `core/business/trading_manager.py` - 保留但使用TradingService

### 需要更新的UI文件
1. `gui/widgets/trading_widget.py` - 确保使用正确的服务
2. `gui/widgets/trading_panel.py` - 更新服务调用
3. `gui/widgets/enhanced_trading_monitor_widget.py` - 统一接口

### 需要验证的文件
1. 所有使用交易功能的UI组件
2. 策略插件的兼容性
3. 回测功能的正确性

## 预期结果

1. **统一的交易架构**: 所有交易功能通过TradingService统一管理
2. **插件兼容性**: 完全符合插件架构原则，不直接调用hikyuu
3. **功能完整性**: 保留所有现有功能，提升稳定性
4. **UI正常工作**: 所有交易相关UI组件正常调用和显示
5. **代码清洁**: 移除重复代码，统一接口标准 