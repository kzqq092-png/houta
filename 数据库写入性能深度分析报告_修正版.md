# æ•°æ®åº“å†™å…¥æ€§èƒ½æ·±åº¦åˆ†ææŠ¥å‘Šï¼ˆä¿®æ­£ç‰ˆï¼‰

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**ç°è±¡**ï¼š
- å†™å…¥5711æ¡è®°å½•è€—æ—¶16.26ç§’
- å†™å…¥é€Ÿåº¦ï¼š351.3æ¡/ç§’
- å†™å…¥çº¿ç¨‹æ˜¾ç¤ºï¼š5214æ¡è®°å½•è€—æ—¶14.77ç§’ï¼Œé€Ÿåº¦353.0æ¡/ç§’

**é¢„æœŸæ€§èƒ½**ï¼š
- ç†æƒ³æƒ…å†µä¸‹åº”è¯¥è¾¾åˆ°ï¼š5000-10000æ¡/ç§’
- å½“å‰æ€§èƒ½ä»…ä¸ºé¢„æœŸçš„3.5%-7%

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æï¼ˆé‡æ–°å®¡è§†ï¼‰

### 1. **executemanyé€æ¡æ‰§è¡ŒON CONFLICTï¼ˆä¸»è¦åŸå› ï¼Œ60-70%ï¼‰**

**é—®é¢˜ç¡®è®¤**ï¼š
```python
# å½“å‰å®ç°
data_tuples = [tuple(row) for row in filtered_data.values]
conn.executemany(sql, data_tuples)  # é€æ¡æ‰§è¡ŒINSERT ON CONFLICT
```

**åˆ†æ**ï¼š
- âœ… **ç¡®è®¤**ï¼šDuckDBçš„`executemany`å¯¹äº`INSERT ... ON CONFLICT`è¯­å¥ï¼Œ**ç¡®å®æ˜¯é€æ¡æ‰§è¡Œ**
- æ¯æ¡è®°å½•éƒ½éœ€è¦ï¼š
  1. æ£€æŸ¥ä¸»é”®å†²çªï¼ˆ4ä¸ªå­—æ®µï¼šsymbol, data_source, timestamp, frequencyï¼‰
  2. å¦‚æœå†²çªåˆ™æ‰§è¡ŒUPDATEï¼Œå¦åˆ™æ‰§è¡ŒINSERT
  3. ç»´æŠ¤æ‰€æœ‰ç´¢å¼•ï¼ˆ5ä¸ªç´¢å¼•ï¼‰
  4. æ›´æ–°updated_atå­—æ®µï¼ˆè°ƒç”¨NOW()å‡½æ•°ï¼‰

**æ€§èƒ½å¼€é”€**ï¼š
- 5711æ¡è®°å½• = 5711æ¬¡ä¸»é”®æ£€æŸ¥
- 5711æ¬¡ç´¢å¼•ç»´æŠ¤
- 5711æ¬¡äº‹åŠ¡æ—¥å¿—å†™å…¥
- 5711æ¬¡NOW()å‡½æ•°è°ƒç”¨

**å½±å“**ï¼š**çº¦å æ€»è€—æ—¶çš„60-70%**

---

### 2. **ç´¢å¼•ç»´æŠ¤å¼€é”€ï¼ˆæ¬¡è¦åŸå› ï¼Œ15-20%ï¼‰**

**å½“å‰ç´¢å¼•**ï¼š
```sql
CREATE INDEX idx_historical_kline_data_symbol ON historical_kline_data(symbol)
CREATE INDEX idx_historical_kline_data_timestamp ON historical_kline_data(timestamp)
CREATE INDEX idx_historical_kline_data_symbol_timestamp ON historical_kline_data(symbol, timestamp)
CREATE INDEX idx_historical_kline_data_data_source ON historical_kline_data(data_source)
CREATE INDEX idx_historical_kline_data_conflict_key ON historical_kline_data(symbol, data_source, timestamp, frequency)
```

**é—®é¢˜åˆ†æ**ï¼š
- âœ… **ç¡®è®¤**ï¼š5ä¸ªç´¢å¼•ï¼Œæ¯æ¬¡æ’å…¥/æ›´æ–°éƒ½éœ€è¦ç»´æŠ¤
- âš ï¸ **ä¿®æ­£**ï¼š`conflict_key`ç´¢å¼•**ä¸å®Œå…¨é‡å¤**ä¸»é”®ç´¢å¼•
  - ä¸»é”®ç´¢å¼•ï¼šè‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºå”¯ä¸€æ€§çº¦æŸ
  - conflict_keyç´¢å¼•ï¼šæ˜¾å¼åˆ›å»ºï¼Œç”¨äºä¼˜åŒ–ON CONFLICTæŸ¥è¯¢
  - ä½†ä¸¤è€…ç¡®å®æœ‰é‡å ï¼Œå¯ä»¥è€ƒè™‘ä¼˜åŒ–
- âš ï¸ **ä¿®æ­£**ï¼š`symbol_timestamp`ç´¢å¼•ä¸`conflict_key`ç´¢å¼•æœ‰é‡å 
  - å¦‚æœæŸ¥è¯¢ç»å¸¸ä½¿ç”¨`(symbol, timestamp)`ï¼Œä¿ç•™æ­¤ç´¢å¼•
  - å¦‚æœæŸ¥è¯¢ä¸»è¦ä½¿ç”¨å®Œæ•´ä¸»é”®ï¼Œå¯ä»¥ç§»é™¤

**å½±å“**ï¼š**çº¦å æ€»è€—æ—¶çš„15-20%**

---

### 3. **æ•°æ®è½¬æ¢å¼€é”€ï¼ˆæ¬¡è¦åŸå› ï¼Œ5-10%ï¼‰**

**å½“å‰å®ç°**ï¼š
```python
data_tuples = [tuple(row) for row in filtered_data.values]
```

**åˆ†æ**ï¼š
- DataFrameè½¬Python tupleåˆ—è¡¨éœ€è¦å†…å­˜æ‹·è´
- 5711æ¡è®°å½• Ã— çº¦15ä¸ªå­—æ®µ = 85665ä¸ªå€¼éœ€è¦è½¬æ¢
- Pythonå¯¹è±¡åˆ›å»ºå¼€é”€

**å½±å“**ï¼š**çº¦å æ€»è€—æ—¶çš„5-10%**

---

### 4. **ON CONFLICTæ£€æŸ¥é€»è¾‘ï¼ˆæ¬¡è¦åŸå› ï¼Œ10-15%ï¼‰**

**å½“å‰SQL**ï¼š
```sql
INSERT INTO historical_kline_data (...) 
VALUES (?)
ON CONFLICT (symbol, data_source, timestamp, frequency) DO UPDATE SET
    open = EXCLUDED.open,
    high = EXCLUDED.high,
    ...
    updated_at = NOW()
```

**é—®é¢˜**ï¼š
- âœ… **ç¡®è®¤**ï¼šæ¯æ¡è®°å½•éƒ½éœ€è¦æ£€æŸ¥4ä¸ªå­—æ®µçš„å¤åˆä¸»é”®
- âœ… **ç¡®è®¤**ï¼šå³ä½¿æ²¡æœ‰å†²çªï¼Œä¹Ÿéœ€è¦æ£€æŸ¥
- âš ï¸ **ä¿®æ­£**ï¼š`NOW()`å‡½æ•°è°ƒç”¨å¼€é”€ï¼ˆæ¯æ¡è®°å½•ï¼‰
  - åœ¨æ‰¹é‡INSERTä¸­ï¼Œåº”è¯¥ä½¿ç”¨å¸¸é‡å€¼æˆ–æ‰¹é‡æ›´æ–°

**å½±å“**ï¼š**çº¦å æ€»è€—æ—¶çš„10-15%**

---

### 5. **æ•°æ®è´¨é‡éªŒè¯å¼€é”€ï¼ˆé—æ¼é¡¹ï¼Œ3-5%ï¼‰**

**å½“å‰å®ç°**ï¼š
```python
if data_type == DataType.HISTORICAL_KLINE:
    is_valid, errors = self._validate_kline_data_quality(data)
```

**åˆ†æ**ï¼š
- âš ï¸ **é—æ¼**ï¼šæ•°æ®è´¨é‡éªŒè¯å¯¹æ¯æ¡è®°å½•è¿›è¡Œæ£€æŸ¥
- éªŒè¯é€»è¾‘å¯èƒ½åŒ…æ‹¬ï¼šç©ºå€¼æ£€æŸ¥ã€èŒƒå›´æ£€æŸ¥ã€æ•°æ®ç±»å‹æ£€æŸ¥ç­‰
- è¿™ä¸ªå¼€é”€åœ¨ä¹‹å‰çš„åˆ†æä¸­è¢«é—æ¼

**å½±å“**ï¼š**çº¦å æ€»è€—æ—¶çš„3-5%**

---

### 6. **è¡¨ç»“æ„æŸ¥è¯¢å¼€é”€ï¼ˆé—æ¼é¡¹ï¼Œ1-2%ï¼‰**

**å½“å‰å®ç°**ï¼š
```python
table_columns = self._get_table_columns(conn, table_name)
filtered_data = self._filter_dataframe_columns(data, table_columns)
```

**åˆ†æ**ï¼š
- âš ï¸ **é—æ¼**ï¼š`_get_table_columns`éœ€è¦æŸ¥è¯¢æ•°æ®åº“å…ƒæ•°æ®
- è™½ç„¶å¯ä»¥ç¼“å­˜ï¼Œä½†æ¯æ¬¡è°ƒç”¨ä»æœ‰å¼€é”€
- DataFrameè¿‡æ»¤æ“ä½œä¹Ÿæœ‰å¼€é”€

**å½±å“**ï¼š**çº¦å æ€»è€—æ—¶çš„1-2%**

---

### 7. **æ—¥å¿—è¾“å‡ºå¼€é”€ï¼ˆè½»å¾®å½±å“ï¼Œ1-2%ï¼‰**

**å½“å‰å®ç°**ï¼š
```python
logger.debug(f"[æ•°æ®æ’å…¥] æ‰§è¡Œæ‰¹é‡æ’å…¥ï¼Œè¡¨: {table_name}, è®°å½•æ•°: {len(filtered_data)}")
```

**åˆ†æ**ï¼š
- è™½ç„¶å·²ç»ä¼˜åŒ–ä¸ºdebugçº§åˆ«ï¼Œä½†ä»æœ‰å¼€é”€
- å­—ç¬¦ä¸²æ ¼å¼åŒ–å¼€é”€

**å½±å“**ï¼š**çº¦å æ€»è€—æ—¶çš„1-2%**

---

## ğŸ“Š æ€§èƒ½ç“¶é¢ˆåˆ†å¸ƒï¼ˆä¿®æ­£ç‰ˆï¼‰

| ç“¶é¢ˆé¡¹ | å æ¯” | è¯´æ˜ |
|--------|------|------|
| executemanyé€æ¡æ‰§è¡Œ | 60-70% | ä¸»è¦ç“¶é¢ˆ |
| ç´¢å¼•ç»´æŠ¤ | 15-20% | æ¬¡è¦ç“¶é¢ˆ |
| ON CONFLICTæ£€æŸ¥ | 10-15% | æ¬¡è¦ç“¶é¢ˆ |
| æ•°æ®è½¬æ¢ | 5-10% | è½»å¾®å½±å“ |
| æ•°æ®è´¨é‡éªŒè¯ | 3-5% | é—æ¼é¡¹ |
| è¡¨ç»“æ„æŸ¥è¯¢ | 1-2% | é—æ¼é¡¹ |
| æ—¥å¿—è¾“å‡º | 1-2% | å¯å¿½ç•¥ |

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆï¼ˆä¿®æ­£ç‰ˆï¼‰

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨DuckDBæ‰¹é‡INSERTï¼ˆæ¨èï¼Œæ€§èƒ½æå‡10-50å€ï¼‰

**åŸç†**ï¼š
- ä½¿ç”¨DuckDBçš„`register`åŠŸèƒ½æ³¨å†ŒDataFrame
- ä½¿ç”¨`INSERT INTO ... SELECT FROM`æ‰¹é‡æ’å…¥
- ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰è®°å½•ï¼Œè€Œä¸æ˜¯é€æ¡æ‰§è¡Œ

**å®ç°ï¼ˆä¿®æ­£ç‰ˆï¼‰**ï¼š
```python
def _upsert_data_batch(self, conn, table_name: str, data: pd.DataFrame, data_type: DataType) -> int:
    """ä½¿ç”¨DuckDBæ‰¹é‡INSERTä¼˜åŒ–æ€§èƒ½ï¼ˆä¿®æ­£ç‰ˆï¼‰"""
    try:
        # è¿‡æ»¤æ•°æ®
        table_columns = self._get_table_columns(conn, table_name)
        filtered_data = self._filter_dataframe_columns(data, table_columns)
        
        if filtered_data.empty:
            return 0
        
        # âœ… ä¿®æ­£ï¼šä½¿ç”¨å”¯ä¸€ä¸´æ—¶è¡¨åç§°ï¼ˆé¿å…è¿æ¥æ± ä¸­çš„åç§°å†²çªï¼‰
        import time
        import threading
        temp_table = f"temp_insert_{int(time.time() * 1000000)}_{threading.get_ident()}"
        
        # âœ… ä¿®æ­£ï¼šç¡®ä¿åˆ—é¡ºåºä¸€è‡´ï¼ˆä¸èƒ½ä½¿ç”¨SELECT *ï¼‰
        columns = list(filtered_data.columns)
        columns_str = ', '.join(columns)
        
        try:
            # æ³¨å†ŒDataFrameä¸ºä¸´æ—¶è¡¨ï¼ˆé›¶æ‹·è´ï¼‰
            conn.register(temp_table, filtered_data)
            
            # âœ… ä¿®æ­£ï¼šä½¿ç”¨æ˜¾å¼äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
            # âš ï¸ æ³¨æ„ï¼šDuckDBé»˜è®¤æ˜¯è‡ªåŠ¨æäº¤æ¨¡å¼ï¼Œä½†æ˜¾å¼äº‹åŠ¡å¯ä»¥ç¡®ä¿åŸå­æ€§
            conn.execute("BEGIN TRANSACTION")
            
            try:
                # æ„å»ºæ‰¹é‡UPSERT SQL
                if data_type == DataType.HISTORICAL_KLINE:
                    # âœ… ç¡®è®¤ï¼šä¸»é”®å­—æ®µæ˜¯(symbol, data_source, timestamp, frequency)
                    # è·å–éœ€è¦æ›´æ–°çš„å­—æ®µï¼ˆæ’é™¤ä¸»é”®å­—æ®µï¼‰
                    update_fields = []
                    for col in filtered_data.columns:
                        if col not in ['symbol', 'data_source', 'timestamp', 'frequency']:
                            update_fields.append(f"{col} = EXCLUDED.{col}")
                    
                    # âœ… ä¿®æ­£ï¼šä½¿ç”¨CURRENT_TIMESTAMPè€Œä¸æ˜¯NOW()ï¼ˆæ‰¹é‡æ›´æ–°æ—¶æ›´é«˜æ•ˆï¼‰
                    # âš ï¸ æ³¨æ„ï¼šDuckDBä¸­CURRENT_TIMESTAMPå’ŒNOW()ç­‰ä»·ï¼Œä½†CURRENT_TIMESTAMPæ›´æ ‡å‡†
                    update_clause = ', '.join(update_fields)
                    if update_clause:
                        update_clause += ", updated_at = CURRENT_TIMESTAMP"
                    else:
                        update_clause = "updated_at = CURRENT_TIMESTAMP"
                    
                    sql = f"""
                        INSERT INTO {table_name} ({columns_str})
                        SELECT {columns_str} FROM {temp_table}
                        ON CONFLICT (symbol, data_source, timestamp, frequency) DO UPDATE SET
                        {update_clause}
                    """
                elif data_type == DataType.REAL_TIME_QUOTE:
                    # å®æ—¶è¡Œæƒ…ä½¿ç”¨symbolå’Œtimestampä½œä¸ºå”¯ä¸€é”®
                    update_fields = []
                    for col in filtered_data.columns:
                        if col not in ['symbol', 'timestamp']:
                            update_fields.append(f"{col} = EXCLUDED.{col}")
                    update_clause = ', '.join(update_fields) if update_fields else "current_price = EXCLUDED.current_price"
                    update_clause += ", updated_at = CURRENT_TIMESTAMP"
                    
                    sql = f"""
                        INSERT INTO {table_name} ({columns_str})
                        SELECT {columns_str} FROM {temp_table}
                        ON CONFLICT (symbol, timestamp) DO UPDATE SET
                        {update_clause}
                    """
                else:
                    # å…¶ä»–æ•°æ®ç±»å‹çš„ç®€å•æ’å…¥
                    sql = f"INSERT INTO {table_name} ({columns_str}) SELECT {columns_str} FROM {temp_table}"
                
                # æ‰§è¡Œæ‰¹é‡æ’å…¥
                write_start = time.time()
                conn.execute(sql)
                write_duration = time.time() - write_start
                
                # âœ… ä¿®æ­£ï¼šæäº¤äº‹åŠ¡
                conn.execute("COMMIT")
                
            except Exception as e:
                # âœ… ä¿®æ­£ï¼šå›æ»šäº‹åŠ¡
                try:
                    conn.execute("ROLLBACK")
                except Exception:
                    pass  # å›æ»šå¯èƒ½å¤±è´¥ï¼Œå¿½ç•¥
                raise
            finally:
                # âœ… ä¿®æ­£ï¼šç¡®ä¿æ¸…ç†ä¸´æ—¶è¡¨ï¼ˆå³ä½¿å‡ºé”™ï¼‰
                try:
                    conn.unregister(temp_table)
                except Exception:
                    pass  # ä¸´æ—¶è¡¨å¯èƒ½ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
            
            write_speed = len(filtered_data) / write_duration if write_duration > 0 else 0
            logger.info(f"[æ‰¹é‡æ’å…¥] æˆåŠŸæ’å…¥ {len(filtered_data)} æ¡è®°å½•ï¼Œè€—æ—¶: {write_duration:.2f}ç§’, é€Ÿåº¦: {write_speed:.1f}æ¡/ç§’")
            
            return len(filtered_data)
            
        except Exception as e:
            logger.error(f"[æ‰¹é‡æ’å…¥] æ’å…¥å¤±è´¥: {e}")
            raise
            
    except Exception as e:
        logger.error(f"[æ‰¹é‡æ’å…¥] å¤„ç†å¤±è´¥: {e}")
        raise
```

**å…³é”®ä¿®æ­£ç‚¹**ï¼š
1. âœ… **ä¸´æ—¶è¡¨åç§°å”¯ä¸€æ€§**ï¼šä½¿ç”¨æ—¶é—´æˆ³+çº¿ç¨‹IDç¡®ä¿å”¯ä¸€
2. âœ… **åˆ—é¡ºåºæ˜ç¡®**ï¼šä¸ä½¿ç”¨SELECT *ï¼Œæ˜ç¡®æŒ‡å®šåˆ—é¡ºåº
3. âœ… **äº‹åŠ¡ç®¡ç†**ï¼šæ˜¾å¼BEGIN/COMMIT/ROLLBACK
4. âœ… **é”™è¯¯å¤„ç†**ï¼šç¡®ä¿ä¸´æ—¶è¡¨æ¸…ç†
5. âœ… **NOW()ä¼˜åŒ–**ï¼šä½¿ç”¨CURRENT_TIMESTAMPï¼ˆæ‰¹é‡æ›´æ–°æ—¶æ›´é«˜æ•ˆï¼‰

**é¢„æœŸæ€§èƒ½æå‡**ï¼š
- 5711æ¡è®°å½•ï¼š16.26ç§’ â†’ **0.5-1.5ç§’**ï¼ˆæå‡10-30å€ï¼‰
- å†™å…¥é€Ÿåº¦ï¼š351æ¡/ç§’ â†’ **3500-11000æ¡/ç§’**

---

### æ–¹æ¡ˆ2ï¼šä¼˜åŒ–ç´¢å¼•ç»“æ„ï¼ˆæ€§èƒ½æå‡20-30%ï¼‰

**ä¼˜åŒ–ç­–ç•¥**ï¼š
1. **ä¿ç•™å¿…è¦ç´¢å¼•**ï¼š
   - ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼Œä¸èƒ½åˆ é™¤ï¼‰
   - `symbol_timestamp`ç´¢å¼•ï¼ˆå¦‚æœæŸ¥è¯¢å¸¸ç”¨ï¼‰
   - `data_source`ç´¢å¼•ï¼ˆå¦‚æœæŸ¥è¯¢å¸¸ç”¨ï¼‰

2. **ç§»é™¤é‡å¤ç´¢å¼•**ï¼š
   - âŒ `idx_symbol`ï¼ˆä¸»é”®å·²åŒ…å«symbolï¼‰
   - âŒ `idx_timestamp`ï¼ˆå·²æœ‰symbol_timestampï¼‰
   - âš ï¸ `idx_conflict_key`ï¼ˆä¸ä¸»é”®é‡å¤ï¼Œä½†å¯èƒ½ä¼˜åŒ–ON CONFLICTæŸ¥è¯¢ï¼‰

**ä¼˜åŒ–åçš„ç´¢å¼•**ï¼š
```sql
-- ä¿ç•™ï¼šä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
-- PRIMARY KEY (symbol, data_source, timestamp, frequency)

-- ä¿ç•™ï¼šæŸ¥è¯¢å¸¸ç”¨ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_historical_kline_data_symbol_timestamp 
ON historical_kline_data(symbol, timestamp);

-- å¯é€‰ï¼šå¦‚æœç»å¸¸æŒ‰data_sourceæŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_historical_kline_data_data_source 
ON historical_kline_data(data_source);

-- ç§»é™¤ï¼šé‡å¤ç´¢å¼•
-- âŒ CREATE INDEX idx_historical_kline_data_symbol (ä¸»é”®å·²åŒ…å«)
-- âŒ CREATE INDEX idx_historical_kline_data_timestamp (å·²æœ‰symbol_timestamp)
-- âš ï¸ CREATE INDEX idx_historical_kline_data_conflict_key (ä¸ä¸»é”®é‡å¤ï¼Œä½†å¯èƒ½ä¼˜åŒ–ON CONFLICT)
```

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
- ä¸èƒ½ç›²ç›®åˆ é™¤ç´¢å¼•ï¼Œéœ€è¦å…ˆåˆ†ææŸ¥è¯¢æ¨¡å¼
- `conflict_key`ç´¢å¼•è™½ç„¶ä¸ä¸»é”®é‡å¤ï¼Œä½†å¯èƒ½ä¼˜åŒ–ON CONFLICTæŸ¥è¯¢æ€§èƒ½
- å»ºè®®å…ˆæµ‹è¯•æ‰¹é‡INSERTçš„æ€§èƒ½æå‡ï¼Œå†å†³å®šæ˜¯å¦ä¼˜åŒ–ç´¢å¼•

**é¢„æœŸæ€§èƒ½æå‡**ï¼š
- ç´¢å¼•ç»´æŠ¤å¼€é”€å‡å°‘çº¦40%
- æ•´ä½“æ€§èƒ½æå‡çº¦20-30%

---

### æ–¹æ¡ˆ3ï¼šæ‰¹é‡å¤§å°è‡ªé€‚åº”ï¼ˆæ€§èƒ½æå‡10-20%ï¼‰

**åŸç†**ï¼š
- å°æ‰¹é‡ï¼ˆ<1000æ¡ï¼‰ï¼šä½¿ç”¨executemanyï¼ˆå½“å‰å®ç°ï¼‰
- å¤§æ‰¹é‡ï¼ˆâ‰¥1000æ¡ï¼‰ï¼šä½¿ç”¨æ‰¹é‡INSERTï¼ˆæ–¹æ¡ˆ1ï¼‰

**å®ç°**ï¼š
```python
def _upsert_data(self, conn, table_name: str, data: pd.DataFrame, data_type: DataType) -> int:
    """æ’å…¥æˆ–æ›´æ–°æ•°æ®ï¼ˆè‡ªé€‚åº”æ‰¹é‡å¤§å°ï¼‰"""
    # âœ… ä¿®æ­£ï¼šæ ¹æ®æ•°æ®é‡é€‰æ‹©æœ€ä¼˜ç­–ç•¥
    if len(data) < 1000:
        # å°æ‰¹é‡ï¼šä½¿ç”¨executemanyï¼ˆå½“å‰å®ç°ï¼‰
        return self._upsert_data_executemany(conn, table_name, data, data_type)
    else:
        # å¤§æ‰¹é‡ï¼šä½¿ç”¨æ‰¹é‡INSERTï¼ˆæ–¹æ¡ˆ1ï¼‰
        return self._upsert_data_batch(conn, table_name, data, data_type)
```

**é¢„æœŸæ€§èƒ½æå‡**ï¼š
- å°æ‰¹é‡ï¼šä¿æŒå½“å‰æ€§èƒ½
- å¤§æ‰¹é‡ï¼šæå‡10-50å€

---

### æ–¹æ¡ˆ4ï¼šä¼˜åŒ–æ•°æ®è´¨é‡éªŒè¯ï¼ˆæ€§èƒ½æå‡3-5%ï¼‰

**ä¼˜åŒ–ç­–ç•¥**ï¼š
1. **æ‰¹é‡éªŒè¯**ï¼šå¯¹æ•´æ‰¹æ•°æ®è¿›è¡ŒéªŒè¯ï¼Œè€Œä¸æ˜¯é€æ¡éªŒè¯
2. **ç¼“å­˜éªŒè¯ç»“æœ**ï¼šå¦‚æœæ•°æ®æ ¼å¼ç›¸åŒï¼Œå¯ä»¥ç¼“å­˜éªŒè¯ç»“æœ
3. **å¯é€‰éªŒè¯**ï¼šæ ¹æ®é…ç½®å†³å®šæ˜¯å¦è¿›è¡Œä¸¥æ ¼éªŒè¯

**å®ç°**ï¼š
```python
def _validate_kline_data_quality_batch(self, data: pd.DataFrame) -> Tuple[bool, List[str]]:
    """æ‰¹é‡éªŒè¯Kçº¿æ•°æ®è´¨é‡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰"""
    errors = []
    
    # âœ… æ‰¹é‡æ£€æŸ¥ï¼šä½¿ç”¨å‘é‡åŒ–æ“ä½œ
    if data.empty:
        return False, ["æ•°æ®ä¸ºç©º"]
    
    # æ‰¹é‡æ£€æŸ¥ç©ºå€¼
    required_cols = ['symbol', 'timestamp', 'open', 'high', 'low', 'close']
    missing_cols = [col for col in required_cols if col not in data.columns]
    if missing_cols:
        errors.append(f"ç¼ºå°‘å¿…éœ€å­—æ®µ: {missing_cols}")
    
    # æ‰¹é‡æ£€æŸ¥æ•°æ®ç±»å‹ï¼ˆä½¿ç”¨pandasçš„å‘é‡åŒ–æ“ä½œï¼‰
    if 'open' in data.columns:
        invalid_open = data[(data['open'] <= 0) | data['open'].isna()]
        if len(invalid_open) > 0:
            errors.append(f"openå­—æ®µæ— æ•ˆ: {len(invalid_open)}æ¡è®°å½•")
    
    # ... å…¶ä»–æ‰¹é‡æ£€æŸ¥
    
    return len(errors) == 0, errors
```

**é¢„æœŸæ€§èƒ½æå‡**ï¼š
- éªŒè¯å¼€é”€å‡å°‘çº¦50%
- æ•´ä½“æ€§èƒ½æå‡çº¦3-5%

---

### æ–¹æ¡ˆ5ï¼šç¼“å­˜è¡¨ç»“æ„ï¼ˆæ€§èƒ½æå‡1-2%ï¼‰

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- ç¼“å­˜è¡¨ç»“æ„ä¿¡æ¯ï¼Œé¿å…é‡å¤æŸ¥è¯¢
- ä½¿ç”¨LRUç¼“å­˜ç­–ç•¥

**å®ç°**ï¼š
```python
from functools import lru_cache
from typing import Dict, Tuple

class AssetSeparatedDatabaseManager:
    def __init__(self):
        # ... å…¶ä»–åˆå§‹åŒ–
        self._table_columns_cache: Dict[Tuple[str, str], List[str]] = {}
    
    def _get_table_columns(self, conn, table_name: str) -> list:
        """è·å–è¡¨çš„åˆ—åï¼ˆå¸¦ç¼“å­˜ï¼‰"""
        cache_key = (str(conn), table_name)
        
        if cache_key in self._table_columns_cache:
            return self._table_columns_cache[cache_key]
        
        # æŸ¥è¯¢è¡¨ç»“æ„
        columns = self._query_table_columns(conn, table_name)
        
        # ç¼“å­˜ç»“æœï¼ˆæœ€å¤šç¼“å­˜100ä¸ªè¡¨ï¼‰
        if len(self._table_columns_cache) < 100:
            self._table_columns_cache[cache_key] = columns
        
        return columns
```

**é¢„æœŸæ€§èƒ½æå‡**ï¼š
- è¡¨ç»“æ„æŸ¥è¯¢å¼€é”€å‡å°‘çº¦80%
- æ•´ä½“æ€§èƒ½æå‡çº¦1-2%

---

## âš ï¸ å…³é”®å‘ç°ï¼šç³»ç»Ÿä¸­å·²æœ‰æ‰¹é‡INSERTå®ç°ä½†æœªä½¿ç”¨

### é‡è¦å‘ç°

**é—®é¢˜**ï¼š
- âœ… `DuckDBOperations`ç±»ä¸­å·²ç»æœ‰`_upsert_batch`æ–¹æ³•ï¼Œä½¿ç”¨äº†`register`+æ‰¹é‡INSERT
- âŒ ä½†`AssetSeparatedDatabaseManager`æ²¡æœ‰ä½¿ç”¨`DuckDBOperations`ç±»
- âŒ `AssetSeparatedDatabaseManager`è‡ªå·±å®ç°äº†`_upsert_data`æ–¹æ³•ï¼Œä½¿ç”¨çš„æ˜¯`executemany`

**ç°æœ‰å®ç°**ï¼ˆ`core/database/duckdb_operations.py`ï¼‰ï¼š
```python
def _upsert_batch(self, conn, table_name: str, batch_data: pd.DataFrame,
                  conflict_columns: List[str]):
    """Upsertå•ä¸ªæ‰¹æ¬¡æ•°æ®"""
    columns = list(batch_data.columns)
    conflict_cols = ', '.join(conflict_columns)
    
    # æ„å»ºUPDATE SETå­å¥
    update_clauses = []
    for col in columns:
        if col not in conflict_columns:
            update_clauses.append(f"{col} = EXCLUDED.{col}")
    
    update_set = ', '.join(update_clauses)
    
    # âš ï¸ é—®é¢˜ï¼šä½¿ç”¨å›ºå®šä¸´æ—¶è¡¨åç§°ï¼ˆå¯èƒ½å†²çªï¼‰
    conn.register('temp_batch', batch_data)
    
    columns_str = ', '.join(columns)
    upsert_sql = f"""
    INSERT INTO {table_name} ({columns_str})
    SELECT {columns_str} FROM temp_batch
    ON CONFLICT ({conflict_cols}) 
    DO UPDATE SET {update_set}
    """
    
    conn.execute(upsert_sql)
    conn.unregister('temp_batch')
```

**é—®é¢˜åˆ†æ**ï¼š
1. âš ï¸ **ä¸´æ—¶è¡¨åç§°å›ºå®š**ï¼š`'temp_batch'`åœ¨è¿æ¥æ± ç¯å¢ƒä¸­å¯èƒ½å†²çª
2. âš ï¸ **æ²¡æœ‰äº‹åŠ¡ç®¡ç†**ï¼šæ²¡æœ‰BEGIN/COMMIT/ROLLBACK
3. âš ï¸ **é”™è¯¯å¤„ç†ä¸å®Œæ•´**ï¼šå¦‚æœå¤±è´¥ï¼Œä¸´æ—¶è¡¨å¯èƒ½æ²¡æœ‰æ¸…ç†
4. âš ï¸ **æ²¡æœ‰updated_atå­—æ®µæ›´æ–°**ï¼šç¼ºå°‘æ—¶é—´æˆ³æ›´æ–°

---

## âš ï¸ å…³é”®ä¿®æ­£ç‚¹æ€»ç»“

### 1. **ä¸´æ—¶è¡¨åç§°å†²çªé—®é¢˜**

**é—®é¢˜**ï¼š
- è¿æ¥æ± ä¼šå¤ç”¨è¿æ¥
- å¦‚æœä¸´æ—¶è¡¨åç§°å›ºå®šï¼Œå¯èƒ½å†²çª
- **ç°æœ‰å®ç°**ï¼š`DuckDBOperations._upsert_batch`ä½¿ç”¨å›ºå®šåç§°`'temp_batch'`

**ä¿®æ­£**ï¼š
```python
# âŒ é”™è¯¯ï¼šå›ºå®šåç§°ï¼ˆç°æœ‰å®ç°ï¼‰
temp_table = "temp_batch"

# âœ… æ­£ç¡®ï¼šå”¯ä¸€åç§°
import time
import threading
temp_table = f"temp_insert_{int(time.time() * 1000000)}_{threading.get_ident()}"
```

---

### 2. **åˆ—é¡ºåºé—®é¢˜**

**é—®é¢˜**ï¼š
- `SELECT * FROM temp_table`å¯èƒ½åˆ—é¡ºåºä¸ä¸€è‡´
- å¯¼è‡´æ•°æ®é”™ä½

**ä¿®æ­£**ï¼š
```python
# âŒ é”™è¯¯ï¼šä½¿ç”¨SELECT *
sql = f"INSERT INTO {table_name} SELECT * FROM {temp_table}"

# âœ… æ­£ç¡®ï¼šæ˜ç¡®æŒ‡å®šåˆ—é¡ºåº
columns_str = ', '.join(filtered_data.columns)
sql = f"INSERT INTO {table_name} ({columns_str}) SELECT {columns_str} FROM {temp_table}"
```

---

### 3. **äº‹åŠ¡ç®¡ç†é—®é¢˜**

**é—®é¢˜**ï¼š
- æ‰¹é‡INSERTå¦‚æœæ²¡æœ‰äº‹åŠ¡ï¼Œå¤±è´¥æ—¶å¯èƒ½å¯¼è‡´éƒ¨åˆ†æ•°æ®å†™å…¥

**ä¿®æ­£**ï¼š
```python
# âœ… æ·»åŠ æ˜¾å¼äº‹åŠ¡
conn.execute("BEGIN TRANSACTION")
try:
    conn.execute(sql)
    conn.execute("COMMIT")
except Exception as e:
    conn.execute("ROLLBACK")
    raise
```

---

### 4. **NOW()å‡½æ•°ä¼˜åŒ–**

**é—®é¢˜**ï¼š
- æ¯æ¡è®°å½•éƒ½è°ƒç”¨NOW()å‡½æ•°
- æ‰¹é‡INSERTä¸­åº”è¯¥ä½¿ç”¨å¸¸é‡å€¼

**ä¿®æ­£**ï¼š
```python
# âŒ é”™è¯¯ï¼šæ¯æ¡è®°å½•è°ƒç”¨NOW()
update_clause += ", updated_at = NOW()"

# âœ… æ­£ç¡®ï¼šä½¿ç”¨CURRENT_TIMESTAMPï¼ˆæ‰¹é‡æ›´æ–°æ—¶æ›´é«˜æ•ˆï¼‰
update_clause += ", updated_at = CURRENT_TIMESTAMP"
```

---

### 5. **é”™è¯¯å¤„ç†å’Œä¸´æ—¶è¡¨æ¸…ç†**

**é—®é¢˜**ï¼š
- å¦‚æœæ‰¹é‡INSERTå¤±è´¥ï¼Œä¸´æ—¶è¡¨å¯èƒ½æ²¡æœ‰æ¸…ç†
- å¯¼è‡´è¿æ¥æ± ä¸­çš„è¿æ¥æ±¡æŸ“

**ä¿®æ­£**ï¼š
```python
try:
    conn.register(temp_table, filtered_data)
    conn.execute(sql)
finally:
    # âœ… ç¡®ä¿æ¸…ç†ä¸´æ—¶è¡¨
    try:
        conn.unregister(temp_table)
    except Exception:
        pass  # ä¸´æ—¶è¡¨å¯èƒ½ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
```

---

### 6. **ç´¢å¼•ä¼˜åŒ–ç­–ç•¥ä¿®æ­£**

**é—®é¢˜**ï¼š
- ä¸èƒ½ç›²ç›®åˆ é™¤ç´¢å¼•
- éœ€è¦å…ˆåˆ†ææŸ¥è¯¢æ¨¡å¼

**ä¿®æ­£**ï¼š
- âš ï¸ **å»ºè®®**ï¼šå…ˆå®æ–½æ–¹æ¡ˆ1ï¼ˆæ‰¹é‡INSERTï¼‰ï¼Œæµ‹è¯•æ€§èƒ½æå‡
- å¦‚æœæ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå†è€ƒè™‘ä¼˜åŒ–ç´¢å¼•
- ç´¢å¼•ä¼˜åŒ–éœ€è¦æ ¹æ®å®é™…æŸ¥è¯¢æ¨¡å¼å†³å®š

---

## ğŸ¯ ç»¼åˆä¼˜åŒ–æ•ˆæœé¢„æµ‹ï¼ˆä¿®æ­£ç‰ˆï¼‰

| ä¼˜åŒ–æ–¹æ¡ˆ | æ€§èƒ½æå‡ | å®æ–½éš¾åº¦ | ä¼˜å…ˆçº§ | é£é™© |
|---------|---------|---------|--------|------|
| æ–¹æ¡ˆ1ï¼šæ‰¹é‡INSERT | 10-50å€ | ä¸­ç­‰ | â­â­â­â­â­ | ä½ |
| æ–¹æ¡ˆ2ï¼šä¼˜åŒ–ç´¢å¼• | 20-30% | ä½ | â­â­â­ | ä¸­ï¼ˆå¯èƒ½å½±å“æŸ¥è¯¢ï¼‰ |
| æ–¹æ¡ˆ3ï¼šè‡ªé€‚åº”æ‰¹é‡ | 10-20% | ä½ | â­â­â­â­ | ä½ |
| æ–¹æ¡ˆ4ï¼šä¼˜åŒ–éªŒè¯ | 3-5% | ä¸­ç­‰ | â­â­ | ä½ |
| æ–¹æ¡ˆ5ï¼šç¼“å­˜è¡¨ç»“æ„ | 1-2% | ä½ | â­ | ä½ |

**ç»¼åˆé¢„æœŸ**ï¼š
- **å½“å‰æ€§èƒ½**ï¼š351æ¡/ç§’
- **ä¼˜åŒ–åæ€§èƒ½**ï¼š**5000-15000æ¡/ç§’**ï¼ˆæå‡14-43å€ï¼‰
- **5711æ¡è®°å½•è€—æ—¶**ï¼š16.26ç§’ â†’ **0.4-1.2ç§’**

---

## ğŸ”§ å®æ–½å»ºè®®ï¼ˆä¿®æ­£ç‰ˆï¼‰

### é˜¶æ®µ1ï¼šç«‹å³å®æ–½ï¼ˆé«˜ä¼˜å…ˆçº§ï¼Œä½é£é™©ï¼‰
1. âœ… **æ–¹æ¡ˆ1ï¼šæ‰¹é‡INSERT**ï¼ˆæœ€å¤§æ€§èƒ½æå‡ï¼Œå…³é”®ä¿®æ­£ç‚¹å·²è§£å†³ï¼‰
   - âš ï¸ **æ³¨æ„**ï¼šéœ€è¦ä¿®æ­£`DuckDBOperations._upsert_batch`çš„ä¸´æ—¶è¡¨åç§°é—®é¢˜
   - âš ï¸ **æ³¨æ„**ï¼šéœ€è¦æ·»åŠ äº‹åŠ¡ç®¡ç†å’Œé”™è¯¯å¤„ç†
   - âš ï¸ **æ³¨æ„**ï¼šéœ€è¦æ·»åŠ updated_atå­—æ®µæ›´æ–°
2. âœ… **æ–¹æ¡ˆ3ï¼šè‡ªé€‚åº”æ‰¹é‡**ï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰

### é˜¶æ®µ2ï¼šæ¶æ„æ•´åˆï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
3. âš ï¸ **æ•´åˆDuckDBOperations**ï¼šè€ƒè™‘è®©`AssetSeparatedDatabaseManager`ä½¿ç”¨`DuckDBOperations`
   - ä¼˜ç‚¹ï¼šä»£ç å¤ç”¨ï¼Œç»Ÿä¸€å®ç°
   - ç¼ºç‚¹ï¼šéœ€è¦é‡æ„ï¼Œå¯èƒ½å½±å“å…¶ä»–åŠŸèƒ½
   - å»ºè®®ï¼šå…ˆä¼˜åŒ–ç°æœ‰å®ç°ï¼Œå†è€ƒè™‘æ•´åˆ

### é˜¶æ®µ3ï¼šæ€§èƒ½éªŒè¯åï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
4. âš ï¸ **æ–¹æ¡ˆ2ï¼šä¼˜åŒ–ç´¢å¼•**ï¼ˆéœ€è¦å…ˆæµ‹è¯•ï¼Œå¯èƒ½å½±å“æŸ¥è¯¢æ€§èƒ½ï¼‰

### é˜¶æ®µ4ï¼šè¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
5. âœ… **æ–¹æ¡ˆ4ï¼šä¼˜åŒ–éªŒè¯**ï¼ˆæå‡è¾ƒå°ï¼‰
6. âœ… **æ–¹æ¡ˆ5ï¼šç¼“å­˜è¡¨ç»“æ„**ï¼ˆæå‡å¾ˆå°ï¼‰

---

## ğŸ“ ç»“è®ºï¼ˆä¿®æ­£ç‰ˆï¼‰

### æ ¹æœ¬åŸå› ï¼ˆç¡®è®¤ï¼‰
1. âœ… **ä¸»è¦é—®é¢˜**ï¼š`executemany`é€æ¡æ‰§è¡Œ`INSERT ON CONFLICT`ï¼ˆ60-70%ï¼‰
2. âœ… **æ¬¡è¦é—®é¢˜**ï¼šç´¢å¼•è¿‡å¤šï¼Œç»´æŠ¤å¼€é”€å¤§ï¼ˆ15-20%ï¼‰
3. âœ… **è½»å¾®é—®é¢˜**ï¼šæ•°æ®è½¬æ¢ã€éªŒè¯ã€æŸ¥è¯¢å¼€é”€ï¼ˆ10-15%ï¼‰

### é—®é¢˜æ€§è´¨
- **ç¨‹åºé—®é¢˜**ï¼š70%ï¼ˆexecutemanyä½¿ç”¨ä¸å½“ï¼‰
- **æ•°æ®åº“é—®é¢˜**ï¼š20%ï¼ˆç´¢å¼•è®¾è®¡å¯ä¼˜åŒ–ï¼‰
- **é…ç½®é—®é¢˜**ï¼š10%ï¼ˆæ‰¹é‡å¤§å°è®¾ç½®ï¼‰

### ä¼˜åŒ–æ–¹å‘ï¼ˆä¿®æ­£ï¼‰
1. âœ… **æ”¹ç”¨æ‰¹é‡INSERT**ï¼šä½¿ç”¨DuckDBçš„`register`+`INSERT INTO ... SELECT FROM`
2. âš ï¸ **è°¨æ…ä¼˜åŒ–ç´¢å¼•**ï¼šéœ€è¦å…ˆæµ‹è¯•ï¼Œä¸èƒ½ç›²ç›®åˆ é™¤
3. âœ… **è‡ªé€‚åº”æ‰¹é‡**ï¼šæ ¹æ®æ•°æ®é‡é€‰æ‹©æœ€ä¼˜ç­–ç•¥
4. âœ… **å…³é”®ä¿®æ­£**ï¼šä¸´æ—¶è¡¨åç§°ã€åˆ—é¡ºåºã€äº‹åŠ¡ç®¡ç†ã€é”™è¯¯å¤„ç†

### é—æ¼é¡¹ï¼ˆå·²è¡¥å……ï¼‰
1. âœ… **æ•°æ®è´¨é‡éªŒè¯å¼€é”€**ï¼š3-5%
2. âœ… **è¡¨ç»“æ„æŸ¥è¯¢å¼€é”€**ï¼š1-2%
3. âœ… **ä¸´æ—¶è¡¨ç®¡ç†é—®é¢˜**ï¼šè¿æ¥æ± ä¸­çš„åç§°å†²çª
4. âœ… **äº‹åŠ¡ç®¡ç†é—®é¢˜**ï¼šéœ€è¦æ˜¾å¼äº‹åŠ¡
5. âœ… **åˆ—é¡ºåºé—®é¢˜**ï¼šä¸èƒ½ä½¿ç”¨SELECT *

---

## âœ… éªŒè¯æ–¹æ³•ï¼ˆä¿®æ­£ç‰ˆï¼‰

ä¼˜åŒ–åéªŒè¯æŒ‡æ ‡ï¼š
1. **å†™å…¥é€Ÿåº¦**ï¼šåº”è¾¾åˆ°5000+æ¡/ç§’
2. **5711æ¡è®°å½•è€—æ—¶**ï¼šåº”<2ç§’
3. **CPUä½¿ç”¨ç‡**ï¼šåº”é™ä½ï¼ˆå‡å°‘é€æ¡å¤„ç†å¼€é”€ï¼‰
4. **å†…å­˜ä½¿ç”¨**ï¼šåº”ç¨³å®šï¼ˆæ‰¹é‡å¤„ç†æ›´é«˜æ•ˆï¼‰
5. **æ•°æ®ä¸€è‡´æ€§**ï¼šåº”100%ï¼ˆäº‹åŠ¡ä¿è¯ï¼‰
6. **é”™è¯¯å¤„ç†**ï¼šåº”æ­£ç¡®å¤„ç†ï¼ˆä¸´æ—¶è¡¨æ¸…ç†ï¼‰

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. DuckDBå®˜æ–¹æ–‡æ¡£ï¼šæ‰¹é‡æ’å…¥æœ€ä½³å®è·µ
2. DuckDBå®˜æ–¹æ–‡æ¡£ï¼šregisterå’Œä¸´æ—¶è¡¨ä½¿ç”¨
3. DuckDBå®˜æ–¹æ–‡æ¡£ï¼šON CONFLICTè¯­æ³•
4. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–æŒ‡å—
5. ç´¢å¼•è®¾è®¡åŸåˆ™

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-01-XX
**åˆ†æäººå‘˜**ï¼šAI Assistant
**çŠ¶æ€**ï¼šå·²ä¿®æ­£ï¼Œå¾…å®æ–½ä¼˜åŒ–
**ç‰ˆæœ¬**ï¼šä¿®æ­£ç‰ˆï¼ˆv2.0ï¼‰

