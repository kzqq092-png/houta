â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   UI å±‚ (GUI)                                 â”‚
â”‚  EnhancedDataImportWidget - æ•°æ®å¯¼å…¥UIç•Œé¢                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä»»åŠ¡æ‰§è¡Œå±‚ (Task Execution)                       â”‚
â”‚  DataImportExecutionEngine - å¯¼å…¥æ‰§è¡Œå¼•æ“                      â”‚
â”‚  â€¢ æ™ºèƒ½é…ç½®ä¼˜åŒ–ã€AIä¼˜åŒ–ã€AutoTuner                             â”‚
â”‚  â€¢ æ€§èƒ½ç›‘æ§ã€é£é™©ç›‘æ§ã€æ•°æ®è´¨é‡ç›‘æ§                             â”‚
â”‚  â€¢ åˆ†å¸ƒå¼æ‰§è¡Œã€äº‹ä»¶å‘å¸ƒã€å¼‚æ­¥ä»»åŠ¡ç®¡ç†                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®å¤„ç†å±‚ (Data Processing)                      â”‚
â”‚  â€¢ æ•°æ®ä¸‹è½½ï¼šRealDataProvider - çœŸå®æ•°æ®ä¾›åº”å™¨                 â”‚
â”‚  â€¢ æ•°æ®æ ‡å‡†åŒ–ï¼šDataStandardizationEngine - æ ‡å‡†åŒ–å¼•æ“          â”‚
â”‚  â€¢ å­—æ®µæ˜ å°„ã€æ ¼å¼è½¬æ¢ã€è´¨é‡æ£€æŸ¥                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®å­˜å‚¨å±‚ (Data Storage)                         â”‚
â”‚  AssetSeparatedDatabaseManager - èµ„äº§åˆ†æ•°æ®åº“ç®¡ç†å™¨            â”‚
â”‚  â€¢ æŒ‰èµ„äº§ç±»å‹åˆ†ç¦»æ•°æ®åº“ï¼ˆSTOCK_A, STOCK_USç­‰ï¼‰               â”‚
â”‚  â€¢ historical_kline_data ä¸»è¡¨ + é…å¥—æ”¯æŒè¡¨                    â”‚
â”‚  â€¢ Upsert æ“ä½œã€ç´¢å¼•ä¼˜åŒ–ã€æ•°æ®è´¨é‡ç›‘æ§è¡¨                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


UIWidget.on_start_import()
  â””â”€> import_engine.start_task(task_id)
        â”œâ”€> æ™ºèƒ½é…ç½®ä¼˜åŒ– (if enable_intelligent_config)
        â”œâ”€> ç¼“å­˜é…ç½®æŸ¥è¯¢ (if enable_intelligent_caching)
        â”œâ”€> AutoTuner è‡ªåŠ¨è°ƒä¼˜ (if enable_auto_tuning)
        â”œâ”€> AI å‚æ•°ä¼˜åŒ– (if enable_ai_optimization)
        â”œâ”€> æ£€æŸ¥åˆ†å¸ƒå¼æ‰§è¡Œæ¡ä»¶ (if enable_distributed_execution)
        â””â”€> executor.submit(_execute_task, task_config, result)
              â””â”€> _execute_task() ã€æ ¸å¿ƒæ‰§è¡Œã€‘


_execute_task(task_config, result)
  â””â”€> æ ¹æ® data_type åˆ†æ”¯ï¼š
        â”œâ”€ "Kçº¿æ•°æ®" â†’ _import_kline_data()
        â”œâ”€ "å®æ—¶è¡Œæƒ…" â†’ _import_realtime_data()
        â””â”€ "åŸºæœ¬é¢æ•°æ®" â†’ _import_fundamental_data()


        
é˜¶æ®µ 3ï¼šKçº¿æ•°æ®å¯¼å…¥çš„è¯¦ç»†æµç¨‹ â­ å…³é”®

_import_kline_data(task_config, result)
  â”‚
  â”œâ”€ [åˆå§‹åŒ–é˜¶æ®µ]
  â”‚  â”œâ”€> _ensure_data_manager()
  â”‚  â”œâ”€> _ensure_real_data_provider()
  â”‚  â””â”€> åˆå§‹åŒ–å®æ—¶å†™å…¥æœåŠ¡ (RealtimeWriteService)
  â”‚
  â”œâ”€ [å¹¶å‘ä¸‹è½½é˜¶æ®µ] ğŸ‘ˆ **æ ¸å¿ƒä¸‹è½½é€»è¾‘**
  â”‚  â””â”€> ThreadPoolExecutor (max_workers = min(task_config.max_workers, len(symbols), 8))
  â”‚       â””â”€> for each symbol in symbols:
  â”‚            â””â”€> download_single_stock(symbol)
  â”‚                 â”œâ”€ _check_incremental_update(symbol, task_config)
  â”‚                 â”‚   â””â”€ æŸ¥è¯¢ historical_kline_data è¡¨çš„æœ€æ–°æ—¥æœŸ
  â”‚                 â”‚
  â”‚                 â”œâ”€ [æ•°æ®ä¸‹è½½]
  â”‚                 â”‚  â””â”€> real_data_provider.get_kline_data(
  â”‚                 â”‚       symbol, start_date, end_date, frequency, data_source)
  â”‚                 â”‚
  â”‚                 â”œâ”€ [æ•°æ®æ ‡å‡†åŒ–] ğŸ‘ˆ **å­—æ®µæ˜ å°„å…³é”®ç‚¹**
  â”‚                 â”‚  â””â”€> _standardize_kline_data_fields(kdata, data_source=task_config.data_source)
  â”‚                 â”‚       â”œâ”€ datetime å¤„ç†ï¼ˆDatetimeIndex â†’ datetime åˆ—ï¼‰
  â”‚                 â”‚       â”œâ”€ symbol å¤„ç†ï¼ˆcode â†’ symbol æ˜ å°„ï¼‰
  â”‚                 â”‚       â”œâ”€ å­—æ®µæ˜ å°„ï¼ˆ20 ä¸ªæ ‡å‡†å­—æ®µï¼‰
  â”‚                 â”‚       â”œâ”€ ç±»å‹è½¬æ¢ï¼ˆæ•°å€¼ã€æ—¥æœŸï¼‰
  â”‚                 â”‚       â”œâ”€ ç¼ºå¤±å­—æ®µè¡¥å……ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰
  â”‚                 â”‚       â”œâ”€ data_source å­—æ®µè®¾ç½® âœ… ã€é‡ç‚¹ã€‘
  â”‚                 â”‚       â””â”€> è¿”å›æ ‡å‡†åŒ– DataFrame
  â”‚                 â”‚
  â”‚                 â”œâ”€ [æ•°æ®éªŒè¯]
  â”‚                 â”‚  â””â”€> _validate_imported_data()
  â”‚                 â”‚       â”œâ”€ æ•°æ®è´¨é‡è¯„åˆ†è®¡ç®—
  â”‚                 â”‚       â”œâ”€ è´¨é‡æŒ‡æ ‡è®°å½•
  â”‚                 â”‚       â””â”€ è´¨é‡åˆ†æ•°å†™å…¥ DuckDB
  â”‚                 â”‚
  â”‚                 â”œâ”€ [å®æ—¶å†™å…¥ æˆ– æ‰¹é‡ç§¯ç´¯]
  â”‚                 â”‚  â”œâ”€ [å¦‚æœ RealtimeWriteService å¯ç”¨]
  â”‚                 â”‚  â”‚  â””â”€> realtime_write_service.write_kline_data(
  â”‚                 â”‚  â”‚       symbol, kdata, task_config.asset_type)
  â”‚                 â”‚  â”‚       â””â”€> ç›´æ¥å†™å…¥æ•°æ®åº“ + å‘å¸ƒè¿›åº¦äº‹ä»¶
  â”‚                 â”‚  â”‚
  â”‚                 â”‚  â””â”€ [é™çº§åˆ°æ‰¹é‡æ¨¡å¼]
  â”‚                 â”‚     â””â”€> all_kdata_list.append(kdata)
  â”‚                 â”‚
  â”‚                 â””â”€> å‘å¸ƒä¸‹è½½å®Œæˆäº‹ä»¶
  â”‚
  â”œâ”€ [æ‰¹é‡ä¿å­˜é˜¶æ®µ] (ä»…é™çº§æ¨¡å¼)
  â”‚  â””â”€> _batch_save_kdata_to_database(all_kdata_list, task_config)
  â”‚       â”œâ”€ pd.concat(all_kdata_list) â†’ åˆå¹¶æ‰€æœ‰æ•°æ®
  â”‚       â”œâ”€ _standardize_kline_data_fields() â†’ äºŒæ¬¡æ ‡å‡†åŒ–
  â”‚       â”œâ”€ _enrich_kline_data_with_metadata() â†’ è¡¥å……å…ƒæ•°æ®
  â”‚       â””â”€> asset_manager.store_standardized_data()
  â”‚            â””â”€> ã€å­˜å‚¨é˜¶æ®µã€‘
  â”‚
  â””â”€ [æ¸…ç†å’Œæ±‡æ€»]
     â”œâ”€ æ¸…ç†æ•°æ®æºè¿æ¥æ± 
     â”œâ”€ å‘å¸ƒå®Œæˆäº‹ä»¶
     â””â”€ æ›´æ–°è¿›åº¦ç»Ÿè®¡


é˜¶æ®µ 4ï¼šæ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“

asset_manager.store_standardized_data(
    data=kdata, 
    asset_type=task_config.asset_type, 
    data_type=DataType.HISTORICAL_KLINE)
  â”‚
  â”œâ”€ è·å–èµ„äº§ç±»å‹å¯¹åº”æ•°æ®åº“è·¯å¾„
  â”‚  â””â”€> _ensure_database_exists(asset_type)
  â”‚      â””â”€> åˆ›å»ºæŒ‰èµ„äº§ç±»å‹åˆ†ç¦»çš„ DuckDB æ•°æ®åº“
  â”‚          (e.g., data/databases/stock_a/stock_a_data.duckdb)
  â”‚
  â”œâ”€ ç¡®ä¿è¡¨ç»“æ„å­˜åœ¨
  â”‚  â””â”€> _ensure_table_exists(conn, 'historical_kline_data', data, DataType.HISTORICAL_KLINE)
  â”‚       â””â”€ è¡¨ç»“æ„ï¼š
  â”‚           CREATE TABLE historical_kline_data (
  â”‚               symbol VARCHAR NOT NULL,
  â”‚               data_source VARCHAR NOT NULL,     â† å…³é”®å­—æ®µï¼
  â”‚               timestamp TIMESTAMP NOT NULL,      â† datetime æ˜ å°„åˆ°æ­¤
  â”‚               frequency VARCHAR NOT NULL DEFAULT '1d',
  â”‚               open DECIMAL(10,2) NOT NULL,
  â”‚               high DECIMAL(10,2) NOT NULL,
  â”‚               low DECIMAL(10,2) NOT NULL,
  â”‚               close DECIMAL(10,2) NOT NULL,
  â”‚               volume BIGINT DEFAULT 0,
  â”‚               amount DECIMAL(18,2) DEFAULT 0,
  â”‚               ... [å…¶ä»–å­—æ®µ] ...
  â”‚               PRIMARY KEY (symbol, data_source, timestamp, frequency)
  â”‚           )
  â”‚
  â”œâ”€ è·å–è¡¨å®é™…åˆ—å
  â”‚  â””â”€> _get_table_columns(conn, 'historical_kline_data')
  â”‚
  â”œâ”€ å­—æ®µè¿‡æ»¤å’Œæ˜ å°„
  â”‚  â””â”€> _filter_dataframe_columns(data, table_columns)
  â”‚       â”œâ”€ datetime â†’ timestamp å­—æ®µæ˜ å°„ âœ…
  â”‚       â”œâ”€ è¿‡æ»¤ä¸åœ¨è¡¨ä¸­çš„åˆ—
  â”‚       â””â”€ âš ï¸ ã€é—®é¢˜ç‚¹ã€‘ data_source åˆ—çš„æ£€æŸ¥ (line 1055-1057)
  â”‚
  â”œâ”€ æ•°æ®éªŒè¯
  â”‚  â””â”€> æ£€æŸ¥ data_source åˆ—å­˜åœ¨ä¸”æ— ç©ºå€¼
  â”‚       â””â”€ âš ï¸ ã€é—®é¢˜ç‚¹ã€‘ å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œè¿”å› 0ï¼ˆä¸æ’å…¥ï¼‰
  â”‚
  â””â”€> _upsert_data(conn, 'historical_kline_data', filtered_data, DataType.HISTORICAL_KLINE)
       â”œâ”€ ã€å…³é”®ä¿®å¤ã€‘ data_source å­—æ®µåˆå§‹åŒ–
       â”‚  â””â”€ if 'data_source' not in data.columns:
       â”‚       data['data_source'] = 'unknown'
       â”‚
       â”œâ”€ æ„å»º INSERT ... ON CONFLICT è¯­å¥
       â”‚  â””â”€ PRIMARY KEY å†²çªå¤„ç†
       â”‚      UPDATE (symbol, data_source, timestamp, frequency) æ—¶çš„å­—æ®µæ›´æ–°
       â”‚
       â””â”€> conn.executemany(sql, data_tuples)
           â””â”€ æ‰¹é‡æ’å…¥ â†’ æ•°æ®åº“