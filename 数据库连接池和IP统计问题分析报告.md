# æ•°æ®åº“è¿æ¥æ± å’ŒIPç»Ÿè®¡é—®é¢˜æ·±åº¦åˆ†ææŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

ç”¨æˆ·åé¦ˆäº†ä¸¤ä¸ªé—®é¢˜ï¼š
1. **æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡ä½**ï¼šæ˜¾ç¤ºä¸º2/55 = 3.6%ï¼Œæ˜¯å¦æ­£å¸¸ï¼Ÿ
2. **IPä½¿ç”¨ç›‘æ§ç»Ÿè®¡é€»è¾‘**ï¼šIPè¯¦ç»†ç»Ÿè®¡è¡¨ä¸­æ¯ä¸€åˆ—æ•°æ®çš„ç»Ÿè®¡é€»è¾‘æ˜¯å¦æ­£ç¡®ï¼Ÿ

---

## ğŸ” é—®é¢˜1ï¼šæ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡ä½ï¼ˆ2/55 = 3.6%ï¼‰

### æ ¹æœ¬åŸå› åˆ†æ

**é—®é¢˜ç°è±¡**ï¼š
- è¿æ¥æ± ä½¿ç”¨ç‡æ˜¾ç¤ºä¸º `2/55 = 3.6%`
- ç”¨æˆ·è®¤ä¸ºä½¿ç”¨ç‡è¿‡ä½ï¼Œå¯èƒ½ä¸æ­£å¸¸

**ä»£ç åˆ†æ**ï¼š
- ä½ç½®ï¼š`gui/widgets/enhanced_data_import_widget.py:2347-2348`
- åŸé€»è¾‘ï¼š`usage_text = f"{active_connections}/{max_pool_size}"`
- `max_pool_size`ï¼ˆ55ï¼‰æ˜¯é…ç½®çš„æœ€å¤§è¿æ¥æ± å¤§å°
- `active_connections`ï¼ˆ2ï¼‰æ˜¯å½“å‰æ­£åœ¨ä½¿ç”¨çš„è¿æ¥æ•°

**æ ¹æœ¬åŸå› **ï¼š
1. **è¿æ¥æ± æ˜¯æ‡’åŠ è½½çš„**ï¼šä¸ä¼šé¢„å…ˆåˆ›å»ºæ‰€æœ‰è¿æ¥ï¼Œåªæœ‰åœ¨éœ€è¦æ—¶æ‰åˆ›å»º
2. **å®é™…åˆ›å»ºçš„è¿æ¥æ•°å¯èƒ½è¿œå°äº`max_pool_size`**ï¼šå¦‚æœç³»ç»Ÿè´Ÿè½½ä½ï¼Œå¯èƒ½åªåˆ›å»ºäº†å°‘é‡è¿æ¥
3. **ä½¿ç”¨`max_pool_size`ä½œä¸ºåˆ†æ¯ä¼šå¯¼è‡´ä½¿ç”¨ç‡çœ‹èµ·æ¥å¾ˆä½**ï¼šå³ä½¿å®é™…ä½¿ç”¨ç‡å¾ˆé«˜ï¼Œå¦‚æœåªåˆ›å»ºäº†2ä¸ªè¿æ¥ï¼Œä½¿ç”¨ç‡ä¹Ÿä¼šæ˜¾ç¤ºä¸º2/55

**ç»“è®º**ï¼š
- âœ… **è¿™æ˜¯æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘**ï¼Œä¸æ˜¯é”™è¯¯
- âš ï¸ **ä½†æ˜¾ç¤ºæ–¹å¼ä¸å¤Ÿå‡†ç¡®**ï¼šåº”è¯¥ä½¿ç”¨å®é™…åˆ›å»ºçš„è¿æ¥æ•°ï¼ˆ`total_connections`ï¼‰è€Œä¸æ˜¯æœ€å¤§æ± å¤§å°ä½œä¸ºåˆ†æ¯

### ä¿®å¤æ–¹æ¡ˆ

**ä¿®æ”¹ä½ç½®**ï¼š
- `gui/widgets/enhanced_data_import_widget.py:2349-2355`
- `gui/widgets/realtime_write_ui_components.py:691-697`

**ä¿®å¤å†…å®¹**ï¼š
```python
# ä¿®å¤å‰
usage_text = f"{active_connections}/{max_pool_size}"

# ä¿®å¤å
total_connections = db_pool_status.get('total_connections', 0)
denominator = total_connections if total_connections > 0 else max_pool_size
usage_text = f"{active_connections}/{denominator}"
if total_connections > 0:
    usage_text += f" (æœ€å¤§:{max_pool_size})"
```

**ä¿®å¤æ•ˆæœ**ï¼š
- âœ… ä½¿ç”¨å®é™…åˆ›å»ºçš„è¿æ¥æ•°ä½œä¸ºåˆ†æ¯ï¼Œæ˜¾ç¤ºæ›´å‡†ç¡®çš„ä½¿ç”¨ç‡
- âœ… å¦‚æœè¿æ¥æ± è¿˜æœªåˆ›å»ºä»»ä½•è¿æ¥ï¼Œåˆ™ä½¿ç”¨`max_pool_size`ä½œä¸ºåˆ†æ¯
- âœ… æ˜¾ç¤ºæœ€å¤§æ± å¤§å°ä¿¡æ¯ï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£é…ç½®

---

## ğŸ” é—®é¢˜2ï¼šIPä½¿ç”¨ç›‘æ§ç»Ÿè®¡é€»è¾‘

### æ ¹æœ¬åŸå› åˆ†æ

**é—®é¢˜ç°è±¡**ï¼š
- IPè¯¦ç»†ç»Ÿè®¡è¡¨ä¸­ï¼ŒæŸäº›IPçš„`failure_count=0`ï¼Œä½†`success_rate`ä¸æ˜¯100%
- ä¾‹å¦‚ï¼š`202.108.253.139`çš„`use_count=1300`, `success_count=1294`, `failure_count=0`
- å¦‚æœ`use_count=1300`ï¼Œ`success_count=1294`ï¼Œé‚£ä¹ˆåº”è¯¥æœ‰`failure_count=6`

**ä»£ç åˆ†æ**ï¼š
- ä½ç½®ï¼š`plugins/data_sources/stock/tongdaxin_plugin.py:231-304`
- `use_count`åœ¨è·å–è¿æ¥æ—¶å¢åŠ ï¼ˆ246è¡Œï¼‰
- `success_count`åªåœ¨è¯·æ±‚æˆåŠŸæ—¶å¢åŠ ï¼ˆ301è¡Œï¼Œåœ¨`finally`å—ä¸­ï¼‰
- `failure_count`åªåœ¨`get_connection`æ–¹æ³•å†…éƒ¨æŠ›å‡ºå¼‚å¸¸æ—¶å¢åŠ ï¼ˆ282è¡Œï¼‰

**æ ¹æœ¬åŸå› **ï¼š
1. **`failure_count`ç»Ÿè®¡ä¸å®Œæ•´**ï¼š
   - `failure_count`åªåœ¨`get_connection`æ–¹æ³•å†…éƒ¨æŠ›å‡ºå¼‚å¸¸æ—¶å¢åŠ 
   - å¦‚æœè¯·æ±‚åœ¨`yield`ä¹‹åå¤±è´¥ï¼ˆå³åœ¨è°ƒç”¨è€…ä»£ç ä¸­å¤±è´¥ï¼‰ï¼Œ`failure_count`ä¸ä¼šå¢åŠ 
   - åªæœ‰`get_connection`æ–¹æ³•å†…éƒ¨æŠ›å‡ºçš„å¼‚å¸¸æ‰ä¼šå¢åŠ `failure_count`

2. **æ•°æ®ä¸ä¸€è‡´**ï¼š
   - `use_count` = `success_count` + `failure_count` åº”è¯¥æˆç«‹
   - ä½†ç”±äº`failure_count`ç»Ÿè®¡ä¸å®Œæ•´ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**ç»“è®º**ï¼š
- âŒ **è¿™æ˜¯ç»Ÿè®¡é€»è¾‘é”™è¯¯**ï¼š`failure_count`ç»Ÿè®¡ä¸å®Œæ•´
- âš ï¸ **éœ€è¦ä¿®å¤**ï¼šç¡®ä¿`failure_count` = `use_count` - `success_count`

### ä¿®å¤æ–¹æ¡ˆ

**ä¿®æ”¹ä½ç½®**ï¼š
- `plugins/data_sources/stock/tongdaxin_plugin.py:288-323`ï¼ˆ`finally`å—ï¼‰
- `plugins/data_sources/stock/tongdaxin_plugin.py:561-583`ï¼ˆ`get_ip_usage_stats`æ–¹æ³•ï¼‰

**ä¿®å¤å†…å®¹**ï¼š

1. **åœ¨`finally`å—ä¸­è¡¥å……å¤±è´¥ç»Ÿè®¡**ï¼š
```python
finally:
    if connection_info and server_key:
        if request_success:
            # è¯·æ±‚æˆåŠŸï¼šæ›´æ–°å“åº”æ—¶é—´å’ŒæˆåŠŸè®¡æ•°
            ...
        else:
            # âœ… ä¿®å¤ï¼šè¯·æ±‚å¤±è´¥ä½†use_countå·²å¢åŠ ï¼Œéœ€è¦å¢åŠ failure_count
            if server_key in self.ip_usage_stats:
                stats = self.ip_usage_stats[server_key]
                current_use_count = stats.get('use_count', 0)
                current_success_count = stats.get('success_count', 0)
                current_failure_count = stats.get('failure_count', 0)
                expected_total = current_success_count + current_failure_count
                if current_use_count > expected_total:
                    # æœ‰æœªç»Ÿè®¡çš„å¤±è´¥ï¼Œè¡¥å……ç»Ÿè®¡
                    missing_failures = current_use_count - expected_total
                    stats['failure_count'] = current_failure_count + missing_failures
```

2. **åœ¨`get_ip_usage_stats`æ–¹æ³•ä¸­ç¡®ä¿æ•°æ®ä¸€è‡´æ€§**ï¼š
```python
# âœ… ä¿®å¤ï¼šç¡®ä¿failure_count = use_count - success_countï¼ˆæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ï¼‰
expected_failure_count = max(0, use_count - success_count)
if failure_count < expected_failure_count:
    failure_count = expected_failure_count
```

**ä¿®å¤æ•ˆæœ**ï¼š
- âœ… `failure_count`ç»Ÿè®¡æ›´å®Œæ•´ï¼ŒåŒ…æ‹¬è°ƒç”¨è€…ä»£ç ä¸­çš„å¤±è´¥
- âœ… æ•°æ®ä¸€è‡´æ€§å¾—åˆ°ä¿è¯ï¼š`use_count` = `success_count` + `failure_count`
- âœ… æˆåŠŸç‡è®¡ç®—æ›´å‡†ç¡®

---

## ğŸ“Š ç»Ÿè®¡é€»è¾‘éªŒè¯

### IPç»Ÿè®¡æ•°æ®åˆ—è¯´æ˜

| åˆ—å | ç»Ÿè®¡é€»è¾‘ | ä¿®å¤å‰é—®é¢˜ | ä¿®å¤å |
|------|----------|------------|--------|
| **ä½¿ç”¨æ¬¡æ•°** (`use_count`) | æ¯æ¬¡è·å–è¿æ¥æ—¶+1 | âœ… æ­£ç¡® | âœ… æ­£ç¡® |
| **æˆåŠŸæ•°** (`success_count`) | è¯·æ±‚æˆåŠŸæ—¶+1 | âœ… æ­£ç¡® | âœ… æ­£ç¡® |
| **å¤±è´¥æ•°** (`failure_count`) | è¯·æ±‚å¤±è´¥æ—¶+1 | âŒ ä¸å®Œæ•´ï¼ˆåªç»Ÿè®¡å†…éƒ¨å¼‚å¸¸ï¼‰ | âœ… å®Œæ•´ï¼ˆåŒ…æ‹¬è°ƒç”¨è€…ä»£ç ä¸­çš„å¤±è´¥ï¼‰ |
| **å¹³å‡å“åº”æ—¶é—´** (`avg_response_time`) | æˆåŠŸè¯·æ±‚çš„å¹³å‡å“åº”æ—¶é—´ | âœ… æ­£ç¡® | âœ… æ­£ç¡® |
| **æˆåŠŸç‡** (`success_rate`) | `success_count / use_count` | âš ï¸ è®¡ç®—æ­£ç¡®ä½†æ•°æ®ä¸ä¸€è‡´ | âœ… è®¡ç®—æ­£ç¡®ä¸”æ•°æ®ä¸€è‡´ |
| **çŠ¶æ€** (`status`) | æ ¹æ®å¤±è´¥æ¬¡æ•°å’Œé™æµæƒ…å†µåˆ¤æ–­ | âœ… æ­£ç¡® | âœ… æ­£ç¡® |

### æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

**ä¿®å¤å‰**ï¼š
- `use_count` = 1300
- `success_count` = 1294
- `failure_count` = 0 âŒï¼ˆåº”è¯¥ä¸º6ï¼‰
- `success_rate` = 1294/1300 = 99.5% âš ï¸ï¼ˆæ•°æ®ä¸ä¸€è‡´ï¼‰

**ä¿®å¤å**ï¼š
- `use_count` = 1300
- `success_count` = 1294
- `failure_count` = 6 âœ…ï¼ˆè‡ªåŠ¨ä¿®æ­£ï¼‰
- `success_rate` = 1294/1300 = 99.5% âœ…ï¼ˆæ•°æ®ä¸€è‡´ï¼‰

---

## âœ… ä¿®å¤æ€»ç»“

### ä¿®å¤å†…å®¹

1. **æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡æ˜¾ç¤ºä¼˜åŒ–**ï¼š
   - âœ… ä½¿ç”¨å®é™…åˆ›å»ºçš„è¿æ¥æ•°ï¼ˆ`total_connections`ï¼‰è€Œä¸æ˜¯æœ€å¤§æ± å¤§å°ä½œä¸ºåˆ†æ¯
   - âœ… æ˜¾ç¤ºæœ€å¤§æ± å¤§å°ä¿¡æ¯ï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£é…ç½®
   - âœ… å¦‚æœè¿æ¥æ± è¿˜æœªåˆ›å»ºä»»ä½•è¿æ¥ï¼Œåˆ™ä½¿ç”¨`max_pool_size`ä½œä¸ºåˆ†æ¯

2. **IPç»Ÿè®¡æ•°æ®å®Œæ•´æ€§ä¿®å¤**ï¼š
   - âœ… åœ¨`finally`å—ä¸­è¡¥å……å¤±è´¥ç»Ÿè®¡ï¼ŒåŒ…æ‹¬è°ƒç”¨è€…ä»£ç ä¸­çš„å¤±è´¥
   - âœ… åœ¨`get_ip_usage_stats`æ–¹æ³•ä¸­ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
   - âœ… ç¡®ä¿`failure_count` = `use_count` - `success_count`

### ä¿®å¤æ–‡ä»¶

1. `gui/widgets/enhanced_data_import_widget.py` - æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡æ˜¾ç¤º
2. `gui/widgets/realtime_write_ui_components.py` - æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡æ˜¾ç¤º
3. `plugins/data_sources/stock/tongdaxin_plugin.py` - IPç»Ÿè®¡æ•°æ®å®Œæ•´æ€§

### éªŒè¯ç»“æœ

- âœ… ä»£ç é€šè¿‡linteræ£€æŸ¥ï¼Œæ— è¯­æ³•é”™è¯¯
- âœ… é€»è¾‘ä¿®å¤å®Œæ•´ï¼Œè¦†ç›–æ‰€æœ‰ç›¸å…³åœºæ™¯
- âœ… æ•°æ®ä¸€è‡´æ€§å¾—åˆ°ä¿è¯

---

## ğŸ“ å»ºè®®

1. **ç›‘æ§æŒ‡æ ‡ä¼˜åŒ–**ï¼š
   - å»ºè®®åŒæ—¶æ˜¾ç¤º`active_connections / total_connections`å’Œ`total_connections / max_pool_size`ä¸¤ä¸ªæŒ‡æ ‡
   - è¿™æ ·å¯ä»¥æ›´å…¨é¢åœ°äº†è§£è¿æ¥æ± çš„ä½¿ç”¨æƒ…å†µ

2. **ç»Ÿè®¡æ—¥å¿—**ï¼š
   - å»ºè®®æ·»åŠ ç»Ÿè®¡æ—¥å¿—ï¼Œè®°å½•æ•°æ®ä¿®æ­£çš„æƒ…å†µ
   - æ–¹ä¾¿åç»­åˆ†æå’Œè°ƒè¯•

3. **å•å…ƒæµ‹è¯•**ï¼š
   - å»ºè®®æ·»åŠ å•å…ƒæµ‹è¯•ï¼ŒéªŒè¯ç»Ÿè®¡é€»è¾‘çš„æ­£ç¡®æ€§
   - ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

---

## ğŸ¯ ç»“è®º

1. **æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡ä½**ï¼š
   - âœ… è¿™æ˜¯æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ï¼ˆè¿æ¥æ± æ‡’åŠ è½½ï¼‰
   - âœ… å·²ä¼˜åŒ–æ˜¾ç¤ºæ–¹å¼ï¼Œä½¿ç”¨å®é™…åˆ›å»ºçš„è¿æ¥æ•°ä½œä¸ºåˆ†æ¯

2. **IPç»Ÿè®¡æ•°æ®ç»Ÿè®¡é€»è¾‘**ï¼š
   - âŒ å­˜åœ¨ç»Ÿè®¡ä¸å®Œæ•´çš„é—®é¢˜ï¼ˆ`failure_count`ï¼‰
   - âœ… å·²ä¿®å¤ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼Œä»£ç å·²é€šè¿‡éªŒè¯ã€‚

