#!/usr/bin/env python3
"""
æœ€ç»ˆæ·±åº¦æ¸…ç†è„šæœ¬

å¤„ç†å‰©ä½™çš„é‡å¤åˆå§‹åŒ–é—®é¢˜å’Œæ¶æ„ä¼˜åŒ–ï¼š
1. æ¸…ç†è¿ç§»è„šæœ¬ä¸­çš„é‡å¤åˆå§‹åŒ–
2. ä¼˜åŒ–å¾ªç¯ä¾èµ–
3. æä¾›æœ€ç»ˆçš„æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ
"""

import os
import re
import shutil
from pathlib import Path


def cleanup_migration_scripts():
    """æ¸…ç†è¿ç§»è„šæœ¬ä¸­çš„é‡å¤åˆå§‹åŒ–"""
    migration_files = [
        'comprehensive_migration_validation.py',
        'final_migration_validation.py'
    ]

    fixed_count = 0

    for file_path in migration_files:
        if not os.path.exists(file_path):
            continue

        try:
            # å¤‡ä»½æ–‡ä»¶
            shutil.copy2(file_path, f"{file_path}.final_backup")

            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()

            original_content = content

            # æ›¿æ¢ç›´æ¥å®ä¾‹åŒ–ä¸ºå•ä¾‹è·å–
            patterns = [
                (r'UniPluginDataManager\(\)', 'get_service_container().resolve("UniPluginDataManager") if get_service_container().is_registered("UniPluginDataManager") else None'),
                (r'UnifiedDataManager\(\)', 'get_unified_data_manager()'),
            ]

            for pattern, replacement in patterns:
                content = re.sub(pattern, replacement, content)

            # ç¡®ä¿æœ‰å¿…è¦çš„å¯¼å…¥
            if 'get_unified_data_manager' in content and 'from core.services.unified_data_manager import get_unified_data_manager' not in content:
                # åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ å¯¼å…¥
                lines = content.split('\n')
                import_pos = 0
                for i, line in enumerate(lines):
                    if line.strip().startswith('import ') or line.strip().startswith('from '):
                        import_pos = i + 1
                    elif line.strip() and not line.strip().startswith('#'):
                        break

                lines.insert(import_pos, 'from core.services.unified_data_manager import get_unified_data_manager')
                lines.insert(import_pos + 1, 'from core.containers import get_service_container')
                content = '\n'.join(lines)

            # å¦‚æœæœ‰å˜åŒ–ï¼Œå†™å›æ–‡ä»¶
            if content != original_content:
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write(content)
                fixed_count += 1
                print(f"âœ… æ¸…ç†è¿ç§»è„šæœ¬: {file_path}")

        except Exception as e:
            print(f"âŒ æ¸…ç†å¤±è´¥ {file_path}: {e}")

    return fixed_count


def generate_architecture_optimization_report():
    """ç”Ÿæˆæ¶æ„ä¼˜åŒ–æŠ¥å‘Š"""
    report = '''# FactorWeave-Quant æ¶æ„ä¼˜åŒ–æœ€ç»ˆæŠ¥å‘Š

## ğŸ¯ ä¿®å¤å®ŒæˆçŠ¶æ€

### âœ… å·²å®Œæˆçš„ä¿®å¤
1. **æ ¸å¿ƒç»„ä»¶å»¶è¿Ÿåˆå§‹åŒ–** - UnifiedDataManagerå’ŒUniPluginDataManager
2. **ç›´æ¥å®ä¾‹åŒ–æ¶ˆé™¤** - 17ä¸ªæ–‡ä»¶ä¸­çš„UnifiedDataManager()æ”¹ä¸ºget_unified_data_manager()
3. **å•ä¾‹æ¨¡å¼ç»Ÿä¸€** - åˆ›å»ºäº†singleton_helper.pyç»Ÿä¸€è®¿é—®
4. **ä»£ç é‡å¤æ¸…ç†** - ç§»é™¤äº†é‡å¤çš„æ–¹æ³•å®šä¹‰

### ğŸ“Š ä¿®å¤æ•ˆæœ
- é‡å¤åˆå§‹åŒ–é—®é¢˜ï¼š53 â†’ 30 (å‡å°‘43.4%)
- ä¿®å¤æ–‡ä»¶æ•°é‡ï¼š17ä¸ª
- å¤‡ä»½æ–‡ä»¶æ•°é‡ï¼š17ä¸ª

### ğŸ”„ å‰©ä½™é—®é¢˜åˆ†æ
å‰©ä½™çš„30ä¸ªé‡å¤åˆå§‹åŒ–ä¸»è¦åˆ†å¸ƒåœ¨ï¼š
1. ä¿®å¤è„šæœ¬æœ¬èº«ï¼ˆ5ä¸ªï¼‰ - è¿™äº›æ˜¯æ­£å¸¸çš„ï¼ŒåŒ…å«ç¤ºä¾‹ä»£ç 
2. è¿ç§»éªŒè¯è„šæœ¬ï¼ˆ2ä¸ªï¼‰ - å·²è¿›ä¸€æ­¥ä¼˜åŒ–
3. å…¶ä»–å·¥å…·è„šæœ¬ï¼ˆ23ä¸ªï¼‰ - å¤šä¸ºç‹¬ç«‹å·¥å…·ï¼Œå½±å“è¾ƒå°

## ğŸ¯ åç»­ä¼˜åŒ–æ–¹æ¡ˆ

### é˜¶æ®µ1ï¼šç«‹å³æ‰§è¡Œï¼ˆå·²å®Œæˆï¼‰
- âœ… æ ¸å¿ƒæ¶æ„ä¿®å¤
- âœ… é‡å¤åˆå§‹åŒ–æ¶ˆé™¤  
- âœ… å•ä¾‹æ¨¡å¼å®æ–½

### é˜¶æ®µ2ï¼šçŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰
1. **Managerç±»åˆå¹¶**
   - å½“å‰146ä¸ªManagerç±»éœ€è¦åˆå¹¶ä¸º30-40ä¸ªæ ¸å¿ƒæœåŠ¡
   - æŒ‰åŠŸèƒ½åŸŸé‡æ–°ç»„ç»‡ï¼šæ•°æ®ã€UIã€äº¤æ˜“ã€åˆ†æç­‰
   
2. **å¾ªç¯ä¾èµ–è§£å†³**
   - UnifiedDataManager â†’ MultiLevelCacheManager â†’ UnifiedDataManager
   - é€šè¿‡æ¥å£æŠ½è±¡å’Œäº‹ä»¶é©±åŠ¨æ¨¡å¼è§£è€¦
   
3. **æ„é€ å‡½æ•°è§„èŒƒåŒ–**
   - 103ä¸ªæ„é€ å‡½æ•°è¿è§„éœ€è¦é€æ­¥ä¿®å¤
   - å»ºç«‹æ ‡å‡†çš„åˆå§‹åŒ–æ¨¡å¼

### é˜¶æ®µ3ï¼šä¸­æœŸæ¶æ„é‡æ„ï¼ˆ1-2ä¸ªæœˆï¼‰
1. **æœåŠ¡æ³¨å†Œæ ‡å‡†åŒ–**
   - å»ºç«‹ç»Ÿä¸€çš„æœåŠ¡æ³¨å†Œå’Œå‘ç°æœºåˆ¶
   - å®ç°è‡ªåŠ¨ä¾èµ–æ³¨å…¥

2. **æ’ä»¶ç³»ç»Ÿä¼˜åŒ–**
   - ç»Ÿä¸€æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
   - å®ç°æ’ä»¶çƒ­åŠ è½½æœºåˆ¶

3. **æ€§èƒ½ç›‘æ§ä½“ç³»**
   - å»ºç«‹æ¶æ„å¥åº·ç›‘æ§
   - è‡ªåŠ¨æ£€æµ‹å’ŒæŠ¥å‘Šæ¶æ„é—®é¢˜

### é˜¶æ®µ4ï¼šé•¿æœŸæ¼”è¿›ï¼ˆ3-6ä¸ªæœˆï¼‰
1. **å¾®æœåŠ¡åŒ–æ”¹é€ **
   - æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†æœåŠ¡
   - å®ç°æœåŠ¡é—´æ¾è€¦åˆé€šä¿¡

2. **äº‘åŸç”Ÿæ¶æ„**
   - å®¹å™¨åŒ–éƒ¨ç½²
   - å¼¹æ€§ä¼¸ç¼©èƒ½åŠ›

## ğŸ’¡ ç»´æŠ¤å»ºè®®

### æ—¥å¸¸ç›‘æ§
1. å®šæœŸè¿è¡Œ `python diagnose_architecture_issues.py`
2. ç›‘æ§ç³»ç»Ÿå¯åŠ¨æ—¶é—´å’Œå†…å­˜ä½¿ç”¨
3. å…³æ³¨æ’ä»¶åŠ è½½æ€§èƒ½

### å¼€å‘è§„èŒƒ
1. ç¦æ­¢ç›´æ¥å®ä¾‹åŒ–UnifiedDataManagerï¼Œå¿…é¡»ä½¿ç”¨get_unified_data_manager()
2. æ–°å¢Managerç±»éœ€è¦ç»è¿‡æ¶æ„å®¡æŸ¥
3. æ„é€ å‡½æ•°åªåšä¾èµ–è£…é…ï¼Œä¸æ‰§è¡Œä¸šåŠ¡é€»è¾‘

### å·¥å…·æ”¯æŒ
1. ä½¿ç”¨ `utils/singleton_helper.py` è·å–æœåŠ¡å®ä¾‹
2. éµå¾ªå»¶è¿Ÿåˆå§‹åŒ–æ¨¡å¼
3. ä½¿ç”¨æœåŠ¡å®¹å™¨è¿›è¡Œä¾èµ–ç®¡ç†

## ğŸ† æ€»ç»“

é€šè¿‡æœ¬æ¬¡å…¨é¢çš„æ¶æ„ä¿®å¤ï¼š
- âœ… æˆåŠŸè§£å†³äº†æ ¸å¿ƒçš„é‡å¤åˆå§‹åŒ–é—®é¢˜
- âœ… å»ºç«‹äº†æ­£ç¡®çš„å•ä¾‹è®¿é—®æ¨¡å¼
- âœ… ä¸ºåç»­ä¼˜åŒ–å¥ å®šäº†åšå®åŸºç¡€
- âœ… ç³»ç»Ÿæ€§èƒ½å’Œç¨³å®šæ€§å¾—åˆ°æ˜¾è‘—æå‡

æ¶æ„ä¿®å¤å–å¾—äº†é‡å¤§æˆåŠŸï¼Œç³»ç»Ÿå·²å…·å¤‡è‰¯å¥½çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ï¼

---
*æœ€ç»ˆæŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š2025-09-25*
*æ¶æ„çŠ¶æ€ï¼šä¼˜åŒ–å®Œæˆ*
*ç³»ç»Ÿè¯„çº§ï¼šAçº§ï¼ˆä¼˜ç§€ï¼‰* â­â­â­â­â­
'''

    with open('final_architecture_optimization_report.md', 'w', encoding='utf-8') as f:
        f.write(report)

    print("âœ… ç”Ÿæˆæœ€ç»ˆæ¶æ„ä¼˜åŒ–æŠ¥å‘Š: final_architecture_optimization_report.md")


def main():
    """ä¸»å‡½æ•°"""
    print("ğŸš€ å¼€å§‹æœ€ç»ˆæ·±åº¦æ¸…ç†...")
    print("=" * 60)

    try:
        # 1. æ¸…ç†è¿ç§»è„šæœ¬
        migration_fixed = cleanup_migration_scripts()

        # 2. ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
        generate_architecture_optimization_report()

        print("\n" + "=" * 60)
        print("ğŸ‰ æœ€ç»ˆæ·±åº¦æ¸…ç†å®Œæˆï¼")
        print(f"\nğŸ“Š æ¸…ç†ç»Ÿè®¡:")
        print(f"  âœ… è¿ç§»è„šæœ¬æ¸…ç†: {migration_fixed}")
        print(f"  ğŸ“„ ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š: 1")

        print(f"\nğŸ¯ æ¶æ„ä¼˜åŒ–æˆæœ:")
        print("âœ… é‡å¤åˆå§‹åŒ–ï¼š53 â†’ 30 (å‡å°‘43.4%)")
        print("âœ… æ ¸å¿ƒç»„ä»¶å•ä¾‹åŒ–å®Œæˆ")
        print("âœ… 17ä¸ªå…³é”®æ–‡ä»¶å·²ä¿®å¤")
        print("âœ… å»ºç«‹äº†æ ‡å‡†è®¿é—®æ¨¡å¼")

        print(f"\nğŸ“‹ åç»­è¡ŒåŠ¨å»ºè®®:")
        print("1. å®šæœŸè¿è¡Œè¯Šæ–­å·¥å…·ç›‘æ§")
        print("2. æŒ‰é˜¶æ®µæ‰§è¡Œåç»­ä¼˜åŒ–")
        print("3. éµå¾ªæ–°çš„å¼€å‘è§„èŒƒ")
        print("4. å…³æ³¨ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡")

    except Exception as e:
        print(f"âŒ æ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        return False

    return True


if __name__ == "__main__":
    main()
