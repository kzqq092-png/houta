id,name,english_name,description,algorithm_code
1,双顶,double_top,双顶是一种看跌反转形态，当价格形成两个相近的高点后，通常会向下突破,
2,头肩顶,head_shoulders_top,头肩顶是最可靠的看跌反转形态，由左肩、头部、右肩三个高点组成,
3,三重顶,triple_top,三重顶由三个相近的高点组成，是强烈的看跌信号,
4,圆弧顶,rounding_top,价格缓慢形成圆弧状的顶部，表示上升趋势即将结束,
5,岛形反转顶,island_reversal_top,价格在高位形成跳空缺口后再次跳空下跌的形态,
6,双底,double_bottom,双底是一种看涨反转形态，当价格形成两个相近的低点后，通常会向上突破,
7,头肩底,head_shoulders_bottom,头肩底是最可靠的看涨反转形态，由左肩、头部、右肩三个低点组成,
8,三重底,triple_bottom,三重底由三个相近的低点组成，是强烈的看涨信号,
9,圆弧底,rounding_bottom,价格缓慢形成圆弧状的底部，表示下降趋势即将结束,
10,岛形反转底,island_reversal_bottom,价格在低位形成跳空缺口后再次跳空上涨的形态,
11,潜在双底,potential_double_bottom,正在形成中的双底形态，需要确认突破,
12,上升三角形,ascending_triangle,价格高点连线水平，低点连线上升，通常向上突破,
13,下降三角形,descending_triangle,价格低点连线水平，高点连线下降，通常向下突破,
14,对称三角形,symmetrical_triangle,价格高点下降，低点上升，形成楔形，突破方向不确定,
15,扩散三角形,expanding_triangle,价格波动幅度逐渐扩大，市场不确定性增加,
16,矩形整理,rectangle,价格在水平的支撑阻力区间内震荡整理,
17,楔形上升,rising_wedge,价格上涨但成交量递减，通常是看跌信号,
18,楔形下降,falling_wedge,价格下跌但成交量递减，通常是看涨信号,
19,旗形,flag,短期内价格小幅震荡的整理形态,
20,三角旗形,pennant,类似三角形的短期整理形态,
21,锤头线,hammer,实体小，下影线长，出现在下跌趋势中是看涨信号,"# 至少需要4根K线来判断短期趋势
if i < 3:
    continue

# 趋势判断：要求前面3根K线至少有2根是收盘价下跌的
trend_check = (kdata['close'][i-3] > kdata['close'][i-2]) + \
              (kdata['close'][i-2] > kdata['close'][i-1])
if trend_check < 2:
    continue

k = kdata.iloc[i]
body_size = abs(k['close'] - k['open'])
upper_shadow = k['high'] - max(k['open'], k['close'])
lower_shadow = min(k['open'], k['close']) - k['low']
total_range = k['high'] - k['low']

if total_range == 0:
    continue

body_ratio = body_size / total_range
upper_ratio = upper_shadow / total_range
lower_ratio = lower_shadow / total_range

if (body_ratio < 0.3 and upper_ratio < 0.1 and lower_ratio > 0.6):
    confidence = min(0.9, lower_ratio * 0.8 + (0.3 - body_ratio) * 0.5 + (0.1 - upper_ratio) * 0.3)
    datetime_val = str(k['datetime']) if 'datetime' in k.index else str(k.name)
    result = create_result(
        pattern_type='hammer', signal_type=SignalType.BUY, confidence=confidence,
        index=i, price=k['close'], datetime_val=datetime_val,
        extra_data={'body_ratio': body_ratio, 'upper_ratio': upper_ratio, 'lower_ratio': lower_ratio}
    )"
22,上吊线,hanging_man,实体小，下影线长，出现在上涨趋势中是看跌信号,
23,倒锤头,inverted_hammer,实体小，上影线长，出现在下跌趋势中是看涨信号,"if i < 3:
    continue

trend_check = (kdata['close'][i-3] > kdata['close'][i-2]) + \
              (kdata['close'][i-2] > kdata['close'][i-1])
if trend_check < 2:
    continue

k = kdata.iloc[i]
body_size = abs(k['close'] - k['open'])
upper_shadow = k['high'] - max(k['open'], k['close'])
lower_shadow = min(k['open'], k['close']) - k['low']
total_range = k['high'] - k['low']

if total_range == 0:
    continue

body_ratio = body_size / total_range
upper_ratio = upper_shadow / total_range
lower_ratio = lower_shadow / total_range

if (body_ratio < 0.3 and upper_ratio > 0.6 and lower_ratio < 0.1):
    confidence = min(0.9, upper_ratio * 0.8 + (0.3 - body_ratio) * 0.5)
    datetime_val = str(k['datetime']) if 'datetime' in k.index else str(k.name)
    result = create_result(
        pattern_type='inverted_hammer', signal_type=SignalType.BUY, confidence=confidence,
        index=i, price=k['close'], datetime_val=datetime_val,
        extra_data={'body_ratio': body_ratio, 'upper_ratio': upper_ratio, 'lower_ratio': lower_ratio}
    )"
24,流星线,shooting_star,实体小，上影线长，出现在上涨趋势中是看跌信号,"if i < 3:
    continue

trend_check = (kdata['close'][i-3] < kdata['close'][i-2]) + \
              (kdata['close'][i-2] < kdata['close'][i-1])
if trend_check < 2:
    continue

k = kdata.iloc[i]
body_size = abs(k['close'] - k['open'])
upper_shadow = k['high'] - max(k['open'], k['close'])
lower_shadow = min(k['open'], k['close']) - k['low']
total_range = k['high'] - k['low']

if total_range == 0:
    continue

body_ratio = body_size / total_range
upper_ratio = upper_shadow / total_range
lower_ratio = lower_shadow / total_range

if (body_ratio < 0.3 and upper_ratio > 0.6 and lower_ratio < 0.1):
    confidence = min(0.9, upper_ratio * 0.8 + (0.3 - body_ratio) * 0.5 + (0.1 - lower_ratio) * 0.3)
    datetime_val = str(k['datetime']) if 'datetime' in k.index else str(k.name)
    result = create_result(
        pattern_type='shooting_star', signal_type=SignalType.SELL, confidence=confidence,
        index=i, price=k['close'], datetime_val=datetime_val,
        extra_data={'body_ratio': body_ratio, 'upper_ratio': upper_ratio, 'lower_ratio': lower_ratio}
    )
    results.append(result)"
25,十字星,doji,开盘价与收盘价相近，表示市场犹豫不决,"
# 十字星识别算法
for i in range(len(kdata)):
    k = kdata.iloc[i]
    
    body_size = abs(k['close'] - k['open'])
    total_range = k['high'] - k['low']
    
    if total_range == 0:
        continue
    
    body_ratio = body_size / total_range
    
    # 实体占比小于10%认为是十字星
    if body_ratio < 0.1:
        confidence = min(0.9, (0.1 - body_ratio) / 0.1 * 0.9 + 0.5)
        
        datetime_val = str(kdata.iloc[i]['datetime']) if 'datetime' in kdata.columns else None
        
        result = create_result(
            pattern_type='doji',
            signal_type=SignalType.NEUTRAL,
            confidence=confidence,
            index=i,
            price=(k['open'] + k['close']) / 2,
            datetime_val=datetime_val,
            extra_data={
                'body_ratio': body_ratio,
                'upper_shadow': k['high'] - max(k['open'], k['close']),
                'lower_shadow': min(k['open'], k['close']) - k['low']
            }
        )
        results.append(result)
"
26,长十字星,long_legged_doji,上下影线都很长的十字星，市场极度不确定,
27,蜻蜓十字星,dragonfly_doji,只有下影线的十字星，在底部是看涨信号,
28,墓碑十字星,gravestone_doji,只有上影线的十字星，在顶部是看跌信号,
29,光头光脚阳线,white_marubozu,没有上下影线的阳线，表示强烈的买盘,
30,光头光脚阴线,black_marubozu,没有上下影线的阴线，表示强烈的卖盘,
31,纺锤线,spinning_top,实体小，上下影线长，表示多空力量均衡,"
# 纺锤线识别算法
for i in range(len(kdata)):
    k = kdata.iloc[i]
    
    body_size = abs(k['close'] - k['open'])
    upper_shadow = k['high'] - max(k['open'], k['close'])
    lower_shadow = min(k['open'], k['close']) - k['low']
    total_range = k['high'] - k['low']
    
    if total_range == 0:
        continue
    
    body_ratio = body_size / total_range
    upper_ratio = upper_shadow / total_range
    lower_ratio = lower_shadow / total_range
    
    # 纺锤线特征：小实体，上下影线都较长
    if (body_ratio < 0.3 and upper_ratio > 0.2 and lower_ratio > 0.2):
        confidence = min(0.8, (0.3 - body_ratio) * 1.5 + min(upper_ratio, lower_ratio) * 0.5)
        
        datetime_val = str(kdata.iloc[i]['datetime']) if 'datetime' in kdata.columns else None
        
        result = create_result(
            pattern_type='spinning_top',
            signal_type=SignalType.NEUTRAL,
            confidence=confidence,
            index=i,
            price=(k['open'] + k['close']) / 2,
            datetime_val=datetime_val,
            extra_data={
                'body_ratio': body_ratio,
                'upper_ratio': upper_ratio,
                'lower_ratio': lower_ratio
            }
        )
        results.append(result)
"
32,看涨吞没,bullish_engulfing,大阳线完全吞没前一根阴线，强烈看涨信号,"if i < 3:
    continue

trend_check = (kdata['close'][i-3] > kdata['close'][i-2]) + \
              (kdata['close'][i-2] > kdata['close'][i-1])
if trend_check < 2:
    continue

k1 = kdata.iloc[i-1]
k2 = kdata.iloc[i]

if k1['close'] < k1['open'] and k2['close'] > k2['open']:
    if k2['open'] < k1['close'] and k2['close'] > k1['open']:
        engulf_ratio = (k2['close'] - k2['open']) / (k1['open'] - k1['close'])
        confidence = min(0.9, 0.6 + engulf_ratio * 0.3)
        datetime_val = str(k2['datetime']) if 'datetime' in k2.index else str(k2.name)
        result = create_result(
            pattern_type='bullish_engulfing', signal_type=SignalType.BUY, confidence=confidence,
            index=i, price=k2['close'], datetime_val=datetime_val, start_index=i-1, end_index=i,
            extra_data={'engulf_ratio': engulf_ratio}
        )
        results.append(result)"
33,看跌吞没,bearish_engulfing,大阴线完全吞没前一根阳线，强烈看跌信号,"if i < 3:
    continue

trend_check = (kdata['close'][i-3] < kdata['close'][i-2]) + \
              (kdata['close'][i-2] < kdata['close'][i-1])
if trend_check < 2:
    continue

k1 = kdata.iloc[i-1]
k2 = kdata.iloc[i]

if k1['close'] > k1['open'] and k2['close'] < k2['open']:
    if k2['open'] > k1['close'] and k2['close'] < k1['open']:
        engulf_ratio = (k2['open'] - k2['close']) / (k1['close'] - k1['open'])
        confidence = min(0.9, 0.6 + engulf_ratio * 0.3)
        datetime_val = str(k2['datetime']) if 'datetime' in k2.index else str(k2.name)
        result = create_result(
            pattern_type='bearish_engulfing', signal_type=SignalType.SELL, confidence=confidence,
            index=i, price=k2['close'], datetime_val=datetime_val, start_index=i-1, end_index=i,
            extra_data={'engulf_ratio': engulf_ratio}
        )
        results.append(result)"
34,刺透形态,piercing_pattern,阳线向上刺透前一根阴线实体的一半以上,"if i < 3:
    continue

trend_check = (kdata['close'][i-3] > kdata['close'][i-2]) + \
              (kdata['close'][i-2] > kdata['close'][i-1])
if trend_check < 2:
    continue

k1 = kdata.iloc[i-1]
k2 = kdata.iloc[i]

if k1['close'] < k1['open'] and k2['close'] > k2['open']:
    k1_mid = (k1['open'] + k1['close']) / 2
    if k2['open'] < k1['low'] and k2['close'] > k1_mid: # 修正：开盘价低于最低价
        pierce_ratio = (k2['close'] - k1['close']) / (k1['open'] - k1['close'])
        confidence = min(0.8, 0.5 + pierce_ratio * 0.3)
        datetime_val = str(k2['datetime']) if 'datetime' in k2.index else str(k2.name)
        result = create_result(
            pattern_type='piercing_pattern', signal_type=SignalType.BUY, confidence=confidence,
            index=i, price=k2['close'], datetime_val=datetime_val, start_index=i-1, end_index=i,
            extra_data={'pierce_ratio': pierce_ratio}
        )
        results.append(result)"
35,乌云盖顶,dark_cloud_cover,阴线向下覆盖前一根阳线实体的一半以上,"if i < 3:
    continue

trend_check = (kdata['close'][i-3] < kdata['close'][i-2]) + \
              (kdata['close'][i-2] < kdata['close'][i-1])
if trend_check < 2:
    continue

k1 = kdata.iloc[i-1]
k2 = kdata.iloc[i]

if k1['close'] > k1['open'] and k2['close'] < k2['open']:
    k1_mid = (k1['open'] + k1['close']) / 2
    if k2['open'] > k1['high'] and k2['close'] < k1_mid: # 修正：开盘价高于最高价
        cover_ratio = (k1['close'] - k2['close']) / (k1['close'] - k1['open'])
        confidence = min(0.8, 0.5 + cover_ratio * 0.3)
        datetime_val = str(k2['datetime']) if 'datetime' in k2.index else str(k2.name)
        result = create_result(
            pattern_type='dark_cloud_cover', signal_type=SignalType.SELL, confidence=confidence,
            index=i, price=k2['close'], datetime_val=datetime_val, start_index=i-1, end_index=i,
            extra_data={'cover_ratio': cover_ratio}
        )
        results.append(result)"
36,孕线形态,harami,小K线被包含在大K线实体内，表示趋势可能转变,
37,十字孕线,harami_cross,十字星被包含在前一根大K线内，转向信号更强,
38,早晨之星,morning_star,阴线+小实体+阳线的组合，底部反转信号,"if i < 4: # 需要至少4根前期K线来判断趋势
    continue

# 趋势判断：要求前面3根K线至少有2根是收盘价下跌的
trend_check = (kdata['close'][i-4] > kdata['close'][i-3]) + \
              (kdata['close'][i-3] > kdata['close'][i-2])
if trend_check < 2:
    continue

k0 = kdata.iloc[i-2] # 第一根长阴线
k1 = kdata.iloc[i-1] # 第二根星线
k2 = kdata.iloc[i]   # 第三根长阳线

# 1. 第一根是长阴线, 第三根是长阳线
is_long_bearish = k0['close'] < k0['open'] and (k0['open'] - k0['close']) / (k0['high'] - k0['low'] if k0['high'] > k0['low'] else 1) > 0.6
is_long_bullish = k2['close'] > k2['open'] and (k2['close'] - k2['open']) / (k2['high'] - k2['low'] if k2['high'] > k2['low'] else 1) > 0.6
if not (is_long_bearish and is_long_bullish):
    continue

# 2. 第二根是小实体（星线）
star_body_ratio = abs(k1['close'] - k1['open']) / (k1['high'] - k1['low'] if k1['high'] > k1['low'] else 1)
if star_body_ratio >= 0.3: # 修正：正确的逻辑判断
    continue

# 3. 检查跳空：星线实体与第一根和第三根实体不重叠
gap1_down = max(k1['open'], k1['close']) < k0['close']
gap2_up = min(k1['open'], k1['close']) < k2['open'] # 经典定义是星线与阳线有缺口
if not (gap1_down and gap2_up):
    continue

# 4. 第三根阳线收盘价深入第一根阴线实体一半以上
penetration = (k2['close'] - k0['close']) / (k0['open'] - k0['close'])
if penetration <= 0.5: # 修正：正确的逻辑判断
    continue

confidence = min(0.95, 0.7 + (0.3 - star_body_ratio) * 0.5 + (penetration - 0.5) * 0.5)
datetime_val = str(k2['datetime']) if 'datetime' in k2.index else str(k2.name)
result = create_result(
    pattern_type='morning_star', signal_type=SignalType.BUY, confidence=confidence,
    index=i, price=k2['close'], datetime_val=datetime_val, start_index=i-2, end_index=i,
    extra_data={'star_body_ratio': star_body_ratio, 'penetration': penetration}
)
results.append(result)"
39,黄昏之星,evening_star,阳线+小实体+阴线的组合，顶部反转信号,"if i < 4: # 需要至少4根前期K线来判断趋势
    continue

# 趋势判断：要求前面3根K线至少有2根是收盘价上涨的
trend_check = (kdata['close'][i-4] < kdata['close'][i-3]) + \
              (kdata['close'][i-3] < kdata['close'][i-2])
if trend_check < 2:
    continue

k0 = kdata.iloc[i-2] # 第一根长阳线
k1 = kdata.iloc[i-1] # 第二根星线
k2 = kdata.iloc[i]   # 第三根长阴线

# 1. 第一根是长阳线, 第三根是长阴线
is_long_bullish = k0['close'] > k0['open'] and (k0['close'] - k0['open']) / (k0['high'] - k0['low'] if k0['high'] > k0['low'] else 1) > 0.6
is_long_bearish = k2['close'] < k2['open'] and (k2['open'] - k2['close']) / (k2['high'] - k2['low'] if k2['high'] > k2['low'] else 1) > 0.6
if not (is_long_bullish and is_long_bearish):
    continue

# 2. 第二根是小实体（星线）
star_body_ratio = abs(k1['close'] - k1['open']) / (k1['high'] - k1['low'] if k1['high'] > k1['low'] else 1)
if star_body_ratio >= 0.3: # 修正：正确的逻辑判断
    continue

# 3. 检查跳空：星线实体与第一根和第三根实体不重叠
gap1_up = min(k1['open'], k1['close']) > k0['close']
gap2_down = max(k1['open'], k1['close']) > k2['open'] # 经典定义是星线与阴线有缺口
if not (gap1_up and gap2_down):
    continue

# 4. 第三根阴线收盘价深入第一根阳线实体一半以上
penetration = (k0['close'] - k2['close']) / (k0['close'] - k0['open'])
if penetration <= 0.5: # 修正：正确的逻辑判断
    continue

confidence = min(0.95, 0.7 + (0.3 - star_body_ratio) * 0.5 + (penetration - 0.5) * 0.5)
datetime_val = str(k2['datetime']) if 'datetime' in k2.index else str(k2.name)
result = create_result(
    pattern_type='evening_star', signal_type=SignalType.SELL, confidence=confidence,
    index=i, price=k2['close'], datetime_val=datetime_val, start_index=i-2, end_index=i,
    extra_data={'star_body_ratio': star_body_ratio, 'penetration': penetration}
)
results.append(result)"
40,早晨十字星,morning_doji_star,阴线+十字星+阳线的组合，强烈底部反转信号,
41,黄昏十字星,evening_doji_star,阳线+十字星+阴线的组合，强烈顶部反转信号,
42,三白兵,three_white_soldiers,三根连续上涨的阳线，强烈看涨信号,"if i < 4: # 需要至少4根前期K线来判断趋势
    continue

# 趋势判断：要求前面3根K线至少有2根是收盘价下跌的
trend_check = (kdata['close'][i-4] > kdata['close'][i-3]) + \
              (kdata['close'][i-3] > kdata['close'][i-2])
if trend_check < 2:
    continue

k0 = kdata.iloc[i-2]
k1 = kdata.iloc[i-1]
k2 = kdata.iloc[i]

if not (k0['close'] > k0['open'] and k1['close'] > k1['open'] and k2['close'] > k2['open']):
    continue

if not (k2['close'] > k1['close'] > k0['close']):
    continue

# 优化：开盘价在前一根实体内，且不能是“墓碑”
if not (k1['open'] > k0['open'] and k1['open'] < k0['close'] and \
          k2['open'] > k1['open'] and k2['open'] < k1['close']):
    continue

body_0 = k0['close'] - k0['open']
body_1 = k1['close'] - k1['open']
body_2 = k2['close'] - k2['open']

if not (body_1 > body_0 * 0.8 and body_2 > body_1 * 0.8): # 实体不能过度萎缩
    continue

# 上影线不能太长
upper_shadow_0 = k0['high'] - k0['close']
upper_shadow_1 = k1['high'] - k1['close']
upper_shadow_2 = k2['high'] - k2['close']

if (upper_shadow_1 > body_1 * 0.5 or upper_shadow_2 > body_2 * 0.5):
     continue

confidence = 0.85
datetime_val = str(k2['datetime']) if 'datetime' in k2.index else str(k2.name)
result = create_result(
    pattern_type='three_white_soldiers', signal_type=SignalType.BUY, confidence=confidence,
    index=i, price=k2['close'], datetime_val=datetime_val, start_index=i-2, end_index=i,
    extra_data={'body_sizes': [body_0, body_1, body_2]}
)
results.append(result)"
43,三只乌鸦,three_black_crows,三根连续下跌的阴线，强烈看跌信号,"if i < 4: # 需要至少4根前期K线来判断趋势
    continue

# 趋势判断：要求前面3根K线至少有2根是收盘价上涨的
trend_check = (kdata['close'][i-4] < kdata['close'][i-3]) + \
              (kdata['close'][i-3] < kdata['close'][i-2])
if trend_check < 2:
    continue

k0 = kdata.iloc[i-2]
k1 = kdata.iloc[i-1]
k2 = kdata.iloc[i]

if not (k0['close'] < k0['open'] and k1['close'] < k1['open'] and k2['close'] < k2['open']):
    continue

if not (k2['close'] < k1['close'] < k0['close']):
    continue

# 优化：开盘价在前一根实体内
if not (k1['open'] < k0['open'] and k1['open'] > k0['close'] and \
          k2['open'] < k1['open'] and k2['open'] > k1['close']):
    continue

body_0 = k0['open'] - k0['close']
body_1 = k1['open'] - k1['close']
body_2 = k2['open'] - k2['close']

if not (body_1 > body_0 * 0.8 and body_2 > body_1 * 0.8): # 实体不能过度萎缩
    continue

# 下影线不能太长
lower_shadow_0 = k0['close'] - k0['low']
lower_shadow_1 = k1['close'] - k1['low']
lower_shadow_2 = k2['close'] - k2['low']

if (lower_shadow_1 > body_1 * 0.5 or lower_shadow_2 > body_2 * 0.5):
    continue

confidence = 0.85
datetime_val = str(k2['datetime']) if 'datetime' in k2.index else str(k2.name)
result = create_result(
    pattern_type='three_black_crows', signal_type=SignalType.SELL, confidence=confidence,
    index=i, price=k2['close'], datetime_val=datetime_val, start_index=i-2, end_index=i,
    extra_data={'body_sizes': [body_0, body_1, body_2]}
)
results.append(result)"
44,红三兵,three_advancing_soldiers,三根逐步上涨的阳线，稳健看涨信号,
45,三个内部上升,three_inside_up,看涨孕线后跟随一根确认阳线,
46,三个内部下降,three_inside_down,看跌孕线后跟随一根确认阴线,
47,弃婴形态,abandoned_baby,中间K线与两侧K线都有跳空，强烈反转信号,
48,塔形顶,tower_top,长阳线后经过整理再出现长阴线的顶部形态,
49,塔形底,tower_bottom,长阴线后经过整理再出现长阳线的底部形态,
50,上升通道,rising_channel,价格在上升趋势线和平行线之间运行,
51,下降通道,falling_channel,价格在下降趋势线和平行线之间运行,
52,喇叭形,megaphone,价格波动幅度逐渐扩大的形态,
53,钻石形,diamond,先扩散后收敛的菱形整理形态,
54,杯柄形态,cup_and_handle,U形底部后的小幅整理，长期看涨形态,
55,碟形整理,saucer,长期的圆弧底形态，温和的看涨信号,
56,向上跳空,gap_up,开盘价高于前一日最高价，表示强烈看涨,
57,向下跳空,gap_down,开盘价低于前一日最低价，表示强烈看跌,
58,突破缺口,breakaway_gap,突破重要阻力或支撑时形成的缺口,
59,中继缺口,runaway_gap,趋势中段出现的缺口，确认趋势继续,
60,衰竭缺口,exhaustion_gap,趋势末端的缺口，预示趋势可能反转,
61,普通缺口,common_gap,整理过程中的小缺口，通常会被回补,
62,价涨量增,price_up_volume_up,价格上涨伴随成交量放大，健康的上涨,
63,价跌量增,price_down_volume_up,价格下跌伴随成交量放大，空头力量强,
64,价涨量缩,price_up_volume_down,价格上涨但成交量萎缩，上涨动力不足,
65,价跌量缩,price_down_volume_down,价格下跌但成交量萎缩，抛压减轻,
66,地量地价,low_volume_low_price,成交量和价格都处于低位，可能是底部信号,
67,天量天价,high_volume_high_price,成交量和价格都处于高位，可能是顶部信号,
