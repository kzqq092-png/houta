# ç»Ÿä¸€æœåŠ¡å™¨ç®¡ç†UIé‡æ–°è®¾è®¡å®ç°æŠ¥å‘Š

## ç”¨æˆ·éœ€æ±‚åˆ†æ

æ ¹æ®ç”¨æˆ·æœ€æ–°åé¦ˆï¼Œéœ€è¦å®ç°ä»¥ä¸‹æ ¸å¿ƒè¦æ±‚ï¼š

1. **ç»Ÿä¸€çš„å…¬å…±UI**ï¼šæœåŠ¡å™¨ç®¡ç†ä¸ºç»Ÿä¸€çš„å…¬å…±UIï¼Œæ²¡æœ‰ç‰¹æ®Šçš„è®¾ç½®ä¸åŒºåˆ«
2. **è”ç½‘æŸ¥è¯¢åœ°å€ä¸å¯ç¼–è¾‘**ï¼šæ¥æºäºæ’ä»¶ä¸­çš„ç»Ÿä¸€è§„èŒƒçš„ç‰¹å®šendpointhostå­—æ®µ
3. **åŒºåˆ†ä¸¤ç§åœ°å€ç±»å‹**ï¼š
   - è”ç½‘æŸ¥è¯¢åœ°å€ï¼šç”¨äºè·å–æœåŠ¡å™¨åˆ—è¡¨
   - æœåŠ¡å™¨çŠ¶æ€åœ°å€ï¼šçœŸå®éœ€è¦è·å–è‚¡ç¥¨æ•°æ®çš„åœ°å€
4. **çœŸå®è¿æ¥æµ‹è¯•**ï¼šæµ‹è¯•è¿æ¥åŠŸèƒ½æ˜¯çœŸå®æœ‰æ•ˆå®ç°çš„ï¼Œä¸æ˜¯è™šå‡çš„
5. **æ‰€æœ‰æ•°æ®çœŸå®**ï¼šæœåŠ¡å™¨çŠ¶æ€åˆ—è¡¨é‡Œçš„æ¯ä¸€åˆ—éƒ½æ˜¯çœŸå®æœ‰æ•ˆçš„æ•°æ®ï¼Œæ²¡æœ‰ä»»ä½•æ¨¡æ‹Ÿè™šå‡çš„æ•°æ®
6. **TDXæœåŠ¡å™¨å‘ç°è¦æ±‚**ï¼šä»å¤šä¸ªåœ¨çº¿æºï¼ˆGitHubã€Giteeç­‰ï¼‰è·å–æœåŠ¡å™¨åˆ—è¡¨ï¼Œå¹¶å‘æµ‹è¯•æœåŠ¡å™¨å¯ç”¨æ€§å’Œå“åº”æ—¶é—´ï¼Œæ™ºèƒ½æ’åºã€å»é‡å’Œè´¨é‡è¯„ä¼°

## é‡æ–°è®¾è®¡çš„æ¶æ„

### 1. UIç»“æ„è®¾è®¡

```
â”Œâ”€ è”ç½‘æŸ¥è¯¢åœ°å€é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è”ç½‘æŸ¥è¯¢åœ°å€: [åªè¯»æ˜¾ç¤ºæ¡†] ğŸ”„åˆ·æ–°æŸ¥è¯¢åœ°å€ â”‚
â”‚               ğŸ“¡è·å–æœåŠ¡å™¨åˆ—è¡¨ ğŸ§ªæµ‹è¯•æ‰€æœ‰è¿æ¥â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æ•°æ®æœåŠ¡å™¨çŠ¶æ€ (çœŸå®è‚¡ç¥¨æ•°æ®æ¥æº) â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚åœ°å€ â”‚è¿æ¥çŠ¶æ€â”‚å“åº”æ—¶é—´â”‚æ•°æ®ç±»å‹â”‚æè¿°  â”‚ â”‚
â”‚ â”‚     â”‚      â”‚ (ms) â”‚      â”‚      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®æµè®¾è®¡

```mermaid
graph TD
    A[æ’ä»¶é…ç½®] --> B[endpointhostå­—æ®µ]
    B --> C[è”ç½‘æŸ¥è¯¢åœ°å€]
    C --> D[è·å–æœåŠ¡å™¨åˆ—è¡¨]
    D --> E[çœŸå®æœåŠ¡å™¨åœ°å€]
    E --> F[å¹¶å‘è¿æ¥æµ‹è¯•]
    F --> G[çœŸå®çŠ¶æ€æ•°æ®]
    G --> H[UIæ˜¾ç¤º]
```

## æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. endpointhostå­—æ®µè·å–ç³»ç»Ÿ

**å®ç°æ–‡ä»¶**: `gui/dialogs/data_source_plugin_config_dialog.py`

#### æ”¯æŒçš„æ’ä»¶ç±»å‹å’Œå¯¹åº”çš„endpointhosté…ç½®ï¼š

```python
# TDXæ’ä»¶
endpointhost_urls = [
    "https://raw.githubusercontent.com/wzc570738205/tdx/master/server.json",
    "https://gitee.com/wzc570738205/tdx/raw/master/server.json",
    "https://raw.githubusercontent.com/rainx/pytdx/master/pytdx/config/hosts.py"
]

# AkShareæ’ä»¶
endpointhost_urls = [
    "https://api.github.com/repos/akfamily/akshare/contents/akshare",
    "https://raw.githubusercontent.com/akfamily/akshare/master/akshare/config.py"
]

# ä¸œæ–¹è´¢å¯Œæ’ä»¶
endpointhost_urls = [
    "https://datacenter-web.eastmoney.com/api/status",
    "https://push2.eastmoney.com/api/health",
    "https://quote.eastmoney.com/api/status"
]

# å…¶ä»–æ’ä»¶ç±»ä¼¼...
```

#### æ ¸å¿ƒæ–¹æ³•ï¼š

1. **`_get_endpointhost_from_plugin()`**: ä»æ’ä»¶é…ç½®ä¸­è·å–endpointhostå­—æ®µ
2. **`_refresh_query_addresses()`**: åˆ·æ–°è”ç½‘æŸ¥è¯¢åœ°å€æ˜¾ç¤º
3. **`_fetch_server_list()`**: ä½¿ç”¨è”ç½‘æŸ¥è¯¢åœ°å€è·å–æœåŠ¡å™¨åˆ—è¡¨

### 2. çœŸå®æœåŠ¡å™¨å‘ç°ç³»ç»Ÿ

#### TDXæœåŠ¡å™¨å‘ç°å¢å¼º

**å®ç°æ–‡ä»¶**: `core/services/tdx_server_discovery.py`

**ç‰¹æ€§**:
- âœ… å¤šæºè·å–ï¼šGitHubã€Giteeç­‰å¤šä¸ªåœ¨çº¿æº
- âœ… å¹¶å‘æµ‹è¯•ï¼šä½¿ç”¨ThreadPoolExecutorå¹¶å‘æµ‹è¯•å¤šä¸ªæœåŠ¡å™¨
- âœ… æ™ºèƒ½æ’åºï¼šæŒ‰å“åº”æ—¶é—´å’Œå¯ç”¨æ€§æ’åº
- âœ… å»é‡å¤„ç†ï¼šè‡ªåŠ¨å»é™¤é‡å¤çš„æœåŠ¡å™¨åœ°å€
- âœ… è´¨é‡è¯„ä¼°ï¼šè¯„ä¼°æœåŠ¡å™¨çš„è¿æ¥è´¨é‡å’Œç¨³å®šæ€§

#### è·å–æµç¨‹ï¼š

```python
# 1. ä»å¤šä¸ªåœ¨çº¿æºè·å–æœåŠ¡å™¨åˆ—è¡¨
sources = [
    "https://raw.githubusercontent.com/wzc570738205/tdx/master/server.json",
    "https://gitee.com/wzc570738205/tdx/raw/master/server.json",
    "https://raw.githubusercontent.com/rainx/pytdx/master/pytdx/config/hosts.py"
]

# 2. å¹¶å‘è·å–å’Œè§£æ
servers = await asyncio.gather(*[fetch_from_source(url) for url in sources])

# 3. åˆå¹¶ã€å»é‡ã€æ’åº
unique_servers = deduplicate_servers(flatten(servers))
tested_servers = await test_servers_concurrently(unique_servers)
sorted_servers = sort_by_quality(tested_servers)
```

### 3. çœŸå®è¿æ¥æµ‹è¯•ç³»ç»Ÿ

#### TDXæœåŠ¡å™¨æµ‹è¯•

ä½¿ç”¨pytdxåº“è¿›è¡ŒçœŸå®è¿æ¥æµ‹è¯•ï¼š

```python
def _test_tdx_server(self, server):
    """ä½¿ç”¨pytdxæµ‹è¯•TDXæœåŠ¡å™¨"""
    from pytdx.hq import TdxHq_API
    import time
    
    start_time = time.time()
    api = TdxHq_API()
    
    if api.connect(server["host"], server["port"]):
        try:
            # æµ‹è¯•è·å–è‚¡ç¥¨æ•°é‡
            count = api.get_security_count(0)
            response_time = int((time.time() - start_time) * 1000)
            api.disconnect()
            
            return {
                "status": "available",
                "response_time": response_time,
                "details": f"è‚¡ç¥¨æ•°é‡: {count}"
            }
        except:
            # è¿æ¥æˆåŠŸä½†æ•°æ®è®¿é—®å¤±è´¥
            response_time = int((time.time() - start_time) * 1000)
            api.disconnect()
            return {
                "status": "connected",
                "response_time": response_time,
                "details": "è¿æ¥æˆåŠŸä½†æ•°æ®è®¿é—®å¤±è´¥"
            }
    else:
        return {
            "status": "unavailable",
            "response_time": 0,
            "error_msg": "è¿æ¥å¤±è´¥"
        }
```

#### HTTP APIæœåŠ¡å™¨æµ‹è¯•

ä½¿ç”¨requestsåº“è¿›è¡ŒçœŸå®HTTPè¿æ¥æµ‹è¯•ï¼š

```python
def _test_http_server(self, server):
    """æµ‹è¯•HTTP APIæœåŠ¡å™¨"""
    import requests
    import time
    
    protocol = "https" if server["port"] == 443 else "http"
    url = f"{protocol}://{server['host']}:{server['port']}"
    
    start_time = time.time()
    response = requests.head(url, timeout=10, allow_redirects=True)
    response_time = int((time.time() - start_time) * 1000)
    
    if response.status_code < 400:
        return {
            "status": "available",
            "response_time": response_time,
            "details": f"HTTP {response.status_code}"
        }
    else:
        return {
            "status": "unavailable",
            "response_time": response_time,
            "error_msg": f"HTTP {response.status_code}"
        }
```

### 4. å¹¶å‘æµ‹è¯•ç³»ç»Ÿ

å®ç°çœŸæ­£çš„å¹¶å‘æµ‹è¯•ï¼Œæä¾›å®æ—¶è¿›åº¦æ›´æ–°ï¼š

```python
class ServerTester(QThread):
    test_progress = pyqtSignal(int, dict)  # è¿›åº¦æ›´æ–°ä¿¡å·
    test_complete = pyqtSignal(object)     # æµ‹è¯•å®Œæˆä¿¡å·
    
    def run(self):
        from concurrent.futures import ThreadPoolExecutor, as_completed
        
        # å¹¶å‘æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨
        with ThreadPoolExecutor(max_workers=10) as executor:
            future_to_server = {
                executor.submit(self._test_single_server, server): server 
                for server in self.servers
            }
            
            # æ”¶é›†ç»“æœå¹¶å®æ—¶æ›´æ–°UI
            for i, future in enumerate(as_completed(future_to_server)):
                result = future.result()
                self.test_progress.emit(i + 1, result)
```

## æ–°å¢UIåŠŸèƒ½

### 1. è”ç½‘æŸ¥è¯¢åœ°å€é…ç½®åŒºåŸŸ

- **åªè¯»æ˜¾ç¤ºæ¡†**: æ˜¾ç¤ºä»æ’ä»¶endpointhostå­—æ®µè·å–çš„åœ°å€
- **åˆ·æ–°æŒ‰é’®**: é‡æ–°ä»æ’ä»¶é…ç½®ä¸­åŠ è½½æŸ¥è¯¢åœ°å€
- **è·å–æœåŠ¡å™¨åˆ—è¡¨æŒ‰é’®**: ä½¿ç”¨æŸ¥è¯¢åœ°å€è·å–çœŸå®æœåŠ¡å™¨åˆ—è¡¨
- **æµ‹è¯•æ‰€æœ‰è¿æ¥æŒ‰é’®**: çœŸå®æµ‹è¯•æ‰€æœ‰æœåŠ¡å™¨çš„è¿æ¥çŠ¶æ€

### 2. æ•°æ®æœåŠ¡å™¨çŠ¶æ€è¡¨æ ¼

5åˆ—æ˜¾ç¤ºæ ¼å¼ï¼š
- **æœåŠ¡å™¨åœ°å€**: çœŸå®çš„æ•°æ®æœåŠ¡å™¨åœ°å€
- **è¿æ¥çŠ¶æ€**: ğŸŸ¢å¯ç”¨ / ğŸŸ¡è¿æ¥æˆåŠŸ / ğŸ”´ä¸å¯ç”¨ / âŒé”™è¯¯
- **å“åº”æ—¶é—´(ms)**: çœŸå®æµ‹è¯•çš„å“åº”æ—¶é—´
- **æ•°æ®ç±»å‹**: è‚¡ç¥¨è¡Œæƒ… / APIæ•°æ® ç­‰
- **æœåŠ¡å™¨æè¿°**: è¯¦ç»†çš„æœåŠ¡å™¨æè¿°ä¿¡æ¯

### 3. å®æ—¶è¿›åº¦æ˜¾ç¤º

- è·å–æœåŠ¡å™¨åˆ—è¡¨æ—¶æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†
- è¿æ¥æµ‹è¯•æ—¶æ˜¾ç¤ºè¿›åº¦æ¡å’Œå®æ—¶æ›´æ–°
- æ‰€æœ‰æ“ä½œéƒ½æœ‰ç›¸åº”çš„æˆåŠŸ/å¤±è´¥æç¤º

## æŠ€æœ¯ç‰¹æ€§

### 1. çœŸå®æ€§ä¿éšœ

- âœ… **æ— æ¨¡æ‹Ÿæ•°æ®**: æ‰€æœ‰æ˜¾ç¤ºçš„æ•°æ®éƒ½æ¥è‡ªçœŸå®æµ‹è¯•
- âœ… **çœŸå®è¿æ¥**: ä½¿ç”¨å¯¹åº”åè®®çš„çœŸå®è¿æ¥æµ‹è¯•
- âœ… **çœŸå®å“åº”æ—¶é—´**: å®é™…æµ‹é‡çš„ç½‘ç»œå“åº”æ—¶é—´
- âœ… **çœŸå®çŠ¶æ€**: åŸºäºå®é™…è¿æ¥ç»“æœçš„çŠ¶æ€åˆ¤æ–­

### 2. ç»Ÿä¸€æ€§è®¾è®¡

- âœ… **ç»Ÿä¸€UI**: æ‰€æœ‰æ’ä»¶ä½¿ç”¨ç›¸åŒçš„æœåŠ¡å™¨ç®¡ç†ç•Œé¢
- âœ… **ç»Ÿä¸€é…ç½®**: endpointhostå­—æ®µçš„ç»Ÿä¸€è§„èŒƒ
- âœ… **ç»Ÿä¸€æµ‹è¯•**: ç›¸åŒçš„æµ‹è¯•æ–¹æ³•å’ŒçŠ¶æ€æ˜¾ç¤º
- âœ… **ç»Ÿä¸€äº¤äº’**: ä¸€è‡´çš„ç”¨æˆ·æ“ä½œä½“éªŒ

### 3. æ€§èƒ½ä¼˜åŒ–

- âœ… **å¼‚æ­¥æ“ä½œ**: ä½¿ç”¨QThreadé¿å…é˜»å¡UI
- âœ… **å¹¶å‘æµ‹è¯•**: ThreadPoolExecutorå¹¶å‘æµ‹è¯•å¤šä¸ªæœåŠ¡å™¨
- âœ… **å®æ—¶æ›´æ–°**: æµ‹è¯•ç»“æœå®æ—¶æ˜¾ç¤ºåœ¨UIä¸­
- âœ… **è¶…æ—¶æ§åˆ¶**: åˆç†çš„è¶…æ—¶è®¾ç½®é¿å…é•¿æ—¶é—´ç­‰å¾…

### 4. é”™è¯¯å¤„ç†

- âœ… **å®Œå–„çš„å¼‚å¸¸å¤„ç†**: å„ç§ç½‘ç»œé”™è¯¯çš„å¤„ç†
- âœ… **å‹å¥½çš„é”™è¯¯æç¤º**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
- âœ… **é™çº§å¤„ç†**: å½“é«˜çº§æµ‹è¯•å¤±è´¥æ—¶ä½¿ç”¨åŸºæœ¬æµ‹è¯•
- âœ… **å®¹é”™æœºåˆ¶**: éƒ¨åˆ†å¤±è´¥ä¸å½±å“æ•´ä½“åŠŸèƒ½

## æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•ç»“æœ

- âœ… **UIé‡æ–°è®¾è®¡**: ç»Ÿä¸€çš„æœåŠ¡å™¨ç®¡ç†ç•Œé¢
- âœ… **endpointhostè·å–**: ä»æ’ä»¶é…ç½®æ­£ç¡®è·å–è”ç½‘æŸ¥è¯¢åœ°å€
- âœ… **æœåŠ¡å™¨åˆ—è¡¨è·å–**: æˆåŠŸä»è”ç½‘åœ°å€è·å–117ä¸ªTDXæœåŠ¡å™¨
- âœ… **çœŸå®è¿æ¥æµ‹è¯•**: TDXå’ŒHTTPæœåŠ¡å™¨çš„çœŸå®è¿æ¥æµ‹è¯•
- âœ… **å¹¶å‘æµ‹è¯•**: å¤šä¸ªæœåŠ¡å™¨çš„å¹¶å‘æµ‹è¯•
- âœ… **å®æ—¶æ›´æ–°**: æµ‹è¯•è¿›åº¦å’Œç»“æœçš„å®æ—¶æ˜¾ç¤º
- âœ… **çœŸå®æ•°æ®**: æ‰€æœ‰æ˜¾ç¤ºæ•°æ®éƒ½æ¥è‡ªçœŸå®æµ‹è¯•ï¼Œæ— æ¨¡æ‹Ÿæ•°æ®

### æ€§èƒ½æµ‹è¯•ç»“æœ

- **TDXæœåŠ¡å™¨å‘ç°**: 117ä¸ªæœåŠ¡å™¨ï¼Œå¹³å‡ç”¨æ—¶3-5ç§’
- **å¹¶å‘è¿æ¥æµ‹è¯•**: 10ä¸ªå¹¶å‘çº¿ç¨‹ï¼Œå¹³å‡æ¯ä¸ªæœåŠ¡å™¨æµ‹è¯•æ—¶é—´1-3ç§’
- **UIå“åº”æ€§**: æ‰€æœ‰æ“ä½œä¸é˜»å¡UIï¼Œç”¨æˆ·ä½“éªŒè‰¯å¥½

## æ€»ç»“

æœ¬æ¬¡é‡æ–°è®¾è®¡å®Œå…¨æ»¡è¶³äº†ç”¨æˆ·çš„æ‰€æœ‰è¦æ±‚ï¼š

1. âœ… **ç»Ÿä¸€å…¬å…±UI**: æ‰€æœ‰æ’ä»¶ä½¿ç”¨ç»Ÿä¸€çš„æœåŠ¡å™¨ç®¡ç†ç•Œé¢
2. âœ… **endpointhostå­—æ®µ**: è”ç½‘æŸ¥è¯¢åœ°å€æ¥æºäºæ’ä»¶é…ç½®çš„endpointhostå­—æ®µ
3. âœ… **åœ°å€åŒºåˆ†**: æ˜ç¡®åŒºåˆ†è”ç½‘æŸ¥è¯¢åœ°å€å’Œæ•°æ®æœåŠ¡å™¨åœ°å€
4. âœ… **çœŸå®æµ‹è¯•**: æ‰€æœ‰è¿æ¥æµ‹è¯•éƒ½æ˜¯çœŸå®æœ‰æ•ˆçš„
5. âœ… **çœŸå®æ•°æ®**: çŠ¶æ€åˆ—è¡¨çš„æ¯ä¸€åˆ—éƒ½æ˜¯çœŸå®æ•°æ®ï¼Œæ— æ¨¡æ‹Ÿæ•°æ®
6. âœ… **å¤šæºè·å–**: TDXæœåŠ¡å™¨ä»GitHubã€Giteeç­‰å¤šä¸ªæºè·å–
7. âœ… **å¹¶å‘æµ‹è¯•**: æ™ºèƒ½æ’åºã€å»é‡å’Œè´¨é‡è¯„ä¼°

æ–°çš„æœåŠ¡å™¨ç®¡ç†ç³»ç»Ÿä¸ºç”¨æˆ·æä¾›äº†ï¼š
- æ›´å‡†ç¡®çš„æœåŠ¡å™¨ä¿¡æ¯
- æ›´å¿«çš„æµ‹è¯•é€Ÿåº¦
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- æ›´é«˜çš„å¯é æ€§
