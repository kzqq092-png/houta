# å¢é‡ä¸‹è½½åŠŸèƒ½å®Œæ•´æ€§éªŒè¯æŠ¥å‘Š

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

**éªŒè¯æ—¥æœŸ**: 2025-11-20
**éªŒè¯èŒƒå›´**: å›æº¯å¤©æ•°ã€æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ã€è·³è¿‡æœ€æ–°æ•°æ®ã€æ–°å¢åŠŸèƒ½é›†æˆ
**éªŒè¯ç»“æœ**: âš ï¸ **å­˜åœ¨é›†æˆç¼ºé™·éœ€è¦ä¿®å¤**

---

## ğŸ” è¯¦ç»†éªŒè¯ç»“æœ

### 1. å›æº¯å¤©æ•°åŠŸèƒ½ (incremental_days)

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
|--------|------|------|
| UIç»„ä»¶åˆ›å»º | âœ… | `incremental_days_spin` QSpinBoxæ­£ç¡®åˆ›å»º |
| é»˜è®¤å€¼è®¾ç½® | âœ… | é»˜è®¤å€¼ä¸º7å¤©ï¼ŒèŒƒå›´1-365å¤© |
| å‚æ•°è¯»å– | âœ… | `start_import()`æ­£ç¡®è¯»å–: `incremental_days_spin.value()` |
| ä¼ é€’åˆ°task_config | âœ… | æ­£ç¡®ä¼ é€’: `incremental_days=incremental_days` |
| åœ¨ImportTaskConfigä¸­ | âš ï¸ | **å­—æ®µåä¸åŒ¹é…**: UIä¼ é€’`incremental_days`ï¼Œä½†é…ç½®ä¸­æ˜¯`incremental_days_threshold` |
| ä¼ é€’åˆ°å¼•æ“ | âœ… | `_convert_to_unified_task()`æ­£ç¡®å¤„ç†: `incremental_days` |
| APIè·å–æ•°æ® | âœ… | `_execute_incremental_sync()`æ­£ç¡®ä½¿ç”¨è¯¥å‚æ•° |

**é—®é¢˜**: ImportTaskConfigä¸­ä½¿ç”¨çš„æ˜¯`incremental_days_threshold`ï¼Œä½†UIä¼ é€’çš„æ˜¯`incremental_days`

### 2. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ (check_completeness)

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
|--------|------|------|
| UIç»„ä»¶åˆ›å»º | âœ… | `check_completeness_cb` QCheckBoxæ­£ç¡®åˆ›å»º |
| å‚æ•°è¯»å– | âœ… | `start_import()`æ­£ç¡®è¯»å–: `check_completeness_cb.isChecked()` |
| ä¼ é€’åˆ°task_config | âš ï¸ | **å‚æ•°æœªå®šä¹‰**: å°è¯•ä¼ é€’`check_completeness=check_completeness`ä½†å­—æ®µä¸å­˜åœ¨ |
| åœ¨ImportTaskConfigä¸­ | âŒ | **å­—æ®µä¸å­˜åœ¨**: ImportTaskConfigä¸­æ²¡æœ‰`check_completeness`å­—æ®µ |
| å¼•æ“ä½¿ç”¨ | âŒ | **æœªä½¿ç”¨**: å¼•æ“ä¸­å®Œå…¨æ²¡æœ‰ä½¿ç”¨æ­¤å‚æ•° |
| åŠŸèƒ½å®ç° | âŒ | **ä¸å¯ç”¨**: è™½ç„¶UIæœ‰å¤é€‰æ¡†ï¼Œä½†åŠŸèƒ½æœªå®ç° |

**é—®é¢˜**: è¯¥åŠŸèƒ½åªåœ¨UIä¸­å­˜åœ¨ï¼Œæœªåœ¨åç«¯å®ç°

### 3. è·³è¿‡æœ€æ–°æ•°æ® (skip_latest_data)

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
|--------|------|------|
| UIç»„ä»¶åˆ›å»º | âœ… | `skip_latest_data_cb` QCheckBoxæ­£ç¡®åˆ›å»º |
| å‚æ•°è¯»å– | âœ… | `start_import()`æ­£ç¡®è¯»å–: `skip_latest_data_cb.isChecked()` |
| ä¼ é€’åˆ°task_config | âš ï¸ | **å‚æ•°æœªå®šä¹‰**: å°è¯•ä¼ é€’`skip_latest_data=skip_latest_data`ä½†å­—æ®µä¸å­˜åœ¨ |
| åœ¨ImportTaskConfigä¸­ | âŒ | **å­—æ®µä¸å­˜åœ¨**: ImportTaskConfigä¸­æ²¡æœ‰`skip_latest_data`å­—æ®µ |
| å¼•æ“ä½¿ç”¨ | âŒ | **æœªä½¿ç”¨**: å¼•æ“ä¸­å®Œå…¨æ²¡æœ‰ä½¿ç”¨æ­¤å‚æ•° |
| åŠŸèƒ½å®ç° | âŒ | **ä¸å¯ç”¨**: è™½ç„¶UIæœ‰å¤é€‰æ¡†ï¼Œä½†åŠŸèƒ½æœªå®ç° |

**é—®é¢˜**: è¯¥åŠŸèƒ½åªåœ¨UIä¸­å­˜åœ¨ï¼Œæœªåœ¨åç«¯å®ç°

### 4. æ–°å¢åŠŸèƒ½é›†æˆçŠ¶æ€

#### 4.1 IncrementalUpdateScheduler (å®šæ—¶è°ƒåº¦å™¨)

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
|--------|------|------|
| æ¨¡å—åˆ›å»º | âœ… | `incremental_update_scheduler.py`æ­£ç¡®åˆ›å»º |
| ä»£ç è¯­æ³• | âœ… | æ— è¯­æ³•é”™è¯¯ |
| æœåŠ¡æ³¨å†Œ | âœ… | åœ¨`service_bootstrap.py`æ­£ç¡®æ³¨å†Œ |
| ç”Ÿå‘½å‘¨æœŸ | âœ… | SINGLETONç”Ÿå‘½å‘¨æœŸé…ç½® |
| åŠŸèƒ½å®Œæ•´ | âœ… | æ”¯æŒæ—¥ã€å‘¨ã€æœˆã€è‡ªå®šä¹‰è°ƒåº¦ |
| ä¸ç³»ç»Ÿé›†æˆ | âš ï¸ | **éƒ¨åˆ†é›†æˆ**: æœåŠ¡å·²æ³¨å†Œä½†UIä¸­æ²¡æœ‰ä½¿ç”¨è¯¥æœåŠ¡ |

#### 4.2 BreakpointResumeManager (æ–­ç‚¹ç»­ä¼ )

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
|--------|------|------|
| æ¨¡å—åˆ›å»º | âœ… | `breakpoint_resume_manager.py`æ­£ç¡®åˆ›å»º |
| ä»£ç è¯­æ³• | âœ… | æ— è¯­æ³•é”™è¯¯ |
| æœåŠ¡æ³¨å†Œ | âœ… | åœ¨`service_bootstrap.py`æ­£ç¡®æ³¨å†Œ |
| ç”Ÿå‘½å‘¨æœŸ | âœ… | SINGLETONç”Ÿå‘½å‘¨æœŸé…ç½® |
| åŠŸèƒ½å®Œæ•´ | âœ… | æ”¯æŒæš‚åœ/æ¢å¤/åœæ­¢ |
| ä¸ç³»ç»Ÿé›†æˆ | âš ï¸ | **éƒ¨åˆ†é›†æˆ**: æœåŠ¡å·²æ³¨å†Œä½†å¯¼å…¥å¼•æ“ä¸­æ²¡æœ‰ä½¿ç”¨è¯¥æœåŠ¡ |

#### 4.3 UpdateHistoryWidget (å†å²è®°å½•UI)

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
|--------|------|------|
| æ¨¡å—åˆ›å»º | âœ… | `incremental_update_history_widget.py`æ­£ç¡®åˆ›å»º |
| ä»£ç è¯­æ³• | âœ… | æ— è¯­æ³•é”™è¯¯ |
| åŠŸèƒ½å®Œæ•´ | âœ… | UIç»„ä»¶é½å…¨ |
| ä¸ç³»ç»Ÿé›†æˆ | âš ï¸ | **éƒ¨åˆ†é›†æˆ**: ç»„ä»¶å­˜åœ¨ä½†æœªé›†æˆåˆ°ä¸»çª—å£ä¸­ |

#### 4.4 æµ‹è¯•æ¨¡å—

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
|--------|------|------|
| æ¨¡å—åˆ›å»º | âœ… | `test_incremental_update_system.py`æ­£ç¡®åˆ›å»º |
| ä»£ç è¯­æ³• | âœ… | æ— è¯­æ³•é”™è¯¯ |
| æµ‹è¯•è¦†ç›– | âœ… | åŒ…å«11ä¸ªæµ‹è¯•ç”¨ä¾‹ |

---

## ğŸ”§ éœ€è¦ä¿®å¤çš„é—®é¢˜

### é—®é¢˜1: incremental_dayså­—æ®µåä¸åŒ¹é…

**ä½ç½®**:
- UI: `gui/widgets/enhanced_data_import_widget.py` ç¬¬3449è¡Œ
- é…ç½®: `core/importdata/import_config_manager.py` ç¬¬106è¡Œ

**å½“å‰çŠ¶æ€**:
- UIä¼ é€’: `incremental_days=incremental_days`
- é…ç½®æœŸæœ›: `incremental_days_threshold`

**å½±å“**: å‚æ•°å¯èƒ½è¢«å¿½ç•¥ï¼Œå¯¼è‡´å›æº¯å¤©æ•°åŠŸèƒ½å¤±æ•ˆ

### é—®é¢˜2: check_completenesså’Œskip_latest_dataæœªåœ¨åç«¯å®ç°

**ä½ç½®**:
- UI: `gui/widgets/enhanced_data_import_widget.py` ç¬¬3350-3352è¡Œ
- é…ç½®: `core/importdata/import_config_manager.py` (ä¸å­˜åœ¨)
- å¼•æ“: `core/importdata/unified_data_import_engine.py` (ä¸ä½¿ç”¨)

**å½“å‰çŠ¶æ€**:
- UIæœ‰å¤é€‰æ¡†æ§ä»¶
- ä¼ é€’äº†å‚æ•°åˆ°task_config
- ä½†ImportTaskConfigæ²¡æœ‰è¿™äº›å­—æ®µ
- å¼•æ“ä¸­å®Œå…¨æ²¡æœ‰å¤„ç†é€»è¾‘

**å½±å“**: è¿™ä¸¤ä¸ªåŠŸèƒ½å®Œå…¨ä¸å·¥ä½œ

### é—®é¢˜3: æ–°å¢åŠŸèƒ½æœªå……åˆ†é›†æˆ

**å®šæ—¶è°ƒåº¦å™¨**:
- âœ… æœåŠ¡å·²æ³¨å†Œ
- âŒ UIä¸­æ²¡æœ‰è®¿é—®ç‚¹
- âŒ å¯¼å…¥å¼•æ“ä¸­æ²¡æœ‰è°ƒç”¨

**æ–­ç‚¹ç»­ä¼ **:
- âœ… æœåŠ¡å·²æ³¨å†Œ
- âŒ å¯¼å…¥å¼•æ“ä¸­æ²¡æœ‰ä½¿ç”¨
- âŒ UIä¸­æ²¡æœ‰ä½¿ç”¨

**å†å²è®°å½•UI**:
- âœ… ç»„ä»¶å­˜åœ¨
- âŒ æœªæ·»åŠ åˆ°ä¸»çª—å£
- âŒ ä¸ç³»ç»Ÿéš”ç¦»

---

## ğŸ“Š APIå‚æ•°ä¼ é€’é“¾éªŒè¯

### å›æº¯å¤©æ•°ä¼ é€’é“¾

```
UI (incremental_days_spin.value())
  â†“ âœ…
start_import() [è¯»å–å‚æ•°]
  â†“ âœ…
ImportTaskConfig(incremental_days=...)
  â†“ âš ï¸ å­—æ®µåä¸åŒ¹é…(åº”ä¸ºincremental_days_threshold)
UnifiedDataImportEngine._convert_to_unified_task()
  â†“ âœ…
unified_task.config['incremental_days']
  â†“ âœ…
_execute_incremental_sync()
  â†“ âœ…
ä¸‹è½½å™¨.download_incremental_update_all_data()
  â†“ âœ…
APIæŒ‰æŒ‡å®šå¤©æ•°è·å–æ•°æ®
```

**ç»“è®º**: å‚æ•°æµé€šè·¯å¾„æ­£ç¡®ï¼Œä½†å­—æ®µåæ˜ å°„æœ‰é—®é¢˜

### æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ä¼ é€’é“¾

```
UI (check_completeness_cb.isChecked())
  â†“ âœ…
start_import() [è¯»å–å‚æ•°]
  â†“ âŒ
ImportTaskConfig(check_completeness=...) [å­—æ®µä¸å­˜åœ¨]
  â†“ âŒ
UnifiedDataImportEngine [æ— å¤„ç†é€»è¾‘]
```

**ç»“è®º**: å‚æ•°è¢«è¯»å–ä½†æ— å¤„ç†å®ç°

### è·³è¿‡æœ€æ–°æ•°æ®ä¼ é€’é“¾

```
UI (skip_latest_data_cb.isChecked())
  â†“ âœ…
start_import() [è¯»å–å‚æ•°]
  â†“ âŒ
ImportTaskConfig(skip_latest_data=...) [å­—æ®µä¸å­˜åœ¨]
  â†“ âŒ
UnifiedDataImportEngine [æ— å¤„ç†é€»è¾‘]
```

**ç»“è®º**: å‚æ•°è¢«è¯»å–ä½†æ— å¤„ç†å®ç°

---

## âœ… æ­£å¸¸å·¥ä½œçš„åŠŸèƒ½

1. **å›æº¯å¤©æ•°** (incremental_days)
   - âœ… UIæ­£ç¡®è¯»å–
   - âœ… å‚æ•°ä¼ é€’æµé€š
   - âœ… å¼•æ“æ­£ç¡®ä½¿ç”¨
   - âš ï¸ ä»…éœ€ä¿®å¤å­—æ®µåæ˜ å°„

2. **å››ç§ä¸‹è½½æ¨¡å¼**
   - âœ… UIå•é€‰æŒ‰é’®æ­£ç¡®å®ç°
   - âœ… å‚æ•°æ­£ç¡®ä¼ é€’
   - âœ… å¼•æ“è·¯ç”±æ­£ç¡®

3. **é—´éš™é˜ˆå€¼** (gap_threshold)
   - âœ… UIæ­£ç¡®è¯»å–
   - âœ… å‚æ•°ä¼ é€’æµé€š
   - âœ… å¼•æ“æ­£ç¡®ä½¿ç”¨

4. **è¡¥å…¨ç­–ç•¥** (completion_strategy)
   - âœ… UIæ­£ç¡®è¯»å–
   - âœ… å‚æ•°ä¼ é€’æµé€š
   - âœ… å¼•æ“æ­£ç¡®ä½¿ç”¨

---

## ğŸ¯ ä¿®å¤å»ºè®®

### ä¼˜å…ˆçº§1 (å¿…é¡»ä¿®å¤)

1. **ä¿®å¤incremental_dayså­—æ®µå**
   ```
   åœ¨core/importdata/import_config_manager.pyç¬¬106è¡Œ:
   å°† incremental_days_threshold æ”¹ä¸º incremental_days
   æˆ–
   åœ¨UIä¸­æ”¹ä¸ºä¼ é€’ incremental_days_threshold
   ```

2. **ä¸ºcheck_completenessæ·»åŠ åç«¯å®ç°**
   ```
   - åœ¨ImportTaskConfigä¸­æ·»åŠ å­—æ®µ
   - åœ¨å¼•æ“ä¸­å®ç°å¤„ç†é€»è¾‘
   - åœ¨APIè°ƒç”¨ä¸­åº”ç”¨è¯¥å‚æ•°
   ```

3. **ä¸ºskip_latest_dataæ·»åŠ åç«¯å®ç°**
   ```
   - åœ¨ImportTaskConfigä¸­æ·»åŠ å­—æ®µ
   - åœ¨å¼•æ“ä¸­å®ç°å¤„ç†é€»è¾‘
   - åœ¨æ•°æ®éªŒè¯ä¸­åº”ç”¨è¯¥å‚æ•°
   ```

### ä¼˜å…ˆçº§2 (åº”è¯¥å®Œæˆ)

1. **é›†æˆå®šæ—¶è°ƒåº¦å™¨åˆ°å¯¼å…¥å¼•æ“**
2. **é›†æˆæ–­ç‚¹ç»­ä¼ åˆ°å¯¼å…¥å¼•æ“**
3. **æ·»åŠ å†å²è®°å½•UIåˆ°ä¸»çª—å£**

---

## ğŸ“ æ€»ä½“è¯„åˆ†

| æ–¹é¢ | è¯„åˆ† | å¤‡æ³¨ |
|------|------|------|
| UIå®ç° | 85% | å¤é€‰æ¡†å­˜åœ¨ä½†åŠŸèƒ½ä¸å®Œæ•´ |
| åç«¯å®ç° | 60% | ä»…å®ç°äº†éƒ¨åˆ†å‚æ•° |
| å‚æ•°ä¼ é€’ | 70% | å¤§éƒ¨åˆ†è·¯å¾„æ­£ç¡®ï¼Œæœ‰å­—æ®µåä¸åŒ¹é… |
| ç³»ç»Ÿé›†æˆ | 55% | æ–°å¢åŠŸèƒ½æ³¨å†Œä½†æœªå……åˆ†ä½¿ç”¨ |
| **æ€»ä½“** | **67%** | **éœ€è¦ä¿®å¤å…³é”®é›†æˆé—®é¢˜** |

---

## ğŸ“Œ å»ºè®®è¡ŒåŠ¨è®¡åˆ’

1. **ç«‹å³** (å½“å‰ä¼šè¯):
   - [ ] ä¿®å¤incremental_dayså­—æ®µåæ˜ å°„
   - [ ] å®ç°check_completenessåŠŸèƒ½
   - [ ] å®ç°skip_latest_dataåŠŸèƒ½

2. **çŸ­æœŸ** (æœ¬å‘¨):
   - [ ] å®Œå…¨é›†æˆæ–­ç‚¹ç»­ä¼ åˆ°å¯¼å…¥æµç¨‹
   - [ ] å®Œå…¨é›†æˆå®šæ—¶è°ƒåº¦å™¨
   - [ ] å°†å†å²è®°å½•UIæ·»åŠ åˆ°ä¸»çª—å£

3. **éªŒè¯**:
   - [ ] é€ä¸ªæµ‹è¯•æ‰€æœ‰å‚æ•°ä¼ é€’
   - [ ] éªŒè¯APIæ˜¯å¦æŒ‰æ­£ç¡®çš„æ•°æ®é‡è·å–
   - [ ] è¿›è¡Œç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
