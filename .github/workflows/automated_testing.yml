name: Automated Testing Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.9'
  POETRY_VERSION: '1.6.1'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}
        
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
      
    - name: Install project
      run: poetry install --no-interaction
      
    - name: Run Ruff linting
      run: |
        poetry run ruff check . --output-format=github
        
    - name: Run Ruff formatting check
      run: |
        poetry run ruff format --check .
        
    - name: Run type checking with mypy
      run: |
        poetry run mypy core/ --ignore-missing-imports --no-strict-optional
        
    - name: Check import sorting
      run: |
        poetry run isort --check-only --diff core/ tests/

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
        
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
      
    - name: Install project
      run: poetry install --no-interaction
      
    - name: Create test database directory
      run: mkdir -p db
      
    - name: Run unit tests with coverage
      run: |
        poetry run pytest tests/core/ \
          --cov=core \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --cov-fail-under=80 \
          --junit-xml=test-results-unit.xml \
          -v
          
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        
    - name: Upload unit test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: unit-test-results-${{ matrix.python-version }}
        path: |
          test-results-unit.xml
          htmlcov/
          coverage.xml

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      # å¦‚æœéœ€è¦æ•°æ®åº“æœåŠ¡
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}
        
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
      
    - name: Install project
      run: poetry install --no-interaction
      
    - name: Set up test environment
      run: |
        mkdir -p db logs temp
        chmod 755 db logs temp
        
    - name: Run integration tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        TEST_ENV: ci
      run: |
        poetry run pytest tests/integration/ \
          --junit-xml=test-results-integration.xml \
          --timeout=300 \
          -v \
          --tb=short
          
    - name: Upload integration test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results
        path: |
          test-results-integration.xml
          logs/

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf-test]')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}
        
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
      
    - name: Install project
      run: poetry install --no-interaction
      
    - name: Run performance benchmarks
      run: |
        poetry run pytest tests/performance/ \
          --benchmark-only \
          --benchmark-json=benchmark-results.json \
          --benchmark-sort=mean \
          -v
          
    - name: Store benchmark results
      uses: benchmark-action/github-action-benchmark@v1
      if: github.ref == 'refs/heads/main'
      with:
        tool: 'pytest'
        output-file-path: benchmark-results.json
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: true
        
    - name: Upload performance test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-test-results
        path: benchmark-results.json

  # å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}
        
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
      
    - name: Run safety check for known vulnerabilities
      run: |
        poetry run safety check --json --output safety-report.json || true
        
    - name: Run bandit security linter
      run: |
        poetry run bandit -r core/ -f json -o bandit-report.json || true
        
    - name: Upload security scan results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-scan-results
        path: |
          safety-report.json
          bandit-report.json

  # æ–‡æ¡£æ„å»ºæµ‹è¯•
  docs-build:
    name: Documentation Build
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}
        
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root --extras docs
      
    - name: Build documentation
      run: |
        poetry run sphinx-build -b html docs/ docs/_build/html -W
        
    - name: Upload documentation
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: docs/_build/html

  # æµ‹è¯•ç»“æœæ±‡æ€»å’ŒæŠ¥å‘Š
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-scan, docs-build]
    if: always()
    
    steps:
    - name: Download all test artifacts
      uses: actions/download-artifact@v3
      
    - name: Display test summary
      run: |
        echo "## ğŸ§ª æµ‹è¯•ç»“æœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥å•å…ƒæµ‹è¯•ç»“æœ
        if [ -f unit-test-results-*/test-results-unit.xml ]; then
          echo "âœ… å•å…ƒæµ‹è¯•: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ å•å…ƒæµ‹è¯•: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ£€æŸ¥é›†æˆæµ‹è¯•ç»“æœ
        if [ -f integration-test-results/test-results-integration.xml ]; then
          echo "âœ… é›†æˆæµ‹è¯•: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ é›†æˆæµ‹è¯•: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ£€æŸ¥å®‰å…¨æ‰«æç»“æœ
        if [ -f security-scan-results/safety-report.json ]; then
          echo "âœ… å®‰å…¨æ‰«æ: å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ å®‰å…¨æ‰«æ: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ£€æŸ¥æ–‡æ¡£æ„å»ºç»“æœ
        if [ -d documentation/ ]; then
          echo "âœ… æ–‡æ¡£æ„å»º: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ æ–‡æ¡£æ„å»º: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š è¦†ç›–ç‡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        
        # å¦‚æœæœ‰è¦†ç›–ç‡æ–‡ä»¶ï¼Œæ˜¾ç¤ºè¦†ç›–ç‡ä¿¡æ¯
        if [ -f unit-test-results-*/coverage.xml ]; then
          echo "è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹ Codecovã€‚" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— ç›¸å…³é“¾æ¥" >> $GITHUB_STEP_SUMMARY
        echo "- [æµ‹è¯•è¦†ç›–ç‡](https://codecov.io/gh/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
        echo "- [å®‰å…¨æ‰«ææŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒï¼ˆä»…åœ¨ä¸»åˆ†æ”¯ï¼‰
  deploy-test:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Install dependencies
      run: poetry install --no-interaction --no-root --only=main
      
    - name: Build application package
      run: |
        poetry build
        
    - name: Deploy to test environment
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
        echo "åº”ç”¨ç‰ˆæœ¬: $(poetry version -s)"
        echo "Gitæäº¤: ${{ github.sha }}"
        echo "éƒ¨ç½²æ—¶é—´: $(date)"
        
        # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„éƒ¨ç½²è„šæœ¬
        # ä¾‹å¦‚ï¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ã€æ›´æ–°å®¹å™¨ç­‰
        
    - name: Run smoke tests
      run: |
        echo "ğŸ” è¿è¡Œå†’çƒŸæµ‹è¯•..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ åŸºæœ¬çš„å¥åº·æ£€æŸ¥
        poetry run python -c "
        import core.importdata.intelligent_config_manager as icm
        print('âœ… æ ¸å¿ƒæ¨¡å—å¯¼å…¥æˆåŠŸ')
        
        # åŸºæœ¬åŠŸèƒ½æµ‹è¯•
        manager = icm.IntelligentConfigManager(':memory:')
        print('âœ… é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ')
        
        stats = manager.get_intelligent_statistics()
        print(f'âœ… ç»Ÿè®¡ä¿¡æ¯è·å–æˆåŠŸ: {len(stats)} é¡¹æŒ‡æ ‡')
        "
        
    - name: Notify deployment
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
        else
          echo "âŒ æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼"
        fi

# å·¥ä½œæµç¨‹å¤±è´¥æ—¶çš„é€šçŸ¥
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-scan, docs-build]
    if: failure()
    
    steps:
    - name: Create failure issue
      uses: actions/github-script@v6
      with:
        script: |
          const title = `ğŸš¨ è‡ªåŠ¨åŒ–æµ‹è¯•å¤±è´¥ - ${context.workflow} #${context.runNumber}`;
          const body = `
          ## æµ‹è¯•å¤±è´¥æŠ¥å‘Š
          
          **å·¥ä½œæµç¨‹**: ${context.workflow}
          **è¿è¡Œç¼–å·**: ${context.runNumber}
          **åˆ†æ”¯**: ${context.ref}
          **æäº¤**: ${context.sha}
          **è§¦å‘è€…**: ${context.actor}
          **æ—¶é—´**: ${new Date().toISOString()}
          
          ### å¤±è´¥çš„ä½œä¸š
          è¯·æ£€æŸ¥ä»¥ä¸‹é“¾æ¥æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š
          ${context.payload.repository.html_url}/actions/runs/${context.runId}
          
          ### å¯èƒ½çš„åŸå› 
          - ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥
          - å•å…ƒæµ‹è¯•å¤±è´¥
          - é›†æˆæµ‹è¯•å¤±è´¥
          - å®‰å…¨æ‰«æå‘ç°é—®é¢˜
          - æ–‡æ¡£æ„å»ºå¤±è´¥
          
          ### ä¸‹ä¸€æ­¥è¡ŒåŠ¨
          1. æŸ¥çœ‹å¤±è´¥çš„ä½œä¸šæ—¥å¿—
          2. ä¿®å¤ç›¸å…³é—®é¢˜
          3. é‡æ–°æäº¤ä»£ç 
          4. å…³é—­æ­¤ issue
          
          ---
          *æ­¤ issue ç”±è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹è‡ªåŠ¨åˆ›å»º*
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'ci-failure', 'high-priority']
          });
